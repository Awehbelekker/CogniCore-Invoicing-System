<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConiCore - Professional Invoice System</title>
    <meta name="description" content="ConiCore Invoicing - Professional business management and invoicing system">
    <meta name="theme-color" content="#00d4ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ConiCore">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒŠ</text></svg>" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒŠ</text></svg>">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .u-mt-1 {
            margin-top: 1rem;
        }

        .is-hidden {
            display: none;
        }

        .gdrive-control {
            display: none;
        }

        .sync-status {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-right: 0.5rem;
        }

        .google-icon {
            width: 14px;
            height: 14px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .setup-google-drive-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
        }

        :root {
            --primary: #00d4ff;
            --secondary: #ff006e;
            --accent: #7209b7;
            --success: #06ffa5;
            --warning: #ffbe0b;
            --danger: #f72585;
            --dark: #0a0e27;
            --darker: #050714;
            --light: #e0e7ff;
            --card-bg: rgba(10, 14, 39, 0.95);
            --text-primary: #e0e7ff;
            --text-secondary: rgba(224, 231, 255, 0.7);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-hover: rgba(255, 255, 255, 0.08);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light Theme */
        [data-theme="light"] {
            --dark: #f5f7fa;
            --darker: #e8ecf0;
            --light: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1a1a2e;
            --text-secondary: rgba(26, 26, 46, 0.7);
            --glass: rgba(0, 0, 0, 0.03);
            --glass-hover: rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf0 50%, #f5f7fa 100%);
            color: var(--text-primary);
        }

        [data-theme="light"] .card {
            background: var(--card-bg);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .nav-tab {
            color: var(--text-secondary);
        }

        [data-theme="light"] .nav-tab.active {
            color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
        }

        [data-theme="light"] .modal-content {
            background: var(--card-bg);
        }

        [data-theme="light"] .form-control {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.15);
            color: var(--text-primary);
        }

        [data-theme="light"] header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] nav {
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Global Search Results */
        .global-search-results {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .search-result-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-category {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.6;
            margin-bottom: 0.25rem;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--light);
        }

        .search-result-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        * {
            transition: background-color var(--transition-base), 
                        border-color var(--transition-base),
                        transform var(--transition-fast),
                        opacity var(--transition-base),
                        box-shadow var(--transition-base);
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--darker) 100%);
            background-attachment: fixed;
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* BUTTON FIX: Ensure buttons are always clickable */
        .btn, button {
            pointer-events: auto !important;
            z-index: 100 !important;
            position: relative !important;
        }
        
        /* Fix: Modal should NOT block buttons when closed */
        .modal:not(.active) {
            display: none !important;
            pointer-events: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            transition: all var(--transition-base);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        ::-webkit-scrollbar-thumb:active {
            background: var(--primary);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(0, 0, 0, 0.3);
        }

        /* Header */
        header {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            position: sticky;
            top: 0;
            z-index: 1000;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .logo h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .business-switcher button {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .business-switcher button:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        /* Utility Classes */
        .hide-mobile {
            display: inline;
        }

        /* Navigation */
        nav {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 212, 255, 0.15);
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-content::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-bottom: 2px solid transparent;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';\n            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transform: translateX(-50%);
            transition: width var(--transition-base);
        }

        .nav-tab:hover {
            color: var(--primary);
            background: var(--glass);
            transform: translateY(-2px);
        }

        .nav-tab:hover::before {
            width: 80%;
        }

        .nav-tab.active {
            color: var(--primary);
            background: var(--glass-hover);
        }

        .nav-tab.active::before {
            width: 100%;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            animation: cardIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.3);
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.15);
        }

        .card-title {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 0.3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn span,
        .btn strong,
        .btn small {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--danger));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 0, 110, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00b377);
            color: var(--dark);
            box-shadow: 0 4px 15px rgba(6, 255, 165, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(6, 255, 165, 0.5);
        }

        .btn-outline {
            background: var(--glass);
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            color: var(--light);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-control:hover {
            border-color: rgba(0, 212, 255, 0.4);
            background: var(--glass-hover);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.15), 0 0 20px rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        select.form-control {
            cursor: pointer;
            background: var(--glass);
            color: var(--light);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        select.form-control option {
            background: var(--dark);
            color: #ffffff;
            padding: 0.75rem;
            font-weight: 500;
        }

        select.form-control option:hover {
            background: var(--primary);
            color: var(--dark);
        }

        /* Product Search Results */
        .product-search-results {
            background: var(--dark);
            border: 1px solid var(--primary);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--light);
            margin-bottom: 0.25rem;
        }

        .search-result-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.12), rgba(138, 43, 226, 0.12));
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            padding: 2rem 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
            cursor: default;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(138, 43, 226, 0.3));
            border-radius: 16px;
            z-index: -1;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.15) 0%, transparent 70%);
            animation: statPulse 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes statPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 0.4; 
            }
            50% { 
                transform: scale(1.2) rotate(180deg); 
                opacity: 0.8; 
            }
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.3),
                        0 0 60px rgba(138, 43, 226, 0.2);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            animation: statValueIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes statValueIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.85);
            text-transform: uppercase;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .product-card {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        /* Product List View */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .product-list-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
            transform: translateX(5px);
        }

        .product-brand {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .product-sku {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 1rem;
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 280px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding-left: 3.5rem;
            padding-right: 3rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 212, 255, 0.2);
            transition: all var(--transition-base);
        }

        .search-box input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1),
                        0 8px 24px rgba(0, 212, 255, 0.2);
            padding-left: 3.75rem;
        }

        .search-box input:not(:placeholder-shown) {
            background: rgba(0, 212, 255, 0.05);
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.3rem;
            transition: all var(--transition-base);
            pointer-events: none;
        }

        .search-box input:focus + .search-icon {
            color: var(--accent);
            transform: translateY(-50%) scale(1.1);
            filter: drop-shadow(0 0 8px var(--primary));
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 0.5rem 1rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            color: var(--primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tag:hover,
        .filter-tag.active {
            background: var(--primary);
            color: var(--dark);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        th {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(138, 43, 226, 0.15));
            color: var(--primary);
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(20px);
        }

        td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            color: var(--light);
            transition: all var(--transition-base);
        }

        tr {
            transition: all var(--transition-fast);
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.08), rgba(138, 43, 226, 0.05));
            transform: scale(1.01);
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        tbody tr:hover td {
            color: rgba(255, 255, 255, 0.95);
        }

        tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .editable {
            background: rgba(255, 190, 11, 0.2);
            border: 1px dashed var(--warning);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .editable:hover {
            background: rgba(255, 190, 11, 0.3);
            border-style: solid;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            z-index: 10000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1.5px solid rgba(0, 212, 255, 0.3);
            border-radius: 24px;
            padding: 0;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg), 0 0 60px rgba(0, 212, 255, 0.2);
            animation: modalSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.1));
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .close-modal {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-header {
            flex-shrink: 0;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            max-height: calc(90vh - 80px);
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content > div:not(.modal-header):not(.modal-body) {
            padding: 2rem;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        /* Setup Wizard Styles */
        .wizard-modal {
            max-width: 850px;
            padding: 0;
        }

        .wizard-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 1.5rem;
            border-radius: 14px 14px 0 0;
            text-align: center;
        }

        .wizard-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
            padding: 0 1rem;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .wizard-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: -1;
        }

        .wizard-step:first-child::before {
            display: none;
        }

        .wizard-step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-step-number {
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
        }

        .wizard-step.completed .wizard-step-number {
            background: var(--success);
        }

        .wizard-step.completed .wizard-step-number::after {
            content: 'âœ“';
        }

        .wizard-step-label {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .wizard-step.active .wizard-step-label {
            opacity: 1;
            font-weight: bold;
        }

        .wizard-content {
            padding: 2rem;
            min-height: 400px;
        }

        .wizard-step-content {
            display: none;
        }

        .wizard-step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .wizard-instruction {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }

        .wizard-instruction h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .wizard-instruction ol {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .wizard-instruction li {
            margin: 0.5rem 0;
        }

        .wizard-copy-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary);
            padding: 0.75rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wizard-copy-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--light);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .wizard-copy-btn {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wizard-copy-btn:hover {
            background: var(--success);
            transform: scale(1.05);
        }

        .wizard-link-btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin: 1rem 0.5rem 1rem 0;
            transition: all 0.3s;
        }

        .wizard-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .wizard-validation {
            margin: 1rem 0;
        }

        .wizard-validation input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: var(--light);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .wizard-validation input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .wizard-validation.valid input {
            border-color: var(--success);
        }

        .wizard-validation.invalid input {
            border-color: var(--danger);
        }

        .wizard-validation-msg {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            display: none;
        }

        .wizard-validation.valid .wizard-validation-msg.success {
            display: block;
            color: var(--success);
        }

        .wizard-validation.invalid .wizard-validation-msg.error {
            display: block;
            color: var(--danger);
        }

        .wizard-footer {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wizard-alert {
            background: rgba(255, 190, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }

        .wizard-success {
            background: rgba(6, 255, 165, 0.1);
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 5px;
            text-align: center;
        }

        .wizard-success h3 {
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(247, 37, 133, 0.2);
            transform: rotate(90deg);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, rgba(6, 255, 165, 0.95), rgba(0, 179, 119, 0.95));
            backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: 16px;
            border: 2px solid rgba(6, 255, 165, 0.3);
            box-shadow: 0 8px 32px rgba(6, 255, 165, 0.5),
                        0 0 60px rgba(6, 255, 165, 0.2);
            z-index: 2000;
            animation: toastSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            min-width: 280px;
            max-width: 420px;
        }

        .toast.active {
            display: block;
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(255, 64, 129, 0.95), rgba(208, 0, 105, 0.95));
            border-color: rgba(255, 64, 129, 0.3);
            box-shadow: 0 8px 32px rgba(255, 64, 129, 0.5),
                        0 0 60px rgba(255, 64, 129, 0.2);
        }

        .toast.warning {
            background: linear-gradient(135deg, rgba(255, 190, 11, 0.95), rgba(230, 167, 0, 0.95));
            border-color: rgba(255, 190, 11, 0.3);
            color: var(--darker);
            box-shadow: 0 8px 32px rgba(255, 190, 11, 0.5),
                        0 0 60px rgba(255, 190, 11, 0.2);
        }

        .toast.info {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.95), rgba(138, 43, 226, 0.95));
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.5),
                        0 0 60px rgba(138, 43, 226, 0.2);
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(150px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spinnerRotate 0.8s linear infinite;
            margin: 0 auto;
        }

        .loading-spinner.large {
            width: 60px;
            height: 60px;
            border-width: 5px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-base);
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-overlay .loading-spinner {
            width: 80px;
            height: 80px;
            border-width: 6px;
            border-top-color: var(--primary);
            border-right-color: var(--accent);
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
        }

        .loading-overlay .loading-text {
            color: var(--light);
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 1px;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes spinnerRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Global Loading Overlay Enhancements */
        .loading-overlay {
            background: linear-gradient(135deg, rgba(10, 14, 20, 0.98) 0%, rgba(20, 30, 48, 0.98) 100%);
        }

        .loading-logo {
            animation: logoBounce 1s ease-in-out infinite;
        }

        @keyframes logoBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Skeleton Loader for Lists */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s infinite;
            border-radius: 8px;
        }

        .skeleton-line {
            height: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 70%; }
        .skeleton-line.long { width: 100%; }

        .skeleton-card {
            height: 120px;
            border-radius: 12px;
        }

        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tab switching animation */
        .tab-content {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tab-content.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Pull-to-refresh indicator */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--card-bg);
            padding: 0.75rem 1.5rem;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 9998;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pull-to-refresh.visible {
            transform: translateX(-50%) translateY(0);
        }

        .pull-to-refresh .loading-spinner {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }

        /* Refresh button animation */
        .btn-refresh {
            transition: transform 0.3s ease;
        }

        .btn-refresh.spinning {
            animation: spinnerRotate 1s linear infinite;
        }

        /* Data loading state for cards */
        .data-card.loading {
            position: relative;
            overflow: hidden;
        }

        .data-card.loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: skeletonShimmer 1.5s infinite;
        }

        /* Button loading state */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spinnerRotate 0.8s linear infinite;
        }

        /* Empty state improvements */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            animation: fadeIn 0.5s ease;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.9rem;
            max-width: 300px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(100px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Keyboard Shortcut Hints */
        .shortcut-hint {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
            margin-left: 0.5rem;
            opacity: 0.6;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 8px;
            transition: width var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 1.5s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Badges and Tags */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            transition: all var(--transition-fast);
        }

        .badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .badge.success {
            background: linear-gradient(135deg, rgba(6, 255, 165, 0.2), rgba(0, 179, 119, 0.2));
            border-color: var(--success);
            color: var(--success);
        }

        .badge.warning {
            background: linear-gradient(135deg, rgba(255, 190, 11, 0.2), rgba(230, 167, 0, 0.2));
            border-color: var(--warning);
            color: var(--warning);
        }

        .badge.danger {
            background: linear-gradient(135deg, rgba(255, 64, 129, 0.2), rgba(208, 0, 105, 0.2));
            border-color: var(--danger);
            color: var(--danger);
        }

        .badge.info {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(138, 43, 226, 0.2));
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.05) 25%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
            animation: skeletonLoad 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeletonLoad {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Color Picker */
        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .color-picker-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 4px;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        /* Logo Upload */
        .logo-upload-area {
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 1rem auto;
            display: none;
        }

        .logo-preview.active {
            display: block;
        }

        /* Invoice Items Table */
        .invoice-items-table {
            margin-top: 1.5rem;
        }

        .invoice-items-table td input {
            background: rgba(255, 190, 11, 0.1);
            border: 1px solid var(--warning);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Profile Selector */
        .profile-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        /* Mobile Responsive */
        /* Tablet and Mobile Responsiveness */
        @media (max-width: 768px) {
            :root {
                --shadow-lg: 0 6px 24px rgba(0, 0, 0, 0.4);
            }

            .container {
                padding: 0.75rem;
            }

            /* Mobile Header - Improved */
            header {
                padding: 1rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0.75rem;
            }
            
            /* Hide user email on mobile */
            .user-info-display {
                display: none !important;
            }
            
            .logo {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.25rem !important;
            }
            
            .logo h1 {
                font-size: 1.2rem !important;
                white-space: nowrap;
            }
            
            .business-switcher {
                display: none; /* Hide on mobile, use hamburger menu instead */
            }

            .header-actions {
                display: none; /* Hide by default on mobile */
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(10, 14, 39, 0.98);
                backdrop-filter: blur(20px);
                flex-direction: column;
                padding: 1.5rem;
                gap: 0.75rem;
                z-index: 999;
                overflow-y: auto;
            }
            
            .header-actions.mobile-open {
                display: flex !important;
            }

            /* Mobile Header Actions - Better Touch Targets */
            .quick-actions-group {
                display: flex !important;
                flex-wrap: nowrap;
                gap: 0.5rem !important;
            }
            
            .header-actions .btn {
                min-width: 44px;
                min-height: 44px;
                padding: 0.75rem;
                font-size: 1.25rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Hide text labels on mobile, keep icons */
            .hide-mobile {
                display: none !important;
            }
            
            .header-actions .global-search-container {
                width: 100%;
                margin-right: 0 !important;
            }
            
            .header-actions .global-search-container input {
                width: 100% !important;
            }

            #syncStatus {
                width: 100%;
                text-align: left;
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
            }
            
            /* Mobile Menu Toggle Button */
            .mobile-menu-toggle {
                display: flex !important;
                background: none;
                border: none;
                font-size: 1.5rem;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--text-primary, white);
            }

            /* Mobile Bottom Navigation */
            nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(10, 14, 39, 0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0, 212, 255, 0.2);
                z-index: 100;
                padding: 0;
            }
            
            .nav-content {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                scrollbar-width: none;
                padding: 0.5rem;
                gap: 0.25rem;
            }
            
            .nav-content::-webkit-scrollbar {
                display: none;
            }

            .nav-tab {
                flex: 0 0 auto;
                padding: 1rem 1.25rem;
                font-size: 0.85rem;
                white-space: nowrap;
                min-width: 80px;
                min-height: 44px;
                flex-direction: column;
                gap: 0.25rem;
                border-radius: 12px;
            }
            
            .nav-tab.active {
                background: rgba(0, 212, 255, 0.2);
            }
            
            /* Add padding to main content for fixed nav */
            main, .container {
                padding-bottom: 80px;
            }

            .stats-grid,
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .search-filter-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .search-filter-bar > * {
                width: 100%;
            }

            .modal-content {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 0;
                margin: 0;
            }
            
            .modal-header {
                position: sticky;
                top: 0;
                z-index: 10;
                padding: 1rem 1.25rem;
            }
            
            .modal-body {
                padding: 1.25rem;
                max-height: calc(100vh - 60px);
                padding-bottom: 100px;
            }

            .wizard-modal {
                max-width: 100%;
                border-radius: 0;
            }

            .table-container {
                font-size: 0.85rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 12px;
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }

            table {
                min-width: 500px;
            }

            th, td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
                font-size: 0.85rem;
            }

            .action-buttons {
                display: flex;
                gap: 0.5rem;
                flex-wrap: nowrap;
            }

            .btn-icon {
                min-width: 40px;
                min-height: 40px;
                padding: 0.4rem;
                font-size: 1rem;
            }

            .toast {
                right: 0.75rem;
                left: 0.75rem;
                top: auto;
                bottom: 90px;
                font-size: 0.9rem;
                padding: 0.875rem 1rem;
            }

            .card {
                padding: 1rem;
                border-radius: 16px;
                margin-bottom: 0.75rem;
            }

            .card-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start !important;
            }
            
            .card-header .btn {
                width: 100%;
            }

            .card-title {
                font-size: 1.1rem;
            }
            
            /* Mobile-friendly stat cards */
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            /* Dashboard mobile improvements */
            #dashboard .card:first-child {
                margin-top: 0;
            }
            
            /* Financial cards grid */
            .financial-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .financial-grid > div {
                padding: 1rem !important;
            }
            
            .financial-grid .stat-value,
            .financial-grid > div > div:nth-child(2) {
                font-size: 1.25rem !important;
            }
        }

        /* Small Mobile Phones */
        @media (max-width: 480px) {
            header {
                padding: 0.75rem;
            }

            .logo h1 {
                font-size: 1.1rem !important;
            }
            
            .logo img {
                height: 35px !important;
            }
            
            /* Larger buttons on small phones */
            .header-actions .btn {
                min-width: 48px;
                min-height: 48px;
                font-size: 1.35rem;
            }
            
            .nav-tab {
                padding: 1.1rem 1rem;
                font-size: 0.9rem;
                min-height: 48px;
            }

            .card {
                padding: 1.25rem;
                border-radius: 12px;
            }

            .card-title {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .stats-grid,
            .product-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.75rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .btn {
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
                min-width: 44px;
                min-height: 44px;
                border-radius: 10px;
            }
            
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.625rem 1rem;
                min-width: 40px;
                min-height: 40px;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            /* Prevent zoom on input focus (iOS) */
            .form-control, 
            .form-select, 
            select, 
            input[type="text"], 
            input[type="email"], 
            input[type="number"], 
            input[type="date"], 
            input[type="password"],
            textarea {
                font-size: 16px !important;
                min-height: 44px;
                padding: 0.75rem;
            }

            textarea {
                min-height: 100px;
            }

            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
            }

            .product-card,
            .customer-card {
                padding: 1rem;
            }

            /* Better touch targets */
            a, button, .btn, .nav-tab, .editable {
                min-height: 44px;
            }

            /* Scrollable tables on mobile */
            .table-container {
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            th, td {
                padding: 0.5rem 0.4rem;
                font-size: 0.8rem;
            }
            
            /* Financial cards on small screens */
            .financial-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Dashboard view toggle */
            #dashboardViewMode {
                font-size: 0.8rem;
                min-width: 140px !important;
            }
        }
        
        /* Mobile Floating Action Button */
        .fab-container {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 1rem;
            z-index: 99;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.6);
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .fab-container {
                display: block;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            header, nav, .btn, .modal {
                display: none !important;
            }

            .card {
                border: 1px solid #ddd;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo" style="display: flex; align-items: center; gap: 1rem;">
                <h1 id="headerBusinessName">ConiCore Invoicing</h1>
                <!-- Quick Business Switcher (Desktop) -->
                <div class="business-switcher" style="position: relative;">
                    <button id="businessSwitcherBtn" onclick="toggleBusinessSwitcher()" class="btn btn-outline btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;" title="Switch Business">
                        ðŸ¢ <span id="headerBusinessShort">Main</span> â–¼
                    </button>
                    <div id="businessSwitcherDropdown" style="display: none; position: absolute; top: 100%; left: 0; min-width: 250px; background: var(--card-bg, rgba(10, 14, 39, 0.98)); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1001; margin-top: 0.5rem; overflow: hidden;">
                        <div id="businessSwitcherList" style="max-height: 300px; overflow-y: auto;"></div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding: 0.75rem;">
                            <button onclick="openCreateBusinessModal(); toggleBusinessSwitcher();" class="btn btn-success btn-sm" style="width: 100%;">âž• Add New Business</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu" style="display: none;">
                <span id="mobileMenuIcon">â˜°</span>
            </button>
            
            <div class="header-actions" role="toolbar" aria-label="Main actions">
                <!-- Current User Display (Desktop Only) -->
                <div class="user-info-display" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border-radius: 20px; margin-right: 0.5rem;">
                    <span style="font-size: 0.85rem; opacity: 0.8;" id="currentUserEmail"></span>
                </div>
                
                <!-- Quick Actions Group -->
                <div class="quick-actions-group" style="display: flex; gap: 0.5rem; align-items: center;">
                    <!-- Cloud Sync Status (Google Drive / OneDrive) -->
                    <div style="position: relative;">
                        <button id="syncCloudBtn" class="btn btn-outline btn-sm" onclick="toggleCloudSyncMenu()" aria-label="Cloud Sync" title="Cloud Sync" style="display: flex; align-items: center; gap: 0.3rem;">
                            <span id="syncStatusIcon">â˜ï¸</span>
                            <span class="hide-mobile">Sync</span>
                            <span style="font-size: 0.7rem;">â–¼</span>
                        </button>
                        <!-- Sync Menu Dropdown -->
                        <div id="cloudSyncMenu" style="display: none; position: absolute; top: 100%; right: 0; background: var(--dark); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; min-width: 200px; z-index: 1000; margin-top: 0.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                            <div style="padding: 0.5rem;">
                                <button class="btn btn-sm" onclick="syncGoogle()" style="width: 100%; justify-content: flex-start; gap: 0.5rem; margin-bottom: 0.25rem; background: rgba(255,255,255,0.05);">
                                    <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    Google Drive
                                </button>
                                <button class="btn btn-sm" onclick="syncOneDrive()" style="width: 100%; justify-content: flex-start; gap: 0.5rem; background: rgba(255,255,255,0.05);">
                                    <svg width="16" height="16" viewBox="0 0 23 23"><path fill="#0078d4" d="M9 4.5c-2.5 0-4.5 2-4.5 4.5 0 .2 0 .4.1.6C2.5 10 1 11.8 1 14c0 2.5 2 4.5 4.5 4.5h12c2.5 0 4.5-2 4.5-4.5 0-2-1.3-3.7-3.2-4.2-.3-2.6-2.5-4.8-5.3-4.8-1.4 0-2.7.5-3.7 1.5-.3-1.1-1.3-2-2.8-2z"/></svg>
                                    OneDrive
                                </button>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding: 0.5rem; font-size: 0.75rem; opacity: 0.7; text-align: center;">
                                Choose your cloud backup
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice AI Button -->
                    <button class="btn btn-primary btn-sm" id="voiceAIBtn" onclick="voiceAI.toggle()" aria-label="Voice AI Assistant" title="Voice AI Assistant" style="display: flex; align-items: center; gap: 0.3rem; background: linear-gradient(135deg, #7209b7, #00d4ff);">
                        ðŸŽ™ï¸ <span class="hide-mobile">Voice AI</span>
                    </button>

                    <!-- Quick Scan Button -->
                    <button class="btn btn-primary btn-sm" onclick="openModal('quickScanModal')" aria-label="Quick Scan" title="Quick Scanner" style="display: flex; align-items: center; gap: 0.3rem;">
                        ðŸ“· <span class="hide-mobile">Quick Scan</span>
                    </button>
                    
                    <!-- New Invoice -->
                    <button class="btn btn-success btn-sm" onclick="openCreateInvoiceModal()" aria-label="Create new invoice" title="New Invoice" style="display: flex; align-items: center; gap: 0.3rem;">
                        âž• <span class="hide-mobile">New Invoice</span>
                    </button>
                    
                    <!-- Settings -->
                    <button class="btn btn-outline btn-sm" onclick="openSettingsModal()" aria-label="Settings" title="Settings">
                        âš™ï¸
                    </button>
                    
                    <!-- Logout -->
                    <button class="btn btn-outline btn-sm" onclick="logout()" aria-label="Logout" title="Logout" style="border-color: rgba(255, 64, 129, 0.5); color: #ff4081;">
                        ðŸšª
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-content">
            <button class="nav-tab active" onclick="switchTab('dashboard')" aria-label="Dashboard tab" role="tab" aria-selected="true">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('ai-agents')" aria-label="AI Agents tab" role="tab" aria-selected="false">ðŸ¤– AI Agents</button>
            <button class="nav-tab" onclick="switchTab('products')" aria-label="Products tab" role="tab" aria-selected="false">Products</button>
            <button class="nav-tab" onclick="switchTab('invoices')" aria-label="Invoices tab" role="tab" aria-selected="false">Invoices</button>
            <button class="nav-tab" id="adminTab" onclick="switchTab('admin')" aria-label="Admin tab" role="tab" aria-selected="false" style="display: none;">ðŸ‘‘ Admin</button>
            <button class="nav-tab" onclick="switchTab('customers')" aria-label="Customers tab" role="tab" aria-selected="false">Customers</button>
            <button class="nav-tab" onclick="switchTab('suppliers')" aria-label="Suppliers tab" role="tab" aria-selected="false">Suppliers</button>
            <button class="nav-tab" onclick="switchTab('receiving')" aria-label="Stock Receiving tab" role="tab" aria-selected="false">ðŸ“¦ Receiving</button>
            <button class="nav-tab" onclick="switchTab('documents')" aria-label="Documents tab" role="tab" aria-selected="false">ðŸ“„ Documents</button>
            <button class="nav-tab" onclick="switchTab('settings')" aria-label="Settings tab" role="tab" aria-selected="false">Settings</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container" role="main" aria-label="Main content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Business View Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 1.5rem;" id="dashBusinessLogo">ðŸ¢</span>
                    <div>
                        <h2 id="dashBusinessTitle" style="margin: 0; font-size: 1.3rem;">Dashboard</h2>
                        <small id="dashBusinessSubtitle" style="opacity: 0.7;">Viewing current business data</small>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label style="font-size: 0.9rem; opacity: 0.8;">View:</label>
                    <select id="dashboardViewMode" class="form-control" style="width: auto; min-width: 180px;" onchange="toggleDashboardView(this.value)">
                        <option value="current">ðŸ“Š Current Business</option>
                        <option value="linked">ðŸ”— Linked Businesses</option>
                        <option value="all">ðŸŒ All Businesses</option>
                    </select>
                </div>
            </div>
            
            <!-- All Businesses Summary (hidden by default) -->
            <div id="allBusinessesSummary" style="display: none; margin-bottom: 1.5rem;">
                <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.1)); border: 2px solid rgba(0, 212, 255, 0.3);">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ¢ Business Breakdown</h3>
                    </div>
                    <div id="businessBreakdownList" style="padding: 1rem;"></div>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(6, 255, 165, 0.15)); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">ðŸ’¾</span>
                    <div style="flex: 1;">
                        <strong>Your data is automatically saved</strong> to your device (localStorage).
                        <div style="font-size: 0.9rem; opacity: 0.85; margin-top: 0.25rem;">Google Drive sync is <strong>optional</strong> for backup across devices.</div>
                        <div id="storageUsageBar" style="margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem;">
                                <span id="storageUsageText">Calculating storage...</span>
                                <span id="storagePercentText"></span>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div id="storageProgressBar" style="background: linear-gradient(90deg, var(--success), var(--primary)); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Overview Dashboard -->
            <div class="card" style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), rgba(0, 212, 255, 0.1)); border: 2px solid rgba(114, 9, 183, 0.3); margin-bottom: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">ðŸ’° Financial Overview</h2>
                    <button class="btn btn-sm btn-outline" onclick="updateFinancialDashboard()">ðŸ”„ Refresh</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- Income -->
                        <div style="background: linear-gradient(135deg, #06ffa5, #00d4ff); padding: 1.5rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ’µ Total Income</div>
                            <div id="dashTotalIncome" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="dashIncomeInvoices">0 invoices</div>
                        </div>
                        
                        <!-- Expenses -->
                        <div style="background: linear-gradient(135deg, #f72585, #7209b7); padding: 1.5rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ’¸ Total Expenses</div>
                            <div id="dashTotalExpenses" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="dashExpenseCount">0 scanned</div>
                        </div>
                        
                        <!-- Profit -->
                        <div style="background: linear-gradient(135deg, #ffbe0b, #fb5607); padding: 1.5rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ“Š Net Profit</div>
                            <div id="dashNetProfit" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="dashProfitMargin">0% margin</div>
                        </div>
                        
                        <!-- Available Funds -->
                        <div style="background: linear-gradient(135deg, #00d4ff, #560bad); padding: 1.5rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ¦ Available Funds</div>
                            <div id="dashAvailableFunds" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="dashPendingIncome">+R 0 pending</div>
                        </div>
                        
                        <!-- Cash Flow -->
                        <div style="background: linear-gradient(135deg, #3a86ff, #8338ec); padding: 1.5rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ“ˆ This Month</div>
                            <div id="dashMonthCashFlow" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="dashMonthChange">+0% vs last month</div>
                        </div>
                    </div>
                    
                    <!-- Income vs Expenses Chart -->
                    <div style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 12px;">
                        <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">ðŸ“Š Income vs Expenses (Last 6 Months)</h3>
                        <div id="incomeExpensesChart" style="height: 200px; position: relative;">
                            <!-- Simple bar chart visualization -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices by Topic/Category -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ðŸ·ï¸ Invoices by Topic</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="topicFilter" class="form-control" style="width: 200px;" onchange="filterByTopic()">
                            <option value="all">All Categories</option>
                        </select>
                        <button class="btn btn-sm btn-outline" onclick="categorizeInvoices()">ðŸ¤– Auto-Categorize</button>
                    </div>
                </div>
                <div id="invoicesByTopic" style="padding: 1.5rem;">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        <p>Click "Auto-Categorize" to group invoices by topic using AI</p>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayInvoices">0</div>
                    <div class="stat-label">Today's Invoices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayRevenue">R 0</div>
                    <div class="stat-label">Today's Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthInvoices">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">R 0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <!-- AI Business Insights Card -->
            <div class="card" id="aiInsightsCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">ðŸ¤– AI Business Insights</h2>
                    <button class="btn btn-sm btn-outline" onclick="loadAIInsights()">ðŸ”„ Refresh</button>
                </div>
                <div id="aiInsightsContainer" style="padding: 1rem;">
                    <p style="text-align: center; opacity: 0.7;">Enable AI Insights in Settings to see smart recommendations...</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Invoices</h2>
                    <button class="btn btn-sm btn-primary" onclick="openCreateInvoiceModal()">Create New</button>
                </div>
                <div class="table-container">
                    <table id="recentInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices yet. Create your first invoice!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Agents Tab -->
        <div id="ai-agents" class="tab-content">
            <!-- AI Smart Search -->
            <div class="card" style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), rgba(0, 212, 255, 0.1)); border: 2px solid rgba(114, 9, 183, 0.3);">
                <div class="card-header">
                    <h2 class="card-title">ðŸ” Smart Search (RAGFlow)</h2>
                    <span style="font-size: 0.85rem; opacity: 0.8;">Ask questions about your invoices in natural language</span>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="aiSmartSearch" class="form-control" placeholder='Try: "Show Beach Bums total spending last month" or "Which invoices are overdue?"' style="flex: 1;">
                        <button class="btn btn-primary" onclick="runSmartSearch()">ðŸ” Search</button>
                    </div>
                    <div id="smartSearchResults" style="min-height: 100px;"></div>
                </div>
            </div>

            <!-- AI Agent Status -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ðŸ¤– AI Agents (CrewAI)</h2>
                    <button class="btn btn-sm btn-primary" onclick="runAllAgents()">â–¶ï¸ Run All Agents</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <!-- Invoice Analyst Agent -->
                        <div class="agent-card" style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(0, 212, 255, 0.3);">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <span style="font-size: 2rem;">ðŸ“Š</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem;">Invoice Analyst</h3>
                                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.8;">Analyzes payment patterns</p>
                                </div>
                            </div>
                            <div id="analystStatus" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;">Status: Ready</div>
                            <button class="btn btn-sm btn-outline" onclick="runAgent('analyst')">â–¶ï¸ Run Analysis</button>
                            <div id="analystResults" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                        </div>

                        <!-- Collection Specialist Agent -->
                        <div class="agent-card" style="background: rgba(6, 255, 165, 0.1); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(6, 255, 165, 0.3);">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <span style="font-size: 2rem;">ðŸ’¬</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem;">Collection Specialist</h3>
                                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.8;">Drafts follow-ups</p>
                                </div>
                            </div>
                            <div id="collectorStatus" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;">Status: Ready</div>
                            <button class="btn btn-sm btn-outline" onclick="runAgent('collector')">â–¶ï¸ Draft Follow-ups</button>
                            <div id="collectorResults" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                        </div>

                        <!-- Data Organizer Agent -->
                        <div class="agent-card" style="background: rgba(255, 190, 11, 0.1); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(255, 190, 11, 0.3);">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <span style="font-size: 2rem;">ðŸ—‚ï¸</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem;">Data Organizer</h3>
                                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.8;">Cleans invoice data</p>
                                </div>
                            </div>
                            <div id="organizerStatus" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;">Status: Ready</div>
                            <button class="btn btn-sm btn-outline" onclick="runAgent('organizer')">â–¶ï¸ Organize Data</button>
                            <div id="organizerResults" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DSPy Optimization Insights -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">âš¡ AI Optimization (DSPy)</h2>
                    <span style="font-size: 0.85rem; opacity: 0.8;">Self-optimizing prompts that learn from your data</span>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.5rem;">Recommendation Accuracy</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">88%</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.5rem;">Follow-up Effectiveness</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">92%</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.5rem;">Insights Generated</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">247</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OCR Scanning System -->
            <div class="card" style="background: linear-gradient(135deg, rgba(255, 0, 110, 0.1), rgba(255, 190, 11, 0.1)); border: 2px solid rgba(255, 0, 110, 0.3);">
                <div class="card-header">
                    <h2 class="card-title">ðŸ“¸ OCR Scanning System</h2>
                    <span style="font-size: 0.85rem; opacity: 0.8;">Scan documents with camera or upload images</span>
                </div>
                <div style="padding: 1.5rem;">
                    <p style="margin-bottom: 1.5rem; opacity: 0.9;">Extract text from invoices, price lists, and customer documents using AI-powered OCR (Tesseract.js + Together AI Vision)</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="scanPriceList()" style="padding: 1.5rem; height: auto;">
                            ðŸ“‹ <strong>Scan Price List</strong><br>
                            <small style="opacity: 0.8; font-weight: normal;">Extract products, SKUs, and prices from supplier price lists</small>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="scanInvoice()" style="padding: 1.5rem; height: auto;">
                            ðŸ§¾ <strong>Scan Invoice</strong><br>
                            <small style="opacity: 0.8; font-weight: normal;">Extract invoice data to create orders or track purchases</small>
                        </button>
                        <button type="button" class="btn btn-accent" onclick="scanCustomerDoc()" style="padding: 1.5rem; height: auto;">
                            ðŸ‘¤ <strong>Scan Customer Info</strong><br>
                            <small style="opacity: 0.8; font-weight: normal;">Extract customer details from business cards or documents</small>
                        </button>
                    </div>
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid var(--warning);">
                        <strong>ðŸ“± How it works:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                            <li>Click a scan button above</li>
                            <li>Use your device camera or upload an image</li>
                            <li>AI extracts text and structures data automatically</li>
                            <li>Review and save to your system</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Product Catalog</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div class="filter-tags">
                            <span class="filter-tag active" data-filter="all">All Products</span>
                            <span class="filter-tag" data-filter="awake">Awake</span>
                            <span class="filter-tag" data-filter="aquamarina">Aqua Marina</span>
                            <span class="filter-tag" data-filter="digg">DIGG</span>
                        </div>
                        <div class="view-toggle" style="display: flex; gap: 0.5rem; margin-left: auto;">
                            <button id="gridViewBtn" class="btn btn-sm" onclick="switchProductView('grid')" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none;" title="Grid View">
                                ðŸ”² Grid
                            </button>
                            <button id="listViewBtn" class="btn btn-sm btn-outline" onclick="switchProductView('list')" style="padding: 0.5rem 1rem;" title="List View">
                                â˜° List
                            </button>
                        </div>
                    </div>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <span class="search-icon" aria-hidden="true">ðŸ”</span>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products by name, SKU, or category..." aria-label="Search products">
                    </div>
                </div>

                <div id="productCount" style="color: var(--primary); margin-bottom: 1rem; font-weight: 600;">
                    Showing <span id="visibleProducts">217</span> of <span id="totalProducts">217</span> products
                </div>

                <div class="product-grid" id="productGrid">
                    <!-- Products will be dynamically loaded here -->
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Invoices</h2>
                    <button class="btn btn-primary btn-sm" onclick="openCreateInvoiceModal()">âž• Create Invoice</button>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" class="form-control" id="invoiceSearch" placeholder="Search invoices..." oninput="loadAllInvoices()">
                    </div>
                    <select class="form-control" style="max-width: 200px;" id="invoiceFilter" onchange="loadAllInvoices()">
                        <option value="all">All Types</option>
                        <option value="invoice">Invoices</option>
                        <option value="quote">Quotes</option>
                        <option value="proforma">Proforma</option>
                        <option value="credit_note">Credit Notes</option>
                        <option value="purchase_order">Purchase Orders</option>
                    </select>
                    <select class="form-control" style="max-width: 200px;" id="statusFilter" onchange="loadAllInvoices()">
                        <option value="all">All Status</option>
                        <option value="draft">ðŸ“ Draft</option>
                        <option value="sent">ðŸ“¤ Sent</option>
                        <option value="partial">ðŸ’° Partial</option>
                        <option value="paid">âœ… Paid</option>
                        <option value="overdue">âš ï¸ Overdue</option>
                        <option value="cancelled">âŒ Cancelled</option>
                    </select>
                    <button type="button" class="btn btn-accent btn-sm" onclick="openReportsModal()">ðŸ“Š Reports</button>
                </div>

                <div class="table-container">
                    <table id="allInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Customers</h2>
                    <button class="btn btn-primary btn-sm" onclick="openAddCustomerModal()">âž• Add Customer</button>
                </div>

                <div class="table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Tier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Customers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Suppliers</h2>
                    <button class="btn btn-primary btn-sm" onclick="openAddSupplierModal()">âž• Add Supplier</button>
                </div>

                <div class="table-container">
                    <table id="suppliersTable">
                        <thead>
                            <tr>
                                <th>Logo</th>
                                <th>Supplier Name</th>
                                <th>Contact</th>
                                <th>Products</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No suppliers yet. Add your first supplier!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ðŸ“· Quick Actions</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="scanPriceList()" style="padding: 1.5rem;">
                        ðŸ“¸ Scan Price List<br>
                        <small style="opacity: 0.7;">Use camera to scan supplier price list</small>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="uploadPriceList()" style="padding: 1.5rem;">
                        ðŸ“„ Upload Price List<br>
                        <small style="opacity: 0.7;">Upload PDF/Excel price list</small>
                    </button>
                    <button type="button" class="btn btn-accent" onclick="scanInvoice()" style="padding: 1.5rem;">
                        ðŸ§¾ Scan Invoice<br>
                        <small style="opacity: 0.7;">Scan supplier invoice to create order</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- Multi-Business Management -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ðŸ¢ Multi-Business Management</h2>
                    <button class="btn btn-primary btn-sm" onclick="openCreateBusinessModal()">âž• Add New Business</button>
                </div>

                <!-- Current Business Display -->
                <div id="currentBusinessDisplay" style="padding: 1rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(6, 255, 165, 0.1)); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="currentBusinessLogo" style="width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            ðŸ¢
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.25rem;">Currently Active:</div>
                            <div id="currentBusinessName" style="font-size: 1.3rem; font-weight: 600; color: var(--primary);">Your Business</div>
                            <div id="currentBusinessDetails" style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;"></div>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="openSwitchBusinessModal()">ðŸ”„ Switch Business</button>
                    </div>
                </div>

                <!-- Business List -->
                <div id="businessListSection" style="display: none;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Your Businesses</h4>
                    <div id="businessList" style="display: grid; gap: 1rem;"></div>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Company Logo</h2>
                </div>
                <div class="logo-upload-area" onclick="document.getElementById('logoUpload').click()">
                    <p>ðŸ“· Click to upload logo (PNG, JPG - Max 5MB)</p>
                    <img id="logoPreview" class="logo-preview" alt="Logo preview">
                    <input type="file" id="logoUpload" accept="image/png,image/jpeg" style="display: none;" onchange="handleLogoUpload(event)">
                </div>
                <button class="btn btn-outline btn-sm" onclick="removeLogo()" style="margin-top: 1rem;">Remove Logo</button>
            </div>

            <!-- Invoice Theme Settings -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ðŸŽ¨ Invoice Theme & Layout</h2>
                    <button class="btn btn-outline btn-sm" onclick="previewInvoiceTheme()">ðŸ‘ï¸ Preview</button>
                </div>

                <!-- Invoice Templates -->
                <div class="form-group">
                    <label class="form-label">ðŸ“‹ Quick Templates (One-Click Apply)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('modern-blue')" style="background: linear-gradient(135deg, #00d4ff, #0099cc); color: white; border: none;">
                            ðŸŒŠ Modern Blue
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('classic-black')" style="background: linear-gradient(135deg, #333, #000); color: white; border: none;">
                            ðŸŽ© Classic Black
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('bold-red')" style="background: linear-gradient(135deg, #ff006e, #cc0055); color: white; border: none;">
                            ðŸ”¥ Bold Red
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('elegant-purple')" style="background: linear-gradient(135deg, #7209b7, #560bad); color: white; border: none;">
                            ðŸ‘‘ Elegant Purple
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('ocean-teal')" style="background: linear-gradient(135deg, #06ffa5, #00b377); color: white; border: none;">
                            ðŸï¸ Ocean Teal
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('sunset-orange')" style="background: linear-gradient(135deg, #ff9500, #ff6b00); color: white; border: none;">
                            ðŸŒ… Sunset Orange
                        </button>
                    </div>
                </div>

                <!-- Logo Position -->
                <div class="form-group">
                    <label class="form-label">Logo Position</label>
                    <select class="form-control" id="logoPosition" onchange="saveSettings()">
                        <option value="top-left">Top Left</option>
                        <option value="top-center">Top Center</option>
                        <option value="top-right">Top Right</option>
                    </select>
                </div>

                <!-- Logo Size -->
                <div class="form-group">
                    <label class="form-label">Logo Size</label>
                    <select class="form-control" id="logoSize" onchange="saveSettings()">
                        <option value="small">Small (100px)</option>
                        <option value="medium" selected>Medium (150px)</option>
                        <option value="large">Large (200px)</option>
                    </select>
                </div>

                <!-- Invoice Layout -->
                <div class="form-group">
                    <label class="form-label">Invoice Layout</label>
                    <select class="form-control" id="invoiceLayout" onchange="saveSettings()">
                        <option value="modern" selected>Modern (Clean & Minimal)</option>
                        <option value="classic">Classic (Traditional)</option>
                        <option value="bold">Bold (High Contrast)</option>
                        <option value="elegant">Elegant (Professional)</option>
                    </select>
                </div>

                <!-- Font Style -->
                <div class="form-group">
                    <label class="form-label">Font Style</label>
                    <select class="form-control" id="fontStyle" onchange="saveSettings()">
                        <option value="sans-serif" selected>Sans-Serif (Modern)</option>
                        <option value="serif">Serif (Traditional)</option>
                        <option value="monospace">Monospace (Technical)</option>
                    </select>
                </div>

                <!-- Font Size -->
                <div class="form-group">
                    <label class="form-label">Base Font Size</label>
                    <select class="form-control" id="fontSize" onchange="saveSettings()">
                        <option value="small">Small (10pt)</option>
                        <option value="medium" selected>Medium (12pt)</option>
                        <option value="large">Large (14pt)</option>
                    </select>
                </div>

                <!-- Show/Hide Elements -->
                <div class="form-group">
                    <label class="form-label">Show on Invoice</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showLogo" checked onchange="saveSettings()">
                            <span>Company Logo</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showCompanyDetails" checked onchange="saveSettings()">
                            <span>Company Details</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showCustomerDetails" checked onchange="saveSettings()">
                            <span>Customer Details</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showItemImages" onchange="saveSettings()">
                            <span>Product Images</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showNotes" checked onchange="saveSettings()">
                            <span>Notes/Terms</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showPageNumbers" checked onchange="saveSettings()">
                            <span>Page Numbers</span>
                        </label>
                    </div>
                </div>

                <!-- Invoice Colors -->
                <div class="form-group">
                    <label class="form-label">Invoice Color Scheme</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Header Color</label>
                            <input type="color" class="form-control" id="invoiceHeaderColor" value="#00d4ff" onchange="saveSettings()">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Text Color</label>
                            <input type="color" class="form-control" id="invoiceTextColor" value="#000000" onchange="saveSettings()">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Accent Color</label>
                            <input type="color" class="form-control" id="invoiceAccentColor" value="#ff006e" onchange="saveSettings()">
                        </div>
                    </div>
                </div>

                <!-- Custom Footer Text -->
                <div class="form-group">
                    <label class="form-label">Invoice Footer Text</label>
                    <textarea class="form-control" id="invoiceFooter" rows="2" placeholder="Thank you for your business!" onchange="saveSettings()">Thank you for your business! Payment terms: 30 days from invoice date.</textarea>
                </div>

                <!-- Profit Margin Display Settings -->
                <div class="form-group" style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(6, 255, 165, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--success);">ðŸ’° Profit Margin Settings</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="showProfitOnPrint" onchange="saveSettings()">
                        <span style="font-size: 0.9rem;">Show profit margins on printed invoices</span>
                    </label>
                    <p style="font-size: 0.8rem; opacity: 0.7; margin: 0.5rem 0 0 0;">
                        âš ï¸ Warning: This will display cost prices and profit margins on the printed invoice. Only enable if you want customers to see this information.
                    </p>
                </div>

                <!-- Invoice Style Options -->
                <div class="form-group" style="background: rgba(255, 190, 11, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255, 190, 11, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: #ffbe0b;">ðŸ“‹ Invoice Display Options</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="showMarkupColumn" onchange="saveSettings()">
                        <span style="font-size: 0.9rem;">Show markup % column on invoice</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="showProjectFeeStyle" onchange="saveSettings()">
                        <span style="font-size: 0.9rem;">Use "Project Fee Due & Payable" style (for professional services)</span>
                    </label>
                    <p style="font-size: 0.8rem; opacity: 0.7; margin: 0.5rem 0 0 0;">
                        These options customize how the invoice appears to your clients.
                    </p>
                </div>

                <!-- Pricing Tier Cost Adjustments -->
                <div class="form-group" style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--primary);">ðŸ·ï¸ Pricing Tier Cost Adjustments</h3>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                        Set cost price multipliers for each tier. This allows you to account for bulk purchase discounts or different supplier pricing for different customer tiers.
                    </p>

                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #FFB6C1;">Retail:</label>
                            <input type="range" class="form-control" id="tierCostRetail" min="0.5" max="1.5" step="0.05" value="1.0"
                                   oninput="updateTierCostDisplay('retail', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostRetailDisplay" style="text-align: right; font-weight: 600;">1.00x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #DDA0DD;">Platinum:</label>
                            <input type="range" class="form-control" id="tierCostPlatinum" min="0.5" max="1.5" step="0.05" value="0.95"
                                   oninput="updateTierCostDisplay('platinum', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostPlatinumDisplay" style="text-align: right; font-weight: 600;">0.95x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #FFD700;">Gold:</label>
                            <input type="range" class="form-control" id="tierCostGold" min="0.5" max="1.5" step="0.05" value="0.90"
                                   oninput="updateTierCostDisplay('gold', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostGoldDisplay" style="text-align: right; font-weight: 600;">0.90x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #C0C0C0;">Silver:</label>
                            <input type="range" class="form-control" id="tierCostSilver" min="0.5" max="1.5" step="0.05" value="0.85"
                                   oninput="updateTierCostDisplay('silver', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostSilverDisplay" style="text-align: right; font-weight: 600;">0.85x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #87CEEB;">Rental:</label>
                            <input type="range" class="form-control" id="tierCostRental" min="0.5" max="1.5" step="0.05" value="0.80"
                                   oninput="updateTierCostDisplay('rental', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostRentalDisplay" style="text-align: right; font-weight: 600;">0.80x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #06FFA5;">Custom:</label>
                            <input type="range" class="form-control" id="tierCostCustom" min="0.5" max="1.5" step="0.05" value="1.0"
                                   oninput="updateTierCostDisplay('custom', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostCustomDisplay" style="text-align: right; font-weight: 600;">1.00x</span>
                        </div>
                    </div>

                    <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 1rem; margin-bottom: 0;">
                        ðŸ’¡ Example: If a product's landed cost is R1000 and Platinum tier has 0.95x cost multiplier, the cost for Platinum customers will be R950 (5% bulk discount).
                    </p>
                </div>
            </div>

            <!-- Color Customization -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Brand Colors (System UI)</h2>
                    <button class="btn btn-outline btn-sm" onclick="resetColors()">Reset to Default</button>
                </div>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label class="form-label">Primary Color</label>
                        <input type="color" id="primaryColor" value="#00d4ff" onchange="updateColors()">
                    </div>
                    <div class="color-picker-item">
                        <label class="form-label">Secondary Color</label>
                        <input type="color" id="secondaryColor" value="#ff006e" onchange="updateColors()">
                    </div>
                    <div class="color-picker-item">
                        <label class="form-label">Accent Color</label>
                        <input type="color" id="accentColor" value="#7209b7" onchange="updateColors()">
                    </div>
                </div>
            </div>

            <!-- Company Information -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Company Information</h2>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trading As</label>
                        <input type="text" class="form-control" id="tradingAs" value="">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="companyEmail" value="sales@awake.co.za">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="companyPhone" value="+27 21 555 0123">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-control" id="companyWebsite" value="www.awake.co.za">
                    </div>
                    <div class="form-group">
                        <label class="form-label">VAT Number</label>
                        <input type="text" class="form-control" id="companyVAT" value="4123456789">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="companyAddress">22 Porterfield Road
Table View, Cape Town
7439, South Africa</textarea>
                </div>
            </div>

            <!-- Banking Details -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Banking Details</h2>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="showBanking" checked onchange="saveSettings()">
                        <span style="font-size: 0.9rem; text-transform: none;">Show on invoices</span>
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bank Name</label>
                        <input type="text" class="form-control" id="bankName" value="First National Bank">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Holder</label>
                        <input type="text" class="form-control" id="accountHolder" value="">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accountNumber" value="62123456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Code</label>
                        <input type="text" class="form-control" id="branchCode" value="250655">
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">ï¿½ Payment Integration</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    Add online payment buttons to your invoices for faster payments.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Stripe -->
                    <div style="padding: 1.5rem; background: rgba(99, 91, 255, 0.1); border-radius: 8px; border: 1px solid rgba(99, 91, 255, 0.3);">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ðŸ’³</span> Stripe
                        </h4>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; cursor: pointer;">
                            <input type="checkbox" id="enableStripe" onchange="saveSettings()">
                            <span>Enable Stripe payments</span>
                        </label>
                        <div class="form-group">
                            <label class="form-label">Stripe Publishable Key</label>
                            <input type="text" class="form-control" id="stripePublishableKey" placeholder="pk_live_...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stripe Secret Key</label>
                            <input type="password" class="form-control" id="stripeSecretKey" placeholder="sk_live_...">
                        </div>
                        <small style="opacity: 0.7;">ðŸ’¡ Get keys from <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color: var(--primary);">Stripe Dashboard</a></small>
                    </div>
                    
                    <!-- PayPal -->
                    <div style="padding: 1.5rem; background: rgba(0, 112, 210, 0.1); border-radius: 8px; border: 1px solid rgba(0, 112, 210, 0.3);">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ðŸ…¿ï¸</span> PayPal
                        </h4>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; cursor: pointer;">
                            <input type="checkbox" id="enablePayPal" onchange="saveSettings()">
                            <span>Enable PayPal payments</span>
                        </label>
                        <div class="form-group">
                            <label class="form-label">PayPal Client ID</label>
                            <input type="text" class="form-control" id="paypalClientId" placeholder="Your Client ID">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PayPal Email (for invoice.me)</label>
                            <input type="email" class="form-control" id="paypalEmail" placeholder="your@email.com">
                        </div>
                        <small style="opacity: 0.7;">ðŸ’¡ Get keys from <a href="https://developer.paypal.com/dashboard/" target="_blank" style="color: var(--primary);">PayPal Developer</a></small>
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">ðŸ”„ Recurring Invoices</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    Automate monthly/quarterly billing for repeat customers.
                </p>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; cursor: pointer;">
                    <input type="checkbox" id="enableRecurring" onchange="saveSettings()">
                    <span>Enable recurring invoices</span>
                </label>
                <div class="form-group">
                    <label class="form-label">Auto-generate on day of month (1-31)</label>
                    <input type="number" class="form-control" id="recurringDay" min="1" max="31" value="1" placeholder="1">
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">ï¿½ðŸ“§ Email Template</h3>
                <div class="form-group">
                    <label class="form-label">Email Subject</label>
                    <input type="text" class="form-control" id="emailSubject" placeholder="Invoice {invoiceNumber} from {companyName}">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Body (use {customerName}, {invoiceNumber}, {total}, {dueDate}, {items}, {bankDetails})</label>
                    <textarea class="form-control" id="emailTemplate" rows="10"></textarea>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">ðŸ¤– AI Settings</h3>
                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.15) 0%, rgba(0, 212, 255, 0.15) 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--success);">
                    <p style="margin: 0; font-weight: 500;">âœ¨ Two AI Options Available:</p>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin: 0.5rem 0 0 0;">
                        <strong>ðŸ†“ FREE:</strong> Together AI (Llama 3.1) - No API key needed, basic features<br>
                        <strong>âš¡ Premium:</strong> Claude API - Your own key for superior AI quality
                    </p>
                </div>
                
                <div>
                    <div class="form-group">
                        <label class="form-label">AI Provider</label>
                        <select class="form-control" id="aiProvider" onchange="toggleAIKeySection()">
                            <option value="">ðŸ†“ FREE - Together AI (Llama 3.1)</option>
                            <option value="anthropic">âš¡ Anthropic Claude (Premium - Recommended)</option>
                            <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                            <option value="azure">Azure OpenAI</option>
                        </select>
                    </div>
                
                    <div id="aiKeySection" class="form-group" style="display: none;">
                        <label class="form-label">AI API Key (stored locally - never sent to our servers)</label>
                        <input type="password" class="form-control" id="aiApiKey" placeholder="Enter your API key...">
                        <small style="opacity: 0.7; display: block; margin-top: 0.5rem;">
                            ðŸ“Œ Get Claude API key: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: var(--primary);">console.anthropic.com</a>
                        </small>
                    </div>

                    <div id="aiModelSection" class="form-group" style="display: none;">
                        <label class="form-label">AI Model</label>
                        <select class="form-control" id="aiModel">
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Recommended - Fast & Smart)</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus (Most Capable)</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fastest & Cheapest)</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline" onclick="testAIConnection()" style="margin-bottom: 1rem;">
                        ðŸ”Œ Test AI Connection
                    </button>
                    <span id="aiTestResult" style="margin-left: 0.5rem;"></span>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--primary); font-size: 1.1rem;">ðŸ’¡ AI Features</h4>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="enableAIFollowups">
                        <span>Payment follow-ups (auto-send reminders for overdue invoices)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="enableAIRecommendations">
                        <span>Product recommendations (suggest products based on customer history)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="enableAIInsights">
                        <span>Business insights (analyze sales trends and customer patterns)</span>
                    </label>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--primary); font-size: 1.1rem;">âš™ï¸ Follow-up Configuration</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Days after due date to send first follow-up</label>
                        <input type="number" class="form-control" id="followupDaysOverdue" value="3" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Follow-up frequency (days)</label>
                        <input type="number" class="form-control" id="followupFrequency" value="7" min="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Maximum follow-up attempts</label>
                    <input type="number" class="form-control" id="maxFollowupAttempts" value="3" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">AI Prompt Template for Follow-ups</label>
                    <textarea class="form-control" id="aiFollowupPrompt" rows="5" placeholder="You are a friendly payment reminder assistant for {companyName}..."></textarea>
                </div>

                <button class="btn btn-success" onclick="saveSettings()">ðŸ’¾ Save All Settings</button>
            </div>

            <!-- OCR Settings Section -->
            <div class="card" style="border-left: 4px solid var(--secondary);">
                <div class="card-header">
                    <h2 class="card-title">ðŸ“· OCR Settings (Document Scanning)</h2>
                </div>

                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.15) 0%, rgba(0, 212, 255, 0.15) 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--success);">
                    <p style="margin: 0; font-weight: 500;">ðŸ“± Offline-First OCR:</p>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin: 0.5rem 0 0 0;">
                        <strong>ðŸŒ Offline:</strong> Tesseract.js runs in your browser - always available, no API needed<br>
                        <strong>â˜ï¸ Online (Optional):</strong> Add your own API keys for enhanced accuracy
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">OCR Mode</label>
                    <select class="form-control" id="ocrMode" onchange="toggleOCRSettings()">
                        <option value="offline">ðŸ“± Offline Only (Tesseract.js - Always Works)</option>
                        <option value="hybrid">ðŸ”„ Hybrid (Try Online First, Fallback to Offline)</option>
                        <option value="online">â˜ï¸ Online Only (Requires API Keys)</option>
                    </select>
                </div>

                <div id="ocrOnlineSettings" style="display: none;">
                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; color: var(--secondary); font-size: 1rem;">â˜ï¸ Online OCR APIs (Your Own Keys)</h4>

                    <!-- Together AI (FREE) -->
                    <div style="padding: 1rem; background: rgba(0, 212, 255, 0.1); border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3); margin-bottom: 1rem;">
                        <h5 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">ðŸ†“</span> Together AI (FREE Tier)
                        </h5>
                        <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.5rem;">Free vision models - get your key at together.ai</p>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="password" class="form-control" id="togetherApiKey" placeholder="Enter your Together AI API key...">
                        </div>
                        <small style="opacity: 0.7;">ðŸ’¡ Get free key: <a href="https://api.together.xyz/" target="_blank" style="color: var(--primary);">api.together.xyz</a></small>
                    </div>

                    <!-- Self-Hosted OCR -->
                    <div style="padding: 1rem; background: rgba(255, 190, 11, 0.1); border-radius: 8px; border: 1px solid rgba(255, 190, 11, 0.3); margin-bottom: 1rem;">
                        <h5 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">ðŸ–¥ï¸</span> Self-Hosted OCR (Advanced)
                        </h5>
                        <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.5rem;">Run your own OCR servers for maximum privacy and accuracy</p>

                        <div class="form-group">
                            <label class="form-label">HunyuanOCR Server URL (92% accuracy)</label>
                            <input type="text" class="form-control" id="hunyuanOcrUrl" placeholder="http://localhost:8000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PaddleOCR Server URL (100+ languages)</label>
                            <input type="text" class="form-control" id="paddleOcrUrl" placeholder="http://localhost:8080">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="showOcrConfidence" checked>
                        <span>Show OCR confidence scores and engine info</span>
                    </label>
                </div>

                <button type="button" class="btn btn-sm btn-outline" onclick="testOCRConnection()" style="margin-bottom: 1rem;">
                    ðŸ”Œ Test OCR Connection
                </button>
                <span id="ocrTestResult" style="margin-left: 0.5rem;"></span>

                <div style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="saveOCRSettings()">ðŸ’¾ Save OCR Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Receiving & Payables Tab -->
    <div id="receiving" class="tab-content">
        <!-- Currency Exchange Rates -->
        <div class="card" style="background: linear-gradient(135deg, rgba(255, 190, 11, 0.1), rgba(251, 86, 7, 0.1)); border: 2px solid rgba(255, 190, 11, 0.3); margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">ðŸ’± Exchange Rates</h2>
                <button class="btn btn-sm btn-outline" onclick="refreshExchangeRates()" id="refreshRatesBtn">ðŸ”„ Refresh Rates</button>
            </div>
            <div style="padding: 1rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ðŸ‡ºðŸ‡¸</span>
                        <span>USD:</span>
                        <strong id="rateUSD" style="color: var(--success);">R 18.50</strong>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ðŸ‡ªðŸ‡º</span>
                        <span>EUR:</span>
                        <strong id="rateEUR" style="color: var(--success);">R 20.20</strong>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ðŸ‡¬ðŸ‡§</span>
                        <span>GBP:</span>
                        <strong id="rateGBP" style="color: var(--success);">R 23.50</strong>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ðŸ‡¸ðŸ‡ª</span>
                        <span>SEK:</span>
                        <strong id="rateSEK" style="color: var(--success);">R 1.75</strong>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ðŸ‡¨ðŸ‡³</span>
                        <span>CNY:</span>
                        <strong id="rateCNY" style="color: var(--success);">R 2.55</strong>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.6; margin-left: auto;">
                        Last updated: <span id="ratesLastUpdated">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">ðŸ“¦ Stock Receiving</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="openStockReceivingModal('auto')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; height: auto;">
                        <span style="font-size: 2.5rem;">ðŸ¤–</span>
                        <span style="font-weight: 600;">AI Auto-Scan</span>
                        <span style="font-size: 0.8rem; opacity: 0.8;">AI detects document type</span>
                    </button>
                    <button class="btn btn-outline" onclick="openStockReceivingModal('supplier-invoice')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; height: auto;">
                        <span style="font-size: 2rem;">ðŸ“‹</span>
                        <span>Supplier Invoice</span>
                    </button>
                    <button class="btn btn-outline" onclick="openStockReceivingModal('customs')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; height: auto;">
                        <span style="font-size: 2rem;">ðŸ›ƒ</span>
                        <span>Customs Declaration</span>
                    </button>
                    <button class="btn btn-outline" onclick="openStockReceivingModal('delivery')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; height: auto;">
                        <span style="font-size: 2rem;">ðŸšš</span>
                        <span>Delivery Note</span>
                    </button>
                    <button class="btn btn-outline" onclick="openStockReceivingModal('shipping')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; height: auto;">
                        <span style="font-size: 2rem;">ðŸš¢</span>
                        <span>Shipping Costs</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Payables Overview -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">ðŸ’³ Accounts Payable (Invoices to Pay)</h2>
            </div>
            <div style="padding: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: linear-gradient(135deg, #f72585, #7209b7); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Total Outstanding</div>
                        <div id="totalPayables" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Overdue</div>
                        <div id="overduePayables" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffbe0b, #fb5607); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Due This Week</div>
                        <div id="weekPayables" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #06ffa5, #00d4ff); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Paid This Month</div>
                        <div id="paidThisMonth" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="payablesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Supplier</th>
                                <th>Invoice #</th>
                                <th>Items</th>
                                <th>Currency</th>
                                <th>Original</th>
                                <th>ZAR Amount</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payablesTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 2rem; opacity: 0.6;">
                                    No payables yet. Scan a supplier invoice to get started.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stock Receiving History -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“œ Receiving History</h2>
                <button class="btn btn-sm btn-outline" onclick="exportReceivingHistory()">ðŸ“Š Export CSV</button>
            </div>
            <div style="padding: 1rem;">
                <div class="table-container">
                    <table id="receivingHistoryTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Document Type</th>
                                <th>Supplier</th>
                                <th>Products</th>
                                <th>Landed Cost</th>
                                <th>Documents</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receivingHistoryBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.6;">
                                    No receiving records yet.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div id="documents" class="tab-content">
        <!-- Bank Statement Import & Management Accounts -->
        <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(6, 255, 165, 0.1)); border: 2px solid rgba(0, 212, 255, 0.3);">
            <div class="card-header">
                <h2 class="card-title">ðŸ¦ Bank & Financial Reports</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm btn-success" onclick="exportManagementAccounts()">ðŸ“Š Export Management Accounts</button>
                    <button class="btn btn-sm btn-primary" onclick="openBankImportModal()">ðŸ“¥ Import Bank Statement</button>
                </div>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ðŸ’¼ Available Reports</h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 0.5rem 0;">âœ“ Profit & Loss Statement</li>
                            <li style="padding: 0.5rem 0;">âœ“ Balance Sheet</li>
                            <li style="padding: 0.5rem 0;">âœ“ Cash Flow Statement</li>
                            <li style="padding: 0.5rem 0;">âœ“ Expense Report</li>
                            <li style="padding: 0.5rem 0;">âœ“ Income by Category</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ðŸ¦ Bank Reconciliation</h3>
                        <div id="bankReconcStats">
                            <p style="margin: 0.5rem 0;"><strong>Transactions:</strong> <span id="bankTransCount">0</span></p>
                            <p style="margin: 0.5rem 0;"><strong>Matched:</strong> <span id="bankMatchedCount">0</span></p>
                            <p style="margin: 0.5rem 0;"><strong>Unmatched:</strong> <span id="bankUnmatchedCount">0</span></p>
                            <button class="btn btn-sm btn-outline" onclick="viewBankTransactions()" style="margin-top: 0.5rem; width: 100%;">View Transactions</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Mobile Scan -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“± Quick Scan</h2>
                <p style="opacity: 0.8; margin-top: 0.5rem;">Scan anything - invoice, business card, price list, receipt, bank statement</p>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="quickScan('customer-invoice')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ§¾</span>
                        <span>Customer Invoice</span>
                    </button>
                    <button class="btn btn-primary" onclick="quickScan('supplier-invoice')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ“‹</span>
                        <span>Supplier Invoice</span>
                    </button>
                    <button class="btn btn-primary" onclick="quickScan('bank-statement')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ¦</span>
                        <span>Bank Statement</span>
                    </button>
                    <button class="btn btn-primary" onclick="quickScan('business-card')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ’¼</span>
                        <span>Business Card</span>
                    </button>
                    <button class="btn btn-primary" onclick="quickScan('price-list')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ’°</span>
                        <span>Price List</span>
                    </button>
                    <button class="btn btn-primary" onclick="quickScan('receipt')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ§¾</span>
                        <span>Receipt</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Expenses from Scanned Invoices -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ’¸ Expenses Tracker</h2>
                <button class="btn btn-sm btn-success" onclick="exportExpenses()">ðŸ“Š Export CSV</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: linear-gradient(135deg, #f72585, #7209b7); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Total Expenses</div>
                        <div id="totalExpenses" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00d4ff, #090979); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">This Month</div>
                        <div id="monthExpenses" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #06ffa5, #00d4ff); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">This Week</div>
                        <div id="weekExpenses" style="font-size: 2rem; font-weight: bold;">R 0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffbe0b, #fb5607); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem;">Items Scanned</div>
                        <div id="scannedCount" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Supplier</th>
                                <th>Items</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; opacity: 0.7;">No expenses yet. Scan a supplier invoice to start tracking!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Document Archive -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“š Document Archive</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <select id="filterDocType" class="form-control" style="width: 200px;" onchange="loadDocuments()">
                        <option value="all">All Types</option>
                        <option value="customer-invoice">Customer Invoices</option>
                        <option value="supplier-invoice">Supplier Invoices</option>
                        <option value="business-card">Business Cards</option>
                        <option value="price-list">Price Lists</option>
                        <option value="receipt">Receipts</option>
                    </select>
                    <button class="btn btn-sm btn-outline" onclick="clearAllDocuments()">ðŸ—‘ï¸ Clear All</button>
                </div>
            </div>
            <div id="documentsGrid" style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <div style="text-align: center; opacity: 0.7; padding: 2rem; grid-column: 1 / -1;">
                    <p>No documents yet. Use Quick Scan above to start!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tab -->
    <div id="admin" class="tab-content">
        <!-- Quick User Actions -->
        <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 2px solid rgba(102, 126, 234, 0.3);">
            <div class="card-header">
                <h2 class="card-title">ðŸš€ Quick Staff Registration</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <!-- Single User Quick Add -->
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.25rem; border-radius: 12px;">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ‘¤ Quick Add Single User
                        </h3>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <input type="text" id="quickAddName" class="form-control" placeholder="Full Name" style="padding: 0.6rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <input type="email" id="quickAddEmail" class="form-control" placeholder="Email Address" style="padding: 0.6rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <select id="quickAddRole" class="form-control" style="padding: 0.6rem;">
                                <option value="user">ðŸ‘¤ Staff</option>
                                <option value="sales">ðŸ›’ Sales Rep</option>
                                <option value="manager">ðŸ“Š Manager</option>
                                <option value="accountant">ðŸ’° Accountant</option>
                                <option value="admin">ðŸ‘‘ Admin</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="quickAddUser()" style="width: 100%;">
                            âš¡ Create & Generate Login Code
                        </button>
                    </div>
                    
                    <!-- Bulk Import -->
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.25rem; border-radius: 12px;">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ“‹ Bulk Staff Import
                        </h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                            Upload a CSV file to auto-register multiple users at once.
                        </p>
                        <div style="background: rgba(255, 190, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem;">
                            <strong>CSV Format:</strong><br>
                            <code style="font-size: 0.75rem;">name,email,role</code><br>
                            <code style="font-size: 0.75rem;">John Doe,john@company.com,sales</code>
                        </div>
                        <input type="file" id="staffCsvUpload" accept=".csv" style="display: none;" onchange="processBulkStaffImport(this)">
                        <button class="btn btn-outline" onclick="document.getElementById('staffCsvUpload').click()" style="width: 100%; margin-bottom: 0.5rem;">
                            ðŸ“¤ Upload Staff CSV
                        </button>
                        <button class="btn btn-outline" onclick="downloadStaffTemplate()" style="width: 100%;">
                            ðŸ“¥ Download Template
                        </button>
                    </div>
                    
                    <!-- Pending Logins -->
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.25rem; border-radius: 12px;">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸŽ« Active Login Codes
                        </h3>
                        <div id="activeLoginCodes" style="max-height: 200px; overflow-y: auto;">
                            <p style="opacity: 0.7; font-size: 0.85rem;">No pending login codes.</p>
                        </div>
                        <button class="btn btn-outline" onclick="refreshLoginCodes()" style="width: 100%; margin-top: 0.75rem;">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ‘¥ User Management</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-outline" onclick="exportUsersReport()">ðŸ“Š Export Report</button>
                    <button class="btn btn-sm btn-primary" onclick="openAddUserModal()">âž• Add User</button>
                </div>
            </div>
            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Login Code</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Password</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; opacity: 0.7;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Permissions Management -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ” Role Permissions</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Owner Role -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.15)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ¢</span><span>Owner</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… Everything + Business Management</li>
                            <li>âœ… Create/Delete Businesses</li>
                            <li>âœ… Merge Entities</li>
                            <li>âœ… Financial Reports</li>
                        </ul>
                    </div>
                    
                    <!-- Admin Role -->
                    <div style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), rgba(0, 212, 255, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(114, 9, 183, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ‘‘</span><span>Admin</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… Full system access</li>
                            <li>âœ… Manage users</li>
                            <li>âœ… System settings</li>
                            <li>âŒ Create businesses</li>
                        </ul>
                    </div>
                    
                    <!-- Accountant Role -->
                    <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 100, 0, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(6, 255, 165, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ’°</span><span>Accountant</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… All financial data</li>
                            <li>âœ… Reports & exports</li>
                            <li>âœ… Bank reconciliation</li>
                            <li>âŒ Delete records</li>
                        </ul>
                    </div>

                    <!-- Manager Role -->
                    <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(6, 255, 165, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ“Š</span><span>Manager</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… Invoices & customers</li>
                            <li>âœ… Products & pricing</li>
                            <li>âœ… AI features</li>
                            <li>âŒ User management</li>
                        </ul>
                    </div>
                    
                    <!-- Sales Rep Role -->
                    <div style="background: linear-gradient(135deg, rgba(255, 0, 110, 0.1), rgba(255, 100, 100, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 0, 110, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ›’</span><span>Sales Rep</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… Create invoices/quotes</li>
                            <li>âœ… View customers</li>
                            <li>âœ… View products</li>
                            <li>âŒ Edit pricing</li>
                        </ul>
                    </div>

                    <!-- Staff Role -->
                    <div style="background: linear-gradient(135deg, rgba(255, 190, 11, 0.1), rgba(255, 0, 110, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 190, 11, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ‘¤</span><span>Staff</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… Own invoices only</li>
                            <li>âœ… View customers</li>
                            <li>âœ… View products</li>
                            <li>âŒ Edit others' work</li>
                        </ul>
                    </div>
                    
                    <!-- Viewer Role -->
                    <div style="background: linear-gradient(135deg, rgba(128, 128, 128, 0.1), rgba(64, 64, 64, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(128, 128, 128, 0.3);">
                        <h3 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <span>ðŸ‘ï¸</span><span>View Only</span>
                        </h3>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li>âœ… View dashboards</li>
                            <li>âœ… View reports</li>
                            <li>âŒ Create anything</li>
                            <li>âŒ Edit anything</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- MASTER ADMIN - MULTI-TENANT COMPANY MANAGEMENT -->
        <!-- ============================================ -->
        <div class="card" id="masterAdminPanel" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 140, 0, 0.08)); border: 2px solid rgba(255, 215, 0, 0.4);">
            <div class="card-header">
                <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">ðŸ›ï¸</span>
                    Master Admin - Company Management
                    <span style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700;">MULTI-TENANT</span>
                </h2>
                <button class="btn btn-sm btn-primary" onclick="openCreateCompanyModal()" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; border: none;">
                    âž• Create Company
                </button>
            </div>
            
            <!-- Company Statistics -->
            <div style="padding: 1.5rem; padding-bottom: 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.05)); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="font-size: 2rem; font-weight: bold; color: #00d4ff;" id="statTotalCompanies">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Total Companies</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.2), rgba(6, 255, 165, 0.05)); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid rgba(6, 255, 165, 0.3);">
                        <div style="font-size: 2rem; font-weight: bold; color: #06ffa5;" id="statActiveCompanies">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Active</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255, 190, 11, 0.2), rgba(255, 190, 11, 0.05)); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 190, 11, 0.3);">
                        <div style="font-size: 2rem; font-weight: bold; color: #ffbe0b;" id="statTrialCompanies">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">On Trial</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255, 0, 110, 0.2), rgba(255, 0, 110, 0.05)); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 0, 110, 0.3);">
                        <div style="font-size: 2rem; font-weight: bold; color: #ff006e;" id="statSuspendedCompanies">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Suspended</div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                    <button class="btn btn-sm btn-outline" onclick="exportCompaniesReport()">ðŸ“Š Export Report</button>
                    <button class="btn btn-sm btn-outline" onclick="bulkImportCompanies()">ðŸ“ Bulk Import</button>
                    <button class="btn btn-sm btn-outline" onclick="refreshCompanyList()">ðŸ”„ Refresh</button>
                </div>
            </div>
            
            <!-- Company List Table -->
            <div class="table-container">
                <table id="companiesTable">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Tier</th>
                            <th>Admin</th>
                            <th>Invoices</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="companiesTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; opacity: 0.7; padding: 2rem;">
                                No companies created yet. Click "Create Company" to add your first client.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“Š System Statistics</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #7209b7, #560bad); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Users</div>
                        <div id="statTotalUsers" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00d4ff, #090979); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Admin Users</div>
                        <div id="statAdminUsers" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #06ffa5, #00d4ff); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Manager Users</div>
                        <div id="statManagerUsers" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffbe0b, #fb5607); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Regular Users</div>
                        <div id="statRegularUsers" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ff006e, #8338ec); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">OAuth Users</div>
                        <div id="statOAuthUsers" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3a86ff, #8338ec); padding: 1.5rem; border-radius: 12px; color: white;">
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Active Today</div>
                        <div id="statActiveToday" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“œ Activity Log</h2>
                <button class="btn btn-sm btn-outline" onclick="clearActivityLog()">ðŸ—‘ï¸ Clear Log</button>
            </div>
            <div id="activityLog" style="padding: 1.5rem; max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; opacity: 0.7;">No activity yet</p>
            </div>
        </div>
        
        <!-- Platform Branding (Master Admin Only) -->
        <div class="card" id="platformBrandingCard" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">ðŸŽ¨ Platform Branding (White-Label)</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.15), rgba(255, 0, 110, 0.1)); padding: 1rem; border-radius: 12px; border: 1px solid rgba(114, 9, 183, 0.3); margin-bottom: 1.5rem;">
                    <p style="font-size: 0.9rem; margin: 0;">
                        <strong>ðŸ‘‘ Master Admin Only:</strong> Customize the platform appearance for your organization. These settings affect the login page and global branding.
                    </p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Platform Name</label>
                        <input type="text" class="form-control" id="platformName" placeholder="ConiCore Invoicing" onchange="savePlatformBranding()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tagline</label>
                        <input type="text" class="form-control" id="platformTagline" placeholder="Professional Invoicing System" onchange="savePlatformBranding()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Platform Logo (Login Page)</label>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div id="platformLogoPreview" style="width: 100px; height: 100px; border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); cursor: pointer;" onclick="document.getElementById('platformLogoInput').click()">
                            <span style="font-size: 2.5rem;">ðŸ“Š</span>
                        </div>
                        <input type="file" id="platformLogoInput" accept="image/*" style="display: none;" onchange="previewPlatformLogo(this)">
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="document.getElementById('platformLogoInput').click()">ðŸ“· Upload Logo</button>
                            <button class="btn btn-outline btn-sm" onclick="clearPlatformLogo()">ðŸ—‘ï¸ Remove</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Primary Brand Color</label>
                        <input type="color" class="form-control" id="platformPrimaryColor" value="#00d4ff" style="height: 50px; cursor: pointer;" onchange="savePlatformBranding()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Secondary Color</label>
                        <input type="color" class="form-control" id="platformSecondaryColor" value="#ff006e" style="height: 50px; cursor: pointer;" onchange="savePlatformBranding()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Accent Color</label>
                        <input type="color" class="form-control" id="platformAccentColor" value="#7209b7" style="height: 50px; cursor: pointer;" onchange="savePlatformBranding()">
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="padding: 1rem; background: rgba(0, 212, 255, 0.1); border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <p style="margin: 0; display: flex; align-items: center; gap: 0.75rem; color: var(--primary);">
                            <span style="font-size: 1.2rem;">ðŸ”’</span>
                            <span><strong>"Powered by ConiCore"</strong> is always displayed to protect brand integrity.</span>
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="applyPlatformBranding()">âœ¨ Apply Branding</button>
                    <button class="btn btn-outline" onclick="resetPlatformBranding()">â†©ï¸ Reset to Default</button>
                </div>
            </div>
        </div>
        
        <!-- Invoice Template Library -->
        <div class="card" id="invoiceTemplatesCard">
            <div class="card-header">
                <h2 class="card-title">ðŸ“‘ Invoice Template Library</h2>
            </div>
            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; opacity: 0.8;">Choose a template style for your invoices. Each business can have its own template.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem;">
                    <!-- Modern Template -->
                    <div class="invoice-template-card" data-template="modern" onclick="selectInvoiceTemplate('modern')" style="border: 2px solid rgba(0,212,255,0.3); border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“˜</div>
                        <h4 style="color: var(--primary);">Modern</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Clean lines, bold headers</p>
                    </div>
                    
                    <!-- Classic Template -->
                    <div class="invoice-template-card" data-template="classic" onclick="selectInvoiceTemplate('classic')" style="border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“‹</div>
                        <h4>Classic</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Traditional business style</p>
                    </div>
                    
                    <!-- Minimal Template -->
                    <div class="invoice-template-card" data-template="minimal" onclick="selectInvoiceTemplate('minimal')" style="border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“„</div>
                        <h4>Minimal</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Simple and elegant</p>
                    </div>
                    
                    <!-- Corporate Template -->
                    <div class="invoice-template-card" data-template="corporate" onclick="selectInvoiceTemplate('corporate')" style="border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ¢</div>
                        <h4>Corporate</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Professional enterprise</p>
                    </div>
                    
                    <!-- Creative Template -->
                    <div class="invoice-template-card" data-template="creative" onclick="selectInvoiceTemplate('creative')" style="border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸŽ¨</div>
                        <h4>Creative</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Bold colors, unique layout</p>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <p style="font-size: 0.9rem; margin: 0;"><strong>Current Template:</strong> <span id="currentTemplateName">Modern</span></p>
                </div>
            </div>
        </div>
        
        <!-- AI Hub (Master Admin) -->
        <div class="card" id="aiHubCard">
            <div class="card-header">
                <h2 class="card-title">ðŸ¤– AI Configuration Hub</h2>
                <button class="btn btn-accent btn-sm" onclick="openAISetupWizard()" style="background: linear-gradient(135deg, #06ffa5, #00d4ff);">
                    ðŸ§™ Setup Wizard
                </button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.1)); padding: 1rem; border-radius: 12px; border: 1px solid rgba(6, 255, 165, 0.3); margin-bottom: 1.5rem;">
                    <p style="font-size: 0.9rem; margin: 0;">
                        <strong>ðŸ’¡ AI Powers:</strong> Document scanning, invoice analysis, smart recommendations, and chatbot assistant.
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">AI Provider</label>
                    <select class="form-control" id="aiProviderSelect" onchange="updateAIProviderSettings()">
                        <optgroup label="â˜ï¸ Cloud Providers">
                            <option value="together">Together AI (FREE - Recommended)</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="google">Google AI (Gemini)</option>
                        </optgroup>
                        <optgroup label="ðŸ–¥ï¸ Local AI (Free & Private)">
                            <option value="ollama">Ollama (Local)</option>
                            <option value="lmstudio">LM Studio (Local)</option>
                            <option value="gpt4all">GPT4All (Local)</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Cloud AI Settings -->
                <div id="cloudAISettings">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-control" id="aiApiKeyInput" placeholder="Enter your API key...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <select class="form-control" id="aiModelSelect">
                            <option value="auto">Auto (Best for provider)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Local AI Settings -->
                <div id="localAISettings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Local Server URL</label>
                        <input type="text" class="form-control" id="localAIUrl" placeholder="http://localhost:11434">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="localAIModel" placeholder="llama3.2, mistral, etc.">
                    </div>
                    <div style="background: rgba(255, 190, 11, 0.1); border: 1px solid rgba(255, 190, 11, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h5 style="color: #ffbe0b; margin-bottom: 0.5rem;">ðŸ“¥ Setup Local AI:</h5>
                        <ul style="font-size: 0.85rem; padding-left: 1.5rem; margin: 0;">
                            <li><strong>Ollama:</strong> <code>ollama serve</code> then <code>ollama pull llama3.2</code></li>
                            <li><strong>LM Studio:</strong> Start local server on port 1234</li>
                            <li><strong>GPT4All:</strong> Enable API server in settings</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="enableOfflineAI" checked>
                        <span>Enable Offline AI Cache (stores responses for offline use)</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveAIConfig()">ðŸ’¾ Save AI Config</button>
                    <button class="btn btn-outline" onclick="testAIConnection()">ðŸ”Œ Test Connection</button>
                    <button class="btn btn-outline" onclick="downloadAIConfig()">ðŸ“¥ Download Config</button>
                    <button class="btn btn-outline" onclick="document.getElementById('aiConfigUpload').click()">ðŸ“¤ Upload Config</button>
                    <input type="file" id="aiConfigUpload" accept=".json" style="display: none;" onchange="uploadAIConfig(this)">
                </div>
                
                <div id="aiTestResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>

        <!-- Enterprise API Key Management (Master Admin) -->
        <div class="card" id="enterpriseKeyMgmtCard" style="display: none; background: linear-gradient(135deg, rgba(114, 9, 183, 0.08), rgba(247, 37, 133, 0.08)); border: 2px solid rgba(114, 9, 183, 0.4);">
            <div class="card-header">
                <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">ðŸ”</span>
                    Enterprise API Key Management
                    <span style="background: linear-gradient(135deg, #7209b7, #f72585); color: #fff; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700;">MASTER ADMIN</span>
                </h2>
                <button class="btn btn-sm btn-primary" onclick="openAddApiKeyModal()" style="background: linear-gradient(135deg, #7209b7, #f72585); border: none;">
                    âž• Add API Key
                </button>
            </div>
            <div style="padding: 1.5rem;">
                <!-- Key Pool Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="font-size: 2rem; font-weight: 700; color: #00d4ff;" id="totalApiKeysCount">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Total Keys</div>
                    </div>
                    <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(6, 255, 165, 0.3);">
                        <div style="font-size: 2rem; font-weight: 700; color: #06ffa5;" id="activeApiKeysCount">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Active</div>
                    </div>
                    <div style="background: rgba(255, 190, 11, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 190, 11, 0.3);">
                        <div style="font-size: 2rem; font-weight: 700; color: #ffbe0b;" id="assignedClientsCount">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Clients Assigned</div>
                    </div>
                    <div style="background: rgba(114, 9, 183, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(114, 9, 183, 0.3);">
                        <div style="font-size: 2rem; font-weight: 700; color: #7209b7;" id="totalAiUsageCount">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Total Requests</div>
                    </div>
                </div>

                <!-- API Keys Table -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(114, 9, 183, 0.2);">
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem;">Provider</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem;">Key (Masked)</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem;">Tier</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem;">Usage</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem;">Status</th>
                                <th style="padding: 1rem; text-align: center; font-size: 0.85rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="apiKeyPoolTable">
                            <tr><td colspan="6" style="padding: 2rem; text-align: center; opacity: 0.6;">No API keys configured. Click "Add API Key" to get started.</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="importClientApiKey()">ðŸ“¥ Import Client Key</button>
                    <button class="btn btn-outline" onclick="rotateAllKeys()">ðŸ”„ Rotate All Keys</button>
                    <button class="btn btn-outline" onclick="exportKeyUsageReport()">ðŸ“Š Usage Report</button>
                    <button class="btn btn-outline" onclick="openLocalLLMGuide()">ðŸ  Local LLM Guide</button>
                </div>
            </div>
        </div>

        <!-- Local Hosting & Billing (Master Admin) -->
        <div class="card" id="localHostingCard" style="display: none; background: linear-gradient(135deg, rgba(6, 255, 165, 0.08), rgba(0, 212, 255, 0.08)); border: 2px solid rgba(6, 255, 165, 0.4);">
            <div class="card-header">
                <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">ðŸ </span>
                    Local Hosting & User Management
                    <span style="background: linear-gradient(135deg, #06ffa5, #00d4ff); color: #000; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700;">OFFLINE-READY</span>
                </h2>
            </div>
            <div style="padding: 1.5rem;">
                <!-- License & Users Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(6, 255, 165, 0.1); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(6, 255, 165, 0.3);">
                        <h4 style="margin: 0 0 0.5rem; color: #06ffa5;">ðŸ“‹ License Info</h4>
                        <p style="margin: 0; font-size: 0.85rem;"><strong>Type:</strong> <span id="licenseType">Enterprise</span></p>
                        <p style="margin: 0.25rem 0; font-size: 0.85rem;"><strong>Max Users:</strong> <span id="licenseMaxUsers">Unlimited</span></p>
                        <p style="margin: 0; font-size: 0.85rem;"><strong>Expires:</strong> <span id="licenseExpiry">Never</span></p>
                    </div>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h4 style="margin: 0 0 0.5rem; color: #00d4ff;">ðŸ‘¥ Active Users</h4>
                        <p style="margin: 0; font-size: 2rem; font-weight: 700;" id="localActiveUsers">0</p>
                        <p style="margin: 0.25rem 0 0; font-size: 0.8rem; opacity: 0.7;">of <span id="localMaxUsers">âˆž</span> allowed</p>
                    </div>
                    <div style="background: rgba(255, 190, 11, 0.1); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(255, 190, 11, 0.3);">
                        <h4 style="margin: 0 0 0.5rem; color: #ffbe0b;">ðŸ’¾ Storage Used</h4>
                        <p style="margin: 0; font-size: 2rem; font-weight: 700;" id="localStorageUsed">0 MB</p>
                        <p style="margin: 0.25rem 0 0; font-size: 0.8rem; opacity: 0.7;">of <span id="localStorageLimit">5 GB</span></p>
                    </div>
                </div>

                <!-- User Quotas -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem;">âš¡ User Quotas & Limits</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">AI Requests per User/Day</label>
                            <input type="number" class="form-control" id="quotaAiRequests" value="100" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Invoices per User/Month</label>
                            <input type="number" class="form-control" id="quotaInvoices" value="500" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Storage per User (MB)</label>
                            <input type="number" class="form-control" id="quotaStorage" value="500" min="0">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" style="margin-top: 1rem;" onclick="saveLocalQuotas()">ðŸ’¾ Save Quotas</button>
                </div>

                <!-- Usage Tracking -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden;">
                    <div style="padding: 1rem; background: rgba(6, 255, 165, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="margin: 0;">ðŸ“Š Usage Tracking (Last 30 Days)</h4>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(0,0,0,0.2);">
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem;">User</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem;">AI Requests</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem;">Invoices</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem;">Storage</th>
                                <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="localUsageTable">
                            <tr><td colspan="5" style="padding: 2rem; text-align: center; opacity: 0.6;">No usage data available</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Business Data Access Control (Owner Only) -->
        <div class="card" id="businessAccessCard">
            <div class="card-header">
                <h2 class="card-title">â˜ï¸ Business Data & Cloud Sync</h2>
            </div>
            <div style="padding: 1.5rem;">
                <div id="businessOwnerInfo" style="margin-bottom: 1.5rem;">
                    <!-- Populated by JS -->
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.1)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(0, 212, 255, 0.3); margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">ðŸ” Data Privacy</h4>
                    <ul style="list-style: none; padding: 0; font-size: 0.9rem; line-height: 1.8;">
                        <li>âœ… Business data syncs to <strong>owner's</strong> Google Drive only</li>
                        <li>âœ… Each business has separate, private folder</li>
                        <li>âœ… Only authorized users can view business data</li>
                        <li>âœ… Users cannot access other businesses' data</li>
                    </ul>
                </div>
                
                <h4 style="margin-bottom: 1rem;">ðŸ‘¥ Authorized Users</h4>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                    Only these users can view and work with this business's data:
                </p>
                <div id="authorizedUsersList" style="margin-bottom: 1rem;">
                    <!-- Populated by JS -->
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <input type="email" id="newAuthorizedEmail" class="form-control" placeholder="Enter email to authorize..." style="flex: 1; min-width: 200px;">
                    <button class="btn btn-primary btn-sm" onclick="addAuthorizedUser()">âž• Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Drive Setup Wizard Modal -->
    <div id="setupWizardModal" class="modal" role="dialog" aria-labelledby="wizardTitle" aria-modal="true">
        <div class="modal-content wizard-modal">
            <div class="wizard-header">
                <h2 id="wizardTitle">ðŸš€ Google Drive Setup Wizard</h2>
                <p style="opacity: 0.9; margin-top: 0.5rem;">Get unlimited cloud storage in just 5 minutes!</p>
            </div>

            <!-- Progress Tracker -->
            <div class="wizard-progress">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <div class="wizard-step-label">Welcome</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <div class="wizard-step-label">Create Project</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-number">3</div>
                    <div class="wizard-step-label">Enable API</div>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-number">4</div>
                    <div class="wizard-step-label">Get Credentials</div>
                </div>
                <div class="wizard-step" data-step="5">
                    <div class="wizard-step-number">5</div>
                    <div class="wizard-step-label">Connect</div>
                </div>
            </div>

            <!-- Wizard Content -->
            <div class="wizard-content">
                <!-- Step 1: Welcome -->
                <div class="wizard-step-content active" data-step="1">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Welcome to Google Drive Integration! ðŸŽ‰</h3>

                    <p style="margin-bottom: 1rem; line-height: 1.6;">
                        You're about to unlock <strong>unlimited cloud storage</strong> for your invoice system!
                    </p>

                    <div class="wizard-success">
                        <h4 style="margin-bottom: 0.75rem;">âœ¨ What You'll Get:</h4>
                        <ul style="text-align: left; margin-left: 2rem; line-height: 1.8;">
                            <li>â˜ï¸ <strong>15 GB free storage</strong> (3000x more than localStorage)</li>
                            <li>ðŸ“± <strong>Multi-device sync</strong> - Access from anywhere</li>
                            <li>ðŸ’¾ <strong>Automatic backups</strong> - Never lose data</li>
                            <li>ðŸ”’ <strong>Secure & private</strong> - Your data, your Google Drive</li>
                            <li>âš¡ <strong>Offline support</strong> - Works without internet</li>
                        </ul>
                    </div>

                    <div class="wizard-alert">
                        <strong>â±ï¸ Time Required:</strong> 5-10 minutes (one-time setup)<br>
                        <strong>ðŸ’° Cost:</strong> FREE (uses your free Google Drive storage)<br>
                        <strong>ðŸ”§ Technical Level:</strong> Easy - we'll guide you step-by-step
                    </div>

                    <p style="margin-top: 1rem; opacity: 0.8;">
                        Click <strong>Next</strong> to begin the setup process!
                    </p>
                </div>

                <!-- Step 2: Create Google Cloud Project -->
                <div class="wizard-step-content" data-step="2">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 1: Create Google Cloud Project</h3>

                    <div class="wizard-instruction">
                        <h4>ðŸ“ Instructions:</h4>
                        <ol>
                            <li>Click the button below to open Google Cloud Console</li>
                            <li>Sign in with your Google account</li>
                            <li>Click <strong>"Select a project"</strong> at the top</li>
                            <li>Click <strong>"New Project"</strong></li>
                            <li>Enter project name: <strong>"ConiCore Invoicing"</strong></li>
                            <li>Click <strong>"Create"</strong></li>
                            <li>Wait 30 seconds for project creation</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/projectcreate" target="_blank" class="wizard-link-btn">
                        ðŸŒ Open Google Cloud Console
                    </a>

                    <div class="wizard-copy-box">
                        <input type="text" value="ConiCore Invoicing" readonly id="projectNameCopy">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('projectNameCopy')">ðŸ“‹ Copy</button>
                    </div>

                    <div class="wizard-alert">
                        <strong>ðŸ’¡ Tip:</strong> Keep the Google Cloud Console tab open - you'll need it for the next steps!
                    </div>
                </div>

                <!-- Step 3: Enable Google Drive API -->
                <div class="wizard-step-content" data-step="3">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 2: Enable Google Drive API</h3>

                    <div class="wizard-instruction">
                        <h4>ðŸ“ Instructions:</h4>
                        <ol>
                            <li>Make sure your project "ConiCore Invoicing" is selected</li>
                            <li>Click the button below to go to the API Library</li>
                            <li>Search for: <strong>"Google Drive API"</strong></li>
                            <li>Click on <strong>"Google Drive API"</strong> in the results</li>
                            <li>Click the <strong>"Enable"</strong> button</li>
                            <li>Wait 10 seconds for activation</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/library" target="_blank" class="wizard-link-btn">
                        ðŸŒ Open API Library
                    </a>

                    <div class="wizard-copy-box">
                        <input type="text" value="Google Drive API" readonly id="apiNameCopy">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('apiNameCopy')">ðŸ“‹ Copy</button>
                    </div>

                    <div class="wizard-alert">
                        <strong>âœ… Success Check:</strong> You should see "API enabled" with a green checkmark!
                    </div>
                </div>

                <!-- Step 4: Get OAuth Credentials -->
                <div class="wizard-step-content" data-step="4">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 3: Get Your OAuth Credentials</h3>

                    <div class="wizard-instruction">
                        <h4>ðŸ“ Part A: Configure OAuth Consent Screen</h4>
                        <ol>
                            <li>Click the button below to open OAuth consent screen</li>
                            <li>Select <strong>"External"</strong> user type</li>
                            <li>Click <strong>"Create"</strong></li>
                            <li>Fill in:
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li><strong>App name:</strong> ConiCore Invoicing</li>
                                    <li><strong>User support email:</strong> Your email</li>
                                    <li><strong>Developer contact:</strong> Your email</li>
                                </ul>
                            </li>
                            <li>Click <strong>"Save and Continue"</strong> (3 times)</li>
                            <li>Click <strong>"Back to Dashboard"</strong></li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" class="wizard-link-btn">
                        ðŸŒ Open OAuth Consent Screen
                    </a>

                    <div class="wizard-instruction" style="margin-top: 1.5rem;">
                        <h4>ðŸ“ Part B: Create OAuth Client ID</h4>
                        <ol>
                            <li>Click the button below to create credentials</li>
                            <li>Click <strong>"Create Credentials"</strong> â†’ <strong>"OAuth client ID"</strong></li>
                            <li>Application type: <strong>"Web application"</strong></li>
                            <li>Name: <strong>"ConiCore Web Client"</strong></li>
                            <li>Under <strong>"Authorized JavaScript origins"</strong>, click <strong>"Add URI"</strong> and add:
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li><code>http://localhost</code></li>
                                    <li><code>http://localhost:8000</code></li>
                                    <li><code>file://</code></li>
                                </ul>
                            </li>
                            <li>Click <strong>"Create"</strong></li>
                            <li><strong>IMPORTANT:</strong> Copy your <strong>Client ID</strong> (looks like: 123456789-abc...xyz.apps.googleusercontent.com)</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="wizard-link-btn">
                        ðŸŒ Create Credentials
                    </a>

                    <div class="wizard-alert">
                        <strong>âš ï¸ Important:</strong> Keep your Client ID safe - you'll need it in the next step!
                    </div>
                </div>

                <!-- Step 5: Connect & Test -->
                <div class="wizard-step-content" data-step="5">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 4: Connect Your Invoice System</h3>

                    <p style="margin-bottom: 1rem;">
                        Almost done! Now paste your <strong>Client ID</strong> below to connect your invoice system to Google Drive.
                    </p>

                    <div class="wizard-validation" id="clientIdValidation">
                        <label class="form-label" style="margin-bottom: 0.5rem; display: block;">
                            <strong>Your OAuth Client ID:</strong>
                        </label>
                        <input
                            type="text"
                            id="clientIdInput"
                            placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
                            oninput="validateClientId(this.value)"
                        >
                        <div class="wizard-validation-msg success">
                            âœ… Valid Client ID format! Click "Test Connection" to verify.
                        </div>
                        <div class="wizard-validation-msg error">
                            âŒ Invalid format. Client ID should end with .apps.googleusercontent.com
                        </div>
                    </div>

                    <button class="btn btn-primary u-mt-1" onclick="testGoogleDriveConnection()" id="testConnectionBtn" disabled>
                        ðŸ”Œ Test Connection
                    </button>

                    <div id="connectionResult" class="u-mt-1 is-hidden"></div>

                    <div class="wizard-instruction" style="margin-top: 1.5rem;">
                        <h4>ðŸ“ What happens next:</h4>
                        <ol>
                            <li>Click <strong>"Test Connection"</strong></li>
                            <li>A Google sign-in popup will appear</li>
                            <li>Sign in with your Google account</li>
                            <li>Grant permission to access Google Drive</li>
                            <li>Your invoice system will connect to Google Drive!</li>
                        </ol>
                    </div>

                    <div class="wizard-alert">
                        <strong>ðŸ”’ Privacy:</strong> Your data goes directly from your browser to YOUR Google Drive. We never see or store your data!
                    </div>
                </div>
            </div>

            <!-- Wizard Footer -->
            <div class="wizard-footer">
                <button class="btn btn-outline" onclick="wizardPrevStep()" id="wizardPrevBtn" style="display: none;">
                    â† Previous
                </button>
                <button class="btn btn-outline" onclick="closeModal('setupWizardModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="wizardNextStep()" id="wizardNextBtn">
                    Next â†’
                </button>
                <button class="btn btn-success" onclick="finishWizard()" id="wizardFinishBtn" style="display: none;">
                    ðŸŽ‰ Finish Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Google Sync Setup (Minimal) -->
    <div id="quickGoogleSetupModal" class="modal" role="dialog" aria-labelledby="quickGoogleSetupTitle" aria-modal="true">
        <div class="modal-content wizard-modal">
            <div class="wizard-header">
                <h2 id="quickGoogleSetupTitle">ðŸ”— Connect Google Drive</h2>
                <p style="opacity: 0.9; margin-top: 0.5rem;">One-time setup: paste your Client ID, then sign in.</p>
            </div>

            <div class="wizard-content">
                <div class="wizard-instruction">
                    <h4>ðŸ“ What you need (one time)</h4>
                    <ol>
                        <li>Create an <strong>OAuth Client ID</strong> in Google Cloud (Web application)</li>
                        <li>Add this as an <strong>Authorized JavaScript origin</strong>:</li>
                    </ol>
                    <div class="wizard-copy-box">
                        <input type="text" readonly id="quickOriginCopy" value="">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('quickOriginCopy')">ðŸ“‹ Copy</button>
                    </div>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="wizard-link-btn">
                        ðŸŒ Open Google Credentials
                    </a>
                </div>

                <div class="wizard-validation" id="quickClientIdValidation" style="margin-top: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.5rem; display: block;">
                        <strong>Your OAuth Client ID:</strong>
                    </label>
                    <input
                        type="text"
                        id="quickClientIdInput"
                        placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
                        oninput="validateQuickClientId(this.value)"
                    >
                    <div class="wizard-validation-msg success">
                        âœ… Looks good. Click â€œConnect Googleâ€.
                    </div>
                    <div class="wizard-validation-msg error">
                        âŒ Invalid format. Client ID should end with .apps.googleusercontent.com
                    </div>
                </div>

                <button class="btn btn-primary u-mt-1" onclick="quickConnectGoogleDrive()" id="quickConnectBtn" disabled>
                    ðŸ”— Connect Google
                </button>

                <div id="quickConnectionResult" class="u-mt-1 is-hidden"></div>

                <div class="wizard-alert" style="margin-top: 1rem;">
                    <strong>After this:</strong> the header button becomes â€œSync Googleâ€ â†’ popup login â†’ done.
                </div>
            </div>

            <div class="wizard-footer">
                <button class="btn btn-outline" onclick="openSetupWizard()">Need help? Full wizard</button>
                <button class="btn btn-outline" onclick="closeModal('quickGoogleSetupModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Invoice Modal -->
    <div id="invoiceModal" class="modal" role="dialog" aria-labelledby="invoiceModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Create New Invoice</h2>
                <button class="close-modal" onclick="closeModal('invoiceModal')" aria-label="Close modal">Ã—</button>
            </div>
            
            <div class="modal-body">
            <!-- Business Selector for Invoice -->
            <div class="form-group" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.1)); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">ðŸ¢</span> Invoice From (Your Business)
                </label>
                <select class="form-control" id="invoiceFromBusiness" onchange="onInvoiceBusinessChanged()">
                    <!-- Populated dynamically -->
                </select>
                <div id="invoiceBusinessPreview" style="margin-top: 0.75rem; display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div id="invoiceBusinessLogo" style="width: 50px; height: 50px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">ðŸ¢</div>
                    <div>
                        <div id="invoiceBusinessName" style="font-weight: 600;">Select a business</div>
                        <div id="invoiceBusinessDetails" style="font-size: 0.85rem; opacity: 0.7;"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI Smart Suggestions Bar -->
            <div id="aiSuggestionsBar" style="display: none; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(6, 255, 165, 0.2)); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(0, 212, 255, 0.3);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">ðŸ¤–</span>
                    <strong>AI Suggestions</strong>
                </div>
                <div id="aiSuggestionsContent"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Customer *</label>
                    <div style="position: relative;">
                        <select class="form-control" id="invoiceCustomer" required onchange="onCustomerSelected()">
                            <option value="">Select Customer...</option>
                        </select>
                        <div id="customerSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(10, 14, 39, 0.98); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    </div>
                    <small id="customerInsight" style="display: none; color: rgba(6, 255, 165, 0.8); margin-top: 0.25rem;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Pricing Tier</label>
                    <select class="form-control" id="invoiceTier" onchange="onPricingTierChanged()">
                        <option value="retail">Retail (+35%)</option>
                        <option value="platinum">Platinum Dealer (-20%)</option>
                        <option value="gold">Gold Dealer (-15%)</option>
                        <option value="silver">Silver Dealer (-12%)</option>
                        <option value="rental">Rental Fleet (-25%)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <small id="tierSuggestion" style="display: none; color: rgba(255, 165, 0, 0.8); margin-top: 0.25rem;"></small>
                </div>
            </div>

            <!-- AI Quick Actions -->
            <div id="aiQuickActions" style="display: none; margin-bottom: 1rem;">
                <label class="form-label">âš¡ Quick Actions</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="repeatLastInvoice()" title="Copy items from last invoice to this customer">
                        ðŸ”„ Repeat Last Order
                    </button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addRecommendedProducts()" title="Add products this customer usually buys">
                        ðŸ’¡ Add Usual Items
                    </button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showCustomerHistory()" title="View customer's invoice history">
                        ðŸ“Š View History
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Document Type</label>
                    <select class="form-control" id="invoiceType">
                        <option value="invoice">Invoice</option>
                        <option value="quote">Quote</option>
                        <option value="proforma">Proforma Invoice</option>
                        <option value="credit_note">Credit Note</option>
                        <option value="purchase_order">Purchase Order</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">VAT Handling</label>
                    <select class="form-control" id="invoiceVAT">
                        <option value="include">Include VAT (15%)</option>
                        <option value="exclude">Exclude VAT</option>
                        <option value="none">No VAT</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="invoiceStatus">
                        <option value="draft">ðŸ“ Draft</option>
                        <option value="sent">ðŸ“¤ Sent</option>
                        <option value="partial">ðŸ’° Partially Paid</option>
                        <option value="paid">âœ… Paid</option>
                        <option value="overdue">âš ï¸ Overdue</option>
                        <option value="cancelled">âŒ Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Terms (Days)</label>
                    <select class="form-control" id="paymentTerms" onchange="updateDueDate()">
                        <option value="0">Due on Receipt</option>
                        <option value="7">Net 7 Days</option>
                        <option value="14">Net 14 Days</option>
                        <option value="30" selected>Net 30 Days</option>
                        <option value="60">Net 60 Days</option>
                        <option value="90">Net 90 Days</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Invoice Date</label>
                    <input type="date" class="form-control" id="invoiceDate" onchange="updateDueDate()">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="invoiceDueDate">
                </div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                    <label class="form-label" style="margin: 0;">Add Products</label>
                    <button type="button" class="btn btn-success btn-sm" onclick="openQuickAddProductModal()" title="Add a new product quickly">âž• Create Product</button>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('favorites')" title="Favorite Products">â­ Favorites</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('recent')" title="Recently Used">ðŸ• Recent</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('awake')" title="Awake Products">ðŸ„ Jetboards</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('aqua')" title="Aqua Marina">ðŸŒŠ Aqua Marina</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('digg')" title="DIGG">DIGG</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('all')" title="All Products">ðŸ“¦ All</button>
                </div>
                <div class="search-box">
                    <span class="search-icon">ðŸ”</span>
                    <input type="text" class="form-control" id="invoiceProductSearch" placeholder="Search products to add..." autocomplete="off" onfocus="showProductSearchResults()">
                </div>
                <div id="productSearchResults" class="product-search-results" style="display: none; max-height: 400px; overflow-y: auto;">
                    <!-- Product search results will appear here -->
                </div>
            </div>

            <!-- AI Product Recommendations -->
            <div id="aiProductRecommendations" style="display: none; background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(6, 255, 165, 0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.1rem;">ðŸ’¡</span>
                        <strong>Customers also bought:</strong>
                    </div>
                    <button type="button" onclick="document.getElementById('aiProductRecommendations').style.display='none'" style="background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.2rem;">Ã—</button>
                </div>
                <div id="recommendedProductsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            </div>

            <div class="invoice-items-table">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Cost</th>
                            <th>Unit Price</th>
                            <th>Markup</th>
                            <th>Total</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceItemsBody">
                        <tr>
                            <td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-row" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Discount</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" class="form-control" id="discountAmount" placeholder="0" onchange="calculateInvoiceTotal()">
                        <select class="form-control" id="discountType" style="max-width: 120px;" onchange="calculateInvoiceTotal()">
                            <option value="percentage">%</option>
                            <option value="fixed">Fixed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Shipping Cost</label>
                    <input type="number" class="form-control" id="shippingCost" placeholder="0" onchange="calculateInvoiceTotal()">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Deposit / Amount Paid</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="number" class="form-control" id="depositAmount" placeholder="0" onchange="calculateInvoiceTotal()">
                    <select class="form-control" id="depositType" style="max-width: 120px;" onchange="calculateInvoiceTotal()">
                        <option value="percentage">%</option>
                        <option value="fixed">Fixed</option>
                    </select>
                </div>
                <small style="color: rgba(255,255,255,0.6); margin-top: 0.25rem; display: block;">Enter percentage (e.g., 30 for 30%) or fixed amount</small>
            </div>

            <!-- Total Project Fees Reference Section (for DIGG/Professional Services) -->
            <div id="projectFeesSection" style="background: linear-gradient(135deg, rgba(255, 190, 11, 0.1), rgba(255, 107, 107, 0.1)); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid rgba(255, 190, 11, 0.3); display: none;">
                <h4 style="color: #ffbe0b; margin: 0 0 1rem 0; font-size: 1rem;">ðŸ“‹ Project Fee Reference (Optional)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" style="font-size: 0.85rem;">Total Project Fees (Excl. VAT)</label>
                        <input type="number" class="form-control" id="totalProjectFees" placeholder="e.g., 180000" onchange="updateProjectFeeReference()">
                        <small style="color: rgba(255,255,255,0.5);">Full project fee as per proposal/contract</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size: 0.85rem;">Previously Billed</label>
                        <input type="number" class="form-control" id="previouslyBilled" placeholder="0" onchange="updateProjectFeeReference()">
                        <small style="color: rgba(255,255,255,0.5);">Total from previous invoices</small>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 0.5rem;">
                    <div class="form-group">
                        <label class="form-label" style="font-size: 0.85rem;">This Invoice Amount</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" class="form-control" id="thisInvoiceAmount" placeholder="e.g., 30 or 54000" onchange="updateProjectFeeReference()">
                            <select class="form-control" id="thisInvoiceBillingType" style="max-width: 120px;" onchange="updateProjectFeeReference()">
                                <option value="percentage">% of Total</option>
                                <option value="fixed">Fixed R</option>
                            </select>
                        </div>
                        <small style="color: rgba(255,255,255,0.5);">Enter 30 for 30% or fixed amount</small>
                    </div>
                </div>
                <div id="projectFeesSummary" style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.9rem; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Total Project Fees:</span>
                        <span id="pfsTotal" style="font-weight: 600;">R 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #28a745;">
                        <span>Previously Billed:</span>
                        <span id="pfsPrevious">R 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #00d4ff;">
                        <span>This Invoice:</span>
                        <span id="pfsThisInvoice">R 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 0.5rem; font-weight: 700; color: #ffbe0b;">
                        <span>Remaining Balance:</span>
                        <span id="pfsRemaining">R 0</span>
                    </div>
                </div>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; cursor: pointer; font-size: 0.85rem;">
                    <input type="checkbox" id="showProjectFeesOnInvoice" onchange="updateProjectFeeReference()">
                    <span>Show project fee summary on printed invoice</span>
                </label>
            </div>

            <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 1.1rem;">
                    <div>
                        <strong>Subtotal:</strong>
                        <span id="invoiceSubtotal" style="float: right;">R 0.00</span>
                    </div>
                    <div>
                        <strong>VAT (15%):</strong>
                        <span id="invoiceVATAmount" style="float: right;">R 0.00</span>
                    </div>
                    <div style="grid-column: 1 / -1; font-size: 1.5rem; color: var(--success); font-weight: 700; border-top: 2px solid var(--primary); padding-top: 1rem;">
                        <strong>TOTAL:</strong>
                        <span id="invoiceTotal" style="float: right;">R 0.00</span>
                    </div>
                    <div id="paymentTrackingSection" style="grid-column: 1 / -1; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 1rem; display: none;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Amount Paid:</strong>
                            <span id="invoiceAmountPaid" style="float: right; color: var(--success);">R 0.00</span>
                        </div>
                        <div style="font-size: 1.3rem; color: var(--accent);">
                            <strong>Balance Due:</strong>
                            <span id="invoiceBalance" style="float: right;">R 0.00</span>
                        </div>
                    </div>

                    <!-- Profit Margin Section (INTERNAL USE ONLY - NOT PRINTED) -->
                    <div id="profitMarginSection" style="grid-column: 1 / -1; border-top: 2px solid rgba(6, 255, 165, 0.3); padding-top: 1rem; margin-top: 1rem; background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.1)); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="color: var(--success); margin: 0;">ðŸ’° Profit Analysis (Internal Only)</h4>
                            <span style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">ðŸ“Š Visible only to you</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Total Cost:</strong>
                            <span id="invoiceTotalCost" style="float: right; color: var(--warning);">R 0.00</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Total Revenue:</strong>
                            <span id="invoiceTotalRevenue" style="float: right; color: var(--primary);">R 0.00</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; font-size: 1.2rem;">
                            <strong>Gross Profit:</strong>
                            <span id="invoiceGrossProfit" style="float: right; color: var(--success);">R 0.00</span>
                        </div>
                        <div style="font-size: 1.3rem; font-weight: 700;">
                            <strong>Profit Margin:</strong>
                            <span id="invoiceProfitMargin" style="float: right; color: var(--success);">0%</span>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            ðŸ’¡ <strong>Tip:</strong> Adjust unit prices above to see profit margins update in real-time
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Recording Section -->
            <div id="paymentSection" style="background: rgba(255, 0, 110, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">ðŸ’° Record Payment</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Amount</label>
                        <input type="number" class="form-control" id="paymentAmount" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="paymentDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-control" id="paymentMethod">
                            <option value="eft">EFT/Bank Transfer</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="cheque">Cheque</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reference/Notes</label>
                        <input type="text" class="form-control" id="paymentReference" placeholder="Payment reference">
                    </div>
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="recordPayment()">ðŸ’µ Add Payment</button>

                <!-- Payment History -->
                <div id="paymentHistory" style="margin-top: 1rem; display: none;">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.7);">Payment History:</h4>
                    <div id="paymentHistoryList" style="font-size: 0.85rem;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
                <div>
                    <button type="button" class="btn btn-outline btn-sm" id="togglePaymentBtn" onclick="togglePaymentSection()" style="display: none;">ðŸ’° Record Payment</button>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invoiceModal')">Cancel</button>
                    <button type="button" class="btn btn-accent" onclick="sendViaWhatsApp()" id="whatsappBtn" style="display: none;">ðŸ“± WhatsApp</button>
                    <button type="button" class="btn btn-secondary" onclick="sendViaEmail()" id="emailBtn" style="display: none;">ðŸ“§ Email</button>
                    <button type="button" class="btn btn-success" onclick="saveInvoice()">ðŸ’¾ Save Invoice</button>
                    <button type="button" class="btn btn-primary" onclick="printInvoice()">ðŸ–¨ï¸ Print</button>
                    <button type="button" class="btn btn-primary" onclick="sendPaymentLink()" id="paymentLinkBtn" style="display: none; background: linear-gradient(135deg, #635BFF 0%, #4942D8 100%);">ðŸ’³ Send Payment Link</button>
                </div>
            </div>
            </div><!-- End modal-body -->
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal" role="dialog" aria-labelledby="invoicePreviewTitle" aria-modal="true">
        <div class="modal-content" style="width: min(1100px, 92vw); height: 88vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex: 0 0 auto;">
                <h2 class="modal-title" id="invoicePreviewTitle">Invoice Preview</h2>
                <button class="close-modal" onclick="closeModal('invoicePreviewModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 0 1.5rem 1rem 1.5rem; display: flex; gap: 0.75rem; align-items: center; justify-content: space-between; flex: 0 0 auto;">
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="printInvoiceFromPreview()">ðŸ–¨ï¸ Print</button>
                    <button type="button" class="btn btn-secondary" onclick="downloadInvoicePdfFromPreview()">â¬‡ï¸ Download PDF</button>
                    <button type="button" class="btn btn-accent" onclick="sendPaymentLinkFromPreview()" id="previewPaymentBtn" style="display: none; background: linear-gradient(135deg, #635BFF 0%, #4942D8 100%);">ðŸ’³ Send Payment Link</button>
                </div>
                <div>
                    <button type="button" class="btn btn-outline" onclick="closeModal('invoicePreviewModal')">Close</button>
                </div>
            </div>

            <div style="padding: 0 1.5rem 1.5rem 1.5rem; flex: 1 1 auto; min-height: 0;">
                <iframe id="invoicePreviewFrame" title="Invoice Preview" style="width: 100%; height: 100%; border: 1px solid rgba(0,212,255,0.25); border-radius: 10px; background: white;"></iframe>
            </div>
        </div>
    </div>

        <!-- Add Customer Modal -->
    <div id="customerModal" class="modal" role="dialog" aria-labelledby="customerModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="customerModalTitle">Add New Customer</h2>
                <button class="close-modal" onclick="closeModal('customerModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" class="form-control" id="customerCompany">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="customerPhone">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="customerAddress"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">VAT Number</label>
                        <input type="text" class="form-control" id="customerVAT">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Default Pricing Tier</label>
                        <select class="form-control" id="customerTier">
                            <option value="retail">Retail</option>
                            <option value="platinum">Platinum Dealer</option>
                            <option value="gold">Gold Dealer</option>
                            <option value="silver">Silver Dealer</option>
                            <option value="rental">Rental Fleet</option>
                        </select>
                    </div>
                </div>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; color: var(--primary);">ðŸ“‡ Additional Contacts</h3>
                <div id="extraContactsContainer"></div>
                <button type="button" class="btn btn-outline btn-sm" onclick="addExtraContactField()" style="margin-top: 0.5rem;">âž• Add Contact</button>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('customerModal')">Cancel</button>
                    <button class="btn btn-success" onclick="saveCustomer()">ðŸ’¾ Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Editor Modal -->
    <div id="whatsappMessageModal" class="modal" role="dialog" aria-labelledby="whatsappMessageTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="whatsappMessageTitle">ðŸ“± Edit WhatsApp Message</h2>
                <button class="close-modal" onclick="closeModal('whatsappMessageModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1rem; font-size: 0.9rem; opacity: 0.8;">Review and edit your message before sending to <span id="whatsappCustomerName" style="color: var(--primary); font-weight: 600;"></span></p>
                
                <div class="form-group">
                    <label class="form-label">Message Preview</label>
                    <textarea class="form-control" id="whatsappMessageEditor" rows="15" style="font-family: 'Segoe UI', sans-serif; line-height: 1.5;"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('whatsappMessageModal')">Cancel</button>
                    <button class="btn btn-success" onclick="confirmSendWhatsApp()">ðŸ“± Send WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Message Editor Modal -->
    <div id="emailMessageModal" class="modal" role="dialog" aria-labelledby="emailMessageTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="emailMessageTitle">ðŸ“§ Edit Email Message</h2>
                <button class="close-modal" onclick="closeModal('emailMessageModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1rem; font-size: 0.9rem; opacity: 0.8;">Review and edit your email before sending to <span id="emailCustomerName" style="color: var(--primary); font-weight: 600;"></span></p>
                
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-control" id="emailSubjectEditor">
                </div>
                <div class="form-group">
                    <label class="form-label">Message Body</label>
                    <textarea class="form-control" id="emailMessageEditor" rows="15" style="font-family: 'Segoe UI', sans-serif; line-height: 1.5;"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('emailMessageModal')">Cancel</button>
                    <button class="btn btn-success" onclick="confirmSendEmail()">ðŸ“§ Send Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Product Modal -->
    <div id="quickAddProductModal" class="modal" role="dialog" aria-labelledby="quickAddProductTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="quickAddProductTitle">âž• Quick Add Product</h2>
                <button class="close-modal" onclick="closeModal('quickAddProductModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="quickProductName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" id="quickProductSKU" placeholder="Auto-generated">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cost Price (R) *</label>
                        <input type="number" class="form-control" id="quickProductCost" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="quickProductCategory">
                            <option value="Custom">Custom</option>
                            <option value="Jetboards">Jetboards</option>
                            <option value="eFoils">eFoils</option>
                            <option value="Batteries">Batteries</option>
                            <option value="Accessories">Accessories</option>
                            <option value="SUP">Stand Up Paddle Boards</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="quickProductDescription" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('quickAddProductModal')">Cancel</button>
                    <button class="btn btn-success" onclick="saveQuickProduct()">ðŸ’¾ Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal" role="dialog" aria-labelledby="editProductTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="editProductTitle">âœï¸ Edit Product</h2>
                <button class="close-modal" onclick="closeModal('editProductModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <input type="hidden" id="editProductIndex">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="editProductName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" id="editProductBrand">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">SKU *</label>
                        <input type="text" class="form-control" id="editProductSKU" required readonly style="background: rgba(255,255,255,0.1);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="editProductCategory">
                            <option value="Jetboards">Jetboards</option>
                            <option value="eFoils">eFoils</option>
                            <option value="Batteries">Batteries</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Boards">Boards</option>
                            <option value="Bags">Bags</option>
                            <option value="SUP">Stand Up Paddle Boards</option>
                            <option value="Kayaks">Kayaks</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cost Price (Excl. VAT) *</label>
                        <input type="number" class="form-control" id="editProductCost" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Calculated VAT (15%)</label>
                        <input type="text" class="form-control" id="editProductVAT" readonly style="background: rgba(0, 255, 0, 0.1); color: var(--success);">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Total Price (Incl. VAT)</label>
                    <input type="text" class="form-control" id="editProductTotal" readonly style="background: rgba(0, 212, 255, 0.1); color: var(--accent); font-weight: 600;">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('editProductModal')">Cancel</button>
                    <button class="btn btn-success" onclick="saveEditedProduct()">ðŸ’¾ Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Receiving Modal -->
    <div id="stockReceivingModal" class="modal" role="dialog" aria-labelledby="stockReceivingTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="stockReceivingTitle">ðŸ“¦ Receive Stock</h2>
                <button class="close-modal" onclick="closeModal('stockReceivingModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <!-- Progress Steps -->
                <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                    <div id="receivingStep1" class="receiving-step active" style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; height: 30px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
                        <span>Upload</span>
                    </div>
                    <div style="width: 50px; height: 2px; background: rgba(255,255,255,0.2); margin: 0 0.5rem; align-self: center;"></div>
                    <div id="receivingStep2" class="receiving-step" style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.5;">
                        <span style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
                        <span>AI Process</span>
                    </div>
                    <div style="width: 50px; height: 2px; background: rgba(255,255,255,0.2); margin: 0 0.5rem; align-self: center;"></div>
                    <div id="receivingStep3" class="receiving-step" style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.5;">
                        <span style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</span>
                        <span>Review</span>
                    </div>
                    <div style="width: 50px; height: 2px; background: rgba(255,255,255,0.2); margin: 0 0.5rem; align-self: center;"></div>
                    <div id="receivingStep4" class="receiving-step" style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.5;">
                        <span style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</span>
                        <span>Confirm</span>
                    </div>
                </div>

                <!-- Step 1: Upload Documents -->
                <div id="receivingContent1">
                    <input type="hidden" id="receivingScanType" value="auto">
                    
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <h3 id="receivingTypeTitle" style="margin: 0;">ðŸ“· Upload or Scan Documents</h3>
                        <p style="opacity: 0.7; margin-top: 0.5rem;">AI will automatically detect document type and extract information</p>
                    </div>

                    <div id="uploadedDocsList" style="margin-bottom: 1.5rem;"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <label style="display: flex; flex-direction: column; align-items: center; padding: 2rem; background: rgba(0, 212, 255, 0.1); border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                            <span style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“·</span>
                            <span style="font-weight: 600;">Take Photo</span>
                            <span style="font-size: 0.85rem; opacity: 0.7;">Use phone camera</span>
                            <input type="file" accept="image/*" capture="environment" onchange="handleReceivingUpload(event)" style="display: none;">
                        </label>
                        <label style="display: flex; flex-direction: column; align-items: center; padding: 2rem; background: rgba(114, 9, 183, 0.1); border: 2px dashed rgba(114, 9, 183, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                            <span style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“</span>
                            <span style="font-weight: 600;">Upload File</span>
                            <span style="font-size: 0.85rem; opacity: 0.7;">PDF, Image, or Document</span>
                            <input type="file" accept="image/*,.pdf" onchange="handleReceivingUpload(event)" style="display: none;">
                        </label>
                    </div>

                    <div style="background: rgba(255, 190, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #ffbe0b;">
                        <strong>ðŸ’¡ Tip for imported goods:</strong>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            Upload multiple documents to calculate landed cost: Supplier Invoice â†’ Customs Declaration â†’ Shipping Invoice
                        </p>
                    </div>
                </div>

                <!-- Step 2: AI Processing -->
                <div id="receivingContent2" style="display: none;">
                    <div style="text-align: center; padding: 3rem;">
                        <div class="loading-spinner" style="width: 60px; height: 60px; border-width: 4px; margin: 0 auto 1.5rem;"></div>
                        <h3 style="margin: 0 0 0.5rem 0;">ðŸ¤– AI Processing Documents...</h3>
                        <p id="aiProcessingStatus" style="opacity: 0.7;">Analyzing document structure...</p>
                    </div>
                </div>

                <!-- Step 3: Review Extracted Data -->
                <div id="receivingContent3" style="display: none;">
                    <h3 style="margin: 0 0 1.5rem 0;">ðŸ“‹ Review Extracted Information</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Supplier</label>
                            <select class="form-control" id="receivingSupplier">
                                <option value="">Select or detected automatically</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="receivingInvoiceNumber" placeholder="Auto-detected">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="receivingInvoiceDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="receivingDueDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select class="form-control" id="receivingCurrency" onchange="updateReceivingTotals()">
                                <option value="ZAR">ZAR (South African Rand)</option>
                                <option value="USD">USD (US Dollar)</option>
                                <option value="EUR">EUR (Euro)</option>
                                <option value="GBP">GBP (British Pound)</option>
                                <option value="SEK">SEK (Swedish Krona)</option>
                                <option value="CNY">CNY (Chinese Yuan)</option>
                            </select>
                        </div>
                    </div>

                    <h4 style="margin: 1.5rem 0 1rem 0;">ðŸ“¦ Line Items</h4>
                    <div class="table-container">
                        <table id="receivingItemsTable">
                            <thead>
                                <tr>
                                    <th>Product / SKU</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Match</th>
                                </tr>
                            </thead>
                            <tbody id="receivingItemsBody">
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-outline btn-sm" onclick="addReceivingLineItem()">âž• Add Item</button>
                    </div>
                </div>

                <!-- Step 4: Landed Cost & Confirm -->
                <div id="receivingContent4" style="display: none;">
                    <h3 style="margin: 0 0 1.5rem 0;">ðŸ’° Landed Cost Calculation</h3>
                    
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <span>ðŸ“‹ Supplier Invoice Total:</span>
                                <strong id="landedSupplierTotal">R 0.00</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <span>ðŸ›ƒ Customs Duties (if applicable):</span>
                                <input type="number" class="form-control" id="landedCustomsDuties" value="0" onchange="calculateLandedCost()" style="width: 150px; text-align: right;">
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <span>ðŸ“¦ Import VAT:</span>
                                <input type="number" class="form-control" id="landedImportVAT" value="0" onchange="calculateLandedCost()" style="width: 150px; text-align: right;">
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <span>ðŸš¢ Shipping / Freight:</span>
                                <input type="number" class="form-control" id="landedShipping" value="0" onchange="calculateLandedCost()" style="width: 150px; text-align: right;">
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <span>ðŸ“„ Clearing Agent Fees:</span>
                                <input type="number" class="form-control" id="landedClearingFees" value="0" onchange="calculateLandedCost()" style="width: 150px; text-align: right;">
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 8px; font-size: 1.2rem;">
                                <span>ðŸ’° TOTAL LANDED COST:</span>
                                <strong id="landedTotalCost">R 0.00</strong>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success); margin-bottom: 1.5rem;">
                        <strong>âœ… What happens when you confirm:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; padding: 0; font-size: 0.9rem;">
                            <li>Product costs will be updated with new landed cost</li>
                            <li>Stock quantities will be increased</li>
                            <li>Payable record will be created (if unpaid)</li>
                            <li>Documents will be stored in your records</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="receivingMarkAsPaid">
                            <span>Mark as already paid</span>
                        </label>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-outline" onclick="closeModal('stockReceivingModal')">Cancel</button>
                    <button id="receivingBackBtn" class="btn btn-outline" onclick="receivingPreviousStep()" style="display: none;">â† Back</button>
                    <button id="receivingNextBtn" class="btn btn-primary" onclick="receivingNextStep()">Process with AI â†’</button>
                    <button id="receivingConfirmBtn" class="btn btn-success" onclick="confirmStockReceiving()" style="display: none;">âœ… Confirm & Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment / POP Upload Modal -->
    <div id="paymentPOPModal" class="modal" role="dialog" aria-labelledby="paymentPOPTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="paymentPOPTitle">ðŸ’³ Record Payment</h2>
                <button class="close-modal" onclick="closeModal('paymentPOPModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <input type="hidden" id="paymentPayableId">
                
                <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Supplier:</span>
                        <strong id="paymentSupplierName">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Invoice #:</span>
                        <strong id="paymentInvoiceNum">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Amount Due:</span>
                        <strong id="paymentAmountDue" style="color: var(--accent);">R 0.00</strong>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="selectPaymentMethod('manual')" id="payMethodManual" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">âœï¸</span>
                        <span>Manual Entry</span>
                    </button>
                    <button class="btn btn-outline" onclick="selectPaymentMethod('scan')" id="payMethodScan" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <span style="font-size: 2rem;">ðŸ“·</span>
                        <span>Scan/Upload POP</span>
                    </button>
                </div>

                <!-- Manual Payment Entry -->
                <div id="manualPaymentSection">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Payment Date</label>
                            <input type="date" class="form-control" id="paymentDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount Paid</label>
                            <input type="number" class="form-control" id="paymentAmount" step="0.01">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select class="form-control" id="paymentMethod">
                                <option value="eft">EFT / Bank Transfer</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="paypal">PayPal</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reference / Transaction ID</label>
                            <input type="text" class="form-control" id="popPaymentReference" placeholder="Bank reference or transaction ID">
                        </div>
                    </div>
                </div>

                <!-- POP Upload Section -->
                <div id="popUploadSection" style="display: none;">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <p style="opacity: 0.8;">Upload or scan your Proof of Payment (POP). AI will extract payment details automatically.</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; flex-direction: column; align-items: center; padding: 2rem; background: rgba(0, 212, 255, 0.1); border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 2.5rem; margin-bottom: 0.5rem;">ðŸ“·</span>
                            <span>Take Photo</span>
                            <input type="file" accept="image/*" capture="environment" onchange="handlePOPUpload(event)" style="display: none;">
                        </label>
                        <label style="display: flex; flex-direction: column; align-items: center; padding: 2rem; background: rgba(114, 9, 183, 0.1); border: 2px dashed rgba(114, 9, 183, 0.5); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 2.5rem; margin-bottom: 0.5rem;">ðŸ“</span>
                            <span>Upload File</span>
                            <input type="file" accept="image/*,.pdf" onchange="handlePOPUpload(event)" style="display: none;">
                        </label>
                    </div>

                    <div id="popPreview" style="display: none; margin-bottom: 1rem;">
                        <img id="popPreviewImage" style="max-width: 100%; border-radius: 8px; border: 2px solid var(--primary);">
                    </div>

                    <div id="popProcessingStatus" style="display: none; text-align: center; padding: 1rem;">
                        <div class="loading-spinner" style="margin: 0 auto 0.5rem;"></div>
                        <span>AI extracting payment details...</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Optional payment notes"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-outline" onclick="closeModal('paymentPOPModal')">Cancel</button>
                    <button class="btn btn-success" onclick="confirmPayment()">ðŸ’³ Record Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal" role="dialog" aria-labelledby="reportsModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="reportsModalTitle">ðŸ“Š Business Reports</h2>
                <button class="close-modal" onclick="closeModal('reportsModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(6, 255, 165, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="reportTotalInvoices">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Invoices</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.2), rgba(0, 212, 255, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="reportTotalRevenue">R 0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Revenue</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255, 0, 110, 0.2), rgba(0, 212, 255, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="reportOutstanding">R 0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Outstanding</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 110, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="reportOverdue">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Overdue Invoices</div>
                </div>
            </div>

            <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Status Breakdown</h3>
                <div id="statusBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;"></div>
            </div>

            <div style="background: rgba(6, 255, 165, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Top Customers</h3>
                <div id="topCustomers"></div>
            </div>

            <div style="background: rgba(255, 0, 110, 0.1); padding: 1.5rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem;">Monthly Revenue (Last 6 Months)</h3>
                <div id="monthlyRevenue"></div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('reportsModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportReportData()">ðŸ“¥ Export Report</button>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div id="supplierModal" class="modal" role="dialog" aria-labelledby="supplierModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="supplierModalTitle">Add New Supplier</h2>
                <button class="close-modal" onclick="closeModal('supplierModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Supplier Name *</label>
                    <input type="text" class="form-control" id="supplierName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Person</label>
                    <input type="text" class="form-control" id="supplierContact">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="supplierEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="supplierPhone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-control" id="supplierWebsite" placeholder="https://">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="supplierCategory">
                        <option value="jetboards">Jetboards & E-foils</option>
                        <option value="watersports">Water Sports Equipment</option>
                        <option value="accessories">Accessories</option>
                        <option value="parts">Parts & Components</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <textarea class="form-control" id="supplierAddress" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="supplierNotes" rows="2" placeholder="Additional information about this supplier..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Supplier Logo</label>
                <input type="file" class="form-control" id="supplierLogoUpload" accept="image/*" onchange="handleSupplierLogoUpload(event)">
                <img id="supplierLogoPreview" style="max-width: 200px; margin-top: 0.5rem; display: none;" alt="Supplier logo preview">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('supplierModal')">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveSupplier()">ðŸ’¾ Save Supplier</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="addUserModal" class="modal" role="dialog" aria-labelledby="addUserModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="addUserModalTitle">âž• Add New User</h2>
                <button class="close-modal" onclick="closeModal('addUserModal')" aria-label="Close modal">Ã—</button>
            </div>

            <form onsubmit="saveUser(event)">
                <div class="form-group">
                    <label class="form-label" for="userName">Full Name *</label>
                    <input type="text" class="form-control" id="userName" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userEmail">Email *</label>
                    <input type="email" class="form-control" id="userEmail" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userUsername">Username *</label>
                    <input type="text" class="form-control" id="userUsername" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userPassword">Password *</label>
                    <input type="password" class="form-control" id="userPassword" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userRole">Role *</label>
                    <select class="form-control" id="userRole" required onchange="updateRoleDescription()">
                        <option value="owner">ðŸ¢ Owner (Full Access)</option>
                        <option value="admin">ðŸ‘‘ Admin</option>
                        <option value="accountant">ðŸ’° Accountant</option>
                        <option value="manager">ðŸ“Š Manager</option>
                        <option value="sales">ðŸ›’ Sales Rep</option>
                        <option value="user">ðŸ‘¤ Staff</option>
                        <option value="viewer">ðŸ‘ï¸ View Only</option>
                    </select>
                    <div id="roleDescription" style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Business Access</label>
                    <div id="userBusinessAccess" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0.75rem;"></div>
                    <small style="color: rgba(255,255,255,0.5);">Select which businesses this user can access</small>
                </div>

                <input type="hidden" id="editUserId">

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">ðŸ’¾ Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal" role="dialog" aria-labelledby="confirmDeleteTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmDeleteTitle">âš ï¸ Confirm Delete</h2>
                <button class="close-modal" onclick="closeModal('confirmDeleteModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <p id="confirmDeleteMessage">Are you sure you want to delete this user?</p>
                <p style="color: #f72585; margin-top: 1rem;">âš ï¸ This action cannot be undone!</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding: 0 1.5rem 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('confirmDeleteModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()" style="background: linear-gradient(135deg, #f72585, #7209b7);">ðŸ—‘ï¸ Delete User</button>
            </div>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- CREATE COMPANY MODAL - 4 STEP WIZARD -->
    <!-- ============================================ -->
    <div id="createCompanyModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffd700, #ff8c00); margin: -1.5rem -1.5rem 1.5rem; padding: 1.25rem 1.5rem; border-radius: 12px 12px 0 0;">
                <h2 class="modal-title" style="color: #000; display: flex; align-items: center; gap: 0.5rem;">
                    ðŸ¢ Create New Company
                </h2>
                <button class="close-modal" onclick="closeModal('createCompanyModal')" style="color: #000;">Ã—</button>
            </div>
            
            <!-- Progress Steps -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative;">
                <div style="position: absolute; top: 20px; left: 10%; right: 10%; height: 3px; background: #333; z-index: 0;"></div>
                <div id="companyWizardProgress" style="position: absolute; top: 20px; left: 10%; height: 3px; background: linear-gradient(90deg, #ffd700, #ff8c00); z-index: 1; width: 0%; transition: width 0.3s;"></div>
                
                <div class="wizard-step" data-step="1" style="display: flex; flex-direction: column; align-items: center; z-index: 2; flex: 1;">
                    <div class="step-circle active" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem;">1</div>
                    <span style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Company</span>
                </div>
                <div class="wizard-step" data-step="2" style="display: flex; flex-direction: column; align-items: center; z-index: 2; flex: 1;">
                    <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem;">2</div>
                    <span style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Branding</span>
                </div>
                <div class="wizard-step" data-step="3" style="display: flex; flex-direction: column; align-items: center; z-index: 2; flex: 1;">
                    <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem;">3</div>
                    <span style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Settings</span>
                </div>
                <div class="wizard-step" data-step="4" style="display: flex; flex-direction: column; align-items: center; z-index: 2; flex: 1;">
                    <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem;">4</div>
                    <span style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Credentials</span>
                </div>
            </div>
            
            <!-- Step 1: Company Information -->
            <div id="companyStep1" class="company-wizard-step">
                <h3 style="margin-bottom: 1.25rem; color: #ffd700; display: flex; align-items: center; gap: 0.5rem;">ðŸ“ Company Information</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Company Name *</label>
                        <input type="text" id="newCoName" class="form-control" placeholder="e.g., ABC Trading (Pty) Ltd" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trading As</label>
                        <input type="text" id="newCoTradingAs" class="form-control" placeholder="e.g., ABC Store">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Number</label>
                        <input type="text" id="newCoRegNo" class="form-control" placeholder="e.g., 2024/123456/07">
                    </div>
                    <div class="form-group">
                        <label class="form-label">VAT Number</label>
                        <input type="text" id="newCoVatNo" class="form-control" placeholder="e.g., 4123456789">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Address</label>
                        <textarea id="newCoAddress" class="form-control" rows="2" placeholder="Full business address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone *</label>
                        <input type="tel" id="newCoPhone" class="form-control" placeholder="+27 XX XXX XXXX" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">WhatsApp Number</label>
                        <input type="tel" id="newCoWhatsApp" class="form-control" placeholder="+27 XX XXX XXXX (for auto-send)">
                        <small style="opacity: 0.6; font-size: 0.75rem;">Leave blank to use phone number</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="newCoEmail" class="form-control" placeholder="admin@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" id="newCoWebsite" class="form-control" placeholder="https://www.company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="newCoIndustry" class="form-control">
                            <option value="retail">ðŸ›’ Retail</option>
                            <option value="wholesale">ðŸ“¦ Wholesale</option>
                            <option value="services">ðŸ’¼ Professional Services</option>
                            <option value="manufacturing">ðŸ­ Manufacturing</option>
                            <option value="construction">ðŸ—ï¸ Construction</option>
                            <option value="hospitality">ðŸ½ï¸ Hospitality</option>
                            <option value="healthcare">ðŸ¥ Healthcare</option>
                            <option value="technology">ðŸ’» Technology</option>
                            <option value="transport">ðŸšš Transport & Logistics</option>
                            <option value="other">ðŸ“‹ Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Branding -->
            <div id="companyStep2" class="company-wizard-step" style="display: none;">
                <h3 style="margin-bottom: 1.25rem; color: #ffd700; display: flex; align-items: center; gap: 0.5rem;">ðŸŽ¨ Branding & Logo</h3>
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <!-- Logo Upload -->
                    <div style="flex: 0 0 auto;">
                        <label class="form-label">Company Logo</label>
                        <div id="newCoLogoPreview" onclick="document.getElementById('newCoLogoInput').click()" style="width: 150px; height: 150px; border: 2px dashed rgba(255, 215, 0, 0.5); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.2); transition: all 0.3s;">
                            <div style="text-align: center; opacity: 0.7;">
                                <div style="font-size: 2.5rem;">ðŸ“·</div>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem;">Click to upload</div>
                            </div>
                        </div>
                        <input type="file" id="newCoLogoInput" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="previewCompanyLogo(this)">
                        <p style="font-size: 0.7rem; opacity: 0.6; margin-top: 0.5rem;">PNG/JPG, max 2MB</p>
                    </div>
                    
                    <!-- Colors -->
                    <div style="flex: 1; min-width: 250px;">
                        <label class="form-label">Brand Colors</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="font-size: 0.75rem; opacity: 0.7;">Primary</label>
                                <input type="color" id="newCoPrimaryColor" value="#00d4ff" style="width: 100%; height: 45px; border: none; border-radius: 8px; cursor: pointer;">
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; opacity: 0.7;">Secondary</label>
                                <input type="color" id="newCoSecondaryColor" value="#7209b7" style="width: 100%; height: 45px; border: none; border-radius: 8px; cursor: pointer;">
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; opacity: 0.7;">Accent</label>
                                <input type="color" id="newCoAccentColor" value="#06ffa5" style="width: 100%; height: 45px; border: none; border-radius: 8px; cursor: pointer;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tagline / Slogan</label>
                            <input type="text" id="newCoTagline" class="form-control" placeholder="e.g., Quality you can trust">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Invoice Template</label>
                            <select id="newCoTemplate" class="form-control">
                                <option value="modern">ðŸ“„ Modern - Clean & Professional</option>
                                <option value="classic">ðŸ“œ Classic - Traditional Layout</option>
                                <option value="minimal">âœ¨ Minimal - Simple & Elegant</option>
                                <option value="corporate">ðŸ¢ Corporate - Business Formal</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Settings & Tier -->
            <div id="companyStep3" class="company-wizard-step" style="display: none;">
                <h3 style="margin-bottom: 1.25rem; color: #ffd700; display: flex; align-items: center; gap: 0.5rem;">âš™ï¸ Account Settings</h3>
                
                <!-- Subscription Tier -->
                <label class="form-label">Subscription Tier</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <label style="cursor: pointer;">
                        <input type="radio" name="newCoTier" value="trial" checked style="display: none;">
                        <div class="tier-card" style="padding: 1.25rem; border: 2px solid rgba(255, 190, 11, 0.5); border-radius: 12px; background: rgba(255, 190, 11, 0.1); transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">ðŸŽ</span>
                                <span style="background: #ffbe0b; color: #000; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">14 DAYS</span>
                            </div>
                            <div style="font-weight: 600;">Trial</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">10 invoices, 5 customers</div>
                        </div>
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="newCoTier" value="starter" style="display: none;">
                        <div class="tier-card" style="padding: 1.25rem; border: 2px solid rgba(0, 212, 255, 0.5); border-radius: 12px; background: rgba(0, 212, 255, 0.1); transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">ðŸš€</span>
                                <span style="background: #00d4ff; color: #000; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">MONTHLY</span>
                            </div>
                            <div style="font-weight: 600;">Starter</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">50 invoices, AI features</div>
                        </div>
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="newCoTier" value="business" style="display: none;">
                        <div class="tier-card" style="padding: 1.25rem; border: 2px solid rgba(6, 255, 165, 0.5); border-radius: 12px; background: rgba(6, 255, 165, 0.1); transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">ðŸ’¼</span>
                                <span style="background: #06ffa5; color: #000; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">POPULAR</span>
                            </div>
                            <div style="font-weight: 600;">Business</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Unlimited, multi-user</div>
                        </div>
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="newCoTier" value="enterprise" style="display: none;">
                        <div class="tier-card" style="padding: 1.25rem; border: 2px solid rgba(114, 9, 183, 0.5); border-radius: 12px; background: rgba(114, 9, 183, 0.1); transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">ðŸ†</span>
                                <span style="background: #7209b7; color: #fff; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">ANNUAL</span>
                            </div>
                            <div style="font-weight: 600;">Enterprise</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">White-label, priority</div>
                        </div>
                    </label>
                </div>
                
                <!-- Default Settings -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select id="newCoCurrency" class="form-control">
                            <option value="ZAR">ðŸ‡¿ðŸ‡¦ ZAR - South African Rand</option>
                            <option value="USD">ðŸ‡ºðŸ‡¸ USD - US Dollar</option>
                            <option value="EUR">ðŸ‡ªðŸ‡º EUR - Euro</option>
                            <option value="GBP">ðŸ‡¬ðŸ‡§ GBP - British Pound</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <input type="number" id="newCoTaxRate" class="form-control" value="15" min="0" max="50" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Invoice Prefix</label>
                        <input type="text" id="newCoInvoicePrefix" class="form-control" value="INV-" placeholder="INV-">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Terms (days)</label>
                        <input type="number" id="newCoPaymentTerms" class="form-control" value="30" min="0" max="180">
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Credentials & Summary -->
            <div id="companyStep4" class="company-wizard-step" style="display: none;">
                <h3 style="margin-bottom: 1.25rem; color: #ffd700; display: flex; align-items: center; gap: 0.5rem;">ðŸ” Login Credentials</h3>
                
                <!-- Generated Credentials Display -->
                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.15), rgba(0, 212, 255, 0.15)); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(6, 255, 165, 0.4); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.25rem;">COMPANY URL</div>
                            <div id="generatedCompanyUrl" style="font-family: monospace; color: #00d4ff; font-size: 0.85rem; word-break: break-all;"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.25rem;">LOGIN CODE</div>
                            <div id="generatedLoginCode" style="font-size: 1.5rem; font-weight: bold; font-family: monospace; color: #ffd700; letter-spacing: 2px;"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.25rem;">TEMP PASSWORD</div>
                            <div id="generatedTempPassword" style="font-size: 1.1rem; font-weight: bold; font-family: monospace; color: #06ffa5;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- WhatsApp Message Preview -->
                <div style="background: rgba(37, 211, 102, 0.1); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(37, 211, 102, 0.4); margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">ðŸ’¬</span>
                            <span style="font-weight: 600;">WhatsApp Message</span>
                        </div>
                        <button class="btn btn-sm" onclick="copyWhatsAppMessage()" style="background: #25d366; color: #fff; border: none;">
                            ðŸ“‹ Copy Message
                        </button>
                    </div>
                    <pre id="whatsappMessagePreview" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; margin: 0;"></pre>
                </div>
                
                <!-- Auto-Send WhatsApp Toggle -->
                <div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.2), rgba(37, 211, 102, 0.1)); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid rgba(37, 211, 102, 0.3);">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="autoSendWhatsApp" checked style="width: 20px; height: 20px; accent-color: #25d366;">
                        <div>
                            <div style="font-weight: 600; color: #25d366;">ðŸš€ Auto-Send WhatsApp</div>
                            <small style="opacity: 0.7;">Automatically send credentials when company is created</small>
                        </div>
                    </label>
                    <div id="whatsAppApiStatus" style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.8rem;">
                        <span id="apiStatusIcon">â³</span> <span id="apiStatusText">Checking WhatsApp API...</span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <button class="btn btn-sm" onclick="sendWhatsAppNow()" style="background: #25d366; color: #fff; border: none; padding: 0.75rem;">
                        ðŸš€ Send WhatsApp Now
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="openWhatsAppWithMessage()" style="padding: 0.75rem;">
                        ðŸ“± Open WhatsApp App
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="copyWhatsAppForGroup()" style="padding: 0.75rem;">
                        ðŸ‘¥ Copy for Group
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="copyCompanyUrl()" style="padding: 0.75rem;">
                        ðŸ”— Copy URL
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="emailCredentials()" style="padding: 0.75rem;">
                        âœ‰ï¸ Send Email
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="downloadCredentialsPDF()" style="padding: 0.75rem;">
                        ðŸ“„ Download PDF
                    </button>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <button id="companyWizardPrev" class="btn btn-outline" onclick="companyWizardPrev()" style="display: none;">
                    â† Previous
                </button>
                <div style="flex: 1;"></div>
                <button id="companyWizardNext" class="btn btn-primary" onclick="companyWizardNext()" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; border: none;">
                    Next Step â†’
                </button>
                <button id="companyWizardCreate" class="btn btn-primary" onclick="createCompanyFinal()" style="display: none; background: linear-gradient(135deg, #06ffa5, #00d4ff); color: #000; border: none;">
                    âœ“ Create Company
                </button>
            </div>
        </div>
    </div>
    
    <!-- AI Smart Scanner Modal - Fully Automated -->
    <div id="quickScanModal" class="modal" role="dialog" aria-labelledby="quickScanTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title" id="quickScanTitle">ðŸ¤– AI Smart Scanner</h2>
                <button class="close-modal" onclick="closeModal('quickScanModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <!-- Main Scan Interface - Show type selection -->
                <div id="quickScanMain">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">ðŸ“·</div>
                        <h3 style="margin-bottom: 0.5rem;">What are you scanning?</h3>
                        <p style="opacity: 0.8; font-size: 0.95rem;">
                            Select document type for faster processing
                        </p>
                    </div>
                    
                    <!-- Document Type Selection Grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <button class="btn btn-outline" onclick="selectScanType('customer')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(6, 255, 165, 0.3);">
                            <span style="font-size: 2rem;">ðŸ‘¤</span>
                            <strong>Business Card</strong>
                        </button>
                        <button class="btn btn-outline" onclick="selectScanType('invoice')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(0, 212, 255, 0.3);">
                            <span style="font-size: 2rem;">ðŸ§¾</span>
                            <strong>Invoice</strong>
                        </button>
                        <button class="btn btn-outline" onclick="selectScanType('pricelist')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(255, 190, 11, 0.3);">
                            <span style="font-size: 2rem;">ðŸ’°</span>
                            <strong>Price List</strong>
                        </button>
                        <button class="btn btn-outline" onclick="selectScanType('receipt')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(251, 86, 7, 0.3);">
                            <span style="font-size: 2rem;">ðŸ›’</span>
                            <strong>Receipt</strong>
                        </button>
                        <button class="btn btn-outline" onclick="selectScanType('delivery')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(131, 56, 236, 0.3);">
                            <span style="font-size: 2rem;">ðŸšš</span>
                            <strong>Delivery Note</strong>
                        </button>
                        <button class="btn btn-outline" onclick="selectScanType('pop')" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem; border-color: rgba(255, 0, 110, 0.3);">
                            <span style="font-size: 2rem;">ðŸ’³</span>
                            <strong>Proof of Payment</strong>
                        </button>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button class="btn btn-outline btn-sm" onclick="selectScanType('auto')" style="opacity: 0.8;">
                            ðŸ¤– Auto-Detect (AI will figure it out)
                        </button>
                    </div>
                </div>
                
                <!-- Camera Selection (after type is chosen) -->
                <div id="quickScanCamera" style="display: none;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;" id="scanTypeIcon">ðŸ“·</div>
                        <h3 id="scanTypeLabel">Scanning Document</h3>
                        <p style="opacity: 0.7; font-size: 0.85rem;">AI will extract all data automatically</p>
                    </div>
                    
                    <!-- Separate inputs for camera vs gallery with MULTIPLE support -->
                    <input type="file" id="quickScanCameraInput" accept="image/*" capture="camera" multiple style="display: none;" onchange="handleMultipleScans(event)">
                    <input type="file" id="quickScanGalleryInput" accept="image/*" multiple style="display: none;" onchange="handleMultipleScans(event)">
                    
                    <button class="btn btn-success" onclick="openCamera()" style="width: 100%; padding: 1.5rem; font-size: 1.2rem;">
                        ðŸ“· Take Photo(s)
                    </button>
                    
                    <button class="btn btn-primary" onclick="document.getElementById('quickScanGalleryInput').click()" style="width: 100%; padding: 1.2rem; margin-top: 0.75rem; font-size: 1.1rem;">
                        ðŸ“ Choose Multiple from Gallery
                    </button>
                    
                    <p style="text-align: center; font-size: 0.85rem; opacity: 0.7; margin-top: 1rem;">
                        ðŸ’¡ You can select multiple documents at once!<br>
                        AI will process each one automatically.
                    </p>
                    
                    <button class="btn btn-outline btn-sm" onclick="showScanTypeSelection()" style="width: 100%; margin-top: 1rem;">
                        â† Back to Type Selection
                    </button>
                </div>
                
                <!-- Processing State -->
                <div id="quickScanProgress" style="display: none; text-align: center;">
                    <div id="scanProgressIcon" style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 1.5s infinite;">ðŸ”</div>
                    <h3 id="quickScanProgressTitle">AI Analyzing...</h3>
                    <p id="quickScanProgressText" style="margin-top: 0.5rem; opacity: 0.8;">Detecting document type</p>
                    
                    <div style="width: 100%; background: rgba(255,255,255,0.1); border-radius: 20px; height: 12px; margin: 1.5rem 0; overflow: hidden;">
                        <div id="quickScanProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #06ffa5, #00d4ff, #7209b7); transition: width 0.3s; background-size: 200% 100%; animation: gradientMove 2s linear infinite;"></div>
                    </div>
                    
                    <!-- Live Processing Steps -->
                    <div id="processingSteps" style="text-align: left; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                        <div id="step1" style="opacity: 0.4; margin-bottom: 0.5rem;">â³ Reading image...</div>
                        <div id="step2" style="opacity: 0.4; margin-bottom: 0.5rem;">â³ Detecting document type...</div>
                        <div id="step3" style="opacity: 0.4; margin-bottom: 0.5rem;">â³ Extracting text & data...</div>
                        <div id="step4" style="opacity: 0.4;">â³ Preparing to save...</div>
                    </div>
                </div>
                
                <!-- Results - Quick confirm before auto-navigation -->
                <div id="quickScanResults" style="display: none;">
                    <div id="quickScanResultsContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
    </style>

    <!-- Bank Import Modal -->
    <div id="bankImportModal" class="modal" role="dialog" aria-labelledby="bankImportTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="bankImportTitle">ðŸ¦ Import Bank Statement</h2>
                <button class="close-modal" onclick="closeModal('bankImportModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                    <p style="margin: 0; font-weight: 500;">ðŸ“ Supported Formats:</p>
                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                        <li>CSV files from your bank</li>
                        <li>PDF bank statements (AI will extract transactions)</li>
                        <li>Excel/XLSX files</li>
                    </ul>
                </div>

                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <input type="file" id="bankStatementFile" accept=".csv,.pdf,.xlsx,.xls" style="display: none;" onchange="processBankStatement(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('bankStatementFile').click()" style="padding: 2rem; font-size: 1.2rem; width: 100%;">
                        ðŸ“‚ Choose Bank Statement File
                    </button>
                </div>

                <div id="bankImportProgress" style="display: none;">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                        <p id="bankImportStatus" style="margin-top: 1rem;">Processing...</p>
                    </div>
                </div>

                <div id="bankImportResults" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Preview Transactions</h3>
                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto; margin-bottom: 1rem;">
                        <table id="bankPreviewTable" style="width: 100%; font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Match</th>
                                </tr>
                            </thead>
                            <tbody id="bankPreviewBody"></tbody>
                        </table>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="closeModal('bankImportModal')">Cancel</button>
                        <button class="btn btn-success" onclick="saveBankTransactions()">ðŸ’¾ Import Transactions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Transactions Modal -->
    <div id="bankTransactionsModal" class="modal" role="dialog" aria-labelledby="bankTransTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title" id="bankTransTitle">ðŸ¦ Bank Transactions</h2>
                <button class="close-modal" onclick="closeModal('bankTransactionsModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <select id="transactionFilter" class="form-control" style="width: 200px;" onchange="filterBankTransactions()">
                        <option value="all">All Transactions</option>
                        <option value="matched">Matched</option>
                        <option value="unmatched">Unmatched</option>
                    </select>
                    <button class="btn btn-sm btn-outline" onclick="autoMatchTransactions()">ðŸ¤– Auto-Match</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Matched Invoice</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bankTransactionsBody">
                            <tr>
                                <td colspan="5" style="text-align: center; opacity: 0.7;">No transactions imported yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- View Document Modal -->
    <div id="viewDocumentModal" class="modal" role="dialog" aria-labelledby="viewDocTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="viewDocTitle">ðŸ“„ Document Details</h2>
                <button class="close-modal" onclick="closeModal('viewDocumentModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <img id="viewDocImage" style="width: 100%; border-radius: 8px;">
                    </div>
                    <div>
                        <div id="viewDocInfo" style="margin-bottom: 1.5rem;"></div>
                        <div id="viewDocText" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                    <button class="btn btn-outline" onclick="downloadDocument(currentViewDoc)">ðŸ’¾ Download</button>
                    <button class="btn btn-danger" onclick="deleteDocument(currentViewDoc)">ðŸ—‘ï¸ Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR Scanner Modal -->
    <div id="scannerModal" class="modal" role="dialog" aria-labelledby="scannerModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" id="scannerModalTitle">ðŸ“· Scan Document</h2>
                <button class="close-modal" onclick="closeModal('scannerModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div id="scannerContent">
                <div style="text-align: center; padding: 2rem;">
                    <p style="margin-bottom: 1rem;">Choose how to scan your document:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="startCamera()" style="padding: 2rem;">
                            ðŸ“¸ Use Camera<br>
                            <small style="opacity: 0.7;">Take a photo with your device camera</small>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('scanFileUpload').click()" style="padding: 2rem;">
                            ðŸ“ Upload File<br>
                            <small style="opacity: 0.7;">Select an image from your device</small>
                        </button>
                    </div>
                    <input type="file" id="scanFileUpload" accept="image/*" style="display: none;" onchange="handleScanFileUpload(event)">
                </div>

                <!-- Camera View -->
                <div id="cameraView" style="display: none;">
                    <video id="cameraPreview" autoplay playsinline style="width: 100%; border-radius: 8px;"></video>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="btn btn-success" onclick="capturePhoto()">ðŸ“¸ Capture</button>
                        <button type="button" class="btn btn-outline" onclick="stopCamera()">Cancel</button>
                    </div>
                </div>

                <!-- Captured Image -->
                <div id="capturedImageView" style="display: none;">
                    <canvas id="capturedCanvas" style="width: 100%; border-radius: 8px;"></canvas>
                    <div id="ocrProgress" style="margin-top: 1rem; text-align: center; display: none;">
                        <div style="padding: 1rem; background: rgba(0, 212, 255, 0.2); border-radius: 8px;">
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">ðŸ” Processing...</div>
                            <div id="ocrStatus">Initializing OCR...</div>
                            <div style="margin-top: 0.5rem;">
                                <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="ocrProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="processOCR()" id="processBtn">ðŸ” Extract Text</button>
                        <button type="button" class="btn btn-outline" onclick="resetScanner()">Try Again</button>
                    </div>
                </div>

                <!-- OCR Results -->
                <div id="ocrResults" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Extracted Data:</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <pre id="ocrText" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;"></pre>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="resetScanner()">Scan Another</button>
                        <button type="button" class="btn btn-success" onclick="analyzeSupplierInvoice()">ðŸ¤– Analyze Invoice</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Business Modal -->
    <div id="businessModal" class="modal" role="dialog" aria-labelledby="businessModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="businessModalTitle">âž• Add New Business</h2>
                <button class="close-modal" onclick="closeModal('businessModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <!-- Business Logo Upload -->
                <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                    <label class="form-label">Business Logo</label>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <div id="businessLogoPreview" style="width: 120px; height: 120px; border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); cursor: pointer;" onclick="document.getElementById('businessLogoInput').click()">
                            <span style="font-size: 3rem; opacity: 0.5;">ðŸ¢</span>
                        </div>
                        <input type="file" id="businessLogoInput" accept="image/*" style="display: none;" onchange="previewBusinessLogo(this)">
                        <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('businessLogoInput').click()">ðŸ“· Upload Logo</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Business Name *</label>
                    <input type="text" class="form-control" id="businessName" placeholder="e.g., Your Company Name">
                </div>

                <div class="form-group">
                    <label class="form-label">Trading As (Optional)</label>
                    <input type="text" class="form-control" id="businessTradingAs" placeholder="e.g., Your Trading Name">
                </div>

                <div class="form-group">
                    <label class="form-label">Business Type</label>
                    <select class="form-control" id="businessType">
                        <option value="retail">Retail</option>
                        <option value="wholesale">Wholesale</option>
                        <option value="service">Service</option>
                        <option value="rental">Rental</option>
                        <option value="trading">Trading Company</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Registration Number</label>
                    <input type="text" class="form-control" id="businessRegNumber" placeholder="e.g., 2021/123456/07">
                </div>

                <div class="form-group">
                    <label class="form-label">VAT Number</label>
                    <input type="text" class="form-control" id="businessVatNumber" placeholder="e.g., 4123456789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="businessEmail" placeholder="e.g., info@company.co.za">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="businessPhone" placeholder="e.g., +27 21 555 0123">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="businessAddress" rows="3" placeholder="Enter business address..."></textarea>
                </div>
                
                <!-- Linked Businesses Section -->
                <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <label class="form-label">ðŸ”— Link to Parent Company (Optional)</label>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Link this as a "Trading As" or subsidiary of another business to combine financial reports.</p>
                    <select class="form-control" id="businessParentId">
                        <option value="">-- Independent Business (No Link) --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="businessShareProducts">
                        <span>Share product catalog with linked businesses</span>
                    </label>
                    <p style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem; margin-left: 1.5rem;">When enabled, all linked businesses can access the same product catalog.</p>
                </div>

                <!-- Upgrade Trading As to Registered Entity -->
                <div id="upgradeTradeSection" style="margin-top: 1.5rem; padding: 1rem; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <span style="font-size: 1.2rem;">ðŸ“‹</span>
                        <h4 style="margin: 0; color: var(--primary);">Upgrade Trading As to Registered Entity</h4>
                    </div>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                        This business is currently registered as a "Trading As" under a parent company. When it becomes an independent registered entity, you can upgrade it here. This will remove the parent link while keeping all invoices, customers, and data intact.
                    </p>
                    <div class="form-group">
                        <label class="form-label">New Registration Number (for upgraded entity)</label>
                        <input type="text" class="form-control" id="businessUpgradeRegNumber" placeholder="e.g., 2024/123456/07">
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="confirmUpgradeTradingAs()">ðŸ“‹ Upgrade to Independent Entity</button>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn btn-outline" onclick="closeModal('businessModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveNewBusiness()">ðŸ’¾ Save Business</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Switch Business Modal -->
    <div id="switchBusinessModal" class="modal" role="dialog" aria-labelledby="switchBusinessModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="switchBusinessModalTitle">ðŸ”„ Switch Business</h2>
                <button class="close-modal" onclick="closeModal('switchBusinessModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; color: rgba(255,255,255,0.7);">
                    Select which business you want to work with. Each business has its own settings, products, and invoices.
                </p>
                <div id="businessSwitchList" style="display: grid; gap: 1rem;"></div>
                
                <!-- Merge Companies Section -->
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">ðŸ”— Merge Companies</h4>
                    <p style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;">Combine invoices, customers, and data from multiple businesses into one.</p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="openMergeBusinessModal()">ðŸ”— Merge Businesses</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="cleanupDuplicateBusinesses()" title="Remove duplicate businesses with the same name">ðŸ§¹ Remove Duplicates</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Merge Businesses Modal -->
    <div id="mergeBusinessModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ðŸ”— Merge Businesses</h2>
                <button class="close-modal" onclick="closeModal('mergeBusinessModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <strong>âš ï¸ Warning:</strong> This will combine all invoices, customers, and suppliers from the source business into the target. The source business will remain but its data will be duplicated.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Source Business (data to move FROM)</label>
                    <select class="form-control" id="mergeSourceBusiness"></select>
                </div>
                
                <div style="text-align: center; padding: 1rem; font-size: 1.5rem;">âž¡ï¸</div>
                
                <div class="form-group">
                    <label class="form-label">Target Business (data to move TO)</label>
                    <select class="form-control" id="mergeTargetBusiness"></select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="deleteSourceAfterMerge">
                        <span>Delete source business after merge</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('mergeBusinessModal')">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="executeBusinessMerge()">ðŸ”— Merge Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="termsModal" class="modal" role="dialog" aria-labelledby="termsModalTitle" aria-modal="true" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-dark), var(--secondary));">
                <h2 class="modal-title" id="termsModalTitle">ðŸ“‹ Terms & Conditions</h2>
            </div>
            
            <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Welcome to ConiCore Invoicing</h3>
                    <p style="margin-bottom: 1rem; line-height: 1.6;">Before you begin using the system, please read and accept the following terms:</p>
                    
                    <div style="font-size: 0.95rem; line-height: 1.8; color: rgba(255,255,255,0.85);">
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">1. Data Responsibility</h4>
                        <p>You are responsible for the accuracy and integrity of all data you enter into the system. This includes invoices, customer information, products, and financial records.</p>
                        
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">2. Confidentiality</h4>
                        <p>You agree to keep all business information confidential and not share login credentials or sensitive data with unauthorized persons.</p>
                        
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">3. Authorized Use</h4>
                        <p>You will only use the system for legitimate business purposes authorized by the business owner/administrator.</p>
                        
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">4. Account Security</h4>
                        <p>You are responsible for maintaining the security of your account. Report any unauthorized access immediately to the administrator.</p>
                        
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">5. Compliance</h4>
                        <p>You agree to comply with all applicable laws and regulations regarding financial record-keeping and data protection.</p>
                        
                        <h4 style="color: var(--secondary); margin: 1rem 0 0.5rem;">6. User Conduct</h4>
                        <p>You agree to use the system responsibly and not engage in any activities that could harm the system, other users, or the business.</p>
                    </div>
                </div>
                
                <div style="background: rgba(6, 255, 165, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="termsAcceptCheckbox" style="margin-top: 0.25rem; width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-size: 0.95rem; line-height: 1.5;">
                            I have read and agree to the Terms & Conditions. I understand my responsibilities as a user of this system and agree to abide by these terms.
                        </span>
                    </label>
                </div>
            </div>
            
            <div style="padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" class="btn btn-outline" onclick="declineTerms()">Decline & Logout</button>
                <button type="button" class="btn btn-success" id="acceptTermsBtn" onclick="acceptTerms()" disabled>
                    âœ… Accept & Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Supplier Invoice Analysis Modal -->
    <div id="invoiceAnalysisModal" class="modal" role="dialog" aria-labelledby="analysisModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="analysisModalTitle">ðŸ¤– AI Invoice Analysis</h2>
                <button class="close-modal" onclick="closeModal('invoiceAnalysisModal')" aria-label="Close modal">Ã—</button>
            </div>

            <div style="padding: 1.5rem;">
                <!-- Supplier Recognition -->
                <div id="supplierRecognitionSection" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">ðŸ“¦ Supplier Recognition</h3>
                    <div id="supplierRecognitionResult" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                        <div style="text-align: center; color: rgba(255,255,255,0.5);">Analyzing...</div>
                    </div>
                </div>

                <!-- Product Analysis -->
                <div id="productAnalysisSection" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">ðŸ“Š Product & Price Analysis</h3>
                    <div id="productAnalysisResult" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                        <div style="text-align: center; color: rgba(255,255,255,0.5);">Analyzing...</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invoiceAnalysisModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="applyPriceUpdates()" id="applyUpdatesBtn" style="display: none;">âœ… Apply Updates</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Setup Wizard Modal -->
    <div id="aiSetupWizardModal" class="modal" role="dialog" aria-labelledby="aiWizardTitle" aria-modal="true" style="display: none;">
        <div class="modal-content" style="max-width: 700px; background: linear-gradient(180deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.05), var(--card-bg)); border: 2px solid rgba(0, 212, 255, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(6, 255, 165, 0.15)); border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                <h3 id="aiWizardTitle" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">ðŸ¤–</span> AI Setup Wizard
                </h3>
                <button class="modal-close" onclick="closeModal('aiSetupWizardModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Wizard Progress -->
                <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                    <div id="wizardStep1" class="wizard-step active" style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; height: 30px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
                        <span style="font-size: 0.85rem;">Choose Mode</span>
                    </div>
                    <div style="width: 50px; height: 2px; background: rgba(255,255,255,0.2); align-self: center; margin: 0 0.5rem;"></div>
                    <div id="wizardStep2" class="wizard-step" style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.5;">
                        <span style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">2</span>
                        <span style="font-size: 0.85rem;">Configure</span>
                    </div>
                    <div style="width: 50px; height: 2px; background: rgba(255,255,255,0.2); align-self: center; margin: 0 0.5rem;"></div>
                    <div id="wizardStep3" class="wizard-step" style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.5;">
                        <span style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">3</span>
                        <span style="font-size: 0.85rem;">Test</span>
                    </div>
                </div>

                <!-- Step 1: Choose Mode -->
                <div id="wizardPage1" class="wizard-page">
                    <h4 style="margin-bottom: 1.5rem; text-align: center;">How would you like to use AI?</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div onclick="selectAIMode('free')" class="ai-mode-card" style="padding: 1.5rem; border: 2px solid rgba(6, 255, 165, 0.5); border-radius: 12px; cursor: pointer; background: rgba(6, 255, 165, 0.1); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 2.5rem;">ðŸ†“</span>
                                <div>
                                    <h5 style="margin: 0; color: #06ffa5;">FREE Cloud AI (Recommended)</h5>
                                    <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8;">Together AI with Llama 3.2 - No API key needed, works instantly!</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="selectAIMode('local')" class="ai-mode-card" style="padding: 1.5rem; border: 2px solid rgba(114, 9, 183, 0.5); border-radius: 12px; cursor: pointer; background: rgba(114, 9, 183, 0.1); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 2.5rem;">ðŸ </span>
                                <div>
                                    <h5 style="margin: 0; color: #7209b7;">Local AI (Maximum Privacy)</h5>
                                    <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8;">Run Ollama on your PC - All data stays local, no internet needed</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="selectAIMode('premium')" class="ai-mode-card" style="padding: 1.5rem; border: 2px solid rgba(255, 190, 11, 0.5); border-radius: 12px; cursor: pointer; background: rgba(255, 190, 11, 0.1); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 2.5rem;">âš¡</span>
                                <div>
                                    <h5 style="margin: 0; color: #ffbe0b;">Premium Cloud AI (Your API Key)</h5>
                                    <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8;">Claude, GPT-4, or Gemini - Best quality with your own account</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Configure (dynamically populated) -->
                <div id="wizardPage2" class="wizard-page" style="display: none;">
                    <div id="wizardConfigContent"></div>
                </div>

                <!-- Step 3: Test -->
                <div id="wizardPage3" class="wizard-page" style="display: none;">
                    <div style="text-align: center; padding: 2rem;">
                        <div id="wizardTestIcon" style="font-size: 4rem; margin-bottom: 1rem;">ðŸ”Œ</div>
                        <h4 id="wizardTestTitle">Testing Connection...</h4>
                        <p id="wizardTestMessage" style="opacity: 0.8; margin-bottom: 1.5rem;">Please wait while we verify your AI setup</p>
                        <div id="wizardTestResult" style="padding: 1rem; border-radius: 8px; display: none;"></div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button id="wizardBackBtn" class="btn btn-outline" onclick="wizardBack()" style="display: none;">â† Back</button>
                    <div></div>
                    <button id="wizardNextBtn" class="btn btn-primary" onclick="wizardNext()" style="display: none;">Next â†’</button>
                    <button id="wizardFinishBtn" class="btn btn-success" onclick="wizardFinish()" style="display: none;">âœ… Finish Setup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ENTERPRISE API KEY MANAGEMENT MODAL -->
    <!-- ============================================ -->
    <div id="addApiKeyModal" class="modal" role="dialog" aria-modal="true" style="display: none;">
        <div class="modal-content" style="max-width: 600px; background: linear-gradient(180deg, rgba(114, 9, 183, 0.1), rgba(247, 37, 133, 0.05), var(--card-bg)); border: 2px solid rgba(114, 9, 183, 0.4);">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.3), rgba(247, 37, 133, 0.2)); border-bottom: 1px solid rgba(114, 9, 183, 0.3);">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">ðŸ”</span> Add API Key to Pool
                </h3>
                <button class="modal-close" onclick="closeModal('addApiKeyModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: rgba(255, 190, 11, 0.1); border: 1px solid rgba(255, 190, 11, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-size: 0.85rem;">
                        <strong>ðŸ”’ Security:</strong> API keys are encrypted using AES-256 and stored locally. Keys are never transmitted to external servers.
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">AI Provider *</label>
                    <select class="form-control" id="newKeyProvider" onchange="updateKeyProviderInfo()">
                        <option value="">Select Provider...</option>
                        <optgroup label="ðŸ‡¨ðŸ‡³ GLM Series (ZhipuAI) - Recommended">
                            <option value="glm-api">GLM-4.6 API (Z.ai Platform)</option>
                            <option value="glm-local">GLM-4.5-Air (Self-Hosted)</option>
                            <option value="glm-v">GLM-4.6V Vision (Multimodal)</option>
                        </optgroup>
                        <optgroup label="â˜ï¸ Cloud Providers">
                            <option value="together">Together AI (FREE Tier Available)</option>
                            <option value="openai">OpenAI (GPT-4, GPT-4o)</option>
                            <option value="anthropic">Anthropic (Claude 3.5)</option>
                            <option value="google">Google AI (Gemini Pro)</option>
                            <option value="groq">Groq (Ultra Fast)</option>
                            <option value="mistral">Mistral AI</option>
                        </optgroup>
                        <optgroup label="ðŸ  Local LLM">
                            <option value="ollama">Ollama (Local)</option>
                            <option value="lmstudio">LM Studio (Local)</option>
                            <option value="glm-sglang">GLM via SGLang (Local)</option>
                            <option value="glm-vllm">GLM via vLLM (Local)</option>
                        </optgroup>
                    </select>
                </div>

                <div id="keyProviderInfo" style="display: none; background: rgba(0, 212, 255, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <!-- Populated dynamically -->
                </div>

                <div class="form-group" id="apiKeyInputGroup">
                    <label class="form-label">API Key *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="password" class="form-control" id="newApiKeyValue" placeholder="sk-... or your API key">
                        <button type="button" class="btn btn-outline btn-sm" onclick="toggleKeyVisibility('newApiKeyValue')" style="white-space: nowrap;">ðŸ‘ï¸</button>
                    </div>
                </div>

                <div class="form-group" id="localUrlGroup" style="display: none;">
                    <label class="form-label">Local Server URL</label>
                    <input type="text" class="form-control" id="newLocalUrl" placeholder="http://localhost:11434">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Key Nickname</label>
                        <input type="text" class="form-control" id="newKeyNickname" placeholder="e.g., Production Key 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tier/Priority</label>
                        <select class="form-control" id="newKeyTier">
                            <option value="primary">ðŸ¥‡ Primary (Default)</option>
                            <option value="secondary">ðŸ¥ˆ Secondary (Fallback)</option>
                            <option value="backup">ðŸ¥‰ Backup (Emergency)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Monthly Budget Limit (USD)</label>
                    <input type="number" class="form-control" id="newKeyBudget" placeholder="0 = unlimited" min="0" step="10">
                    <small style="opacity: 0.6; font-size: 0.75rem;">Set a spending limit for this key. 0 means unlimited.</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Assign to Companies (Optional)</label>
                    <div id="keyCompanyAssignment" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(6, 255, 165, 0.1);">
                            <input type="checkbox" id="keyAssignAll" checked>
                            <span>ðŸŒ All Companies (Shared Pool)</span>
                        </label>
                        <!-- Company list populated dynamically -->
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-outline" onclick="closeModal('addApiKeyModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveApiKeyToPool()" style="background: linear-gradient(135deg, #7209b7, #f72585);">ðŸ” Add Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Local LLM Guide Modal -->
    <div id="localLLMGuideModal" class="modal" role="dialog" aria-modal="true" style="display: none;">
        <div class="modal-content" style="max-width: 700px; background: linear-gradient(180deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.05), var(--card-bg)); border: 2px solid rgba(6, 255, 165, 0.4);">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.3), rgba(0, 212, 255, 0.2)); border-bottom: 1px solid rgba(6, 255, 165, 0.3);">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">ðŸ </span> Local LLM Setup Guide
                </h3>
                <button class="modal-close" onclick="closeModal('localLLMGuideModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: rgba(6, 255, 165, 0.1); border: 1px solid rgba(6, 255, 165, 0.3); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem; color: #06ffa5;">ðŸ’¡ Why Local LLM?</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
                        <li><strong>100% Privacy:</strong> All data stays on your machine</li>
                        <li><strong>No API Costs:</strong> Free after initial setup</li>
                        <li><strong>Offline Ready:</strong> Works without internet</li>
                        <li><strong>No Rate Limits:</strong> Unlimited requests</li>
                    </ul>
                </div>

                <!-- Ollama Section -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">ðŸ¦™</span> Ollama (Recommended)
                    </h4>
                    <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 2;">
                        <li>Download from <a href="https://ollama.ai" target="_blank" style="color: #00d4ff;">ollama.ai</a></li>
                        <li>Install and run: <code style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 4px;">ollama serve</code></li>
                        <li>Pull a model: <code style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 4px;">ollama pull llama3.2</code></li>
                        <li>Configure URL: <code style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 4px;">http://localhost:11434</code></li>
                    </ol>
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255, 190, 11, 0.1); border-radius: 8px;">
                        <strong>Recommended Models:</strong>
                        <ul style="margin: 0.5rem 0 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li><code>llama3.2</code> - Best balance of speed & quality</li>
                            <li><code>mistral</code> - Fast and efficient</li>
                            <li><code>codellama</code> - Great for technical tasks</li>
                        </ul>
                    </div>
                </div>

                <!-- LM Studio Section -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">ðŸŽ›ï¸</span> LM Studio
                    </h4>
                    <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 2;">
                        <li>Download from <a href="https://lmstudio.ai" target="_blank" style="color: #00d4ff;">lmstudio.ai</a></li>
                        <li>Download a model from the built-in browser</li>
                        <li>Start the local server (Settings â†’ Local Server)</li>
                        <li>Configure URL: <code style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 4px;">http://localhost:1234</code></li>
                    </ol>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-outline" onclick="closeModal('localLLMGuideModal')">Close</button>
                    <button class="btn btn-primary" onclick="closeModal('localLLMGuideModal'); openAddApiKeyModal();" style="background: linear-gradient(135deg, #06ffa5, #00d4ff); color: #000;">âž• Add Local LLM</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice AI Assistant Modal -->
    <div id="voiceAIModal" class="modal" role="dialog" aria-labelledby="voiceAITitle" aria-modal="true" style="display: none;">
        <div class="modal-content" style="max-width: 600px; background: linear-gradient(180deg, rgba(114, 9, 183, 0.15), rgba(0, 212, 255, 0.1), var(--card-bg)); border: 1px solid rgba(114, 9, 183, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(114, 9, 183, 0.3), rgba(0, 212, 255, 0.2)); border-bottom: 1px solid rgba(114, 9, 183, 0.3);">
                <h3 id="voiceAITitle" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">ðŸŽ™ï¸</span> Voice AI Assistant
                    <span id="voiceAIStatus" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 12px; background: rgba(0, 212, 255, 0.2); color: #00d4ff;">Ready</span>
                </h3>
                <button class="modal-close" onclick="closeModal('voiceAIModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Voice Visualizer -->
                <div id="voiceVisualizer" style="height: 80px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
                    <div id="voiceWaveform" style="display: flex; align-items: center; gap: 3px; height: 100%;">
                        <!-- Waveform bars will be added dynamically -->
                    </div>
                    <div id="voiceIdleIcon" style="position: absolute; font-size: 2rem; opacity: 0.5;">ðŸŽ¤</div>
                </div>

                <!-- Transcript Display -->
                <div id="voiceTranscript" style="min-height: 60px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-size: 1.1rem; line-height: 1.5; border: 1px solid rgba(255,255,255,0.1);">
                    <span style="opacity: 0.5; font-style: italic;">Say something like "Create invoice for Beach Bums" or "What's my revenue this month?"</span>
                </div>

                <!-- AI Response -->
                <div id="voiceAIResponse" style="min-height: 40px; background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), rgba(0, 212, 255, 0.1)); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 3px solid #7209b7; display: none;">
                    <div style="font-size: 0.75rem; color: #7209b7; margin-bottom: 0.25rem;">ðŸ¤– AI Response</div>
                    <div id="voiceAIResponseText"></div>
                </div>

                <!-- Quick Commands -->
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.5rem;">ðŸ’¡ Quick Commands:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn btn-outline btn-sm" onclick="voiceAI.executeCommand('show overdue invoices')" style="font-size: 0.8rem;">ðŸ“‹ Overdue Invoices</button>
                        <button class="btn btn-outline btn-sm" onclick="voiceAI.executeCommand('what is my revenue this month')" style="font-size: 0.8rem;">ðŸ’° Revenue</button>
                        <button class="btn btn-outline btn-sm" onclick="voiceAI.executeCommand('show top customers')" style="font-size: 0.8rem;">ðŸ‘¥ Top Customers</button>
                        <button class="btn btn-outline btn-sm" onclick="voiceAI.executeCommand('create new invoice')" style="font-size: 0.8rem;">âž• New Invoice</button>
                    </div>
                </div>

                <!-- Main Controls -->
                <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                    <button id="voiceMicBtn" onclick="voiceAI.toggleListening()" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #7209b7, #00d4ff); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: all 0.3s; box-shadow: 0 4px 20px rgba(114, 9, 183, 0.4);">
                        ðŸŽ¤
                    </button>
                </div>
                <p id="voiceMicLabel" style="text-align: center; opacity: 0.7; font-size: 0.9rem;">Click to start listening</p>

                <!-- Settings Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="voiceAutoSpeak" checked style="cursor: pointer;">
                        <label for="voiceAutoSpeak" style="font-size: 0.85rem; cursor: pointer;">ðŸ”Š Auto-speak responses</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="font-size: 0.85rem;">Speed:</label>
                        <input type="range" id="voiceSpeechRate" min="0.5" max="2" step="0.1" value="1" style="width: 80px;">
                    </div>
                </div>

                <!-- Cloud AI Settings (Collapsible) -->
                <details style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <summary style="cursor: pointer; font-size: 0.9rem; color: #7209b7; font-weight: 600;">ðŸŒ Cloud AI Settings (Optional - Enhanced Accuracy)</summary>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem;">Add your OpenAI API key to use Whisper for enhanced speech recognition. Your key is stored locally only.</p>

                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <input type="checkbox" id="voiceUseWhisper" style="cursor: pointer;">
                            <label for="voiceUseWhisper" style="font-size: 0.85rem; cursor: pointer;">Use OpenAI Whisper API</label>
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <input type="password" id="voiceOpenAIKey" class="form-control" placeholder="sk-..." style="flex: 1; font-size: 0.85rem;">
                            <button class="btn btn-sm btn-primary" onclick="voiceAI.saveCloudSettings()" style="font-size: 0.8rem;">Save</button>
                        </div>

                        <div id="voiceCloudStatus" style="font-size: 0.75rem; opacity: 0.7;"></div>

                        <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <p style="font-size: 0.75rem; opacity: 0.6;">ðŸ”’ API keys are encrypted and stored in your browser only. Never sent to our servers.</p>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="polite" aria-atomic="true"></div>

    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay" class="loading-overlay active">
        <div class="loading-logo">
            <span style="font-size: 4rem;">ðŸ“Š</span>
        </div>
        <div class="loading-spinner large"></div>
        <div class="loading-text" id="loadingText">Loading ConiCore Invoicing...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>

    <script>
        // ==================== LOADING & UX UTILITIES ====================
        
        // Global loading state
        let isAppLoading = true;
        let loadingProgress = 0;
        
        // Update loading progress bar
        function updateLoadingProgress(percent, text) {
            const progressBar = document.getElementById('loadingProgressBar');
            const loadingText = document.getElementById('loadingText');
            if (progressBar) progressBar.style.width = percent + '%';
            if (loadingText && text) loadingText.textContent = text;
        }
        
        // Hide the global loading overlay
        function hideGlobalLoading() {
            const overlay = document.getElementById('globalLoadingOverlay');
            if (overlay) {
                updateLoadingProgress(100, 'Ready!');
                setTimeout(() => {
                    overlay.classList.remove('active');
                    isAppLoading = false;
                    // Extra safety: ensure it can't intercept clicks if CSS fails to apply
                    overlay.style.pointerEvents = 'none';
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 250);
                }, 300);
            }
        }

        // Hard failsafe: never allow the app to remain blocked by the loading overlay.
        // This covers cases where an awaited init promise never resolves.
        setTimeout(() => {
            const overlay = document.getElementById('globalLoadingOverlay');
            const stillActive = Boolean(overlay && overlay.classList.contains('active'));
            if (isAppLoading || stillActive) {
                console.warn('âš ï¸ Loading overlay failsafe triggered; continuing in local-only mode.');
                try {
                    hideGlobalLoading();
                } catch (e) {
                    // Last resort: force-remove overlay from layout
                    if (overlay) {
                        overlay.classList.remove('active');
                        overlay.style.display = 'none';
                        overlay.style.pointerEvents = 'none';
                        overlay.style.opacity = '0';
                    }
                    isAppLoading = false;
                }

                if (typeof showToast === 'function') {
                    showToast('Loaded in local-only mode (cloud sync may be unavailable)', 'warning');
                }
            }
        }, 12000);
        
        // Show loading state on a button
        function setButtonLoading(btn, loading) {
            if (!btn) return;
            if (loading) {
                btn.classList.add('loading');
                btn.dataset.originalText = btn.innerHTML;
            } else {
                btn.classList.remove('loading');
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                }
            }
        }
        
        // Show skeleton loader in a container
        function showSkeletonLoader(container, count = 3) {
            if (!container) return;
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `<div class="skeleton skeleton-card" style="height: 80px; margin-bottom: 1rem;"></div>`;
            }
            container.innerHTML = html;
        }
        
        // Show empty state
        function showEmptyState(container, icon, title, text) {
            if (!container) return;
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">${icon}</div>
                    <div class="empty-state-title">${title}</div>
                    <div class="empty-state-text">${text}</div>
                </div>
            `;
        }
        
        // Refresh with animation
        function animateRefreshButton(btn) {
            if (!btn) return;
            btn.classList.add('spinning');
            setTimeout(() => btn.classList.remove('spinning'), 1000);
        }
        
        // ==================== DATA MIGRATION ====================
        // Migrate from aweh_ to conicore_ keys while preserving data
        function migrateLocalStorageKeys() {
            const migrationDone = localStorage.getItem('conicore_migration_complete');
            if (migrationDone) return;
            
            console.log('ðŸ”„ Starting ConiCore data migration...');
            
            // Map of old keys to new keys
            const keyMappings = {
                'aweh_theme': 'conicore_theme',
                'aweh_user': 'conicore_user', 
                'aweh_users': 'conicore_users',
                'aweh_businesses': 'conicore_businesses',
                'aweh_currentBusiness': 'conicore_currentBusiness',
                'aweh_activity_log': 'conicore_activity_log',
                'aweh_payables': 'conicore_payables',
                'aweh_receiving_history': 'conicore_receiving_history',
                'aweh_exchange_rates': 'conicore_exchange_rates',
                'aweh_product_view': 'conicore_product_view',
                'aweh_bank_transactions': 'conicore_bank_transactions'
            };
            
            let migratedCount = 0;
            
            // Migrate exact key matches
            for (const [oldKey, newKey] of Object.entries(keyMappings)) {
                const value = localStorage.getItem(oldKey);
                if (value !== null) {
                    localStorage.setItem(newKey, value);
                    // Keep old keys for backwards compatibility
                    migratedCount++;
                }
            }
            
            // Migrate business-specific keys (aweh_*_businessId)
            const businessSpecificPrefixes = ['invoices', 'customers', 'suppliers', 'products', 'settings', 'favorites', 'expenses'];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('aweh_')) {
                    for (const prefix of businessSpecificPrefixes) {
                        if (key.startsWith(`aweh_${prefix}_`)) {
                            const newKey = key.replace('aweh_', 'conicore_');
                            const value = localStorage.getItem(key);
                            if (value !== null) {
                                localStorage.setItem(newKey, value);
                                migratedCount++;
                            }
                        }
                    }
                }
            }
            
            localStorage.setItem('conicore_migration_complete', new Date().toISOString());
            console.log(`âœ… ConiCore migration complete: ${migratedCount} keys migrated`);
        }
        
        // Storage key helper - supports both old and new keys
        function getStorageKey(baseKey) {
            // Try new conicore_ key first, fall back to aweh_
            const newKey = baseKey.replace('aweh_', 'conicore_');
            if (localStorage.getItem(newKey) !== null) {
                return newKey;
            }
            return baseKey; // Fall back to old key if new doesn't exist
        }
        
        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('conicore_theme', newTheme);
            localStorage.setItem('aweh_theme', newTheme); // Keep for compatibility
            
            // Update button icon
            const btn = document.getElementById('themeToggleBtn');
            if (btn) {
                btn.innerHTML = newTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            }
            
            showToast(`Switched to ${newTheme} mode`, 'success');
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('conicore_theme') || localStorage.getItem('aweh_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) {
                btn.innerHTML = savedTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            }
        }
        
        // ==================== GLOBAL SEARCH ====================
        let globalSearchTimeout = null;
        
        function handleGlobalSearch(query) {
            clearTimeout(globalSearchTimeout);
            
            if (!query || query.length < 2) {
                hideGlobalSearchResults();
                return;
            }
            
            // Debounce search
            globalSearchTimeout = setTimeout(() => {
                performGlobalSearch(query);
            }, 200);
        }
        
        function performGlobalSearch(query) {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (!resultsDiv) return;
            
            const q = query.toLowerCase();
            let results = [];
            
            // Search invoices
            invoices.forEach(inv => {
                if (inv.number?.toLowerCase().includes(q) || 
                    inv.customerName?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'invoice',
                        icon: 'ðŸ§¾',
                        title: inv.number,
                        subtitle: `${inv.customerName} â€¢ R ${formatNumber(Math.round(inv.total || 0))}`,
                        action: () => { viewInvoice(inv.id); hideGlobalSearchResults(); }
                    });
                }
            });
            
            // Search customers
            customers.forEach(cust => {
                if (cust.name?.toLowerCase().includes(q) || 
                    cust.company?.toLowerCase().includes(q) ||
                    cust.email?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'customer',
                        icon: 'ðŸ‘¤',
                        title: cust.name,
                        subtitle: cust.company || cust.email || cust.phone || '',
                        action: () => { switchTab('customers'); hideGlobalSearchResults(); }
                    });
                }
            });
            
            // Search products
            products.forEach(prod => {
                if (prod.name?.toLowerCase().includes(q) || 
                    prod.sku?.toLowerCase().includes(q) ||
                    prod.category?.toLowerCase().includes(q)) {
                    results.push({
                        type: 'product',
                        icon: 'ðŸ“¦',
                        title: prod.name,
                        subtitle: `${prod.category} â€¢ R ${formatNumber(Math.round(prod.landedCost * 1.35))} ex VAT`,
                        action: () => { switchTab('products'); hideGlobalSearchResults(); }
                    });
                }
            });
            
            // Limit results
            results = results.slice(0, 10);
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1.5rem; text-align: center; opacity: 0.6;">
                        No results found for "${escapeHtml(query)}"
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = results.map((r, i) => `
                    <div class="search-result-item" onclick="globalSearchResults[${i}].action()">
                        <div class="search-result-category">${r.icon} ${r.type}</div>
                        <div class="search-result-title">${escapeHtml(r.title)}</div>
                        <div class="search-result-subtitle">${escapeHtml(r.subtitle)}</div>
                    </div>
                `).join('');
                
                // Store actions for onclick
                window.globalSearchResults = results;
            }
            
            resultsDiv.style.display = 'block';
        }
        
        function showGlobalSearchResults() {
            const input = document.getElementById('globalSearchInput');
            if (input && input.value.length >= 2) {
                document.getElementById('globalSearchResults').style.display = 'block';
            }
        }
        
        function hideGlobalSearchResults() {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (resultsDiv) resultsDiv.style.display = 'none';
        }
        
        // ==================== PWA INSTALL PROMPT ====================
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after a delay
            setTimeout(() => {
                showInstallPrompt();
            }, 30000); // Show after 30 seconds
        });
        
        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const installBanner = document.createElement('div');
            installBanner.id = 'pwaInstallBanner';
            installBanner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--primary), var(--accent));
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 1rem;
                animation: slideUp 0.3s ease;
            `;
            installBanner.innerHTML = `
                <span style="font-size: 1.5rem;">ðŸ“²</span>
                <div>
                    <strong>Install App</strong>
                    <div style="font-size: 0.85rem; opacity: 0.9;">Add to home screen for quick access</div>
                </div>
                <button onclick="installPWA()" style="background: white; color: var(--accent); border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Install</button>
                <button onclick="dismissInstallPrompt()" style="background: transparent; border: none; color: white; cursor: pointer; padding: 0.5rem;">âœ•</button>
            `;
            document.body.appendChild(installBanner);
        }
        
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showToast('ðŸŽ‰ App installed! Find it on your home screen', 'success');
            }
            
            deferredPrompt = null;
            dismissInstallPrompt();
        }
        
        function dismissInstallPrompt() {
            const banner = document.getElementById('pwaInstallBanner');
            if (banner) banner.remove();
        }
        
        // Pull-to-refresh for mobile
        let touchStartY = 0;
        let isPulling = false;
        
        function initPullToRefresh() {
            // Load saved theme
            loadSavedTheme();
            
            const pullIndicator = document.createElement('div');
            pullIndicator.className = 'pull-to-refresh';
            pullIndicator.id = 'pullToRefresh';
            pullIndicator.innerHTML = '<div class="loading-spinner"></div><span>Release to refresh</span>';
            document.body.appendChild(pullIndicator);
            
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    touchStartY = e.touches[0].clientY;
                }
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (window.scrollY === 0 && e.touches[0].clientY > touchStartY + 50) {
                    isPulling = true;
                    pullIndicator.classList.add('visible');
                }
            }, { passive: true });
            
            document.addEventListener('touchend', () => {
                if (isPulling) {
                    isPulling = false;
                    pullIndicator.querySelector('span').textContent = 'Refreshing...';
                    
                    // Refresh data
                    setTimeout(async () => {
                        await refreshAllData();
                        pullIndicator.classList.remove('visible');
                        pullIndicator.querySelector('span').textContent = 'Release to refresh';
                    }, 500);
                }
            });
        }
        
        // Quick refresh from header button
        async function quickRefresh() {
            const btn = document.getElementById('quickRefreshBtn');
            animateRefreshButton(btn);
            await refreshAllData();
        }
        
        // Refresh all data
        async function refreshAllData() {
            try {
                // If Google Drive is connected, sync first
                if (typeof driveStorage !== 'undefined' && driveStorage.isSignedIn) {
                    showToast('ðŸ”„ Syncing from cloud...', 'info');
                    try {
                        await driveStorage.syncDown();
                    } catch (e) {
                        console.warn('Cloud sync failed, using local data');
                    }
                }
                
                invoices = await loadFromStorage(getBusinessKey('aweh_invoices'), []);
                customers = await loadFromStorage(getBusinessKey('aweh_customers'), []);
                suppliers = await loadFromStorage(getBusinessKey('aweh_suppliers'), []);
                
                loadRecentInvoices();
                loadAllInvoices();
                updateDashboard();
                loadCustomers();
                if (typeof loadSuppliers === 'function') loadSuppliers();
                
                // Refresh current tab display
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    if (activeTab.id === 'products') {
                        const activeFilter = document.querySelector('.filter-tag.active')?.dataset?.filter || 'all';
                        displayProducts(activeFilter);
                    }
                }
                
                showToast('âœ… Data refreshed!', 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('Failed to refresh data', 'error');
            }
        }
        
        // ==================== GLOBAL STATE ====================
        let products = [];
        let invoices = [];
        let customers = [];
        let payments = []; // Track all payments
        let suppliers = []; // Supplier management
        let businesses = []; // Multi-business support
        let currentBusiness = null; // Active business
        let favoriteProducts = []; // User's favorite products
        let recentProducts = []; // Recently used products
        let currentInvoice = {
            items: [],
            subtotal: 0,
            vat: 0,
            total: 0,
            status: 'draft', // draft, sent, paid, partial, overdue
            dueDate: '',
            paymentTerms: 30, // days
            amountPaid: 0,
            balance: 0
        };

        // Input Validation Helpers
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        function validatePhone(phone) {
            // Accepts various phone formats including South African numbers
            const re = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
            return !phone || re.test(phone.replace(/\s/g, ''));
        }

        function sanitizeNumber(value, min = 0, max = Infinity) {
            const num = parseFloat(value) || 0;
            return Math.max(min, Math.min(max, num));
        }

        // Date Helper Functions
        function updateDueDate() {
            const invoiceDate = document.getElementById('invoiceDate')?.value;
            const paymentTerms = parseInt(document.getElementById('paymentTerms')?.value || 30);

            if (invoiceDate) {
                const date = new Date(invoiceDate);
                date.setDate(date.getDate() + paymentTerms);
                document.getElementById('invoiceDueDate').value = date.toISOString().split('T')[0];
            }
        }

        async function checkOverdueInvoices() {
            const today = new Date().toISOString().split('T')[0];
            invoices.forEach(inv => {
                if (inv.dueDate && inv.dueDate < today && inv.status !== 'paid' && inv.status !== 'cancelled') {
                    inv.status = 'overdue';
                }
            });
            await saveToStorage(getBusinessKey('aweh_invoices'), invoices);
        }

        // Status Helper Functions
        function getStatusBadge(status) {
            const badges = {
                'draft': '<span style="padding: 0.25rem 0.75rem; background: rgba(128, 128, 128, 0.3); border-radius: 20px; font-size: 0.85rem;">ðŸ“ Draft</span>',
                'sent': '<span style="padding: 0.25rem 0.75rem; background: rgba(0, 212, 255, 0.3); border-radius: 20px; font-size: 0.85rem;">ðŸ“¤ Sent</span>',
                'partial': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 165, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">ðŸ’° Partial</span>',
                'paid': '<span style="padding: 0.25rem 0.75rem; background: rgba(0, 255, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">âœ… Paid</span>',
                'overdue': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 0, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">âš ï¸ Overdue</span>',
                'cancelled': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 0, 110, 0.3); border-radius: 20px; font-size: 0.85rem;">âŒ Cancelled</span>'
            };
            return badges[status] || badges['draft'];
        }

        // Payment Recording Functions
        function togglePaymentSection() {
            const section = document.getElementById('paymentSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';

            // Set default payment date to today
            if (section.style.display === 'block') {
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value || 0);
            if (amount <= 0) {
                showToast('Please enter a valid payment amount', 'error');
                return;
            }

            const balance = currentInvoice.total - (currentInvoice.amountPaid || 0);
            if (amount > balance) {
                if (!confirm(`Payment amount (R ${formatNumber(amount)}) exceeds balance (R ${formatNumber(balance)}). Continue?`)) {
                    return;
                }
            }

            const payment = {
                id: Date.now(),
                invoiceId: currentInvoice.id,
                amount: amount,
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                reference: document.getElementById('paymentReference').value
            };

            // Initialize payments array if needed
            if (!currentInvoice.payments) {
                currentInvoice.payments = [];
            }
            currentInvoice.payments.push(payment);

            // Update amounts
            currentInvoice.amountPaid = (currentInvoice.amountPaid || 0) + amount;
            currentInvoice.balance = currentInvoice.total - currentInvoice.amountPaid;

            // Update status
            if (currentInvoice.balance <= 0) {
                currentInvoice.status = 'paid';
                document.getElementById('invoiceStatus').value = 'paid';
            } else if (currentInvoice.amountPaid > 0) {
                currentInvoice.status = 'partial';
                document.getElementById('invoiceStatus').value = 'partial';
            }

            // Update UI
            updatePaymentDisplay();

            // Clear payment form
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentReference').value = '';

            showToast('Payment recorded successfully!', 'success');
        }

        function updatePaymentDisplay() {
            const amountPaid = currentInvoice.amountPaid || 0;
            const balance = currentInvoice.total - amountPaid;

            document.getElementById('invoiceAmountPaid').textContent = 'R ' + formatNumber(Math.round(amountPaid));
            document.getElementById('invoiceBalance').textContent = 'R ' + formatNumber(Math.round(balance));

            // Show/hide payment tracking section
            const trackingSection = document.getElementById('paymentTrackingSection');
            if (amountPaid > 0) {
                trackingSection.style.display = 'block';
            } else {
                trackingSection.style.display = 'none';
            }

            // Show payment history
            if (currentInvoice.payments && currentInvoice.payments.length > 0) {
                const historyDiv = document.getElementById('paymentHistory');
                const historyList = document.getElementById('paymentHistoryList');

                historyList.innerHTML = currentInvoice.payments.map(p => `
                    <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.5rem;">
                        <strong>R ${formatNumber(p.amount)}</strong> - ${p.date} - ${p.method}
                        ${p.reference ? `<br><small>Ref: ${p.reference}</small>` : ''}
                    </div>
                `).join('');

                historyDiv.style.display = 'block';
            }
        }

        // WhatsApp Integration
        let pendingWhatsAppData = null;

        function sendViaWhatsApp() {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before sending', 'error');
                return;
            }

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }

            if (!customer.phone) {
                showToast('Customer has no phone number', 'error');
                return;
            }

            const invoiceNumber = currentInvoice.number || 'DRAFT';
            const total = formatNumber(Math.round(currentInvoice.total));
            const dueDate = currentInvoice.dueDate || 'TBD';

            // Build items list
            const itemsList = currentInvoice.items.map(item => 
                `â€¢ ${item.name} (${item.qty}x) - R ${formatNumber(item.total)}`
            ).join('\n');

            // Build bank details
            const bankDetails = settings.bankName ? 
                `${settings.bankName}\nAcc: ${settings.accountNumber}\nBranch: ${settings.branchCode}\nReference: ${invoiceNumber}` 
                : 'Contact us for payment details';

            // Get WhatsApp template (use business-specific or default)
            const template = settings.whatsappTemplate || `ðŸ„â€â™‚ï¸ Howzit {customerName}! ðŸŒŠ

Aweh! Your invoice is ready to roll from {companyName}!

ðŸ“„ Invoice #{invoiceNumber}
ðŸ’° Total: R {total}
ðŸ“… Due: {dueDate}

ðŸ›’ What you ordered:
{items}

ðŸ’³ Banking Deets:
{bankDetails}

ðŸ¤™ Lekker! Thanks for the support!
Catch you on the next wave! ðŸŒŠ

{companyName}
{phone}
{email}`;

            // Replace placeholders
            const message = template
                .replace(/{customerName}/g, customer.name)
                .replace(/{companyName}/g, settings.companyName)
                .replace(/{invoiceNumber}/g, invoiceNumber)
                .replace(/{total}/g, total)
                .replace(/{dueDate}/g, dueDate)
                .replace(/{items}/g, itemsList)
                .replace(/{bankDetails}/g, bankDetails)
                .replace(/{phone}/g, settings.phone || '')
                .replace(/{email}/g, settings.email || '');

            // Store data for later use
            pendingWhatsAppData = {
                customer,
                message,
                invoiceNumber
            };

            // Show message editor
            document.getElementById('whatsappCustomerName').textContent = customer.name;
            document.getElementById('whatsappMessageEditor').value = message;
            openModal('whatsappMessageModal');
        }

        function confirmSendWhatsApp() {
            if (!pendingWhatsAppData) {
                showToast('No WhatsApp data found', 'error');
                return;
            }

            const { customer, invoiceNumber } = pendingWhatsAppData;
            const editedMessage = document.getElementById('whatsappMessageEditor').value;

            // Format phone number for WhatsApp (remove spaces, dashes, etc.)
            let phone = customer.phone.replace(/[\s\-\(\)]/g, '');
            if (!phone.startsWith('+')) {
                // Assume South African number if no country code
                phone = '+27' + phone.replace(/^0/, '');
            }

            // Close the editor modal
            closeModal('whatsappMessageModal');

            // Generate PDF invoice
            showToast('ðŸ“„ Generating PDF invoice...', 'info');
            
            const invoice = {
                number: invoiceNumber,
                type: document.getElementById('invoiceType')?.value || 'invoice',
                customer: customer.name,
                tier: document.getElementById('invoiceTier')?.value || '',
                vatOption: document.getElementById('invoiceVAT')?.value || 'include',
                status: 'sent',
                paymentTerms: parseInt(document.getElementById('paymentTerms')?.value || '0', 10),
                date: document.getElementById('invoiceDate')?.value || new Date().toISOString().split('T')[0],
                dueDate: document.getElementById('invoiceDueDate')?.value || '',
                discount: {
                    amount: parseFloat(document.getElementById('discountAmount')?.value || '0'),
                    type: document.getElementById('discountType')?.value || 'percentage'
                },
                shipping: parseFloat(document.getElementById('shippingCost')?.value || '0'),
                items: currentInvoice.items || [],
                subtotal: currentInvoice.subtotal || 0,
                vat: currentInvoice.vat || 0,
                total: currentInvoice.total || 0,
                amountPaid: parseFloat(document.getElementById('depositAmount')?.value || '0') || 0
            };

            // Open print dialog for PDF
            setTimeout(() => {
                openInvoicePrintWindow(invoice, customer, { autoPrint: false });
                showToast('ðŸ’¾ Save the PDF, then attach it to WhatsApp!', 'info');
            }, 500);

            // Open WhatsApp with edited message
            setTimeout(() => {
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(editedMessage)}`;
                window.open(whatsappUrl, '_blank');
                showToast('ðŸ“± Opening WhatsApp... Attach the PDF you just saved!', 'success');
            }, 1000);

            // Update invoice status to sent
            if (currentInvoice.status === 'draft') {
                currentInvoice.status = 'sent';
                document.getElementById('invoiceStatus').value = 'sent';
            }

            // Clear pending data
            pendingWhatsAppData = null;
        }

        // Email Integration
        let pendingEmailData = null;

        function sendViaEmail() {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before sending', 'error');
                return;
            }

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }

            if (!customer.email) {
                showToast('Customer has no email address', 'error');
                return;
            }

            const invoiceNumber = currentInvoice.number || 'DRAFT';
            const total = formatNumber(Math.round(currentInvoice.total));
            const dueDate = currentInvoice.dueDate || 'TBD';

            // Build items list
            const itemsList = currentInvoice.items.map(item => 
                `${item.name} (Qty: ${item.qty}) - R ${formatNumber(item.total)}`
            ).join('\n');

            // Build bank details
            const bankDetails = settings.bankName ? 
                `Bank: ${settings.bankName}\nAccount Number: ${settings.accountNumber}\nBranch Code: ${settings.branchCode}\nAccount Holder: ${settings.accountHolder}\nReference: ${invoiceNumber}` 
                : 'Contact us for payment details';

            // Get email templates
            const subjectTemplate = settings.emailSubject || 'Invoice {invoiceNumber} from {companyName}';
            const bodyTemplate = settings.emailTemplate || `Dear {customerName},

Please find your invoice details below:

Invoice #: {invoiceNumber}
Total Amount: R {total}
Due Date: {dueDate}

Items:
{items}

Payment Details:
{bankDetails}

If you have any questions, please don't hesitate to contact us.

Best regards,
{companyName}
{phone}
{email}`;

            // Replace placeholders
            const subject = subjectTemplate
                .replace(/{customerName}/g, customer.name)
                .replace(/{companyName}/g, settings.companyName)
                .replace(/{invoiceNumber}/g, invoiceNumber)
                .replace(/{total}/g, total)
                .replace(/{dueDate}/g, dueDate);

            const body = bodyTemplate
                .replace(/{customerName}/g, customer.name)
                .replace(/{companyName}/g, settings.companyName)
                .replace(/{invoiceNumber}/g, invoiceNumber)
                .replace(/{total}/g, total)
                .replace(/{dueDate}/g, dueDate)
                .replace(/{items}/g, itemsList)
                .replace(/{bankDetails}/g, bankDetails)
                .replace(/{phone}/g, settings.phone || '')
                .replace(/{email}/g, settings.email || '');

            // Store data for later use
            pendingEmailData = {
                customer,
                invoiceNumber
            };

            // Show message editor
            document.getElementById('emailCustomerName').textContent = customer.name;
            document.getElementById('emailSubjectEditor').value = subject;
            document.getElementById('emailMessageEditor').value = body;
            openModal('emailMessageModal');
        }

        function confirmSendEmail() {
            if (!pendingEmailData) {
                showToast('No email data found', 'error');
                return;
            }

            const { customer, invoiceNumber } = pendingEmailData;
            const editedSubject = document.getElementById('emailSubjectEditor').value;
            const editedBody = document.getElementById('emailMessageEditor').value;

            // Close the editor modal
            closeModal('emailMessageModal');

            // Generate PDF invoice
            showToast('ðŸ“„ Generating PDF invoice...', 'info');
            
            const invoice = {
                number: invoiceNumber,
                type: document.getElementById('invoiceType')?.value || 'invoice',
                customer: customer.name,
                tier: document.getElementById('invoiceTier')?.value || '',
                vatOption: document.getElementById('invoiceVAT')?.value || 'include',
                status: 'sent',
                paymentTerms: parseInt(document.getElementById('paymentTerms')?.value || '0', 10),
                date: document.getElementById('invoiceDate')?.value || new Date().toISOString().split('T')[0],
                dueDate: document.getElementById('invoiceDueDate')?.value || '',
                discount: {
                    amount: parseFloat(document.getElementById('discountAmount')?.value || '0'),
                    type: document.getElementById('discountType')?.value || 'percentage'
                },
                shipping: parseFloat(document.getElementById('shippingCost')?.value || '0'),
                items: currentInvoice.items || [],
                subtotal: currentInvoice.subtotal || 0,
                vat: currentInvoice.vat || 0,
                total: currentInvoice.total || 0,
                amountPaid: parseFloat(document.getElementById('depositAmount')?.value || '0') || 0
            };

            // Open print dialog for PDF
            setTimeout(() => {
                openInvoicePrintWindow(invoice, customer, { autoPrint: false });
                showToast('ðŸ’¾ Save the PDF, then attach it to your email!', 'info');
            }, 500);

            // Open email client with edited message
            setTimeout(() => {
                const mailtoUrl = `mailto:${customer.email}?subject=${encodeURIComponent(editedSubject)}&body=${encodeURIComponent(editedBody)}`;
                window.location.href = mailtoUrl;
                showToast('ðŸ“§ Opening email client... Attach the PDF you just saved!', 'success');
            }, 1000);

            // Update invoice status to sent
            if (currentInvoice.status === 'draft') {
                currentInvoice.status = 'sent';
                document.getElementById('invoiceStatus').value = 'sent';
            }

            // Clear pending data
            pendingEmailData = null;
        }

        // ========================================
        // FREE AI FUNCTIONS (Vercel Serverless)
        // ========================================

        // Call Vercel AI endpoint for follow-up messages
        async function getAIFollowup(customer, invoice) {
            try {
                // Calculate customer history
                const customerHistory = {
                    invoiceCount: invoices.filter(inv => inv.customer === customer.name).length,
                    totalSpent: invoices.filter(inv => inv.customer === customer.name).reduce((sum, inv) => sum + (inv.total || 0), 0),
                    paymentRate: calculatePaymentRate(customer.name),
                    tier: customer.tier || 'retail'
                };

                // Get current business context
                const business = {
                    name: settings.companyName || 'Aweh Be Lekker',
                    tone: settings.businessTone || 'friendly South African surfer vibe'
                };

                const response = await fetch('/api/ai-followup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: { 
                            name: customer.name || customer 
                        },
                        invoice: {
                            number: invoice.number,
                            total: invoice.total,
                            dueDate: invoice.dueDate,
                            daysOverdue: Math.floor((new Date() - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24))
                        },
                        prompt: settings.aiFollowupPrompt,
                        customerHistory: customerHistory,
                        business: business
                    })
                });
                
                const data = await response.json();
                console.log('AI followup generated:', data.source);
                return data.message;
            } catch (error) {
                console.error('AI followup error:', error);
                return null;
            }
        }

        // Get product recommendations from AI
        async function getProductRecommendations(customerHistory, currentItems, customerName) {
            try {
                // Get customer tier and payment rate
                const customer = customers.find(c => c.name === customerName);
                const customerTier = customer?.tier || 'retail';
                const paymentRate = calculatePaymentRate(customerName);

                const response = await fetch('/api/ai-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerHistory: customerHistory || [],
                        currentItems: currentItems || [],
                        products: products,
                        customerTier: customerTier,
                        paymentRate: paymentRate
                    })
                });
                
                const data = await response.json();
                console.log('Product recommendations:', data.recommendations.length, 'items');
                return data.recommendations;
            } catch (error) {
                console.error('Recommendations error:', error);
                return [];
            }
        }

        // Get business insights from AI
        async function getBusinessInsights() {
            try {
                const response = await fetch('/api/ai-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoices: invoices,
                        customers: customers,
                        products: products,
                        timeRange: 30
                    })
                });
                
                const data = await response.json();
                console.log('AI insights generated:', data.insights.length, 'insights');
                return data.insights;
            } catch (error) {
                console.error('Insights error:', error);
                return [];
            }
        }

        // Show AI insights on dashboard
        async function loadAIInsights() {
            const container = document.getElementById('aiInsightsContainer');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Loading insights...</p>';
            
            const insights = await getBusinessInsights();
            
            if (insights.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No insights available. Create some invoices to see AI analysis!</p>';
                return;
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="card" style="padding: 1rem; margin-bottom: 1rem; border-left: 4px solid ${
                    insight.priority === 'high' ? '#ff006e' : 
                    insight.priority === 'medium' ? '#ffbe0b' : 
                    'var(--primary)'
                };">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <span style="font-size: 2rem;">${insight.icon}</span>
                        <div style="flex: 1;">
                            <strong style="color: var(--primary);">${insight.title}</strong>
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; line-height: 1.5;">
                                ${insight.message}
                            </div>
                            ${insight.trend ? `
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.7;">
                                    Trend: ${insight.trend === 'up' ? 'ðŸ“ˆ Increasing' : insight.trend === 'down' ? 'ðŸ“‰ Decreasing' : 'âž¡ï¸ Stable'}
                                </div>
                            ` : ''}
                        </div>
                        ${insight.action ? `
                            <button class="btn btn-sm btn-primary" onclick="handleInsightAction('${insight.action}')">
                                ${insight.actionLabel || 'Take Action'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Handle insight action buttons
        function handleInsightAction(action) {
            if (action === 'sendFollowups') {
                if (confirm('Send AI-generated follow-up messages to all overdue invoices?')) {
                    sendBulkAIFollowups();
                }
            }
        }

        // Send AI follow-ups to all overdue invoices
        async function sendBulkAIFollowups() {
            const now = new Date();
            const overdueInvoices = invoices.filter(inv => {
                if (inv.status === 'paid') return false;
                return new Date(inv.dueDate) < now;
            });

            if (overdueInvoices.length === 0) {
                showToast('No overdue invoices found', 'info');
                return;
            }

            showToast(`Generating ${overdueInvoices.length} AI follow-up messages...`, 'info');

            let successCount = 0;
            for (const invoice of overdueInvoices) {
                const customer = customers.find(c => c.name === invoice.customer);
                if (!customer || (!customer.phone && !customer.email)) continue;

                const message = await getAIFollowup(customer, invoice);
                if (message) {
                    // Send via WhatsApp if phone available
                    if (customer.phone) {
                        const cleanPhone = customer.phone.replace(/[^0-9+]/g, '');
                        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                        // Open in new window (you can batch these)
                        console.log('Would send WhatsApp to:', customer.name);
                        successCount++;
                    }
                }
            }

            showToast(`âœ… Generated ${successCount} follow-up messages. Check console for details.`, 'success');
        }

        // Show product recommendations in invoice modal
        async function showProductRecommendations() {
            if (!settings.enableAIRecommendations) return;
            if (!currentInvoice.items || currentInvoice.items.length === 0) return;

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) return;

            // Get customer history
            const customerHistory = invoices
                .filter(inv => inv.customer === customer.name)
                .flatMap(inv => inv.items || []);

            const recommendations = await getProductRecommendations(customerHistory, currentInvoice.items);
            
            if (recommendations.length === 0) return;

            // Show recommendations in a notification or popup
            console.log('ðŸ’¡ Product recommendations:', recommendations);
            
            // You can add a UI element to display these
            const container = document.getElementById('productRecommendationsContainer');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 1rem; background: rgba(0, 212, 255, 0.1); border-radius: 8px; margin-top: 1rem;">
                        <strong style="color: var(--primary);">ðŸ’¡ Recommended Products:</strong>
                        <div style="margin-top: 0.5rem;">
                            ${recommendations.map(rec => `
                                <div style="padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${rec.name}</strong>
                                        <div style="font-size: 0.85rem; opacity: 0.7;">${rec.reason}</div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="addProductToInvoice('${rec.sku}')">Add</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Initialize AI insights on dashboard load
        function initializeAI() {
            // Show AI insights card if enabled
            if (settings.enableAIInsights) {
                const card = document.getElementById('aiInsightsCard');
                if (card) {
                    card.style.display = 'block';
                    loadAIInsights();
                }
            }
        }

        // ==================== AUTHENTICATION & USER MANAGEMENT ====================

        function checkAuthentication() {
            // Create default admin account if no users exist
            createDefaultAdmin();
            
            // Clean up any orphaned modals (like webcam capture from previous session)
            cleanupOrphanedModals();
            
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || localStorage.getItem('conicore_user') || 'null');
            
            if (!currentUser) {
                // No user logged in, redirect to login page
                window.location.href = 'index.html';
                return;
            }
            
            // Check session validity (24 hour timeout)
            const sessionTime = localStorage.getItem('conicore_session_time');
            const SESSION_TIMEOUT = 24 * 60 * 60 * 1000; // 24 hours
            
            if (sessionTime && (Date.now() - parseInt(sessionTime)) > SESSION_TIMEOUT) {
                // Session expired
                localStorage.removeItem('aweh_user');
                localStorage.removeItem('conicore_user');
                localStorage.removeItem('conicore_session_time');
                showToast('Session expired. Please log in again.', 'info');
                window.location.href = 'index.html';
                return;
            }
            
            // Update session time
            localStorage.setItem('conicore_session_time', Date.now().toString());

            // Show user info in header
            displayUserInfo(currentUser);

            // Show admin tab for admin/owner users
            if (currentUser.role === 'admin' || currentUser.role === 'owner') {
                const adminTab = document.getElementById('adminTab');
                if (adminTab) {
                    adminTab.style.display = 'block';
                }
                loadAdminPanel();
            }
            
            // Apply role-based permissions
            applyRolePermissions(currentUser);

            // Apply user data isolation for non-admin users
            applyUserDataIsolation(currentUser);

            // Log activity
            logActivity(`${currentUser.name} logged in`, currentUser.username);
        }
        
        // Role-based permissions system
        const rolePermissions = {
            owner: {
                viewAllInvoices: true,
                createInvoices: true,
                editAnyInvoice: true,
                deleteInvoices: true,
                manageCustomers: true,
                manageProducts: true,
                editPricing: true,
                viewFinancials: true,
                exportData: true,
                manageUsers: true,
                systemSettings: true,
                manageBusinesses: true,
                mergeEntities: true,
                aiFeatures: true
            },
            admin: {
                viewAllInvoices: true,
                createInvoices: true,
                editAnyInvoice: true,
                deleteInvoices: true,
                manageCustomers: true,
                manageProducts: true,
                editPricing: true,
                viewFinancials: true,
                exportData: true,
                manageUsers: true,
                systemSettings: true,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: true
            },
            accountant: {
                viewAllInvoices: true,
                createInvoices: true,
                editAnyInvoice: true,
                deleteInvoices: false,
                manageCustomers: true,
                manageProducts: false,
                editPricing: false,
                viewFinancials: true,
                exportData: true,
                manageUsers: false,
                systemSettings: false,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: true
            },
            manager: {
                viewAllInvoices: true,
                createInvoices: true,
                editAnyInvoice: true,
                deleteInvoices: true,
                manageCustomers: true,
                manageProducts: true,
                editPricing: true,
                viewFinancials: true,
                exportData: true,
                manageUsers: false,
                systemSettings: false,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: true
            },
            sales: {
                viewAllInvoices: false,
                createInvoices: true,
                editAnyInvoice: false,
                deleteInvoices: false,
                manageCustomers: false,
                manageProducts: false,
                editPricing: false,
                viewFinancials: false,
                exportData: false,
                manageUsers: false,
                systemSettings: false,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: true
            },
            user: {
                viewAllInvoices: false,
                createInvoices: true,
                editAnyInvoice: false,
                deleteInvoices: false,
                manageCustomers: false,
                manageProducts: false,
                editPricing: false,
                viewFinancials: false,
                exportData: false,
                manageUsers: false,
                systemSettings: false,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: false
            },
            viewer: {
                viewAllInvoices: true,
                createInvoices: false,
                editAnyInvoice: false,
                deleteInvoices: false,
                manageCustomers: false,
                manageProducts: false,
                editPricing: false,
                viewFinancials: true,
                exportData: false,
                manageUsers: false,
                systemSettings: false,
                manageBusinesses: false,
                mergeEntities: false,
                aiFeatures: false
            }
        };
        
        // Check if current user has a permission
        function hasPermission(permission) {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (!currentUser) return false;
            
            const perms = rolePermissions[currentUser.role] || rolePermissions.viewer;
            return perms[permission] === true;
        }
        
        // Check if user can access a specific business
        function canAccessBusiness(businessId) {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (!currentUser) return false;
            
            // Owners and admins can access all businesses
            if (currentUser.role === 'owner' || currentUser.role === 'admin') return true;
            
            // Check user's business access list
            if (!currentUser.businessAccess) return true; // Legacy users have access to all
            return currentUser.businessAccess.includes(businessId);
        }
        
        // Apply role-based UI restrictions
        function applyRolePermissions(user) {
            const perms = rolePermissions[user.role] || rolePermissions.viewer;
            
            // Hide create buttons for viewers
            if (!perms.createInvoices) {
                document.querySelectorAll('[onclick*="openCreateInvoiceModal"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            // Hide settings tab for non-permitted users
            if (!perms.systemSettings) {
                // Settings will be read-only
            }
            
            // Hide business management for non-owners
            if (!perms.manageBusinesses) {
                document.querySelectorAll('[onclick*="openCreateBusinessModal()"]').forEach(btn => {
                    if (!btn.closest('[onclick*="openCreateBusinessModal(\'"]')) {
                        btn.style.display = 'none';
                    }
                });
            }
            
            // Filter business list based on access
            if (user.businessAccess && user.role !== 'owner' && user.role !== 'admin') {
                const accessibleBusinesses = businesses.filter(b => user.businessAccess.includes(b.id));
                if (accessibleBusinesses.length === 0) {
                    showToast('You do not have access to any businesses. Contact your administrator.', 'error');
                }
            }
        }
        
        // Clean up any orphaned modals from previous sessions
        function cleanupOrphanedModals() {
            // Remove any leftover webcam capture modals
            const webcamModal = document.getElementById('webcamCaptureModal');
            if (webcamModal) {
                webcamModal.remove();
            }
            
            // Stop any active camera streams
            if (window.webcamStream) {
                window.webcamStream.getTracks().forEach(track => track.stop());
                window.webcamStream = null;
            }
            
            // Remove any dynamically created modals that shouldn't persist
            const orphanedModals = ['loginCodeModal', 'qrCodeModal', 'whatsAppSetupGuide'];
            orphanedModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
            });
            
            // Ensure all modals are closed on page load
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        function createDefaultAdmin() {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            
            // Check if default admin already exists
            const adminExists = users.find(u => u.email === 'awehbelekker@gmail.com');
            
            if (!adminExists) {
                const defaultAdmin = {
                    id: Date.now(),
                    name: 'Admin',
                    email: 'awehbelekker@gmail.com',
                    username: 'admin',
                    password: 'Riley@Dai2024!',
                    role: 'admin',
                    createdAt: new Date().toISOString(),
                    provider: 'local'
                };
                
                users.push(defaultAdmin);
                localStorage.setItem('aweh_users', JSON.stringify(users));
                console.log('âœ… Default admin account created');
            }
        }

        function applyUserDataIsolation(user) {
            if (user.role === 'admin') {
                // Admins can see all data
                return;
            }

            // Non-admin users: filter data to show only their own
            const userId = user.username || user.email;

            // Filter invoices
            invoices = invoices.filter(inv => 
                inv.createdBy === userId || 
                inv.owner === userId || 
                !inv.createdBy // Legacy invoices without owner
            );

            // Filter customers
            customers = customers.filter(cust => 
                cust.createdBy === userId || 
                cust.owner === userId || 
                !cust.createdBy // Legacy customers without owner
            );

            // Filter suppliers
            suppliers = suppliers.filter(supp => 
                supp.createdBy === userId || 
                supp.owner === userId || 
                !supp.createdBy // Legacy suppliers without owner
            );

            // Filter products
            favoriteProducts = favoriteProducts.filter(prod => 
                prod.createdBy === userId || 
                prod.owner === userId || 
                !prod.createdBy // Legacy products without owner
            );
        }

        function displayUserInfo(user) {
            // Update current user email in header
            const emailDisplay = document.getElementById('currentUserEmail');
            if (emailDisplay) {
                const ownerBadge = isBusinessOwner() ? '<span title="Business Owner" style="font-size: 0.7rem;">ðŸ‘‘</span>' : '';
                const syncBadge = (user.provider === 'google' && isBusinessOwner()) ? '<span title="Syncing to your Drive" style="font-size: 0.7rem; color: var(--success);">â˜ï¸</span>' : 
                                  (user.provider === 'google') ? '<span title="Logged in with Google" style="font-size: 0.7rem;">ðŸ”—</span>' : '';
                
                // Show name and badges
                if (user.provider === 'google') {
                    emailDisplay.innerHTML = `
                        ${user.picture ? `<img src="${user.picture}" alt="" style="width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 6px;">` : ''}
                        <span>${user.name || user.email}</span>
                        ${ownerBadge} ${syncBadge}
                    `;
                } else {
                    emailDisplay.innerHTML = `<span>${user.email || user.username || user.name}</span> ${ownerBadge}`;
                }
            }
            
            // Update sync button based on ownership
            updateSyncButtonForOwnership();
        }
        
        // Update sync button to show owner status
        function updateSyncButtonForOwnership() {
            const syncBtn = document.getElementById('syncGoogleBtn');
            const syncIcon = document.getElementById('syncStatusIcon');
            
            if (!syncBtn) return;
            
            if (isBusinessOwner()) {
                // Owner can sync
                syncBtn.style.opacity = '1';
                syncBtn.title = 'Sync to your Google Drive';
            } else if (currentBusiness?.ownerEmail) {
                // Not owner but business has owner
                syncBtn.style.opacity = '0.6';
                syncBtn.title = `Data managed by ${currentBusiness.ownerEmail}`;
                if (syncIcon) syncIcon.textContent = 'ðŸ”’';
            } else {
                // No owner yet
                syncBtn.style.opacity = '1';
                syncBtn.title = 'Click to claim ownership and enable sync';
            }
        }

        function getRoleIcon(role) {
            const icons = {
                owner: 'ðŸ‘‘',
                admin: 'ðŸ›¡ï¸',
                manager: 'ðŸ“Š',
                accountant: 'ðŸ“ˆ',
                user: 'ðŸ‘¤'
            };
            return icons[role] || 'ðŸ‘¤';
        }
        
        // Check if current user is the business owner (has Drive access)
        function isBusinessOwner() {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (!currentUser || !currentBusiness) return false;
            
            // Owner by email match or first user of business
            return currentBusiness.ownerEmail === currentUser.email ||
                   currentBusiness.ownerGoogleId === currentUser.googleId ||
                   currentUser.role === 'owner' ||
                   (currentUser.role === 'admin' && !currentBusiness.ownerEmail);
        }
        
        // Check if current user is authorized to view business data
        function isAuthorizedUser() {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (!currentUser || !currentBusiness) return false;
            
            // Owners always authorized
            if (isBusinessOwner()) return true;
            
            // Check authorized users list
            const authorized = currentBusiness.authorizedUsers || [];
            return authorized.includes(currentUser.email);
        }
        
        // Set current user as business owner (for Drive linking)
        async function claimBusinessOwnership() {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (!currentUser || !currentBusiness) {
                showToast('No user or business found', 'error');
                return false;
            }
            
            if (currentBusiness.ownerEmail && currentBusiness.ownerEmail !== currentUser.email) {
                showToast('This business already has an owner: ' + currentBusiness.ownerEmail, 'error');
                return false;
            }
            
            currentBusiness.ownerEmail = currentUser.email;
            currentBusiness.ownerGoogleId = currentUser.googleId || null;
            if (!currentBusiness.authorizedUsers) currentBusiness.authorizedUsers = [];
            if (!currentBusiness.authorizedUsers.includes(currentUser.email)) {
                currentBusiness.authorizedUsers.push(currentUser.email);
            }
            
            await saveToStorage('aweh_businesses', businesses);
            showToast('You are now the owner of ' + currentBusiness.name, 'success');
            return true;
        }
        
        // Generate unique join code for a business (e.g., "CONI-X7K9-M2PQ")
        function generateJoinCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No confusing chars like 0/O, 1/I/L
            let code = 'CONI-';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            code += '-';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Regenerate join code for current business (admin only)
        async function regenerateJoinCode() {
            if (!isBusinessOwner()) {
                showToast('Only the business owner can regenerate the join code', 'error');
                return;
            }
            
            if (!confirm('Generate a new join code?\n\nThe old code will no longer work for new users.')) return;
            
            currentBusiness.joinCode = generateJoinCode();
            await saveToStorage('aweh_businesses', businesses);
            
            loadBusinessAccessPanel();
            showToast('âœ… New join code generated: ' + currentBusiness.joinCode, 'success');
        }
        
        // Find business by join code
        function findBusinessByJoinCode(code) {
            if (!code) return null;
            const normalizedCode = code.toUpperCase().trim();
            return businesses.find(b => b.joinCode === normalizedCode);
        }
        
        // Copy join code to clipboard
        function copyJoinCode() {
            if (!currentBusiness?.joinCode) {
                showToast('No join code available', 'error');
                return;
            }
            
            navigator.clipboard.writeText(currentBusiness.joinCode).then(() => {
                showToast('âœ… Join code copied: ' + currentBusiness.joinCode, 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentBusiness.joinCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('âœ… Join code copied: ' + currentBusiness.joinCode, 'success');
            });
        }

        async function logout() {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (currentUser) {
                logActivity(`${currentUser.name} logged out`, currentUser.username);
            }
            
            // If Google user, also sign out from Google Drive
            if (currentUser?.provider === 'google' && typeof driveStorage !== 'undefined') {
                try {
                    await driveStorage.signOut();
                } catch (e) {
                    console.warn('Drive sign out error:', e);
                }
            }
            
            // Clear user session and Google token
            localStorage.removeItem('aweh_user');
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_auto_sync_pending');
            
            // Show logout message
            showToast('You have been logged out successfully', 'success');
            
            // Redirect to login page after a brief delay
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
            window.location.href = 'index.html';
        }

        function loadAdminPanel() {
            loadUsersTable();
            updateSystemStats();
            loadActivityLog();
            loadBusinessAccessPanel();
        }
        
        // Load the business access control panel
        function loadBusinessAccessPanel() {
            const ownerInfo = document.getElementById('businessOwnerInfo');
            const usersList = document.getElementById('authorizedUsersList');
            const accessCard = document.getElementById('businessAccessCard');
            
            if (!accessCard) return;
            
            // Only show to business owners
            if (!isBusinessOwner()) {
                accessCard.style.display = 'none';
                return;
            }
            accessCard.style.display = 'block';
            
            // Show owner info
            if (ownerInfo && currentBusiness) {
                const driveStatus = currentBusiness.driveConfigured ? 
                    '<span style="color: var(--success);">âœ… Connected to Google Drive</span>' : 
                    '<span style="color: var(--warning);">âš ï¸ Not connected - Click Sync to setup</span>';
                    
                ownerInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8;">Business</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">${currentBusiness.name}</div>
                        </div>
                        <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8;">Owner</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">ðŸ‘‘ ${currentBusiness.ownerEmail || 'You'}</div>
                        </div>
                        <div style="background: rgba(114, 9, 183, 0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.8;">Cloud Sync</div>
                            <div style="font-size: 1rem;">${driveStatus}</div>
                        </div>
                    </div>
                    
                    <!-- Join Code Section -->
                    <div style="background: linear-gradient(135deg, rgba(255, 190, 11, 0.15), rgba(251, 86, 7, 0.15)); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 190, 11, 0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.5rem;">ðŸŽ« Company Join Code</div>
                                <div style="font-size: 1.5rem; font-weight: bold; font-family: monospace; letter-spacing: 2px; color: var(--warning);">
                                    ${currentBusiness.joinCode || 'Not generated'}
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.5rem;">
                                    Share this code with team members to join your business
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-outline" onclick="copyJoinCode()" title="Copy code">
                                    ðŸ“‹ Copy
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="regenerateJoinCode()" title="Generate new code" style="border-color: rgba(251, 86, 7, 0.5);">
                                    ðŸ”„ New Code
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show authorized users
            if (usersList && currentBusiness) {
                const authorized = currentBusiness.authorizedUsers || [];
                if (authorized.length === 0) {
                    usersList.innerHTML = '<p style="opacity: 0.7; font-size: 0.9rem;">No authorized users yet. Add users below.</p>';
                } else {
                    usersList.innerHTML = authorized.map(email => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 0.5rem;">
                            <span>
                                ${email === currentBusiness.ownerEmail ? 'ðŸ‘‘' : 'ðŸ‘¤'} ${email}
                                ${email === currentBusiness.ownerEmail ? '<span style="font-size: 0.8rem; opacity: 0.7;"> (Owner)</span>' : ''}
                            </span>
                            ${email !== currentBusiness.ownerEmail ? `
                                <button class="btn btn-sm" onclick="removeAuthorizedUser('${email}')" style="color: var(--danger); padding: 0.25rem 0.5rem;">
                                    âœ•
                                </button>
                            ` : ''}
                        </div>
                    `).join('');
                }
            }
        }
        
        // Add authorized user to business
        async function addAuthorizedUser() {
            if (!isBusinessOwner()) {
                showToast('Only the business owner can manage authorized users', 'error');
                return;
            }
            
            const emailInput = document.getElementById('newAuthorizedEmail');
            const email = emailInput?.value?.trim().toLowerCase();
            
            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            if (!currentBusiness.authorizedUsers) {
                currentBusiness.authorizedUsers = [];
            }
            
            if (currentBusiness.authorizedUsers.includes(email)) {
                showToast('This user is already authorized', 'warning');
                return;
            }
            
            currentBusiness.authorizedUsers.push(email);
            await saveToStorage('aweh_businesses', businesses);
            
            emailInput.value = '';
            loadBusinessAccessPanel();
            showToast(`âœ… ${email} can now access ${currentBusiness.name} data`, 'success');
        }
        
        // Remove authorized user from business
        async function removeAuthorizedUser(email) {
            if (!isBusinessOwner()) {
                showToast('Only the business owner can manage authorized users', 'error');
                return;
            }
            
            if (email === currentBusiness.ownerEmail) {
                showToast('Cannot remove the business owner', 'error');
                return;
            }
            
            if (!confirm(`Remove ${email} from authorized users?`)) return;
            
            currentBusiness.authorizedUsers = (currentBusiness.authorizedUsers || []).filter(e => e !== email);
            await saveToStorage('aweh_businesses', businesses);
            
            loadBusinessAccessPanel();
            showToast(`${email} can no longer access ${currentBusiness.name} data`, 'success');
        }

        function loadUsersTable() {
            const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; opacity: 0.7;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const status = user.status || 'active';
                const statusBadge = getStatusBadge(status);
                const isCurrentUser = JSON.parse(localStorage.getItem('conicore_user') || localStorage.getItem('aweh_user') || '{}').id === user.id;
                const needsPasswordChange = user.requirePasswordChange ? '<span style="color: var(--warning);">âš ï¸ Temp</span>' : '<span style="color: var(--success);">âœ… Set</span>';
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '<span style="opacity: 0.5;">Never</span>';
                const loginCode = user.loginCode || user.username;
                
                return `
                <tr style="${status === 'blocked' ? 'opacity: 0.6;' : ''}">
                    <td>${user.name}</td>
                    <td style="font-size: 0.85rem;">${user.email}</td>
                    <td>
                        <code style="background: rgba(102, 126, 234, 0.2); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${loginCode}</code>
                        <button class="btn btn-sm" style="padding: 0.1rem 0.3rem; margin-left: 0.25rem;" onclick="copyToClipboard('${loginCode}')" title="Copy code">ðŸ“‹</button>
                    </td>
                    <td>
                        <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; background: ${getRoleColor(user.role)}; color: white;">
                            ${getRoleIcon(user.role)} ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        ${needsPasswordChange}
                        <button class="btn btn-sm btn-outline" style="padding: 0.1rem 0.3rem; margin-left: 0.25rem;" onclick="resetUserPassword('${user.id}')" title="Reset password">ðŸ”‘</button>
                    </td>
                    <td style="font-size: 0.85rem;">${lastLogin}</td>
                    <td style="white-space: nowrap;">
                        ${status === 'pending' ? `
                            <button class="btn btn-sm" style="background: var(--success); color: white; padding: 0.25rem 0.5rem;" onclick="approveUser('${user.id}')" title="Approve user">
                                âœ…
                            </button>
                        ` : ''}
                        ${status === 'active' && !isCurrentUser && user.role !== 'owner' ? `
                            <button class="btn btn-sm" style="background: var(--danger); color: white; padding: 0.25rem 0.5rem;" onclick="blockUser('${user.id}')" title="Block user">
                                â›”
                            </button>
                        ` : ''}
                        ${status === 'blocked' ? `
                            <button class="btn btn-sm" style="background: var(--success); color: white; padding: 0.25rem 0.5rem;" onclick="unblockUser('${user.id}')" title="Unblock user">
                                ðŸ”“
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline" onclick="changeUserRole('${user.id}')" title="Change role" style="padding: 0.25rem 0.5rem;">
                            ðŸ”„
                        </button>
                        ${!isCurrentUser && user.role !== 'owner' ? `
                            <button class="btn btn-sm btn-outline" onclick="deleteUserPrompt('${user.id}')" title="Delete user" style="padding: 0.25rem 0.5rem;">
                                ðŸ—‘ï¸
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `}).join('');
        }
        
        function getStatusBadge(status) {
            const badges = {
                active: '<span style="padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; background: rgba(6, 255, 165, 0.2); color: var(--success); border: 1px solid var(--success);">âœ… Active</span>',
                pending: '<span style="padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; background: rgba(255, 190, 11, 0.2); color: #ffbe0b; border: 1px solid #ffbe0b;">â³ Pending</span>',
                blocked: '<span style="padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; background: rgba(255, 0, 110, 0.2); color: var(--secondary); border: 1px solid var(--secondary);">â›” Blocked</span>'
            };
            return badges[status] || badges.active;
        }
        
        async function approveUser(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            user.status = 'active';
            user.approvedAt = new Date().toISOString();
            user.approvedBy = JSON.parse(localStorage.getItem('aweh_user') || '{}').email;
            
            localStorage.setItem('aweh_users', JSON.stringify(users));
            loadUsersTable();
            showToast(`âœ… ${user.name} has been approved and can now login`, 'success');
        }
        
        async function blockUser(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            if (user.role === 'owner') {
                showToast('Cannot block the business owner', 'error');
                return;
            }
            
            if (!confirm(`Block ${user.name} (${user.email})?\\n\\nThey will not be able to login.`)) return;
            
            user.status = 'blocked';
            user.blockedAt = new Date().toISOString();
            user.blockedBy = JSON.parse(localStorage.getItem('aweh_user') || '{}').email;
            
            localStorage.setItem('aweh_users', JSON.stringify(users));
            loadUsersTable();
            showToast(`â›” ${user.name} has been blocked`, 'success');
        }
        
        async function unblockUser(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            user.status = 'active';
            user.unblockedAt = new Date().toISOString();
            
            localStorage.setItem('aweh_users', JSON.stringify(users));
            loadUsersTable();
            showToast(`ðŸ”“ ${user.name} has been unblocked and can now login`, 'success');
        }
        
        // Terms & Conditions Functions
        function checkTermsAcceptance() {
            const user = JSON.parse(localStorage.getItem('aweh_user') || '{}');
            if (user.id && !user.termsAccepted) {
                // User hasn't accepted terms yet
                openTermsModal();
                return false;
            }
            return true;
        }
        
        function openTermsModal() {
            document.getElementById('termsAcceptCheckbox').checked = false;
            document.getElementById('acceptTermsBtn').disabled = true;
            openModal('termsModal');
            
            // Enable accept button when checkbox is checked
            document.getElementById('termsAcceptCheckbox').addEventListener('change', function() {
                document.getElementById('acceptTermsBtn').disabled = !this.checked;
            });
        }
        
        function acceptTerms() {
            const checkbox = document.getElementById('termsAcceptCheckbox');
            if (!checkbox.checked) {
                showToast('Please check the checkbox to accept terms', 'error');
                return;
            }
            
            // Update current user
            const user = JSON.parse(localStorage.getItem('aweh_user') || '{}');
            user.termsAccepted = true;
            user.termsAcceptedAt = new Date().toISOString();
            localStorage.setItem('aweh_user', JSON.stringify(user));
            
            // Update in users array
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const userIdx = users.findIndex(u => u.id == user.id);
            if (userIdx !== -1) {
                users[userIdx].termsAccepted = true;
                users[userIdx].termsAcceptedAt = user.termsAcceptedAt;
                localStorage.setItem('aweh_users', JSON.stringify(users));
            }
            
            closeModal('termsModal');
            showToast('âœ… Terms accepted! Welcome to ConiCore Invoicing', 'success');
        }
        
        function declineTerms() {
            if (confirm('If you decline the terms, you will be logged out. Continue?')) {
                closeModal('termsModal');
                showToast('Terms declined. Logging out...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        }
        
        // ==================== PLATFORM BRANDING ====================
        function loadPlatformBranding() {
            const branding = JSON.parse(localStorage.getItem('conicore_platform_branding') || '{}');
            
            if (document.getElementById('platformName')) {
                document.getElementById('platformName').value = branding.name || 'ConiCore Invoicing';
                document.getElementById('platformTagline').value = branding.tagline || 'Professional Invoicing System';
                document.getElementById('platformPrimaryColor').value = branding.primaryColor || '#00d4ff';
                document.getElementById('platformSecondaryColor').value = branding.secondaryColor || '#ff006e';
                document.getElementById('platformAccentColor').value = branding.accentColor || '#7209b7';
                
                if (branding.logo) {
                    document.getElementById('platformLogoPreview').innerHTML = `<img src="${branding.logo}" style="max-width: 100%; max-height: 100%; border-radius: 8px;">`;
                }
            }
            
            // Show platform branding card only for master admin
            const user = JSON.parse(localStorage.getItem('conicore_user') || localStorage.getItem('aweh_user') || '{}');
            if (user.role === 'owner' || user.role === 'admin') {
                const card = document.getElementById('platformBrandingCard');
                if (card) card.style.display = 'block';

                // Show enterprise API key management for master admin
                const keyMgmtCard = document.getElementById('enterpriseKeyMgmtCard');
                if (keyMgmtCard) keyMgmtCard.style.display = 'block';

                // Show local hosting card for master admin
                const localHostingCard = document.getElementById('localHostingCard');
                if (localHostingCard) localHostingCard.style.display = 'block';

                // Refresh API key table
                refreshApiKeyTable();
            }
        }
        
        function savePlatformBranding() {
            const branding = {
                name: document.getElementById('platformName')?.value || 'ConiCore Invoicing',
                tagline: document.getElementById('platformTagline')?.value || 'Professional Invoicing System',
                primaryColor: document.getElementById('platformPrimaryColor')?.value || '#00d4ff',
                secondaryColor: document.getElementById('platformSecondaryColor')?.value || '#ff006e',
                accentColor: document.getElementById('platformAccentColor')?.value || '#7209b7',
                logo: document.getElementById('platformLogoPreview')?.querySelector('img')?.src || null,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('conicore_platform_branding', JSON.stringify(branding));
        }
        
        function previewPlatformLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('platformLogoPreview').innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 100%; border-radius: 8px;">`;
                    savePlatformBranding();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function clearPlatformLogo() {
            document.getElementById('platformLogoPreview').innerHTML = '<span style="font-size: 2.5rem;">ðŸ“Š</span>';
            savePlatformBranding();
        }
        
        function applyPlatformBranding() {
            savePlatformBranding();
            const branding = JSON.parse(localStorage.getItem('conicore_platform_branding') || '{}');
            
            // Apply colors to CSS variables
            document.documentElement.style.setProperty('--primary', branding.primaryColor || '#00d4ff');
            document.documentElement.style.setProperty('--secondary', branding.secondaryColor || '#ff006e');
            document.documentElement.style.setProperty('--accent', branding.accentColor || '#7209b7');
            
            showToast('âœ¨ Platform branding applied!', 'success');
        }
        
        function resetPlatformBranding() {
            if (!confirm('Reset all branding to ConiCore defaults?')) return;
            
            localStorage.removeItem('conicore_platform_branding');
            loadPlatformBranding();
            
            document.documentElement.style.setProperty('--primary', '#00d4ff');
            document.documentElement.style.setProperty('--secondary', '#ff006e');
            document.documentElement.style.setProperty('--accent', '#7209b7');
            
            showToast('â†©ï¸ Branding reset to defaults', 'success');
        }
        
        // ==================== INVOICE TEMPLATES ====================
        function selectInvoiceTemplate(templateId) {
            // Update visual selection
            document.querySelectorAll('.invoice-template-card').forEach(card => {
                card.style.borderColor = 'rgba(255,255,255,0.2)';
                card.style.background = 'transparent';
            });
            
            const selected = document.querySelector(`.invoice-template-card[data-template="${templateId}"]`);
            if (selected) {
                selected.style.borderColor = 'var(--primary)';
                selected.style.background = 'rgba(0, 212, 255, 0.1)';
            }
            
            // Save to settings
            settings.invoiceTemplate = templateId;
            saveSettings();
            
            // Update display
            const names = { modern: 'Modern', classic: 'Classic', minimal: 'Minimal', corporate: 'Corporate', creative: 'Creative' };
            document.getElementById('currentTemplateName').textContent = names[templateId] || 'Modern';
            
            showToast(`ðŸ“‘ Invoice template set to ${names[templateId]}`, 'success');
        }
        
        function loadInvoiceTemplateSelection() {
            const templateId = settings.invoiceTemplate || 'modern';
            document.querySelectorAll('.invoice-template-card').forEach(card => {
                if (card.dataset.template === templateId) {
                    card.style.borderColor = 'var(--primary)';
                    card.style.background = 'rgba(0, 212, 255, 0.1)';
                }
            });
            
            const names = { modern: 'Modern', classic: 'Classic', minimal: 'Minimal', corporate: 'Corporate', creative: 'Creative' };
            const nameEl = document.getElementById('currentTemplateName');
            if (nameEl) nameEl.textContent = names[templateId] || 'Modern';
        }
        
        // ==================== AI CONFIGURATION ====================
        function updateAIProviderSettings() {
            const provider = document.getElementById('aiProviderSelect')?.value || 'together';
            const cloudSettings = document.getElementById('cloudAISettings');
            const localSettings = document.getElementById('localAISettings');
            const modelSelect = document.getElementById('aiModelSelect');
            
            const isLocal = ['ollama', 'lmstudio', 'gpt4all'].includes(provider);
            
            if (cloudSettings) cloudSettings.style.display = isLocal ? 'none' : 'block';
            if (localSettings) localSettings.style.display = isLocal ? 'block' : 'none';
            
            // Update model options based on provider
            if (modelSelect && !isLocal) {
                const models = {
                    together: ['auto', 'meta-llama/Llama-3.2-3B-Instruct-Turbo', 'mistralai/Mistral-7B-Instruct-v0.3'],
                    claude: ['claude-3-5-sonnet-latest', 'claude-3-opus-20240229', 'claude-3-haiku-20240307'],
                    openai: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo'],
                    google: ['gemini-pro', 'gemini-1.5-flash', 'gemini-1.5-pro']
                };
                
                modelSelect.innerHTML = (models[provider] || ['auto']).map(m => 
                    `<option value="${m}">${m}</option>`
                ).join('');
            }
            
            // Set default local URL
            if (isLocal) {
                const urlInput = document.getElementById('localAIUrl');
                const defaults = { ollama: 'http://localhost:11434', lmstudio: 'http://localhost:1234', gpt4all: 'http://localhost:4891' };
                if (urlInput && !urlInput.value) {
                    urlInput.value = defaults[provider] || 'http://localhost:11434';
                }
            }
        }
        
        function saveAIConfig() {
            const provider = document.getElementById('aiProviderSelect')?.value || 'together';
            const isLocal = ['ollama', 'lmstudio', 'gpt4all'].includes(provider);
            
            const config = {
                provider: provider,
                apiKey: isLocal ? null : document.getElementById('aiApiKeyInput')?.value || '',
                model: isLocal ? document.getElementById('localAIModel')?.value : document.getElementById('aiModelSelect')?.value || 'auto',
                localUrl: isLocal ? document.getElementById('localAIUrl')?.value : null,
                offlineEnabled: document.getElementById('enableOfflineAI')?.checked !== false,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('conicore_ai_config', JSON.stringify(config));
            
            // Also update settings object
            settings.aiProvider = config.provider;
            settings.aiApiKey = config.apiKey;
            settings.aiModel = config.model;
            settings.aiLocalUrl = config.localUrl;
            saveSettings();
            
            showToast('ðŸ’¾ AI configuration saved!', 'success');
        }
        
        function loadAIConfig() {
            const config = JSON.parse(localStorage.getItem('conicore_ai_config') || '{}');
            
            if (document.getElementById('aiProviderSelect')) {
                document.getElementById('aiProviderSelect').value = config.provider || 'together';
                updateAIProviderSettings();
                
                if (config.apiKey) document.getElementById('aiApiKeyInput').value = config.apiKey;
                if (config.model) {
                    const modelSelect = document.getElementById('aiModelSelect');
                    const localModel = document.getElementById('localAIModel');
                    if (['ollama', 'lmstudio', 'gpt4all'].includes(config.provider)) {
                        if (localModel) localModel.value = config.model;
                    } else if (modelSelect) {
                        modelSelect.value = config.model;
                    }
                }
                if (config.localUrl) document.getElementById('localAIUrl').value = config.localUrl;
                if (document.getElementById('enableOfflineAI')) {
                    document.getElementById('enableOfflineAI').checked = config.offlineEnabled !== false;
                }
            }
        }

        // ============================================
        // ENTERPRISE API KEY MANAGEMENT SYSTEM
        // ============================================

        // Simple encryption for API keys (AES-like obfuscation for localStorage)
        const keyEncryption = {
            encode: (str) => {
                if (!str) return '';
                const salt = 'conicore_secure_2024';
                return btoa(salt + str.split('').reverse().join('') + salt);
            },
            decode: (str) => {
                if (!str) return '';
                try {
                    const salt = 'conicore_secure_2024';
                    const decoded = atob(str);
                    return decoded.replace(salt, '').replace(salt, '').split('').reverse().join('');
                } catch { return ''; }
            }
        };

        // Get API key pool from storage
        function getApiKeyPool() {
            try {
                return JSON.parse(localStorage.getItem('conicore_api_key_pool') || '[]');
            } catch { return []; }
        }

        // Save API key pool to storage
        function saveApiKeyPool(pool) {
            localStorage.setItem('conicore_api_key_pool', JSON.stringify(pool));
        }

        // Open Add API Key Modal
        function openAddApiKeyModal() {
            // Reset form
            document.getElementById('newKeyProvider').value = '';
            document.getElementById('newApiKeyValue').value = '';
            document.getElementById('newLocalUrl').value = '';
            document.getElementById('newKeyNickname').value = '';
            document.getElementById('newKeyTier').value = 'primary';
            document.getElementById('newKeyBudget').value = '';
            document.getElementById('keyAssignAll').checked = true;
            document.getElementById('keyProviderInfo').style.display = 'none';
            document.getElementById('apiKeyInputGroup').style.display = 'block';
            document.getElementById('localUrlGroup').style.display = 'none';

            // Populate company list
            populateKeyCompanyList();

            openModal('addApiKeyModal');
        }

        // Populate company list for key assignment
        function populateKeyCompanyList() {
            const container = document.getElementById('keyCompanyAssignment');
            const companies = JSON.parse(localStorage.getItem('conicore_companies') || '[]');

            let html = `
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(6, 255, 165, 0.1); margin-bottom: 0.5rem;">
                    <input type="checkbox" id="keyAssignAll" checked onchange="toggleAllCompanyAssignment()">
                    <span>ðŸŒ All Companies (Shared Pool)</span>
                </label>
            `;

            companies.forEach(company => {
                html += `
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; margin-left: 1rem;" class="company-assign-item">
                        <input type="checkbox" class="company-key-assign" value="${company.id}" disabled>
                        <span>${company.name}</span>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        // Toggle all company assignment
        function toggleAllCompanyAssignment() {
            const allChecked = document.getElementById('keyAssignAll').checked;
            document.querySelectorAll('.company-key-assign').forEach(cb => {
                cb.disabled = allChecked;
                if (allChecked) cb.checked = false;
            });
        }

        // Update provider info when selection changes
        function updateKeyProviderInfo() {
            const provider = document.getElementById('newKeyProvider').value;
            const infoDiv = document.getElementById('keyProviderInfo');
            const apiKeyGroup = document.getElementById('apiKeyInputGroup');
            const localUrlGroup = document.getElementById('localUrlGroup');

            const providerInfo = {
                // GLM Series (ZhipuAI) - Top Recommended
                'glm-api': { name: 'GLM-4.6 API', url: 'https://docs.z.ai/guides/llm/glm-4.6', free: false, note: '355B model with 200K context. Best for agents, reasoning & coding. API via Z.ai platform.' },
                'glm-local': { name: 'GLM-4.5-Air (Self-Hosted)', url: 'https://huggingface.co/zai-org/GLM-4.5-Air', local: true, note: '106B-A12B MoE model. Requires 2-4x H100 GPUs. MIT licensed, commercial use OK.' },
                'glm-v': { name: 'GLM-4.6V Vision', url: 'https://docs.z.ai', free: false, note: 'Multimodal: document/invoice scanning, GUI agents, 128K context. Perfect for invoice processing!' },
                'glm-sglang': { name: 'GLM via SGLang', url: 'http://localhost:8000', local: true, note: 'Self-host GLM with SGLang. Fast inference with speculative decoding. See deployment guide.' },
                'glm-vllm': { name: 'GLM via vLLM', url: 'http://localhost:8000', local: true, note: 'Self-host GLM with vLLM. Supports FP8 quantization. CPU offload available.' },
                // Other Cloud Providers
                together: { name: 'Together AI', url: 'https://api.together.xyz', free: true, note: 'Free tier: 1M tokens/month. Great for getting started!' },
                openai: { name: 'OpenAI', url: 'https://platform.openai.com/api-keys', free: false, note: 'GPT-4o recommended. ~$0.01 per 1K tokens.' },
                anthropic: { name: 'Anthropic', url: 'https://console.anthropic.com', free: false, note: 'Claude 3.5 Sonnet recommended. Best for complex analysis.' },
                google: { name: 'Google AI', url: 'https://aistudio.google.com/apikey', free: true, note: 'Gemini Pro free tier available. Good for general use.' },
                groq: { name: 'Groq', url: 'https://console.groq.com', free: true, note: 'Ultra-fast inference. Free tier: 14K tokens/min.' },
                mistral: { name: 'Mistral AI', url: 'https://console.mistral.ai', free: false, note: 'European AI provider. Good privacy compliance.' },
                // Local LLM
                ollama: { name: 'Ollama', url: 'http://localhost:11434', local: true, note: 'Run locally. No API costs. Full privacy.' },
                lmstudio: { name: 'LM Studio', url: 'http://localhost:1234', local: true, note: 'GUI for local models. Easy to use.' }
            };

            if (provider && providerInfo[provider]) {
                const info = providerInfo[provider];
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <strong>${info.name}</strong>
                        ${info.free ? '<span style="background: #06ffa5; color: #000; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 700;">FREE TIER</span>' : ''}
                        ${info.local ? '<span style="background: #7209b7; color: #fff; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 700;">LOCAL</span>' : ''}
                    </div>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.8;">${info.note}</p>
                    ${!info.local ? `<a href="${info.url}" target="_blank" style="color: #00d4ff; font-size: 0.85rem;">ðŸ”— Get API Key</a>` : ''}
                `;

                // Show/hide appropriate input fields
                if (info.local) {
                    apiKeyGroup.style.display = 'none';
                    localUrlGroup.style.display = 'block';
                    document.getElementById('newLocalUrl').value = info.url;
                } else {
                    apiKeyGroup.style.display = 'block';
                    localUrlGroup.style.display = 'none';
                }
            } else {
                infoDiv.style.display = 'none';
                apiKeyGroup.style.display = 'block';
                localUrlGroup.style.display = 'none';
            }
        }

        // Toggle API key visibility
        function toggleKeyVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Save API key to pool
        function saveApiKeyToPool() {
            const provider = document.getElementById('newKeyProvider').value;
            const apiKey = document.getElementById('newApiKeyValue').value;
            const localUrl = document.getElementById('newLocalUrl').value;
            const nickname = document.getElementById('newKeyNickname').value;
            const tier = document.getElementById('newKeyTier').value;
            const budget = parseFloat(document.getElementById('newKeyBudget').value) || 0;
            const assignAll = document.getElementById('keyAssignAll').checked;

            if (!provider) {
                showToast('Please select a provider', 'error');
                return;
            }

            const isLocal = ['ollama', 'lmstudio'].includes(provider);
            if (!isLocal && !apiKey) {
                showToast('Please enter an API key', 'error');
                return;
            }

            // Get assigned companies
            let assignedCompanies = [];
            if (!assignAll) {
                document.querySelectorAll('.company-key-assign:checked').forEach(cb => {
                    assignedCompanies.push(cb.value);
                });
            }

            const pool = getApiKeyPool();
            const newKey = {
                id: 'key_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                provider: provider,
                encryptedKey: isLocal ? null : keyEncryption.encode(apiKey),
                localUrl: isLocal ? localUrl : null,
                nickname: nickname || `${provider.toUpperCase()} Key ${pool.length + 1}`,
                tier: tier,
                budget: budget,
                assignedCompanies: assignAll ? 'all' : assignedCompanies,
                status: 'active',
                usage: { requests: 0, tokens: 0, cost: 0 },
                createdAt: new Date().toISOString(),
                lastUsed: null
            };

            pool.push(newKey);
            saveApiKeyPool(pool);

            closeModal('addApiKeyModal');
            refreshApiKeyTable();
            showToast('ðŸ” API key added to pool!', 'success');
        }

        // Refresh API key table display
        function refreshApiKeyTable() {
            const pool = getApiKeyPool();
            const tbody = document.getElementById('apiKeyPoolTable');

            if (!tbody) return;

            if (pool.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; opacity: 0.6;">No API keys configured. Click "Add API Key" to get started.</td></tr>';
                updateApiKeyStats();
                return;
            }

            const providerIcons = {
                together: 'ðŸ†“', openai: 'ðŸ¤–', anthropic: 'ðŸ§ ', google: 'ðŸ”®',
                groq: 'âš¡', mistral: 'ðŸŒ¬ï¸', ollama: 'ðŸ¦™', lmstudio: 'ðŸŽ›ï¸'
            };

            const tierBadges = {
                primary: { bg: 'linear-gradient(135deg, #ffd700, #ff8c00)', color: '#000', icon: 'ðŸ¥‡' },
                secondary: { bg: 'linear-gradient(135deg, #c0c0c0, #a0a0a0)', color: '#000', icon: 'ðŸ¥ˆ' },
                backup: { bg: 'linear-gradient(135deg, #cd7f32, #8b4513)', color: '#fff', icon: 'ðŸ¥‰' }
            };

            tbody.innerHTML = pool.map(key => {
                const tier = tierBadges[key.tier] || tierBadges.primary;
                const maskedKey = key.encryptedKey ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + keyEncryption.decode(key.encryptedKey).slice(-4) : (key.localUrl || 'Local');
                const statusColor = key.status === 'active' ? '#06ffa5' : (key.status === 'paused' ? '#ffbe0b' : '#ff006e');

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.25rem;">${providerIcons[key.provider] || 'ðŸ”‘'}</span>
                                <div>
                                    <div style="font-weight: 600;">${key.nickname}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.6;">${key.provider.toUpperCase()}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 1rem; font-family: monospace; font-size: 0.85rem;">${maskedKey}</td>
                        <td style="padding: 1rem;">
                            <span style="background: ${tier.bg}; color: ${tier.color}; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">
                                ${tier.icon} ${key.tier.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 0.85rem;">${key.usage?.requests || 0} requests</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">$${(key.usage?.cost || 0).toFixed(2)} spent</div>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="color: ${statusColor}; font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">
                                ${key.status === 'active' ? 'â— Active' : (key.status === 'paused' ? 'â— Paused' : 'â—‹ Disabled')}
                            </span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-outline btn-sm" onclick="toggleKeyStatus('${key.id}')" title="${key.status === 'active' ? 'Pause' : 'Activate'}">
                                    ${key.status === 'active' ? 'â¸ï¸' : 'â–¶ï¸'}
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="rotateApiKey('${key.id}')" title="Rotate Key">ðŸ”„</button>
                                <button class="btn btn-outline btn-sm" onclick="deleteApiKey('${key.id}')" title="Delete" style="color: #ff006e;">ðŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateApiKeyStats();
        }

        // Update API key statistics
        function updateApiKeyStats() {
            const pool = getApiKeyPool();

            document.getElementById('totalApiKeysCount').textContent = pool.length;
            document.getElementById('activeApiKeysCount').textContent = pool.filter(k => k.status === 'active').length;

            // Count assigned clients
            const companies = JSON.parse(localStorage.getItem('conicore_companies') || '[]');
            let assignedCount = 0;
            pool.forEach(key => {
                if (key.assignedCompanies === 'all') {
                    assignedCount = companies.length;
                } else if (Array.isArray(key.assignedCompanies)) {
                    assignedCount += key.assignedCompanies.length;
                }
            });
            document.getElementById('assignedClientsCount').textContent = Math.min(assignedCount, companies.length);

            // Total usage
            const totalRequests = pool.reduce((sum, k) => sum + (k.usage?.requests || 0), 0);
            document.getElementById('totalAiUsageCount').textContent = totalRequests.toLocaleString();
        }

        // Toggle key status (active/paused)
        function toggleKeyStatus(keyId) {
            const pool = getApiKeyPool();
            const key = pool.find(k => k.id === keyId);
            if (key) {
                key.status = key.status === 'active' ? 'paused' : 'active';
                saveApiKeyPool(pool);
                refreshApiKeyTable();
                showToast(`Key ${key.status === 'active' ? 'activated' : 'paused'}`, 'success');
            }
        }

        // Delete API key
        function deleteApiKey(keyId) {
            if (!confirm('Are you sure you want to delete this API key?')) return;

            let pool = getApiKeyPool();
            pool = pool.filter(k => k.id !== keyId);
            saveApiKeyPool(pool);
            refreshApiKeyTable();
            showToast('API key deleted', 'success');
        }

        // Rotate API key (prompt for new key)
        function rotateApiKey(keyId) {
            const pool = getApiKeyPool();
            const key = pool.find(k => k.id === keyId);
            if (!key) return;

            const newKeyValue = prompt(`Enter new API key for ${key.nickname}:`);
            if (newKeyValue) {
                key.encryptedKey = keyEncryption.encode(newKeyValue);
                key.lastRotated = new Date().toISOString();
                saveApiKeyPool(pool);
                refreshApiKeyTable();
                showToast('ðŸ”„ API key rotated successfully!', 'success');
            }
        }

        // Rotate all keys
        function rotateAllKeys() {
            if (!confirm('This will prompt you to enter new keys for all active API keys. Continue?')) return;

            const pool = getApiKeyPool();
            let rotated = 0;

            pool.forEach(key => {
                if (key.status === 'active' && key.encryptedKey) {
                    const newKeyValue = prompt(`Enter new API key for ${key.nickname} (or cancel to skip):`);
                    if (newKeyValue) {
                        key.encryptedKey = keyEncryption.encode(newKeyValue);
                        key.lastRotated = new Date().toISOString();
                        rotated++;
                    }
                }
            });

            saveApiKeyPool(pool);
            refreshApiKeyTable();
            showToast(`ðŸ”„ Rotated ${rotated} API keys`, 'success');
        }

        // Import client API key
        function importClientApiKey() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    if (data.provider && (data.apiKey || data.localUrl)) {
                        const pool = getApiKeyPool();
                        pool.push({
                            id: 'key_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            provider: data.provider,
                            encryptedKey: data.apiKey ? keyEncryption.encode(data.apiKey) : null,
                            localUrl: data.localUrl || null,
                            nickname: data.nickname || `Imported ${data.provider.toUpperCase()} Key`,
                            tier: data.tier || 'secondary',
                            budget: data.budget || 0,
                            assignedCompanies: data.companyId ? [data.companyId] : 'all',
                            status: 'active',
                            usage: { requests: 0, tokens: 0, cost: 0 },
                            createdAt: new Date().toISOString(),
                            lastUsed: null,
                            importedFrom: file.name
                        });
                        saveApiKeyPool(pool);
                        refreshApiKeyTable();
                        showToast('ðŸ“¥ API key imported successfully!', 'success');
                    } else {
                        showToast('Invalid key file format', 'error');
                    }
                } catch (err) {
                    showToast('Failed to import key file', 'error');
                }
            };
            input.click();
        }

        // Export usage report
        function exportKeyUsageReport() {
            const pool = getApiKeyPool();
            const report = {
                generatedAt: new Date().toISOString(),
                summary: {
                    totalKeys: pool.length,
                    activeKeys: pool.filter(k => k.status === 'active').length,
                    totalRequests: pool.reduce((sum, k) => sum + (k.usage?.requests || 0), 0),
                    totalCost: pool.reduce((sum, k) => sum + (k.usage?.cost || 0), 0)
                },
                keys: pool.map(k => ({
                    nickname: k.nickname,
                    provider: k.provider,
                    tier: k.tier,
                    status: k.status,
                    usage: k.usage,
                    createdAt: k.createdAt,
                    lastUsed: k.lastUsed
                }))
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-key-usage-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('ðŸ“Š Usage report exported!', 'success');
        }

        // Open Local LLM Guide
        function openLocalLLMGuide() {
            openModal('localLLMGuideModal');
        }

        // Save local hosting quotas
        function saveLocalQuotas() {
            const quotas = {
                aiRequests: parseInt(document.getElementById('quotaAiRequests')?.value) || 100,
                invoices: parseInt(document.getElementById('quotaInvoices')?.value) || 500,
                storage: parseInt(document.getElementById('quotaStorage')?.value) || 500
            };
            localStorage.setItem('conicore_local_quotas', JSON.stringify(quotas));
            showToast('ðŸ’¾ Quotas saved!', 'success');
        }

        // Get best available API key for a request
        function getBestApiKey(provider = null, companyId = null) {
            const pool = getApiKeyPool();

            // Filter by provider if specified
            let candidates = pool.filter(k => k.status === 'active');
            if (provider) {
                candidates = candidates.filter(k => k.provider === provider);
            }

            // Filter by company assignment
            if (companyId) {
                candidates = candidates.filter(k =>
                    k.assignedCompanies === 'all' ||
                    (Array.isArray(k.assignedCompanies) && k.assignedCompanies.includes(companyId))
                );
            }

            // Sort by tier priority
            const tierOrder = { primary: 0, secondary: 1, backup: 2 };
            candidates.sort((a, b) => (tierOrder[a.tier] || 99) - (tierOrder[b.tier] || 99));

            // Check budget limits
            for (const key of candidates) {
                if (key.budget === 0 || (key.usage?.cost || 0) < key.budget) {
                    return {
                        provider: key.provider,
                        apiKey: key.encryptedKey ? keyEncryption.decode(key.encryptedKey) : null,
                        localUrl: key.localUrl,
                        keyId: key.id
                    };
                }
            }

            return null; // No available key
        }

        // Track API key usage
        function trackApiKeyUsage(keyId, tokens = 0, cost = 0) {
            const pool = getApiKeyPool();
            const key = pool.find(k => k.id === keyId);
            if (key) {
                key.usage = key.usage || { requests: 0, tokens: 0, cost: 0 };
                key.usage.requests++;
                key.usage.tokens += tokens;
                key.usage.cost += cost;
                key.lastUsed = new Date().toISOString();
                saveApiKeyPool(pool);
            }
        }

        async function testAIConnection() {
            const resultDiv = document.getElementById('aiTestResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(255, 190, 11, 0.1)';
            resultDiv.style.border = '1px solid rgba(255, 190, 11, 0.3)';
            resultDiv.innerHTML = 'â³ Testing connection...';

            const provider = document.getElementById('aiProviderSelect')?.value || 'together';
            const apiKey = document.getElementById('aiApiKeyInput')?.value || '';
            const isLocal = ['ollama', 'lmstudio', 'gpt4all'].includes(provider);

            try {
                if (isLocal) {
                    const url = document.getElementById('localAIUrl')?.value || 'http://localhost:11434';
                    const response = await fetch(url.replace(/\/$/, '') + '/api/tags', { method: 'GET' });

                    if (response.ok) {
                        const data = await response.json();
                        const models = data.models?.map(m => m.name).join(', ') || 'Connected';
                        resultDiv.style.background = 'rgba(6, 255, 165, 0.1)';
                        resultDiv.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                        resultDiv.innerHTML = `âœ… <strong>Connected to ${provider}!</strong><br>Available models: ${models}`;
                    } else {
                        throw new Error('Could not connect');
                    }
                } else if (provider === 'google' && apiKey) {
                    // Test Gemini API
                    const response = await fetch('/api/ai-gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'chat', message: 'Say OK', apiKey })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        resultDiv.style.background = 'rgba(6, 255, 165, 0.1)';
                        resultDiv.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                        resultDiv.innerHTML = `âœ… <strong>Gemini connected!</strong><br>Model: ${data.model || 'gemini-1.5-flash'}`;
                    } else {
                        const err = await response.json();
                        throw new Error(err.message || 'Gemini API error');
                    }
                } else if (provider === 'claude' && apiKey) {
                    // Test Claude API
                    const response = await fetch('/api/ai-claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'chat', message: 'Say OK', apiKey })
                    });
                    if (response.ok) {
                        resultDiv.style.background = 'rgba(6, 255, 165, 0.1)';
                        resultDiv.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                        resultDiv.innerHTML = `âœ… <strong>Claude connected!</strong>`;
                    } else {
                        throw new Error('Claude API error');
                    }
                } else if (provider === 'openai' && apiKey) {
                    // Test OpenAI API directly
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    if (response.ok) {
                        resultDiv.style.background = 'rgba(6, 255, 165, 0.1)';
                        resultDiv.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                        resultDiv.innerHTML = `âœ… <strong>OpenAI connected!</strong>`;
                    } else {
                        throw new Error('Invalid OpenAI API key');
                    }
                } else if (provider === 'together') {
                    // Together AI is free and always works
                    resultDiv.style.background = 'rgba(6, 255, 165, 0.1)';
                    resultDiv.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                    resultDiv.innerHTML = `âœ… <strong>Together AI (FREE)</strong><br>No API key required for basic features`;
                } else {
                    resultDiv.style.background = 'rgba(255, 190, 11, 0.1)';
                    resultDiv.style.border = '1px solid rgba(255, 190, 11, 0.3)';
                    resultDiv.innerHTML = `âš ï¸ <strong>${provider} configured</strong><br>Add API key for full functionality`;
                }
            } catch (error) {
                resultDiv.style.background = 'rgba(247, 37, 133, 0.1)';
                resultDiv.style.border = '1px solid rgba(247, 37, 133, 0.3)';
                resultDiv.innerHTML = `âŒ <strong>Connection failed:</strong> ${error.message}<br>Check your API key or server connection.`;
            }
        }

        // Get AI endpoint based on provider
        function getAIEndpoint(provider) {
            const endpoints = {
                together: '/api/ai-chatbot',
                claude: '/api/ai-claude',
                openai: '/api/ai-chatbot', // Uses Together as fallback
                google: '/api/ai-gemini',
                ollama: null, // Local
                lmstudio: null, // Local
                gpt4all: null // Local
            };
            return endpoints[provider] || '/api/ai-chatbot';
        }

        // ==================== AI SETUP WIZARD ====================
        let wizardState = { step: 1, mode: null, config: {} };

        function openAISetupWizard() {
            wizardState = { step: 1, mode: null, config: {} };
            updateWizardUI();
            openModal('aiSetupWizardModal');
        }

        function selectAIMode(mode) {
            wizardState.mode = mode;
            document.querySelectorAll('.ai-mode-card').forEach(card => {
                card.style.border = '2px solid rgba(255,255,255,0.1)';
            });
            event.currentTarget.style.border = '2px solid #06ffa5';
            event.currentTarget.style.boxShadow = '0 0 20px rgba(6, 255, 165, 0.3)';
            document.getElementById('wizardNextBtn').style.display = 'block';
        }

        function wizardNext() {
            wizardState.step++;
            updateWizardUI();
        }

        function wizardBack() {
            wizardState.step--;
            updateWizardUI();
        }

        function updateWizardUI() {
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`wizardStep${i}`);
                if (step) {
                    step.style.opacity = i <= wizardState.step ? '1' : '0.5';
                    step.querySelector('span').style.background = i <= wizardState.step ? 'var(--primary)' : 'rgba(255,255,255,0.2)';
                }
            }

            // Show/hide pages
            document.getElementById('wizardPage1').style.display = wizardState.step === 1 ? 'block' : 'none';
            document.getElementById('wizardPage2').style.display = wizardState.step === 2 ? 'block' : 'none';
            document.getElementById('wizardPage3').style.display = wizardState.step === 3 ? 'block' : 'none';

            // Update buttons
            document.getElementById('wizardBackBtn').style.display = wizardState.step > 1 ? 'block' : 'none';
            document.getElementById('wizardNextBtn').style.display = wizardState.step === 1 && wizardState.mode ? 'block' :
                                                                      wizardState.step === 2 ? 'block' : 'none';
            document.getElementById('wizardFinishBtn').style.display = wizardState.step === 3 ? 'block' : 'none';

            // Populate step 2 content
            if (wizardState.step === 2) populateWizardConfig();
            if (wizardState.step === 3) runWizardTest();
        }

        function populateWizardConfig() {
            const content = document.getElementById('wizardConfigContent');
            if (wizardState.mode === 'free') {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                        <h4 style="color: #06ffa5;">No Configuration Needed!</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Together AI is free and works out of the box.</p>
                        <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; text-align: left;">
                            <p style="margin: 0;"><strong>âœ“</strong> AI Chat & Insights</p>
                            <p style="margin: 0.5rem 0;"><strong>âœ“</strong> Product Recommendations</p>
                            <p style="margin: 0;"><strong>âœ“</strong> Payment Follow-ups</p>
                        </div>
                    </div>`;
                wizardState.config = { provider: 'together', model: 'auto' };
            } else if (wizardState.mode === 'local') {
                content.innerHTML = `
                    <h4 style="margin-bottom: 1rem;">ðŸ  Local AI Setup</h4>
                    <div style="background: rgba(114, 9, 183, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p style="margin: 0; font-size: 0.9rem;">ðŸ“¥ First, install Ollama from <a href="https://ollama.com" target="_blank" style="color: #00d4ff;">ollama.com</a></p>
                        <p style="margin: 0.5rem 0 0; font-size: 0.85rem; opacity: 0.8;">Then run: <code>ollama pull llama3.1:8b</code></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ollama Server URL</label>
                        <input type="text" class="form-control" id="wizardLocalUrl" value="http://localhost:11434" placeholder="http://localhost:11434">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <select class="form-control" id="wizardLocalModel">
                            <option value="llama3.1:8b">Llama 3.1 8B (Recommended)</option>
                            <option value="mistral:7b">Mistral 7B (Fast)</option>
                            <option value="llama3.2:3b">Llama 3.2 3B (Lightweight)</option>
                        </select>
                    </div>`;
            } else if (wizardState.mode === 'premium') {
                content.innerHTML = `
                    <h4 style="margin-bottom: 1rem;">âš¡ Premium Cloud AI</h4>
                    <div class="form-group">
                        <label class="form-label">Provider</label>
                        <select class="form-control" id="wizardPremiumProvider" onchange="updateWizardPremiumFields()">
                            <option value="claude">Claude (Anthropic) - Best Quality</option>
                            <option value="google">Google Gemini - Free Tier Available</option>
                            <option value="openai">OpenAI GPT-4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-control" id="wizardApiKey" placeholder="Enter your API key...">
                    </div>
                    <div id="wizardApiHelp" style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem;">
                        ðŸ“Œ Get Claude key: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #00d4ff;">console.anthropic.com</a>
                    </div>`;
            }
        }

        function updateWizardPremiumFields() {
            const provider = document.getElementById('wizardPremiumProvider')?.value;
            const helpDiv = document.getElementById('wizardApiHelp');
            const links = {
                claude: 'ðŸ“Œ Get Claude key: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #00d4ff;">console.anthropic.com</a>',
                google: 'ðŸ“Œ Get Gemini key: <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #00d4ff;">makersuite.google.com</a>',
                openai: 'ðŸ“Œ Get OpenAI key: <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #00d4ff;">platform.openai.com</a>'
            };
            if (helpDiv) helpDiv.innerHTML = links[provider] || '';
        }

        async function runWizardTest() {
            const testIcon = document.getElementById('wizardTestIcon');
            const testTitle = document.getElementById('wizardTestTitle');
            const testMsg = document.getElementById('wizardTestMessage');
            const testResult = document.getElementById('wizardTestResult');

            testIcon.textContent = 'â³';
            testTitle.textContent = 'Testing Connection...';
            testResult.style.display = 'none';

            try {
                if (wizardState.mode === 'free') {
                    wizardState.config = { provider: 'together', model: 'auto' };
                    await new Promise(r => setTimeout(r, 1000));
                    testIcon.textContent = 'âœ…';
                    testTitle.textContent = 'Ready to Go!';
                    testMsg.textContent = 'Together AI (FREE) is configured and working';
                } else if (wizardState.mode === 'local') {
                    const url = document.getElementById('wizardLocalUrl')?.value || 'http://localhost:11434';
                    const model = document.getElementById('wizardLocalModel')?.value || 'llama3.1:8b';
                    const response = await fetch(url + '/api/tags');
                    if (response.ok) {
                        wizardState.config = { provider: 'ollama', localUrl: url, model };
                        testIcon.textContent = 'âœ…';
                        testTitle.textContent = 'Local AI Connected!';
                        testMsg.textContent = `Ollama is running at ${url}`;
                    } else {
                        throw new Error('Could not connect to Ollama');
                    }
                } else if (wizardState.mode === 'premium') {
                    const provider = document.getElementById('wizardPremiumProvider')?.value;
                    const apiKey = document.getElementById('wizardApiKey')?.value;
                    if (!apiKey) throw new Error('Please enter your API key');
                    wizardState.config = { provider, apiKey, model: 'auto' };
                    testIcon.textContent = 'âœ…';
                    testTitle.textContent = 'Premium AI Configured!';
                    testMsg.textContent = `${provider.charAt(0).toUpperCase() + provider.slice(1)} is ready to use`;
                }
                testResult.style.display = 'block';
                testResult.style.background = 'rgba(6, 255, 165, 0.1)';
                testResult.style.border = '1px solid rgba(6, 255, 165, 0.3)';
                testResult.innerHTML = 'ðŸŽ‰ Setup complete! Click "Finish Setup" to save.';
            } catch (error) {
                testIcon.textContent = 'âŒ';
                testTitle.textContent = 'Connection Failed';
                testMsg.textContent = error.message;
                testResult.style.display = 'block';
                testResult.style.background = 'rgba(247, 37, 133, 0.1)';
                testResult.style.border = '1px solid rgba(247, 37, 133, 0.3)';
                testResult.innerHTML = `Error: ${error.message}<br>Please go back and check your settings.`;
            }
        }

        function wizardFinish() {
            const config = wizardState.config;
            localStorage.setItem('conicore_ai_config', JSON.stringify(config));
            localStorage.setItem('ai_wizard_completed', 'true');
            closeModal('aiSetupWizardModal');
            loadAIConfig();
            showToast('ðŸ¤– AI configured successfully!', 'success');
        }

        // Check if wizard should auto-open on first visit
        function checkAIWizardFirstRun() {
            const completed = localStorage.getItem('ai_wizard_completed');
            const aiConfig = localStorage.getItem('conicore_ai_config');
            if (!completed && !aiConfig) {
                setTimeout(() => openAISetupWizard(), 2000);
            }
        }
        // ==================== END AI SETUP WIZARD ====================

        function downloadAIConfig() {
            const config = JSON.parse(localStorage.getItem('conicore_ai_config') || '{}');
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'conicore-ai-config.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('ðŸ“¥ AI config downloaded', 'success');
        }
        
        function uploadAIConfig(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        localStorage.setItem('conicore_ai_config', JSON.stringify(config));
                        loadAIConfig();
                        showToast('ðŸ“¤ AI config uploaded!', 'success');
                    } catch (err) {
                        showToast('Invalid config file', 'error');
                    }
                };
                reader.readAsText(input.files[0]);
            }
        }

        function getRoleColor(role) {
            const colors = {
                owner: 'linear-gradient(135deg, #ffd700, #ff8c00)',
                admin: 'linear-gradient(135deg, #7209b7, #560bad)',
                accountant: 'linear-gradient(135deg, #06ffa5, #004d00)',
                manager: 'linear-gradient(135deg, #00d4ff, #090979)',
                sales: 'linear-gradient(135deg, #ff006e, #ff6464)',
                user: 'linear-gradient(135deg, #ffbe0b, #fb5607)',
                viewer: 'linear-gradient(135deg, #808080, #404040)'
            };
            return colors[role] || colors.user;
        }
        
        function getRoleIcon(role) {
            const icons = {
                owner: 'ðŸ¢',
                admin: 'ðŸ‘‘',
                accountant: 'ðŸ’°',
                manager: 'ðŸ“Š',
                sales: 'ðŸ›’',
                user: 'ðŸ‘¤',
                viewer: 'ðŸ‘ï¸'
            };
            return icons[role] || 'ðŸ‘¤';
        }
        
        // Role descriptions for the add user modal
        function updateRoleDescription() {
            const role = document.getElementById('userRole').value;
            const descriptions = {
                owner: 'ðŸ¢ <strong>Owner</strong> - Full control over all businesses, can create/delete entities, merge companies, and access all financial data.',
                admin: 'ðŸ‘‘ <strong>Admin</strong> - Full system access including user management and settings, but cannot create new businesses.',
                accountant: 'ðŸ’° <strong>Accountant</strong> - Access to all financial data, reports, bank reconciliation. Cannot delete records.',
                manager: 'ðŸ“Š <strong>Manager</strong> - Manage invoices, customers, products and pricing. No user management access.',
                sales: 'ðŸ›’ <strong>Sales Rep</strong> - Create quotes and invoices, view customers and products. Cannot edit pricing.',
                user: 'ðŸ‘¤ <strong>Staff</strong> - Basic access to own invoices only. Can view but not edit others\' work.',
                viewer: 'ðŸ‘ï¸ <strong>View Only</strong> - Read-only access to dashboards and reports. Cannot create or edit anything.'
            };
            document.getElementById('roleDescription').innerHTML = descriptions[role] || '';
        }
        
        // Populate business access checkboxes
        function populateUserBusinessAccess(selectedBusinessIds = []) {
            const container = document.getElementById('userBusinessAccess');
            if (!container || !businesses) return;
            
            container.innerHTML = businesses.map(business => {
                const checked = selectedBusinessIds.includes(business.id) ? 'checked' : '';
                const parentInfo = business.parentId ? businesses.find(b => b.id === business.parentId) : null;
                const linkedText = parentInfo ? ` <span style="color: var(--primary); font-size: 0.8rem;">(â†’ ${parentInfo.name})</span>` : '';
                return `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; cursor: pointer;">
                        <input type="checkbox" name="userBusinessAccess" value="${business.id}" ${checked}>
                        <span>${business.name}${linkedText}</span>
                    </label>
                `;
            }).join('');
        }

        function openAddUserModal() {
            document.getElementById('addUserModalTitle').textContent = 'âž• Add New User';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('editUserId').value = '';
            
            // Populate business access (all selected by default for new users)
            populateUserBusinessAccess(businesses.map(b => b.id));
            updateRoleDescription();
            
            openModal('addUserModal');
        }

        function editUser(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }

            document.getElementById('addUserModalTitle').textContent = 'âœï¸ Edit User';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').placeholder = 'Leave blank to keep current password';
            document.getElementById('userPassword').required = false;
            document.getElementById('userRole').value = user.role;
            document.getElementById('editUserId').value = user.id;
            
            // Load user's business access
            populateUserBusinessAccess(user.businessAccess || businesses.map(b => b.id));
            updateRoleDescription();
            
            openModal('addUserModal');
        }

        function saveUser(event) {
            event.preventDefault();
            
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const editUserId = document.getElementById('editUserId').value;
            
            // Get selected business access
            const businessAccessCheckboxes = document.querySelectorAll('input[name="userBusinessAccess"]:checked');
            const businessAccess = Array.from(businessAccessCheckboxes).map(cb => cb.value);
            
            const userData = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                username: document.getElementById('userUsername').value.trim(),
                role: document.getElementById('userRole').value,
                provider: 'local',
                businessAccess: businessAccess
            };

            if (editUserId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id == editUserId);
                if (userIndex === -1) {
                    showToast('User not found', 'error');
                    return;
                }

                const password = document.getElementById('userPassword').value;
                if (password) {
                    userData.password = password;
                } else {
                    userData.password = users[userIndex].password; // Keep old password
                }

                users[userIndex] = { ...users[userIndex], ...userData };
                logActivity(`User ${userData.name} updated by admin`, 'admin');
                showToast('User updated successfully', 'success');
            } else {
                // Create new user
                const password = document.getElementById('userPassword').value;
                if (!password) {
                    showToast('Password is required for new users', 'error');
                    return;
                }

                // Check if username or email already exists
                if (users.some(u => u.username === userData.username)) {
                    showToast('Username already exists', 'error');
                    return;
                }
                if (users.some(u => u.email === userData.email)) {
                    showToast('Email already exists', 'error');
                    return;
                }

                userData.id = Date.now();
                userData.password = password;
                userData.createdAt = new Date().toISOString();
                users.push(userData);
                
                logActivity(`New user ${userData.name} created by admin`, 'admin');
                showToast('User created successfully', 'success');
            }

            localStorage.setItem('aweh_users', JSON.stringify(users));
            loadUsersTable();
            updateSystemStats();
            closeModal('addUserModal');
        }

        let userToDelete = null;

        function deleteUserPrompt(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (currentUser && currentUser.id == userId) {
                showToast('You cannot delete your own account', 'error');
                return;
            }

            userToDelete = userId;
            document.getElementById('confirmDeleteMessage').textContent = 
                `Are you sure you want to delete user "${user.name}" (${user.email})?`;
            openModal('confirmDeleteModal');
        }

        function confirmDeleteUser() {
            if (!userToDelete) return;

            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const userIndex = users.findIndex(u => u.id == userToDelete);
            
            if (userIndex === -1) {
                showToast('User not found', 'error');
                return;
            }

            const deletedUser = users[userIndex];
            users.splice(userIndex, 1);
            localStorage.setItem('aweh_users', JSON.stringify(users));
            
            logActivity(`User ${deletedUser.name} deleted by admin`, 'admin');
            showToast('User deleted successfully', 'success');
            
            loadUsersTable();
            updateSystemStats();
            closeModal('confirmDeleteModal');
            userToDelete = null;
        }

        function changeUserRole(userId) {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            if (currentUser && currentUser.id == userId) {
                showToast('You cannot change your own role', 'error');
                return;
            }

            // Cycle through roles: user -> manager -> admin -> user
            const roleOrder = ['user', 'manager', 'admin'];
            const currentIndex = roleOrder.indexOf(user.role);
            const nextIndex = (currentIndex + 1) % roleOrder.length;
            user.role = roleOrder[nextIndex];

            localStorage.setItem('aweh_users', JSON.stringify(users));
            logActivity(`User ${user.name} role changed to ${user.role} by admin`, 'admin');
            showToast(`User role updated to ${user.role}`, 'success');
            
            loadUsersTable();
            updateSystemStats();
        }

        function updateSystemStats() {
            const users = JSON.parse(localStorage.getItem('aweh_users') || '[]');
            
            document.getElementById('statTotalUsers').textContent = users.length;
            document.getElementById('statAdminUsers').textContent = users.filter(u => u.role === 'admin').length;
            document.getElementById('statManagerUsers').textContent = users.filter(u => u.role === 'manager').length;
            document.getElementById('statRegularUsers').textContent = users.filter(u => u.role === 'user').length;
            document.getElementById('statOAuthUsers').textContent = users.filter(u => u.provider !== 'local').length;
            
            // Active today (users who logged in today)
            const today = new Date().toDateString();
            const activityLog = JSON.parse(localStorage.getItem('aweh_activity_log') || '[]');
            const activeToday = new Set(
                activityLog
                    .filter(log => log.action.includes('logged in') && new Date(log.timestamp).toDateString() === today)
                    .map(log => log.username)
            ).size;
            document.getElementById('statActiveToday').textContent = activeToday;
        }

        function logActivity(action, username = 'system') {
            const log = {
                timestamp: new Date().toISOString(),
                action: action,
                username: username
            };

            const activityLog = JSON.parse(localStorage.getItem('aweh_activity_log') || '[]');
            activityLog.unshift(log); // Add to beginning

            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog.splice(100);
            }

            localStorage.setItem('aweh_activity_log', JSON.stringify(activityLog));
            
            // Refresh activity log display if on admin tab
            if (document.getElementById('admin')?.classList.contains('active')) {
                loadActivityLog();
            }
        }

        function loadActivityLog() {
            const activityLog = JSON.parse(localStorage.getItem('aweh_activity_log') || '[]');
            const container = document.getElementById('activityLog');
            
            if (activityLog.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No activity yet</p>';
                return;
            }

            container.innerHTML = activityLog.slice(0, 50).map(log => {
                const date = new Date(log.timestamp);
                const timeAgo = getTimeAgo(date);
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${log.action}</strong>
                            <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">by ${log.username}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; opacity: 0.7;">
                            <div>${timeAgo}</div>
                            <div style="font-size: 0.75rem;">${date.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }

        function clearActivityLog() {
            if (confirm('Are you sure you want to clear all activity logs?')) {
                localStorage.setItem('aweh_activity_log', '[]');
                loadActivityLog();
                showToast('Activity log cleared', 'success');
                logActivity('Activity log cleared by admin', 'admin');
            }
        }

        // ==================== QUICK STAFF REGISTRATION SYSTEM ====================
        
        // Generate a random login code
        function generateLoginCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No I, O, 0, 1 for clarity
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Generate a temporary password
        function generateTempPassword() {
            const words = ['Welcome', 'Start', 'Login', 'Access', 'Enter'];
            const word = words[Math.floor(Math.random() * words.length)];
            const num = Math.floor(Math.random() * 9000) + 1000;
            return word + num + '!';
        }
        
        // Quick add single user with login code
        async function quickAddUser() {
            const name = document.getElementById('quickAddName')?.value?.trim();
            const email = document.getElementById('quickAddEmail')?.value?.trim().toLowerCase();
            const role = document.getElementById('quickAddRole')?.value || 'user';
            
            if (!name || !email) {
                showToast('Please enter name and email', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
            
            // Check if email already exists
            if (users.some(u => u.email === email)) {
                showToast('A user with this email already exists', 'error');
                return;
            }
            
            const loginCode = generateLoginCode();
            const tempPassword = generateTempPassword();
            
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                username: email.split('@')[0],
                loginCode: loginCode,
                password: tempPassword, // Stored as plain text for admin visibility (temp only)
                tempPassword: tempPassword,
                requirePasswordChange: true,
                role: role,
                status: 'active',
                provider: 'code',
                createdAt: new Date().toISOString(),
                createdBy: JSON.parse(localStorage.getItem('conicore_user') || localStorage.getItem('aweh_user') || '{}').email || 'admin'
            };
            
            users.push(newUser);
            localStorage.setItem('conicore_users', JSON.stringify(users));
            
            // Clear form
            document.getElementById('quickAddName').value = '';
            document.getElementById('quickAddEmail').value = '';
            document.getElementById('quickAddRole').value = 'user';
            
            // Show login credentials
            showLoginCodeModal(newUser);
            
            // Refresh tables
            loadUsersTable();
            refreshLoginCodes();
            
            logActivity(`Created user ${name} with login code ${loginCode}`, 'admin');
        }
        
        // Show login code modal with copy options
        function showLoginCodeModal(user) {
            const modal = document.createElement('div');
            modal.id = 'loginCodeModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 2rem; border-radius: 16px; max-width: 450px; width: 90%; border: 2px solid var(--primary);">
                        <h2 style="margin-bottom: 1.5rem; text-align: center;">ðŸŽ« Login Credentials Created</h2>
                        
                        <div style="background: rgba(6, 255, 165, 0.1); padding: 1.25rem; border-radius: 12px; margin-bottom: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; opacity: 0.7;">User:</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${user.name}</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">${user.email}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.25rem;">LOGIN CODE</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; font-family: monospace; color: var(--primary); letter-spacing: 2px;">${user.loginCode}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.25rem;">TEMP PASSWORD</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; font-family: monospace; color: var(--warning);">${user.tempPassword}</div>
                                </div>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem; text-align: center;">
                            âš ï¸ User will be required to change password on first login
                        </p>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-outline" onclick="copyLoginCredentials('${user.loginCode}', '${user.tempPassword}', '${user.email}')" style="flex: 1;">
                                ðŸ“‹ Copy All
                            </button>
                            <button class="btn btn-outline" onclick="emailLoginCredentials('${user.email}', '${user.loginCode}', '${user.tempPassword}', '${user.name}')" style="flex: 1;">
                                âœ‰ï¸ Email User
                            </button>
                            <button class="btn btn-primary" onclick="closeLoginCodeModal()" style="flex: 1;">
                                âœ“ Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeLoginCodeModal() {
            const modal = document.getElementById('loginCodeModal');
            if (modal) modal.remove();
        }
        
        function copyLoginCredentials(code, password, email) {
            const text = `ConiCore Login Credentials\n\nEmail: ${email}\nLogin Code: ${code}\nTemporary Password: ${password}\n\nLogin at: ${window.location.origin}\n\nPlease change your password on first login.`;
            navigator.clipboard.writeText(text);
            showToast('Login credentials copied to clipboard!', 'success');
        }
        
        function emailLoginCredentials(email, code, password, name) {
            const subject = encodeURIComponent('Your ConiCore Login Credentials');
            const body = encodeURIComponent(
                `Hi ${name},\n\n` +
                `Your ConiCore account has been created!\n\n` +
                `Login Code: ${code}\n` +
                `Temporary Password: ${password}\n\n` +
                `Login at: ${window.location.origin}\n\n` +
                `Please change your password on first login.\n\n` +
                `Regards,\nConiCore Admin`
            );
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }
        
        // Process bulk staff import from CSV
        async function processBulkStaffImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(l => l.trim());
                    
                    if (lines.length < 2) {
                        showToast('CSV must have header row and at least one data row', 'error');
                        return;
                    }
                    
                    // Parse header
                    const header = lines[0].toLowerCase().split(',').map(h => h.trim());
                    const nameIdx = header.findIndex(h => h.includes('name'));
                    const emailIdx = header.findIndex(h => h.includes('email'));
                    const roleIdx = header.findIndex(h => h.includes('role'));
                    
                    if (nameIdx === -1 || emailIdx === -1) {
                        showToast('CSV must have "name" and "email" columns', 'error');
                        return;
                    }
                    
                    const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
                    const currentUser = JSON.parse(localStorage.getItem('conicore_user') || localStorage.getItem('aweh_user') || '{}');
                    const newUsers = [];
                    const skipped = [];
                    
                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',').map(c => c.trim());
                        const name = cols[nameIdx];
                        const email = cols[emailIdx]?.toLowerCase();
                        const role = (roleIdx !== -1 ? cols[roleIdx] : 'user') || 'user';
                        
                        if (!name || !email || !email.includes('@')) {
                            skipped.push(`Row ${i + 1}: Invalid data`);
                            continue;
                        }
                        
                        if (users.some(u => u.email === email)) {
                            skipped.push(`${email}: Already exists`);
                            continue;
                        }
                        
                        const loginCode = generateLoginCode();
                        const tempPassword = generateTempPassword();
                        
                        const newUser = {
                            id: Date.now() + i,
                            name: name,
                            email: email,
                            username: email.split('@')[0],
                            loginCode: loginCode,
                            password: tempPassword,
                            tempPassword: tempPassword,
                            requirePasswordChange: true,
                            role: role.toLowerCase(),
                            status: 'active',
                            provider: 'csv-import',
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser.email || 'admin'
                        };
                        
                        users.push(newUser);
                        newUsers.push(newUser);
                    }
                    
                    localStorage.setItem('conicore_users', JSON.stringify(users));
                    
                    // Show results
                    if (newUsers.length > 0) {
                        showToast(`âœ… Imported ${newUsers.length} users successfully!`, 'success');
                        
                        // Show summary modal
                        showBulkImportResults(newUsers, skipped);
                        
                        logActivity(`Bulk imported ${newUsers.length} users from CSV`, 'admin');
                    } else {
                        showToast('No new users were imported', 'warning');
                    }
                    
                    loadUsersTable();
                    refreshLoginCodes();
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    showToast('Error processing CSV file', 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset file input
        }
        
        // Show bulk import results
        function showBulkImportResults(users, skipped) {
            const modal = document.createElement('div');
            modal.id = 'bulkImportModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 2rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--success);">
                        <h2 style="margin-bottom: 1rem; text-align: center;">ðŸ“‹ Bulk Import Complete</h2>
                        
                        <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                            <span style="font-size: 2rem; font-weight: bold; color: var(--success);">${users.length}</span>
                            <span style="opacity: 0.8;"> users imported</span>
                        </div>
                        
                        ${skipped.length > 0 ? `
                            <div style="background: rgba(255, 190, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">
                                <strong>âš ï¸ Skipped (${skipped.length}):</strong><br>
                                ${skipped.slice(0, 5).join('<br>')}
                                ${skipped.length > 5 ? `<br>...and ${skipped.length - 5} more` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                            <table style="width: 100%; font-size: 0.85rem;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="padding: 0.5rem; text-align: left;">Name</th>
                                        <th style="padding: 0.5rem; text-align: left;">Login Code</th>
                                        <th style="padding: 0.5rem; text-align: left;">Temp Password</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(u => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <td style="padding: 0.5rem;">${u.name}</td>
                                            <td style="padding: 0.5rem; font-family: monospace; color: var(--primary);">${u.loginCode}</td>
                                            <td style="padding: 0.5rem; font-family: monospace; color: var(--warning);">${u.tempPassword}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="exportBulkCredentials()" style="flex: 1;">
                                ðŸ“¥ Export Credentials
                            </button>
                            <button class="btn btn-primary" onclick="this.closest('#bulkImportModal').remove()" style="flex: 1;">
                                âœ“ Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store for export
            window.lastBulkImport = users;
        }
        
        // Export bulk credentials as CSV
        function exportBulkCredentials() {
            const users = window.lastBulkImport || [];
            if (users.length === 0) {
                showToast('No credentials to export', 'error');
                return;
            }
            
            let csv = 'Name,Email,Login Code,Temporary Password,Role\n';
            users.forEach(u => {
                csv += `"${u.name}","${u.email}","${u.loginCode}","${u.tempPassword}","${u.role}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `staff-credentials-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Credentials exported!', 'success');
        }
        
        // Download staff template CSV
        function downloadStaffTemplate() {
            const csv = 'name,email,role\nJohn Doe,john@company.com,sales\nJane Smith,jane@company.com,manager\nBob Wilson,bob@company.com,user';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'staff-import-template.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Template downloaded!', 'success');
        }
        
        // Refresh and display active login codes
        function refreshLoginCodes() {
            const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
            const pendingUsers = users.filter(u => u.requirePasswordChange && u.loginCode);
            const container = document.getElementById('activeLoginCodes');
            
            if (!container) return;
            
            if (pendingUsers.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; font-size: 0.85rem;">No pending login codes.</p>';
                return;
            }
            
            container.innerHTML = pendingUsers.map(u => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.85rem;">
                    <div>
                        <div style="font-weight: 600;">${u.name}</div>
                        <div style="opacity: 0.7; font-size: 0.75rem;">${u.email}</div>
                    </div>
                    <div style="text-align: right;">
                        <code style="color: var(--primary);">${u.loginCode}</code>
                        <button class="btn btn-sm" style="padding: 0.1rem 0.3rem; margin-left: 0.25rem;" onclick="copyToClipboard('${u.loginCode}')">ðŸ“‹</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Reset user password
        function resetUserPassword(userId) {
            const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
            const user = users.find(u => u.id == userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            const choice = confirm(`Reset password for ${user.name}?\n\nClick OK to generate a new temporary password, or Cancel to set a custom password.`);
            
            let newPassword;
            if (choice) {
                newPassword = generateTempPassword();
            } else {
                newPassword = prompt(`Enter new password for ${user.name}:`, '');
                if (!newPassword || newPassword.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }
            }
            
            user.password = newPassword;
            user.tempPassword = newPassword;
            user.requirePasswordChange = true;
            user.passwordResetAt = new Date().toISOString();
            
            localStorage.setItem('conicore_users', JSON.stringify(users));
            
            // Show new password
            alert(`Password reset for ${user.name}\n\nNew Password: ${newPassword}\n\nUser will be required to change password on next login.`);
            
            loadUsersTable();
            refreshLoginCodes();
            logActivity(`Reset password for ${user.name}`, 'admin');
            showToast('Password reset successfully!', 'success');
        }
        
        // Export users report
        function exportUsersReport() {
            const users = JSON.parse(localStorage.getItem('conicore_users') || localStorage.getItem('aweh_users') || '[]');
            
            let csv = 'Name,Email,Username,Login Code,Role,Status,Provider,Created,Last Login,Password Status\n';
            users.forEach(u => {
                csv += `"${u.name}","${u.email}","${u.username}","${u.loginCode || 'N/A'}","${u.role}","${u.status || 'active'}","${u.provider || 'local'}","${u.createdAt || ''}","${u.lastLogin || 'Never'}","${u.requirePasswordChange ? 'Temp' : 'Set'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Users report exported!', 'success');
        }
        
        // Copy to clipboard helper
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!', 'success');
        }

        // ==================== END AUTHENTICATION & USER MANAGEMENT ====================
        
        // ==================== MULTI-TENANT COMPANY MANAGEMENT ====================
        
        let companyWizardStep = 1;
        let newCompanyData = {};
        let allTenantCompanies = [];
        
        // Initialize multi-tenant system
        function initMultiTenant() {
            // Load companies from storage
            allTenantCompanies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            
            // Check URL for company context
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('c') || urlParams.get('company');
            
            if (companyId) {
                loadCompanyContext(companyId);
            }
            
            // Update master admin dashboard if visible
            updateCompanyStats();
            loadCompanyList();
        }
        
        // Generate secure 8-character company login code
        function generateCompanyLoginCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Generate 12-character temp password
        function generateCompanyTempPassword() {
            const upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const lower = 'abcdefghjkmnpqrstuvwxyz';
            const nums = '23456789';
            const all = upper + lower + nums;
            
            let pwd = '';
            pwd += upper.charAt(Math.floor(Math.random() * upper.length));
            pwd += lower.charAt(Math.floor(Math.random() * lower.length));
            pwd += nums.charAt(Math.floor(Math.random() * nums.length));
            
            for (let i = 0; i < 9; i++) {
                pwd += all.charAt(Math.floor(Math.random() * all.length));
            }
            
            // Shuffle
            return pwd.split('').sort(() => Math.random() - 0.5).join('');
        }
        
        // Generate unique company ID
        function generateCompanyId(companyName) {
            const slug = companyName.toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .substring(0, 8);
            const suffix = Date.now().toString(36).substring(-4);
            return slug + suffix;
        }
        
        // Open create company modal
        function openCreateCompanyModal() {
            companyWizardStep = 1;
            newCompanyData = {};
            
            // Reset form
            document.querySelectorAll('#createCompanyModal input, #createCompanyModal textarea, #createCompanyModal select').forEach(el => {
                if (el.type === 'color') {
                    // Keep default colors
                } else if (el.type === 'radio') {
                    if (el.value === 'trial' || el.value === 'modern') el.checked = true;
                } else {
                    el.value = el.defaultValue || '';
                }
            });
            
            // Reset logo preview
            document.getElementById('newCoLogoPreview').innerHTML = `
                <div style="text-align: center; opacity: 0.7;">
                    <div style="font-size: 2.5rem;">ðŸ“·</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">Click to upload</div>
                </div>
            `;
            
            updateCompanyWizardUI();
            openModal('createCompanyModal');
        }
        
        // Update wizard UI based on step
        function updateCompanyWizardUI() {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById('companyStep' + i);
                if (step) step.style.display = 'none';
            }
            
            // Show current step
            const currentStep = document.getElementById('companyStep' + companyWizardStep);
            if (currentStep) currentStep.style.display = 'block';
            
            // Update progress bar
            const progress = ((companyWizardStep - 1) / 3) * 100;
            document.getElementById('companyWizardProgress').style.width = progress + '%';
            
            // Update step circles
            document.querySelectorAll('#createCompanyModal .wizard-step').forEach((el, idx) => {
                const circle = el.querySelector('.step-circle');
                if (idx + 1 < companyWizardStep) {
                    circle.style.background = 'linear-gradient(135deg, #06ffa5, #00d4ff)';
                    circle.style.color = '#000';
                    circle.innerHTML = 'âœ“';
                } else if (idx + 1 === companyWizardStep) {
                    circle.style.background = 'linear-gradient(135deg, #ffd700, #ff8c00)';
                    circle.style.color = '#000';
                    circle.innerHTML = idx + 1;
                } else {
                    circle.style.background = '#333';
                    circle.style.color = '#fff';
                    circle.innerHTML = idx + 1;
                }
            });
            
            // Update buttons
            document.getElementById('companyWizardPrev').style.display = companyWizardStep > 1 ? 'block' : 'none';
            document.getElementById('companyWizardNext').style.display = companyWizardStep < 4 ? 'block' : 'none';
            document.getElementById('companyWizardCreate').style.display = companyWizardStep === 4 ? 'block' : 'none';
            
            // Generate credentials on step 4 and check API status
            if (companyWizardStep === 4) {
                generateCompanyCredentials();
                checkWhatsAppApiStatus();
            }
        }
        
        // Navigate wizard
        function companyWizardNext() {
            // Validate current step
            if (companyWizardStep === 1) {
                const name = document.getElementById('newCoName').value.trim();
                const email = document.getElementById('newCoEmail').value.trim();
                const phone = document.getElementById('newCoPhone').value.trim();
                
                if (!name) { showToast('Please enter company name', 'error'); return; }
                if (!email) { showToast('Please enter email address', 'error'); return; }
                if (!phone) { showToast('Please enter phone number', 'error'); return; }
                
                // Save step 1 data
                newCompanyData.name = name;
                newCompanyData.tradingAs = document.getElementById('newCoTradingAs').value.trim();
                newCompanyData.regNo = document.getElementById('newCoRegNo').value.trim();
                newCompanyData.vatNo = document.getElementById('newCoVatNo').value.trim();
                newCompanyData.address = document.getElementById('newCoAddress').value.trim();
                newCompanyData.phone = phone;
                newCompanyData.whatsapp = document.getElementById('newCoWhatsApp').value.trim() || phone;
                newCompanyData.email = email;
                newCompanyData.website = document.getElementById('newCoWebsite').value.trim();
                newCompanyData.industry = document.getElementById('newCoIndustry').value;
            }
            
            if (companyWizardStep === 2) {
                // Save step 2 data
                newCompanyData.branding = {
                    primaryColor: document.getElementById('newCoPrimaryColor').value,
                    secondaryColor: document.getElementById('newCoSecondaryColor').value,
                    accentColor: document.getElementById('newCoAccentColor').value,
                    tagline: document.getElementById('newCoTagline').value.trim(),
                    template: document.getElementById('newCoTemplate').value,
                    logo: newCompanyData.logoBase64 || null
                };
            }
            
            if (companyWizardStep === 3) {
                // Save step 3 data
                newCompanyData.tier = document.querySelector('input[name="newCoTier"]:checked')?.value || 'trial';
                newCompanyData.settings = {
                    currency: document.getElementById('newCoCurrency').value,
                    taxRate: parseFloat(document.getElementById('newCoTaxRate').value) || 15,
                    invoicePrefix: document.getElementById('newCoInvoicePrefix').value || 'INV-',
                    paymentTerms: parseInt(document.getElementById('newCoPaymentTerms').value) || 30
                };
            }
            
            companyWizardStep++;
            updateCompanyWizardUI();
        }
        
        function companyWizardPrev() {
            if (companyWizardStep > 1) {
                companyWizardStep--;
                updateCompanyWizardUI();
            }
        }
        
        // Preview company logo
        function previewCompanyLogo(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Logo must be under 2MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create image to resize
                    const img = new Image();
                    img.onload = function() {
                        // Resize to 200x200
                        const canvas = document.createElement('canvas');
                        const size = 200;
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate crop
                        const minDim = Math.min(img.width, img.height);
                        const sx = (img.width - minDim) / 2;
                        const sy = (img.height - minDim) / 2;
                        
                        ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
                        
                        const resizedBase64 = canvas.toDataURL('image/png', 0.9);
                        newCompanyData.logoBase64 = resizedBase64;
                        
                        document.getElementById('newCoLogoPreview').innerHTML = `
                            <img src="${resizedBase64}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                        `;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Generate credentials for step 4
        function generateCompanyCredentials() {
            const companyId = generateCompanyId(newCompanyData.name);
            const loginCode = generateCompanyLoginCode();
            const tempPassword = generateCompanyTempPassword();
            const companyUrl = window.location.origin + '/COMPLETE-INVOICE-SYSTEM.html?c=' + companyId;
            
            newCompanyData.id = companyId;
            newCompanyData.loginCode = loginCode;
            newCompanyData.tempPassword = tempPassword;
            newCompanyData.url = companyUrl;
            
            document.getElementById('generatedCompanyUrl').textContent = companyUrl;
            document.getElementById('generatedLoginCode').textContent = loginCode;
            document.getElementById('generatedTempPassword').textContent = tempPassword;
            
            // Generate WhatsApp message
            const message = generateWhatsAppMessage();
            document.getElementById('whatsappMessagePreview').textContent = message;
        }
        
        // Generate WhatsApp message
        function generateWhatsAppMessage() {
            const msg = `ðŸŽ‰ *Welcome to ConiCore Invoicing!*

Hi ${newCompanyData.name},

Your account has been created! Here are your login details:

ðŸ”— *Login URL:*
${newCompanyData.url}

ðŸŽ« *Login Code:* ${newCompanyData.loginCode}
ðŸ”‘ *Temporary Password:* ${newCompanyData.tempPassword}

ðŸ“ *First Login Steps:*
1. Click the link above
2. Enter your login code and temp password
3. Complete the setup wizard (logo, colors, bank details)
4. Change your password

Need help? Contact support or reply to this message.

_Powered by ConiCore Technology_`;
            
            return msg;
        }
        
        // Copy WhatsApp message
        function copyWhatsAppMessage() {
            const msg = document.getElementById('whatsappMessagePreview').textContent;
            navigator.clipboard.writeText(msg);
            showToast('ðŸ“‹ WhatsApp message copied!', 'success');
        }
        
        // Copy WhatsApp message for group sharing
        function copyWhatsAppForGroup() {
            const msg = document.getElementById('whatsappMessagePreview').textContent;
            navigator.clipboard.writeText(msg);
            showToast('ðŸ‘¥ Copied! Paste into any WhatsApp group', 'success');
        }
        
        // Open WhatsApp with message
        function openWhatsAppWithMessage() {
            const msg = encodeURIComponent(document.getElementById('whatsappMessagePreview').textContent);
            const whatsappNum = document.getElementById('newCoWhatsApp')?.value?.trim() || newCompanyData.phone;
            const phone = whatsappNum.replace(/[^0-9]/g, '');
            window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
        }
        
        // Check WhatsApp API status
        async function checkWhatsAppApiStatus() {
            const statusIcon = document.getElementById('apiStatusIcon');
            const statusText = document.getElementById('apiStatusText');
            
            try {
                // Quick check if API is configured by calling with empty body
                const response = await fetch('/api/send-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.error === 'WhatsApp not configured') {
                    statusIcon.textContent = 'âš ï¸';
                    statusText.innerHTML = 'API not configured - <a href="#" onclick="showWhatsAppSetupGuide()" style="color: #00d4ff;">Setup Guide</a>';
                    document.getElementById('autoSendWhatsApp').checked = false;
                    document.getElementById('autoSendWhatsApp').disabled = true;
                } else {
                    statusIcon.textContent = 'âœ…';
                    statusText.textContent = 'WhatsApp API ready - auto-send enabled';
                }
            } catch (error) {
                statusIcon.textContent = 'ðŸ“±';
                statusText.textContent = 'Manual mode - use buttons below to share';
                document.getElementById('autoSendWhatsApp').checked = false;
            }
        }
        
        // Send WhatsApp via API
        async function sendWhatsAppNow() {
            const whatsappNum = document.getElementById('newCoWhatsApp')?.value?.trim() || newCompanyData.phone;
            
            if (!whatsappNum) {
                showToast('âš ï¸ No WhatsApp number provided', 'warning');
                return;
            }
            
            showToast('ðŸ“¤ Sending WhatsApp...', 'info');
            
            try {
                const response = await fetch('/api/send-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipientPhone: whatsappNum,
                        companyName: newCompanyData.name,
                        registrationUrl: newCompanyData.url,
                        loginCode: newCompanyData.loginCode,
                        messageType: 'registration'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('âœ… WhatsApp sent successfully!', 'success');
                    logActivity(`WhatsApp sent to ${whatsappNum} for ${newCompanyData.name}`, 'whatsapp');
                } else if (result.fallback === 'manual') {
                    // API not configured, fallback to manual
                    showToast('ðŸ“± Opening WhatsApp manually...', 'info');
                    openWhatsAppWithMessage();
                } else {
                    showToast('âŒ ' + (result.message || 'Failed to send'), 'error');
                }
            } catch (error) {
                console.error('WhatsApp send error:', error);
                showToast('ðŸ“± Opening WhatsApp manually...', 'info');
                openWhatsAppWithMessage();
            }
        }
        
        // Auto-send WhatsApp when company is created
        async function autoSendWhatsAppCredentials() {
            const autoSend = document.getElementById('autoSendWhatsApp')?.checked;
            if (!autoSend) return;
            
            await sendWhatsAppNow();
        }
        
        // Download credentials as PDF
        function downloadCredentialsPDF() {
            // Create printable HTML
            const pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <title>ConiCore - ${newCompanyData.name} Credentials</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            padding: 40px;
            background: #fff;
            color: #333;
        }
        .card {
            max-width: 500px;
            margin: 0 auto;
            border: 3px solid #00d4ff;
            border-radius: 20px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #00d4ff, #06ffa5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { opacity: 0.8; }
        .content { padding: 30px; }
        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #1a1a2e;
            margin-bottom: 20px;
            text-align: center;
        }
        .credential-box {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }
        .credential-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .credential-value {
            font-size: 18px;
            font-weight: bold;
            color: #1a1a2e;
            word-break: break-all;
        }
        .credential-value.code {
            font-size: 32px;
            letter-spacing: 4px;
            color: #00d4ff;
            font-family: monospace;
        }
        .credential-value.password {
            font-size: 24px;
            color: #06ffa5;
            font-family: monospace;
        }
        .steps {
            background: #e8f4f8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .steps h3 {
            margin-bottom: 15px;
            color: #1a1a2e;
        }
        .steps ol {
            margin-left: 20px;
            color: #555;
        }
        .steps li { margin-bottom: 8px; }
        .footer {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            font-size: 12px;
            color: #888;
        }
        @media print {
            body { padding: 20px; }
            .card { border: 2px solid #00d4ff; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <h1>ðŸ¢ ConiCore Invoicing</h1>
            <p>Your Login Credentials</p>
        </div>
        <div class="content">
            <div class="company-name">${newCompanyData.name}</div>
            
            <div class="credential-box">
                <div class="credential-label">Login URL</div>
                <div class="credential-value">${newCompanyData.url}</div>
            </div>
            
            <div class="credential-box">
                <div class="credential-label">Login Code</div>
                <div class="credential-value code">${newCompanyData.loginCode}</div>
            </div>
            
            <div class="credential-box">
                <div class="credential-label">Temporary Password</div>
                <div class="credential-value password">${newCompanyData.tempPassword}</div>
            </div>
            
            <div class="steps">
                <h3>ðŸ“ Getting Started</h3>
                <ol>
                    <li>Visit the Login URL above</li>
                    <li>Enter your Login Code</li>
                    <li>Enter the Temporary Password</li>
                    <li>Change your password when prompted</li>
                    <li>Complete your company setup (logo, colors, bank details)</li>
                </ol>
            </div>
        </div>
        <div class="footer">
            <p>Powered by ConiCore Technology</p>
            <p>Generated: ${new Date().toLocaleString()}</p>
        </div>
    </div>
    <script>window.print();</script>
</body>
</html>`;
            
            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            
            showToast('ðŸ“„ PDF opened - use Print > Save as PDF', 'success');
        }
        
        // Show WhatsApp setup guide
        function showWhatsAppSetupGuide() {
            const guideModal = document.createElement('div');
            guideModal.className = 'modal';
            guideModal.style.display = 'flex';
            guideModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>ðŸ“± WhatsApp API Setup</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem;">1. Create Meta Business Account</h3>
                        <p style="margin-bottom: 1rem; opacity: 0.8;">
                            Go to <a href="https://business.facebook.com" target="_blank" style="color: #00d4ff;">business.facebook.com</a> 
                            and create a business account.
                        </p>
                        
                        <h3 style="margin-bottom: 1rem;">2. Create WhatsApp App</h3>
                        <p style="margin-bottom: 1rem; opacity: 0.8;">
                            Go to <a href="https://developers.facebook.com" target="_blank" style="color: #00d4ff;">developers.facebook.com</a>,
                            create an app, and add WhatsApp product.
                        </p>
                        
                        <h3 style="margin-bottom: 1rem;">3. Get Credentials</h3>
                        <p style="margin-bottom: 1rem; opacity: 0.8;">
                            Copy your <strong>Phone Number ID</strong> and <strong>Access Token</strong> from the WhatsApp dashboard.
                        </p>
                        
                        <h3 style="margin-bottom: 1rem;">4. Add to Vercel</h3>
                        <p style="margin-bottom: 0.5rem; opacity: 0.8;">Add these environment variables in Vercel:</p>
                        <pre style="background: #0a0e14; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.85rem;">
WHATSAPP_ACCESS_TOKEN=your_token_here
WHATSAPP_PHONE_NUMBER_ID=your_phone_id_here</pre>
                        
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(6, 255, 165, 0.1); border-radius: 8px;">
                            <strong>ðŸ’¡ Free Tier:</strong> 1,000 messages/month free!
                        </div>
                        
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()" style="width: 100%; margin-top: 1.5rem;">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(guideModal);
        }
        
        // Copy company URL
        function copyCompanyUrl() {
            navigator.clipboard.writeText(newCompanyData.url);
            showToast('ðŸ”— Company URL copied!', 'success');
        }
        
        // Email credentials
        function emailCredentials() {
            const subject = encodeURIComponent('Your ConiCore Invoicing Login Credentials');
            const body = encodeURIComponent(`Welcome to ConiCore Invoicing!

Company: ${newCompanyData.name}
Login URL: ${newCompanyData.url}
Login Code: ${newCompanyData.loginCode}
Temporary Password: ${newCompanyData.tempPassword}

Please change your password on first login.

Regards,
ConiCore Admin`);
            
            window.open(`mailto:${newCompanyData.email}?subject=${subject}&body=${body}`, '_blank');
        }
        
        // Final company creation
        async function createCompanyFinal() {
            try {
                // Create company record
                const company = {
                    id: newCompanyData.id,
                    name: newCompanyData.name,
                    tradingAs: newCompanyData.tradingAs,
                    regNo: newCompanyData.regNo,
                    vatNo: newCompanyData.vatNo,
                    address: newCompanyData.address,
                    phone: newCompanyData.phone,
                    email: newCompanyData.email,
                    website: newCompanyData.website,
                    industry: newCompanyData.industry,
                    branding: newCompanyData.branding,
                    tier: newCompanyData.tier,
                    settings: newCompanyData.settings,
                    loginCode: newCompanyData.loginCode,
                    status: newCompanyData.tier === 'trial' ? 'trial' : 'active',
                    createdAt: new Date().toISOString(),
                    trialEndsAt: newCompanyData.tier === 'trial' ? new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString() : null,
                    setupComplete: false,
                    firstLoginAt: null,
                    invoiceCount: 0,
                    customerCount: 0,
                    userCount: 1
                };
                
                // Create admin user for company
                const adminUser = {
                    id: Date.now(),
                    name: newCompanyData.name + ' Admin',
                    email: newCompanyData.email,
                    username: newCompanyData.loginCode,
                    loginCode: newCompanyData.loginCode,
                    password: newCompanyData.tempPassword,
                    tempPassword: newCompanyData.tempPassword,
                    requirePasswordChange: true,
                    role: 'owner',
                    status: 'active',
                    provider: 'tenant',
                    companyId: company.id,
                    createdAt: new Date().toISOString()
                };
                
                // Save company
                allTenantCompanies.push(company);
                localStorage.setItem('conicore_tenant_companies', JSON.stringify(allTenantCompanies));
                
                // Save company-specific data namespace
                localStorage.setItem(`conicore_company_${company.id}`, JSON.stringify({
                    users: [adminUser],
                    invoices: [],
                    customers: [],
                    products: [],
                    settings: company.settings,
                    branding: company.branding
                }));
                
                // Also add to main users list for login
                const users = JSON.parse(localStorage.getItem('conicore_users') || '[]');
                users.push(adminUser);
                localStorage.setItem('conicore_users', JSON.stringify(users));
                
                showToast('âœ… Company created successfully!', 'success');
                logActivity(`Created company: ${company.name}`, 'master-admin');
                
                // Auto-send WhatsApp if enabled
                await autoSendWhatsAppCredentials();
                
                closeModal('createCompanyModal');
                updateCompanyStats();
                loadCompanyList();
                
            } catch (error) {
                console.error('Error creating company:', error);
                showToast('Failed to create company', 'error');
            }
        }
        
        // Update company statistics
        function updateCompanyStats() {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            
            const total = companies.length;
            const active = companies.filter(c => c.status === 'active').length;
            const trial = companies.filter(c => c.status === 'trial').length;
            const suspended = companies.filter(c => c.status === 'suspended').length;
            
            const totalEl = document.getElementById('statTotalCompanies');
            const activeEl = document.getElementById('statActiveCompanies');
            const trialEl = document.getElementById('statTrialCompanies');
            const suspendedEl = document.getElementById('statSuspendedCompanies');
            
            if (totalEl) totalEl.textContent = total;
            if (activeEl) activeEl.textContent = active;
            if (trialEl) trialEl.textContent = trial;
            if (suspendedEl) suspendedEl.textContent = suspended;
        }
        
        // Load company list table
        function loadCompanyList() {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const tbody = document.getElementById('companiesTableBody');
            
            if (!tbody) return;
            
            if (companies.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="7" style="text-align: center; opacity: 0.7; padding: 2rem;">
                        No companies created yet. Click "Create Company" to add your first client.
                    </td>
                </tr>`;
                return;
            }
            
            tbody.innerHTML = companies.map(company => {
                const statusColors = {
                    active: { bg: 'rgba(6, 255, 165, 0.2)', color: '#06ffa5', text: 'âœ… Active' },
                    trial: { bg: 'rgba(255, 190, 11, 0.2)', color: '#ffbe0b', text: 'ðŸŽ Trial' },
                    suspended: { bg: 'rgba(255, 0, 110, 0.2)', color: '#ff006e', text: 'â›” Suspended' }
                };
                const status = statusColors[company.status] || statusColors.active;
                
                const tierColors = {
                    trial: '#ffbe0b',
                    starter: '#00d4ff',
                    business: '#06ffa5',
                    enterprise: '#7209b7'
                };
                
                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            ${company.branding?.logo ? 
                                `<img src="${company.branding.logo}" style="width: 32px; height: 32px; border-radius: 6px; object-fit: cover;">` :
                                `<div style="width: 32px; height: 32px; border-radius: 6px; background: linear-gradient(135deg, ${company.branding?.primaryColor || '#00d4ff'}, ${company.branding?.secondaryColor || '#7209b7'}); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">ðŸ¢</div>`
                            }
                            <div>
                                <div style="font-weight: 600;">${company.name}</div>
                                <div style="font-size: 0.75rem; opacity: 0.7;">${company.tradingAs || company.industry}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="background: ${status.bg}; color: ${status.color}; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                            ${status.text}
                        </span>
                    </td>
                    <td>
                        <span style="color: ${tierColors[company.tier] || '#fff'}; font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">
                            ${company.tier}
                        </span>
                    </td>
                    <td style="font-size: 0.85rem;">${company.email}</td>
                    <td>${company.invoiceCount || 0}</td>
                    <td style="font-size: 0.85rem;">${new Date(company.createdAt).toLocaleDateString()}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-sm btn-outline" onclick="viewCompanyDetails('${company.id}')" title="View Details" style="padding: 0.25rem 0.5rem;">
                            ðŸ‘ï¸
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="copyCompanyCredentials('${company.id}')" title="Copy Credentials" style="padding: 0.25rem 0.5rem;">
                            ðŸ“‹
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="editCompanySettings('${company.id}')" title="Edit" style="padding: 0.25rem 0.5rem;">
                            âš™ï¸
                        </button>
                        ${company.status === 'active' || company.status === 'trial' ? 
                            `<button class="btn btn-sm" onclick="suspendCompany('${company.id}')" title="Suspend" style="padding: 0.25rem 0.5rem; background: rgba(255, 0, 110, 0.2); color: #ff006e;">â›”</button>` :
                            `<button class="btn btn-sm" onclick="activateCompany('${company.id}')" title="Activate" style="padding: 0.25rem 0.5rem; background: rgba(6, 255, 165, 0.2); color: #06ffa5;">âœ…</button>`
                        }
                    </td>
                </tr>
            `}).join('');
        }
        
        // Copy company credentials
        function copyCompanyCredentials(companyId) {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const company = companies.find(c => c.id === companyId);
            
            if (!company) {
                showToast('Company not found', 'error');
                return;
            }
            
            // Get the admin user
            const users = JSON.parse(localStorage.getItem('conicore_users') || '[]');
            const adminUser = users.find(u => u.companyId === companyId && u.role === 'owner');
            
            const url = window.location.origin + '/COMPLETE-INVOICE-SYSTEM.html?c=' + companyId;
            const credentials = `
ðŸ¢ ${company.name} - Login Credentials

ðŸ”— URL: ${url}
ðŸŽ« Login Code: ${company.loginCode}
ðŸ”‘ Password: ${adminUser?.tempPassword || adminUser?.password || 'Contact admin'}

Powered by ConiCore`;
            
            navigator.clipboard.writeText(credentials.trim());
            showToast('ðŸ“‹ Credentials copied!', 'success');
        }
        
        // View company details
        function viewCompanyDetails(companyId) {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const company = companies.find(c => c.id === companyId);
            
            if (!company) {
                showToast('Company not found', 'error');
                return;
            }
            
            // Show details in alert (can be enhanced to modal)
            const details = `
Company: ${company.name}
Trading As: ${company.tradingAs || 'N/A'}
Email: ${company.email}
Phone: ${company.phone}
Status: ${company.status}
Tier: ${company.tier}
Created: ${new Date(company.createdAt).toLocaleString()}
Setup Complete: ${company.setupComplete ? 'Yes' : 'No'}
First Login: ${company.firstLoginAt ? new Date(company.firstLoginAt).toLocaleString() : 'Never'}
Invoices: ${company.invoiceCount || 0}
Customers: ${company.customerCount || 0}
            `;
            
            alert(details);
        }
        
        // Suspend company
        function suspendCompany(companyId) {
            if (!confirm('Are you sure you want to suspend this company? Users will not be able to log in.')) return;
            
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const idx = companies.findIndex(c => c.id === companyId);
            
            if (idx !== -1) {
                companies[idx].status = 'suspended';
                companies[idx].suspendedAt = new Date().toISOString();
                localStorage.setItem('conicore_tenant_companies', JSON.stringify(companies));
                
                showToast('Company suspended', 'success');
                updateCompanyStats();
                loadCompanyList();
            }
        }
        
        // Activate company
        function activateCompany(companyId) {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const idx = companies.findIndex(c => c.id === companyId);
            
            if (idx !== -1) {
                companies[idx].status = 'active';
                delete companies[idx].suspendedAt;
                localStorage.setItem('conicore_tenant_companies', JSON.stringify(companies));
                
                showToast('Company activated', 'success');
                updateCompanyStats();
                loadCompanyList();
            }
        }
        
        // Edit company settings
        function editCompanySettings(companyId) {
            showToast('Edit modal coming soon', 'info');
            // TODO: Open edit modal
        }
        
        // Export companies report
        function exportCompaniesReport() {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            
            let csv = 'Company Name,Trading As,Email,Phone,Status,Tier,Created,Invoices,Customers\n';
            companies.forEach(c => {
                csv += `"${c.name}","${c.tradingAs || ''}","${c.email}","${c.phone}","${c.status}","${c.tier}","${c.createdAt}","${c.invoiceCount || 0}","${c.customerCount || 0}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `companies-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ðŸ“Š Report exported!', 'success');
        }
        
        // Bulk import companies
        function bulkImportCompanies() {
            showToast('Bulk import feature coming soon', 'info');
        }
        
        // Refresh company list
        function refreshCompanyList() {
            updateCompanyStats();
            loadCompanyList();
            showToast('ðŸ”„ Refreshed!', 'success');
        }
        
        // Load company context from URL
        function loadCompanyContext(companyId) {
            const companies = JSON.parse(localStorage.getItem('conicore_tenant_companies') || '[]');
            const company = companies.find(c => c.id === companyId);
            
            if (!company) {
                console.log('Company not found:', companyId);
                return;
            }
            
            // Check if suspended
            if (company.status === 'suspended') {
                alert('This company account has been suspended. Please contact support.');
                window.location.href = 'index.html';
                return;
            }
            
            // Store current company context
            sessionStorage.setItem('currentCompanyId', companyId);
            
            // Apply company branding
            applyCompanyBranding(company);
            
            console.log('Loaded company context:', company.name);
        }
        
        // Apply company branding to UI
        function applyCompanyBranding(company) {
            if (!company || !company.branding) return;
            
            const branding = company.branding;
            
            // Apply CSS variables
            if (branding.primaryColor) {
                document.documentElement.style.setProperty('--primary', branding.primaryColor);
            }
            if (branding.secondaryColor) {
                document.documentElement.style.setProperty('--secondary', branding.secondaryColor);
            }
            if (branding.accentColor) {
                document.documentElement.style.setProperty('--accent', branding.accentColor);
            }
            
            // Update header logo
            const headerLogo = document.querySelector('header .logo');
            if (headerLogo && branding.logo) {
                headerLogo.innerHTML = `<img src="${branding.logo}" style="height: 40px; border-radius: 6px;"> ${company.tradingAs || company.name}`;
            } else if (headerLogo) {
                headerLogo.innerHTML = `ðŸ¢ ${company.tradingAs || company.name}`;
            }
            
            // Store for invoice templates
            window.currentCompanyBranding = {
                name: company.name,
                tradingAs: company.tradingAs,
                logo: branding.logo,
                primaryColor: branding.primaryColor,
                tagline: branding.tagline
            };
        }
        
        // Tier selection styling
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers for tier cards
            document.querySelectorAll('input[name="newCoTier"]').forEach(input => {
                input.addEventListener('change', function() {
                    document.querySelectorAll('.tier-card').forEach(card => {
                        card.style.transform = 'scale(1)';
                        card.style.boxShadow = 'none';
                    });
                    if (this.checked) {
                        this.parentElement.querySelector('.tier-card').style.transform = 'scale(1.02)';
                        this.parentElement.querySelector('.tier-card').style.boxShadow = '0 5px 20px rgba(0,0,0,0.3)';
                    }
                });
            });
            
            // Initialize multi-tenant on load
            setTimeout(initMultiTenant, 500);
        });
        
        // ==================== END MULTI-TENANT COMPANY MANAGEMENT ====================
        
        // ==================== AI SMART SCANNER - FULLY AUTOMATED ====================
        
        let scanExtractedData = null;
        let scanStartTime = null;
        
        function openQuickScan() {
            openModal('quickScanModal');
            resetScannerUI();
        }
        
        function resetScannerUI() {
            document.getElementById('quickScanMain').style.display = 'block';
            document.getElementById('quickScanProgress').style.display = 'none';
            document.getElementById('quickScanResults').style.display = 'none';
            
            // Reset file inputs
            const cameraInput = document.getElementById('quickScanCamera');
            const galleryInput = document.getElementById('quickScanGallery');
            if (cameraInput) cameraInput.value = '';
            if (galleryInput) galleryInput.value = '';
        }
        
        // Open camera for scanning - uses native camera capture
        function openCameraForScan() {
            // Check if we're on a mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // On mobile, try the camera input first
                document.getElementById('quickScanCamera').click();
            } else {
                // On desktop, try to use MediaDevices API for webcam
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    openWebcamCapture();
                } else {
                    // Fallback to file input
                    showToast('Camera not available. Please choose a file instead.', 'info');
                    document.getElementById('quickScanGallery').click();
                }
            }
        }
        
        // Webcam capture for desktop browsers
        async function openWebcamCapture() {
            // Create webcam modal
            const webcamModal = document.createElement('div');
            webcamModal.id = 'webcamCaptureModal';
            webcamModal.innerHTML = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10001; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;">
                    <video id="webcamVideo" autoplay playsinline style="max-width: 100%; max-height: 60vh; border-radius: 12px; background: #000;"></video>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button onclick="captureWebcamPhoto()" style="padding: 1rem 2rem; font-size: 1.2rem; background: linear-gradient(135deg, #06ffa5, #00b377); border: none; border-radius: 8px; color: white; cursor: pointer;">
                            ðŸ“¸ Capture
                        </button>
                        <button onclick="closeWebcamCapture()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #666; border: none; border-radius: 8px; color: white; cursor: pointer;">
                            âœ– Cancel
                        </button>
                    </div>
                    <p style="margin-top: 1rem; opacity: 0.7; font-size: 0.9rem;">Position your document and click Capture</p>
                </div>
            `;
            document.body.appendChild(webcamModal);
            
            // Small delay to ensure DOM is ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Start webcam
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                const video = document.getElementById('webcamVideo');
                if (video) {
                    video.srcObject = stream;
                    window.webcamStream = stream;
                } else {
                    console.error('Video element not found');
                    stream.getTracks().forEach(track => track.stop());
                    closeWebcamCapture();
                    showToast('Camera setup failed. Please try again.', 'error');
                }
            } catch (err) {
                console.error('Webcam error:', err);
                closeWebcamCapture();
                showToast('Camera access denied. Please choose a file instead.', 'error');
                const galleryInput = document.getElementById('quickScanGallery');
                if (galleryInput) galleryInput.click();
            }
        }
        
        function captureWebcamPhoto() {
            const video = document.getElementById('webcamVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Convert to blob and trigger scan
            canvas.toBlob(blob => {
                closeWebcamCapture();
                
                // Create a fake file object
                const file = new File([blob], 'webcam-capture.jpg', { type: 'image/jpeg' });
                
                // Create a fake event with the file
                const fakeEvent = {
                    target: {
                        files: [file]
                    }
                };
                
                handleAIScan(fakeEvent);
            }, 'image/jpeg', 0.9);
        }
        
        function closeWebcamCapture() {
            // Stop webcam stream
            if (window.webcamStream) {
                window.webcamStream.getTracks().forEach(track => track.stop());
                window.webcamStream = null;
            }
            
            // Remove modal
            const modal = document.getElementById('webcamCaptureModal');
            if (modal) modal.remove();
        }
        
        async function handleAIScan(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            return processSingleScan(file);
        }
        
        // NEW: Handle multiple document scans
        async function handleMultipleScans(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            if (files.length === 1) {
                return processSingleScan(files[0]);
            }
            
            // Multiple files - process them in sequence
            showToast(`ðŸ“¸ Processing ${files.length} documents...`, 'info');
            
            const results = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validate file
                if (!file.type.startsWith('image/')) {
                    showToast(`Skipping ${file.name} - not an image`, 'warning');
                    continue;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`Skipping ${file.name} - too large (max 10MB)`, 'warning');
                    continue;
                }
                
                try {
                    // Show progress
                    document.getElementById('quickScanMain').style.display = 'none';
                    document.getElementById('quickScanCamera').style.display = 'none';
                    document.getElementById('quickScanProgress').style.display = 'block';
                    document.getElementById('quickScanProgressTitle').textContent = `Processing ${i + 1} of ${files.length}`;
                    document.getElementById('quickScanProgressText').textContent = file.name;
                    
                    const result = await processSingleScanFile(file);
                    results.push(result);
                    
                    // Auto-save each result
                    await autoSaveScanResult(result);
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    showToast(`Error processing ${file.name}`, 'error');
                }
            }
            
            // Show completion summary
            document.getElementById('quickScanProgress').style.display = 'none';
            closeModal('quickScanModal');
            
            showToast(`âœ… Processed ${results.length} of ${files.length} documents successfully!`, 'success');
            
            // Refresh current view
            if (typeof loadDashboard === 'function') loadDashboard();
        }
        
        // Process a single scan file
        async function processSingleScan(file) {
            scanStartTime = Date.now();
            
            // Validate file
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('Image too large. Max 10MB allowed.', 'error');
                return;
            }
            
            // Switch to progress view
            document.getElementById('quickScanMain').style.display = 'none';
            document.getElementById('quickScanCamera').style.display = 'none';
            document.getElementById('quickScanProgress').style.display = 'block';
            
            updateScanStep(1, 'active', 'ðŸ”„ Reading image...');
            document.getElementById('quickScanProgressBar').style.width = '10%';
            
            try {
                const result = await processSingleScanFile(file);
                
                // Calculate benchmark time
                const scanTime = ((Date.now() - scanStartTime) / 1000).toFixed(2);
                
                updateScanStep(4, 'done', `âœ… Ready! (${scanTime}s)`);
                document.getElementById('quickScanProgressBar').style.width = '100%';
                
                // Short delay then show confirmation
                await delay(500);
                showScanConfirmationAndNavigate(result);
                
            } catch (error) {
                console.error('AI Scan error:', error);
                showToast('Scan failed: ' + error.message, 'error');
                resetScannerUI();
            }
        }
        
        // Core scanning logic (used by both single and multi-scan)
        async function processSingleScanFile(file) {
            // Read file as base64
            const base64Data = await readFileAsBase64(file);
            
            updateScanStep(1, 'done', 'âœ… Image loaded');
            updateScanStep(2, 'active', 'ðŸ”„ Detecting document type...');
            document.getElementById('quickScanProgressBar').style.width = '25%';
            document.getElementById('quickScanProgressTitle').textContent = 'AI Analyzing...';
            
            // Try AI OCR first, fallback to local
            let result = await performAIScan(base64Data);
            
            updateScanStep(2, 'done', `âœ… Detected: ${getTypeLabel(result.detectedType)}`);
            updateScanStep(3, 'active', 'ðŸ”„ Extracting text & data...');
            document.getElementById('quickScanProgressBar').style.width = '70%';
            
            // Process based on detected type
            const processedData = await processExtractedData(result);
            
            updateScanStep(3, 'done', 'âœ… Data extracted');
            updateScanStep(4, 'active', 'ðŸ”„ Preparing to save...');
            document.getElementById('quickScanProgressBar').style.width = '90%';
            
            // Store for confirmation
            return {
                ...result,
                processedData: processedData
            };
        }
        
        // Auto-save scan result (for multi-scan batch processing)
        async function autoSaveScanResult(scanData) {
            const type = scanData.detectedType;
            const data = scanData.processedData || scanData.data || {};
            
            try {
                if (type === 'customer' && data.name) {
                    // Add customer
                    const newCustomer = {
                        id: Date.now(),
                        name: data.name || '',
                        company: data.company || '',
                        email: data.email || '',
                        phone: data.phone || '',
                        createdAt: new Date().toISOString()
                    };
                    customers.push(newCustomer);
                    await saveToStorage(getBusinessKey('aweh_customers'), customers);
                    
                } else if (type === 'pricelist' && Array.isArray(data.products) && data.products.length > 0) {
                    // Add products
                    data.products.forEach(p => {
                        products.push({
                            id: Date.now() + Math.random(),
                            name: p.name || 'Product',
                            price: p.price || 0,
                            description: p.description || '',
                            createdAt: new Date().toISOString()
                        });
                    });
                    await saveToStorage(getBusinessKey('aweh_products'), products);
                }
                // Add more auto-save logic for other types as needed
                
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function updateScanStep(stepNum, status, text) {
            const step = document.getElementById(`step${stepNum}`);
            if (!step) return;
            
            step.textContent = text;
            
            if (status === 'active') {
                step.style.opacity = '1';
                step.style.color = 'var(--primary)';
            } else if (status === 'done') {
                step.style.opacity = '1';
                step.style.color = 'var(--success)';
            } else {
                step.style.opacity = '0.4';
                step.style.color = 'inherit';
            }
        }
        
        function getTypeLabel(type) {
            const labels = {
                'customer': 'Business Card',
                'invoice': 'Invoice',
                'pricelist': 'Price List',
                'receipt': 'Receipt',
                'delivery': 'Delivery Note',
                'pop': 'Proof of Payment'
            };
            return labels[type] || 'Document';
        }
        
        async function performAIScan(imageBase64) {
            // Try Vision AI first
            try {
                const response = await fetch('/api/ocr-customer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: imageBase64,
                        mode: 'auto-detect',
                        extractAll: true
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        return {
                            success: true,
                            detectedType: detectDocumentType(data.data, data.rawText || ''),
                            data: data.data,
                            rawText: data.rawText || '',
                            source: 'ai-vision'
                        };
                    }
                }
            } catch (e) {
                console.log('AI Vision unavailable, using local OCR');
            }
            
            // Fallback to local Tesseract OCR
            return await performLocalOCR(imageBase64);
        }
        
        async function performLocalOCR(imageBase64) {
            if (typeof Tesseract === 'undefined') {
                throw new Error('OCR library not loaded. Please refresh the page.');
            }
            
            // Validate base64 data
            if (!imageBase64 || imageBase64.length < 100) {
                throw new Error('Invalid image data. Please try again with a different image.');
            }
            
            document.getElementById('quickScanProgressText').textContent = 'Running local OCR...';
            
            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = 30 + (m.progress * 40);
                            const progressBar = document.getElementById('quickScanProgressBar');
                            if (progressBar) progressBar.style.width = progress + '%';
                        }
                    }
                });
                
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                
                // Try with proper image format detection
                let imgSrc = 'data:image/jpeg;base64,' + imageBase64;
                
                // Check if it's a PNG by header
                if (imageBase64.startsWith('iVBOR')) {
                    imgSrc = 'data:image/png;base64,' + imageBase64;
                }
                
                const { data: { text } } = await worker.recognize(imgSrc);
                await worker.terminate();
                
                if (!text || text.trim().length === 0) {
                    throw new Error('No text detected in image. Please ensure the document is clearly visible.');
                }
                
                return {
                    success: true,
                    detectedType: detectTypeFromText(text),
                    data: extractDataFromText(text, detectTypeFromText(text)),
                    rawText: text,
                    source: 'local-ocr'
                };
            } catch (ocrError) {
                console.error('OCR processing error:', ocrError);
                throw new Error('Could not read image. Please ensure it\'s a clear photo of a document.');
            }
            
            // Detect type from text
            const detectedType = detectTypeFromText(text);
            const extractedData = extractDataFromText(text, detectedType);
            
            return {
                success: true,
                detectedType: detectedType,
                data: extractedData,
                rawText: text,
                source: 'local-ocr'
            };
        }
        
        function detectDocumentType(data, rawText = '') {
            // Check structured data first
            if (data.email && (data.phone || data.name) && !data.total && !data.items) {
                return 'customer';
            }
            if (data.products && Array.isArray(data.products) && data.products.length > 0) {
                return 'pricelist';
            }
            if ((data.supplierName || data.vendor) && (data.total || data.amount)) {
                return 'invoice';
            }
            if (data.paymentReference || data.bankReference || data.transactionId) {
                return 'pop';
            }
            if (data.deliveryItems || data.waybill || data.shipmentNumber) {
                return 'delivery';
            }
            
            // Fallback to text analysis
            return detectTypeFromText(rawText);
        }
        
        function detectTypeFromText(text) {
            if (!text) return 'unknown';
            const lower = text.toLowerCase();
            
            // Business card patterns
            if (text.match(/[\w\.-]+@[\w\.-]+\.\w+/) && 
                text.match(/\+?\d{2,4}[\s-]?\d{3,}/) &&
                !lower.includes('invoice') && !lower.includes('total')) {
                return 'customer';
            }
            
            // Invoice patterns
            if (lower.includes('invoice') || lower.includes('inv no') || 
                lower.includes('tax invoice') || lower.includes('bill to')) {
                return 'invoice';
            }
            
            // Price list patterns
            if (lower.includes('price list') || lower.includes('catalog') || 
                lower.includes('product list') || (text.match(/R\s*\d+[\.,]\d{2}/g) || []).length > 5) {
                return 'pricelist';
            }
            
            // Receipt patterns
            if (lower.includes('receipt') || lower.includes('till slip') || 
                lower.includes('cash sale') || lower.includes('change due')) {
                return 'receipt';
            }
            
            // Delivery note patterns
            if (lower.includes('delivery') || lower.includes('waybill') || 
                lower.includes('shipment') || lower.includes('packing list')) {
                return 'delivery';
            }
            
            // POP patterns
            if (lower.includes('proof of payment') || lower.includes('pop') || 
                lower.includes('payment confirmation') || lower.includes('eft')) {
                return 'pop';
            }
            
            return 'unknown';
        }
        
        function extractDataFromText(text, type) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            const phoneMatch = text.match(/\+?\d{1,4}[\s-]?\(?\d{1,4}\)?[\s-]?\d{1,4}[\s-]?\d{1,9}/);
            const amountMatch = text.match(/R?\s*(\d{1,3}(?:[,\s]?\d{3})*(?:\.\d{2})?)/g);
            
            switch(type) {
                case 'customer':
                    // Find name (usually first meaningful line)
                    let name = '';
                    let company = '';
                    for (const line of lines.slice(0, 5)) {
                        if (line.match(/^[A-Z][a-z]+ [A-Z][a-z]+/) && !name) {
                            name = line;
                        } else if ((line.match(/[A-Z]/g) || []).length >= 3 || /\b(pty|ltd|inc)\b/i.test(line)) {
                            if (!company) company = line;
                        }
                    }
                    return {
                        name: name || lines[0] || '',
                        company: company || '',
                        email: emailMatch ? emailMatch[0] : '',
                        phone: phoneMatch ? phoneMatch[0] : ''
                    };
                    
                case 'invoice':
                    const invNumMatch = text.match(/(?:invoice|inv)[\s#:]*([A-Z0-9-]+)/i);
                    const dateMatch = text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/);
                    const totalMatch = text.match(/(?:total|amount|due)[\s:]*R?\s*(\d[\d,\.\s]+)/i);
                    return {
                        invoiceNumber: invNumMatch ? invNumMatch[1] : '',
                        date: dateMatch ? dateMatch[0] : '',
                        total: totalMatch ? parseFloat(totalMatch[1].replace(/[,\s]/g, '')) : 0,
                        supplierName: lines[0] || ''
                    };
                    
                case 'pricelist':
                    const products = [];
                    const pricePattern = /R?\s*(\d+(?:[,\s]?\d+)*(?:\.\d{2})?)/;
                    lines.forEach(line => {
                        const match = line.match(pricePattern);
                        if (match && match.index > 3) {
                            products.push({
                                name: line.substring(0, match.index).trim(),
                                price: parseFloat(match[1].replace(/[,\s]/g, ''))
                            });
                        }
                    });
                    return { products };
                    
                case 'pop':
                    const refMatch = text.match(/(?:ref|reference|transaction)[\s#:]*([A-Z0-9-]+)/i);
                    return {
                        paymentReference: refMatch ? refMatch[1] : '',
                        amount: amountMatch ? amountMatch[amountMatch.length - 1] : '',
                        date: text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || ''
                    };
                    
                default:
                    return { rawText: text, lines };
            }
        }
        
        async function processExtractedData(result) {
            // Additional processing based on type
            return result.data;
        }
        
        function showScanConfirmationAndNavigate(result) {
            const type = result.detectedType;
            const data = result.data || {};
            const scanTime = ((Date.now() - scanStartTime) / 1000).toFixed(2);
            
            document.getElementById('quickScanProgress').style.display = 'none';
            document.getElementById('quickScanResults').style.display = 'block';
            
            const typeConfig = {
                'customer': { icon: 'ðŸ‘¤', label: 'Business Card', color: '#06ffa5', action: 'Add Customer' },
                'invoice': { icon: 'ðŸ§¾', label: 'Supplier Invoice', color: '#00d4ff', action: 'Process Invoice' },
                'pricelist': { icon: 'ðŸ’°', label: 'Price List', color: '#ffbe0b', action: 'Import Products' },
                'receipt': { icon: 'ðŸ›’', label: 'Receipt', color: '#fb5607', action: 'Record Expense' },
                'delivery': { icon: 'ðŸšš', label: 'Delivery Note', color: '#8338ec', action: 'Receive Stock' },
                'pop': { icon: 'ðŸ’³', label: 'Proof of Payment', color: '#ff006e', action: 'Match Payment' },
                'unknown': { icon: 'ðŸ“„', label: 'Document', color: '#ffffff', action: 'View Data' }
            };
            
            const config = typeConfig[type] || typeConfig['unknown'];
            
            let html = `
                <!-- Success Header -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${config.icon}</div>
                    <div style="display: inline-block; background: ${config.color}20; color: ${config.color}; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">
                        ${config.label} Detected!
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.7;">
                        â±ï¸ Processed in ${scanTime}s â€¢ ðŸ”’ Secure scan
                    </div>
                </div>
            `;
            
            // Type-specific forms with extracted data pre-filled
            if (type === 'customer') {
                html += `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--success);">ðŸ“‡ Extracted Contact Info:</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Name</label>
                            <input type="text" class="form-control" id="scanName" value="${escapeHtml(data.name || '')}" style="font-size: 1rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Company</label>
                            <input type="text" class="form-control" id="scanCompany" value="${escapeHtml(data.company || '')}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Email</label>
                            <input type="email" class="form-control" id="scanEmail" value="${escapeHtml(data.email || '')}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 0.85rem;">Phone</label>
                            <input type="tel" class="form-control" id="scanPhone" value="${escapeHtml(data.phone || '')}">
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="resetScannerUI()" style="flex: 1;">ðŸ“· Scan Another</button>
                        <button class="btn btn-success" onclick="saveAndNavigateCustomer()" style="flex: 2;">
                            âœ… Save & Go to Customers
                        </button>
                    </div>
                `;
            } else if (type === 'pricelist' && data.products) {
                html += `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--warning);">ðŸ’° Found ${data.products.length} Products:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${data.products.slice(0, 20).map((p, i) => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 0.25rem;">
                                    <span style="font-size: 0.9rem;">${escapeHtml(p.name || 'Product ' + (i+1))}</span>
                                    <strong style="color: var(--success);">R ${formatNumber(p.price || 0)}</strong>
                                </div>
                            `).join('')}
                            ${data.products.length > 20 ? `<p style="opacity: 0.7; text-align: center;">+${data.products.length - 20} more...</p>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="resetScannerUI()" style="flex: 1;">ðŸ“· Scan Another</button>
                        <button class="btn btn-success" onclick="saveAndNavigateProducts()" style="flex: 2;">
                            âœ… Import & Go to Products
                        </button>
                    </div>
                `;
            } else if (type === 'invoice') {
                html += `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">ðŸ§¾ Invoice Details:</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Supplier</label>
                            <input type="text" class="form-control" id="scanSupplier" value="${escapeHtml(data.supplierName || '')}">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 0.85rem;">Invoice #</label>
                                <input type="text" class="form-control" id="scanInvNum" value="${escapeHtml(data.invoiceNumber || '')}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 0.85rem;">Total</label>
                                <input type="text" class="form-control" id="scanTotal" value="R ${formatNumber(data.total || 0)}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="resetScannerUI()" style="flex: 1;">ðŸ“· Scan Another</button>
                        <button class="btn btn-success" onclick="saveAndNavigateReceiving()" style="flex: 2;">
                            âœ… Process & Go to Receiving
                        </button>
                    </div>
                `;
            } else if (type === 'pop') {
                html += `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: #ff006e;">ðŸ’³ Payment Details:</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Reference</label>
                            <input type="text" class="form-control" id="scanPayRef" value="${escapeHtml(data.paymentReference || '')}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 0.85rem;">Amount</label>
                            <input type="text" class="form-control" id="scanPayAmount" value="${escapeHtml(data.amount || '')}">
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="resetScannerUI()" style="flex: 1;">ðŸ“· Scan Another</button>
                        <button class="btn btn-success" onclick="saveAndNavigatePayments()" style="flex: 2;">
                            âœ… Match & Go to Invoices
                        </button>
                    </div>
                `;
            } else {
                // Generic/unknown document type - allow user to select
                html += `
                    <div style="background: rgba(255, 190, 11, 0.1); border: 1px solid rgba(255, 190, 11, 0.3); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: var(--warning);">âš ï¸ Couldn't auto-detect document type</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Please select what type of document this is:</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="reclassifyScan('customer')" style="padding: 0.75rem;">
                                ðŸ‘¤<br><small>Business Card</small>
                            </button>
                            <button class="btn btn-outline" onclick="reclassifyScan('invoice')" style="padding: 0.75rem;">
                                ðŸ§¾<br><small>Invoice</small>
                            </button>
                            <button class="btn btn-outline" onclick="reclassifyScan('pricelist')" style="padding: 0.75rem;">
                                ðŸ’°<br><small>Price List</small>
                            </button>
                            <button class="btn btn-outline" onclick="reclassifyScan('receipt')" style="padding: 0.75rem;">
                                ðŸ›’<br><small>Receipt</small>
                            </button>
                            <button class="btn btn-outline" onclick="reclassifyScan('delivery')" style="padding: 0.75rem;">
                                ðŸšš<br><small>Delivery Note</small>
                            </button>
                            <button class="btn btn-outline" onclick="reclassifyScan('pop')" style="padding: 0.75rem;">
                                ðŸ’³<br><small>Proof of Payment</small>
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.8;">ðŸ“„ Extracted Text Preview:</h4>
                        <pre style="max-height: 150px; overflow-y: auto; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; opacity: 0.7;">${escapeHtml((result.rawText || 'No text extracted').substring(0, 500))}${(result.rawText || '').length > 500 ? '...' : ''}</pre>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="resetScannerUI()" style="flex: 1;">ðŸ“· Scan Again</button>
                        <button class="btn btn-outline" onclick="closeModal('quickScanModal')" style="flex: 1;">âœ• Cancel</button>
                    </div>
                `;
            }
            
            document.getElementById('quickScanResultsContent').innerHTML = html;
        }
        
        // Reclassify scan when auto-detection fails
        function reclassifyScan(newType) {
            if (!scanExtractedData) {
                showToast('No scan data available', 'error');
                return;
            }
            
            // Update the detected type
            scanExtractedData.detectedType = newType;
            
            // Re-extract data based on new type
            if (scanExtractedData.rawText) {
                scanExtractedData.data = extractDataFromText(scanExtractedData.rawText, newType);
            }
            
            // Show the confirmation UI for the new type
            showScanConfirmationAndNavigate(scanExtractedData);
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Save and Navigate functions
        async function saveAndNavigateCustomer() {
            const customer = {
                id: Date.now(),
                name: document.getElementById('scanName')?.value || 'Unknown',
                company: document.getElementById('scanCompany')?.value || '',
                email: document.getElementById('scanEmail')?.value || '',
                phone: document.getElementById('scanPhone')?.value || '',
                tier: 'retail',
                createdAt: new Date().toISOString()
            };
            
            customers.push(customer);
            await saveToStorage(getBusinessKey('aweh_customers'), customers);
            
            closeModal('quickScanModal');
            showToast(`âœ… Customer "${customer.name}" saved!`, 'success');
            
            // Navigate to customers tab
            switchTab('customers');
            loadCustomers();
            
            // Highlight the new customer briefly
            setTimeout(() => {
                const rows = document.querySelectorAll('#customersBody tr');
                if (rows.length > 0) {
                    rows[0].style.background = 'rgba(6, 255, 165, 0.2)';
                    setTimeout(() => rows[0].style.background = '', 2000);
                }
            }, 300);
        }
        
        async function saveAndNavigateProducts() {
            if (!scanExtractedData?.data?.products) {
                showToast('No products to save', 'error');
                return;
            }
            
            let imported = 0;
            scanExtractedData.data.products.forEach((p, i) => {
                const sku = p.sku || `SCAN-${Date.now()}-${i}`;
                if (!products.find(prod => prod.sku === sku && prod.name === p.name)) {
                    products.push({
                        sku: sku,
                        name: p.name || 'Scanned Product',
                        landedCost: p.price || 0,
                        brand: 'Imported',
                        category: 'Scanned',
                        description: 'Imported from scanned price list',
                        createdAt: new Date().toISOString()
                    });
                    imported++;
                }
            });
            
            await saveToStorage(getBusinessKey('aweh_products'), products);
            
            closeModal('quickScanModal');
            showToast(`âœ… Imported ${imported} products!`, 'success');
            
            // Navigate to products tab
            switchTab('products');
            displayProducts();
        }
        
        async function saveAndNavigateReceiving() {
            const invoiceData = {
                id: Date.now(),
                supplierName: document.getElementById('scanSupplier')?.value || 'Unknown',
                invoiceNumber: document.getElementById('scanInvNum')?.value || '',
                total: parseFloat((document.getElementById('scanTotal')?.value || '0').replace(/[^0-9.]/g, '')),
                date: new Date().toISOString(),
                status: 'pending'
            };
            
            // Add to payables
            const payables = await loadFromStorage('aweh_payables', []);
            payables.push(invoiceData);
            await saveToStorage('aweh_payables', payables);
            
            closeModal('quickScanModal');
            showToast(`âœ… Invoice from ${invoiceData.supplierName} added to payables!`, 'success');
            
            // Navigate to receiving tab
            switchTab('receiving');
        }
        
        async function saveAndNavigatePayments() {
            const paymentData = {
                reference: document.getElementById('scanPayRef')?.value || '',
                amount: document.getElementById('scanPayAmount')?.value || '',
                date: new Date().toISOString()
            };
            
            closeModal('quickScanModal');
            showToast(`ðŸ’³ Payment reference: ${paymentData.reference}`, 'success');
            
            // Navigate to invoices tab to match payment
            switchTab('invoices');
            
            // Could auto-open payment matching modal here
        }
        
        // ==================== END AI SMART SCANNER ====================
        
        // Quick Scan entry point
        function quickScan(type) {
            // Open the scanner modal
            openModal('quickScanModal');
            resetScannerUI();
            
            // If type is provided, skip selection and go straight to camera
            if (type && type !== 'auto') {
                selectScanType(type);
            }
        }
        
        // Show type selection screen
        function showScanTypeSelection() {
            document.getElementById('quickScanMain').style.display = 'block';
            document.getElementById('quickScanCamera').style.display = 'none';
            document.getElementById('quickScanProgress').style.display = 'none';
            document.getElementById('quickScanResults').style.display = 'none';
        }
        
        // Select document type and show camera options
        function selectScanType(type) {
            // Store selected type for later reference
            window.quickScanContext = { type: type };
            
            // Update UI with type-specific labels and icons
            const typeConfig = {
                'customer': { icon: 'ðŸ‘¤', label: 'Business Card' },
                'invoice': { icon: 'ðŸ§¾', label: 'Invoice' },
                'pricelist': { icon: 'ðŸ’°', label: 'Price List' },
                'receipt': { icon: 'ðŸ›’', label: 'Receipt' },
                'delivery': { icon: 'ðŸšš', label: 'Delivery Note' },
                'pop': { icon: 'ðŸ’³', label: 'Proof of Payment' },
                'auto': { icon: 'ðŸ¤–', label: 'Document (Auto-Detect)' }
            };
            
            const config = typeConfig[type] || typeConfig['auto'];
            document.getElementById('scanTypeIcon').textContent = config.icon;
            document.getElementById('scanTypeLabel').textContent = `Scanning ${config.label}`;
            
            // Show camera selection screen
            document.getElementById('quickScanMain').style.display = 'none';
            document.getElementById('quickScanCamera').style.display = 'block';
        }
        
        // Open camera - force camera on mobile
        async function openCamera() {
            // Check if device has camera capability
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    // Request camera permission first (this often helps trigger camera-only picker)
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    // Stop the stream immediately - we just needed to wake up the camera
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    console.log('Camera permission:', err);
                }
            }
            
            const input = document.getElementById('quickScanCameraInput');
            
            // Reset input to allow same file selection
            input.value = '';
            
            // On mobile, try to force camera
            if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                input.setAttribute('capture', 'environment');
            }
            
            input.click();
        }
        
        // Legacy compatibility - redirect old function calls
        function handleQuickScanFile(event) { handleAIScan(event); }
        function showQuickScanStep1() { resetScannerUI(); }
        function quickScanType(type) { resetScannerUI(); }
        
        // ==================== END AI SMART SCANNER ====================

        // Calculate customer payment rate
        function calculatePaymentRate(customerName) {
            const customerInvoices = invoices.filter(inv => inv.customer === customerName);
            if (customerInvoices.length === 0) return 100;
            
            const paidOnTime = customerInvoices.filter(inv => {
                if (inv.status !== 'paid') return false;
                if (!inv.paidDate || !inv.dueDate) return true;
                return new Date(inv.paidDate) <= new Date(inv.dueDate);
            }).length;
            
            return Math.round((paidOnTime / customerInvoices.length) * 100);
        }

        // ========================================
        // OCR SCANNING FUNCTIONS
        // ========================================

        // Scan supplier invoice (Offline-First: Tesseract.js â†’ Online APIs if configured)
        async function scanSupplierInvoice(imageData) {
            const ocrCfg = getOCRConfig();
            try {
                // Offline mode or no API keys - use Tesseract.js
                if (ocrCfg.mode === 'offline' || (!ocrCfg.togetherApiKey && !ocrCfg.hunyuanOcrUrl)) {
                    showToast('ðŸ” Scanning invoice (offline)...', 'info');
                    const result = await performOfflineInvoiceOCR(imageData);
                    showToast(`âœ… Invoice scanned (OFFLINE) ðŸŸ¡`, 'success');
                    return result;
                }

                // Try online first in hybrid/online mode
                showToast('ðŸ” Scanning invoice with AI OCR...', 'info');
                try {
                    const response = await fetch('/api/ocr-invoice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            context: 'Extract supplier invoice data',
                            userApiKey: ocrCfg.togetherApiKey,
                            hunyuanUrl: ocrCfg.hunyuanOcrUrl,
                            paddleUrl: ocrCfg.paddleOcrUrl
                        })
                    });

                    const result = await response.json();
                    const engineInfo = result.source ? ` (${result.source.toUpperCase()})` : '';
                    const confidenceIcon = result.confidence === 'high' ? 'ðŸŸ¢' :
                                           result.confidence === 'medium' ? 'ðŸŸ¡' : 'ðŸ”´';

                    if (result.success && result.data) {
                        showToast(`âœ… Invoice scanned${engineInfo} ${confidenceIcon}`, 'success');
                        result.data._ocrMeta = { engine: result.source, accuracy: result.accuracy, confidence: result.confidence };
                        return result.data;
                    }
                } catch (onlineErr) {
                    console.log('Online OCR failed, falling back to offline:', onlineErr);
                }

                // Fallback to offline in hybrid mode
                if (ocrCfg.mode === 'hybrid') {
                    showToast('ðŸ“± Switching to offline OCR...', 'info');
                    const result = await performOfflineInvoiceOCR(imageData);
                    showToast(`âœ… Invoice scanned (OFFLINE) ðŸŸ¡`, 'success');
                    return result;
                }

                showToast('âš ï¸ Could not scan invoice', 'warning');
                return null;
            } catch (error) {
                console.error('Invoice scan error:', error);
                showToast('âŒ Scan failed. Try again.', 'error');
                return null;
            }
        }

        // Offline invoice OCR using Tesseract.js
        async function performOfflineInvoiceOCR(imageData) {
            if (typeof Tesseract === 'undefined') {
                throw new Error('OCR library not loaded');
            }

            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            let imgSrc = 'data:image/jpeg;base64,' + imageData;
            if (imageData.startsWith('iVBOR')) {
                imgSrc = 'data:image/png;base64,' + imageData;
            }

            const { data: { text } } = await worker.recognize(imgSrc);
            await worker.terminate();

            // Parse invoice data from text
            return parseInvoiceFromText(text);
        }

        // Parse invoice data from raw OCR text
        function parseInvoiceFromText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const data = {
                supplier: '',
                invoiceNumber: '',
                date: '',
                total: 0,
                items: [],
                rawText: text,
                _ocrMeta: { engine: 'tesseract', confidence: 'medium' }
            };

            // Extract invoice number
            const invMatch = text.match(/inv(?:oice)?[:\s#-]*([A-Z0-9-]+)/i);
            if (invMatch) data.invoiceNumber = invMatch[1];

            // Extract date
            const dateMatch = text.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}|\d{4}[\/-]\d{2}[\/-]\d{2})/);
            if (dateMatch) data.date = dateMatch[1];

            // Extract total
            const totalMatch = text.match(/(?:total|amount|due)[:\s]*R?\s*([\d,]+\.?\d*)/i);
            if (totalMatch) data.total = parseFloat(totalMatch[1].replace(/,/g, ''));

            // First line often contains supplier name
            if (lines.length > 0) data.supplier = lines[0];

            return data;
        }

        // Scan price list (Offline-First: Tesseract.js â†’ Online APIs if configured)
        async function scanPriceList(imageData, supplierName) {
            const ocrCfg = getOCRConfig();
            try {
                // Offline mode - use Tesseract.js
                if (ocrCfg.mode === 'offline' || (!ocrCfg.togetherApiKey && !ocrCfg.paddleOcrUrl)) {
                    showToast('ðŸ” Scanning price list (offline)...', 'info');
                    const products = await performOfflinePriceListOCR(imageData, supplierName);
                    showToast(`âœ… Scanned ${products.length} products (OFFLINE) ðŸŸ¡`, 'success');
                    return products;
                }

                // Try online first
                showToast('ðŸ” Scanning price list with AI OCR...', 'info');
                try {
                    const response = await fetch('/api/ocr-pricelist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            supplier: supplierName,
                            context: 'Extract all products and prices',
                            userApiKey: ocrCfg.togetherApiKey,
                            paddleUrl: ocrCfg.paddleOcrUrl
                        })
                    });

                    const result = await response.json();
                    if (result.success && result.products) {
                        const engineInfo = result.source ? ` (${result.source.toUpperCase()})` : '';
                        showToast(`âœ… Scanned ${result.count} products${engineInfo}`, 'success');
                        return result.products;
                    }
                } catch (onlineErr) {
                    console.log('Online OCR failed, falling back to offline');
                }

                // Fallback to offline
                if (ocrCfg.mode === 'hybrid') {
                    showToast('ðŸ“± Switching to offline OCR...', 'info');
                    const products = await performOfflinePriceListOCR(imageData, supplierName);
                    showToast(`âœ… Scanned ${products.length} products (OFFLINE) ðŸŸ¡`, 'success');
                    return products;
                }

                return [];
            } catch (error) {
                console.error('Price list scan error:', error);
                showToast('âŒ Scan failed.', 'error');
                return [];
            }
        }

        // Offline price list OCR
        async function performOfflinePriceListOCR(imageData, supplierName) {
            if (typeof Tesseract === 'undefined') throw new Error('OCR not loaded');

            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            let imgSrc = 'data:image/jpeg;base64,' + imageData;
            if (imageData.startsWith('iVBOR')) imgSrc = 'data:image/png;base64,' + imageData;

            const { data: { text } } = await worker.recognize(imgSrc);
            await worker.terminate();

            return parsePriceListFromText(text, supplierName);
        }

        // Parse products from raw OCR text
        function parsePriceListFromText(text, supplierName) {
            const products = [];
            const lines = text.split('\n').filter(l => l.trim());

            // Look for lines with prices
            const pricePattern = /R?\s*([\d,]+\.?\d*)\s*$/;

            for (const line of lines) {
                const priceMatch = line.match(pricePattern);
                if (priceMatch) {
                    const price = parseFloat(priceMatch[1].replace(/,/g, ''));
                    if (price > 0 && price < 100000) {
                        const name = line.replace(pricePattern, '').trim();
                        if (name.length > 2) {
                            products.push({
                                name: name,
                                costPrice: price,
                                supplier: supplierName || 'Unknown',
                                _ocrMeta: { engine: 'tesseract', confidence: 'medium' }
                            });
                        }
                    }
                }
            }

            return products;
        }

        // Scan business card (Offline-First)
        async function scanCustomerCard(imageData) {
            const ocrCfg = getOCRConfig();
            try {
                // Offline mode
                if (ocrCfg.mode === 'offline' || (!ocrCfg.togetherApiKey && !ocrCfg.hunyuanOcrUrl)) {
                    showToast('ðŸ” Scanning card (offline)...', 'info');
                    const customer = await performOfflineCardOCR(imageData);
                    showToast(`âœ… Card scanned (OFFLINE) ðŸŸ¡`, 'success');
                    return customer;
                }

                // Try online first
                showToast('ðŸ” Scanning business card with AI OCR...', 'info');
                try {
                    const response = await fetch('/api/ocr-customer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            context: 'Extract customer/business contact info',
                            userApiKey: ocrCfg.togetherApiKey,
                            hunyuanUrl: ocrCfg.hunyuanOcrUrl
                        })
                    });

                    const result = await response.json();
                    if (result.success && result.customer) {
                        const engineInfo = result.source ? ` (${result.source.toUpperCase()})` : '';
                        showToast(`âœ… Card scanned${engineInfo}`, 'success');
                        return result.customer;
                    }
                } catch (onlineErr) {
                    console.log('Online OCR failed, falling back to offline');
                }

                // Fallback to offline
                if (ocrCfg.mode === 'hybrid') {
                    showToast('ðŸ“± Switching to offline OCR...', 'info');
                    const customer = await performOfflineCardOCR(imageData);
                    showToast(`âœ… Card scanned (OFFLINE) ðŸŸ¡`, 'success');
                    return customer;
                }

                return null;
            } catch (error) {
                console.error('Card scan error:', error);
                showToast('âŒ Scan failed.', 'error');
                return null;
            }
        }

        // Offline business card OCR
        async function performOfflineCardOCR(imageData) {
            if (typeof Tesseract === 'undefined') throw new Error('OCR not loaded');

            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            let imgSrc = 'data:image/jpeg;base64,' + imageData;
            if (imageData.startsWith('iVBOR')) imgSrc = 'data:image/png;base64,' + imageData;

            const { data: { text } } = await worker.recognize(imgSrc);
            await worker.terminate();

            return parseBusinessCardFromText(text);
        }

        // Parse business card data from raw OCR text
        function parseBusinessCardFromText(text) {
            const customer = {
                name: '',
                company: '',
                email: '',
                phone: '',
                address: '',
                rawText: text,
                _ocrMeta: { engine: 'tesseract', confidence: 'medium' }
            };

            const lines = text.split('\n').map(l => l.trim()).filter(l => l);

            // Extract email
            const emailMatch = text.match(/[\w.-]+@[\w.-]+\.\w+/i);
            if (emailMatch) customer.email = emailMatch[0].toLowerCase();

            // Extract phone - South African or international formats
            const phoneMatch = text.match(/(?:\+?27|0)[\s-]?\d{2}[\s-]?\d{3}[\s-]?\d{4}|\d{3}[\s-]?\d{3}[\s-]?\d{4}/);
            if (phoneMatch) customer.phone = phoneMatch[0].replace(/[\s-]/g, '');

            // Extract website (might indicate company)
            const webMatch = text.match(/(?:www\.)?[\w-]+\.(?:co\.za|com|org|net)/i);
            if (webMatch) {
                const domain = webMatch[0].replace(/www\./i, '').split('.')[0];
                if (!customer.company) customer.company = domain.charAt(0).toUpperCase() + domain.slice(1);
            }

            // First substantial line is often the name
            for (const line of lines) {
                if (line.length > 3 && !line.includes('@') && !line.match(/^\d/) && !line.match(/www\./i)) {
                    if (!customer.name) {
                        customer.name = line;
                    } else if (!customer.company && line.length > customer.name.length) {
                        customer.company = line;
                    }
                    if (customer.name && customer.company) break;
                }
            }

            return customer;
        }

        // Capture photo and scan (generic handler)
        async function captureAndScan(scanType) {
            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                
                // Create video element
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                // Show camera preview modal
                const modal = showCustomModal(`
                    <div style="text-align: center;">
                        <h2>ðŸ“¸ Scan ${scanType}</h2>
                        <video id="cameraPreview" autoplay style="width: 100%; max-width: 500px; border-radius: 8px;"></video>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="capturePhoto('${scanType}')">ðŸ“· Capture</button>
                            <button class="btn btn-secondary" onclick="stopCamera(); closeModal('customModal');">Cancel</button>
                        </div>
                    </div>
                `);
                
                // Attach stream to preview
                setTimeout(() => {
                    document.getElementById('cameraPreview').srcObject = stream;
                }, 100);
                
            } catch (error) {
                console.error('Camera error:', error);
                showToast('âŒ Camera access denied or unavailable', 'error');
            }
        }

        // Capture photo from video stream
        function capturePhoto(scanType) {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            // Stop camera
            stopCamera();
            closeModal('customModal');
            
            // Process based on type
            if (scanType === 'invoice') {
                scanSupplierInvoice(imageData).then(data => {
                    if (data) processScannedInvoice(data);
                });
            } else if (scanType === 'pricelist') {
                const supplier = prompt('Supplier name?') || 'Unknown';
                scanPriceList(imageData, supplier).then(products => {
                    if (products.length > 0) processScannedPriceList(products);
                });
            } else if (scanType === 'customer') {
                scanCustomerCard(imageData).then(customer => {
                    if (customer) processScannedCustomer(customer);
                });
            }
        }

        // Stop camera stream
        function stopCamera() {
            const video = document.getElementById('cameraPreview');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // Process scanned invoice data
        function processScannedInvoice(data) {
            // Build OCR status badge
            const ocrMeta = data._ocrMeta || {};
            const engineBadge = ocrMeta.engine ?
                `<span style="background: var(--primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">
                    ${ocrMeta.engine.toUpperCase()} ${ocrMeta.confidence === 'high' ? 'ðŸŸ¢' : ocrMeta.confidence === 'medium' ? 'ðŸŸ¡' : 'ðŸ”´'}
                </span>` : '';

            // Remove OCR metadata from display
            const displayData = { ...data };
            delete displayData._ocrMeta;

            showCustomModal(`
                <h2>ðŸ“„ Scanned Invoice Data ${engineBadge}</h2>
                ${ocrMeta.accuracy ? `<p style="opacity: 0.7; font-size: 0.85rem;">Accuracy: ${(ocrMeta.accuracy * 100).toFixed(0)}%</p>` : ''}
                <pre style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">${JSON.stringify(displayData, null, 2)}</pre>
                <button class="btn btn-primary" onclick="alert('Create purchase order feature coming soon!'); closeModal('customModal');">Create Purchase Order</button>
                <button class="btn btn-secondary" onclick="closeModal('customModal');">Close</button>
            `);
        }

        // Process scanned price list
        function processScannedPriceList(products) {
            // Build OCR status badge
            const ocrMeta = products._ocrMeta || {};
            const engineBadge = ocrMeta.engine ?
                `<span style="background: var(--primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">
                    ${ocrMeta.engine.toUpperCase()} ${ocrMeta.confidence === 'high' ? 'ðŸŸ¢' : ocrMeta.confidence === 'medium' ? 'ðŸŸ¡' : 'ðŸ”´'}
                </span>` : '';
            const langBadge = ocrMeta.language?.name ?
                `<span style="background: var(--secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">${ocrMeta.language.name}</span>` : '';

            showCustomModal(`
                <h2>ðŸ’° Scanned Price List ${engineBadge}${langBadge}</h2>
                <p>${products.length} products found ${ocrMeta.accuracy ? `(${(ocrMeta.accuracy * 100).toFixed(0)}% accuracy)` : ''}</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${products.filter(p => p && p.name).map(p => `<div style="padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">${p.name} - R${p.price || 0}</div>`).join('')}
                </div>
                <button class="btn btn-primary" onclick="importScannedProducts(${JSON.stringify(products.filter(p => p && p.name)).replace(/"/g, '&quot;')}); closeModal('customModal');">Import All Products</button>
                <button class="btn btn-secondary" onclick="closeModal('customModal');">Cancel</button>
            `);
        }

        // Process scanned customer
        function processScannedCustomer(customer) {
            // Check if customer already exists
            const existingCustomer = customers.find(c => 
                c.name.toLowerCase() === (customer.companyName || customer.name || '').toLowerCase() ||
                c.email === customer.email
            );
            
            if (existingCustomer) {
                showCustomModal(`
                    <h2>ðŸ‘¤ Customer Already Exists</h2>
                    <p style="margin: 1rem 0;">A customer with this name or email already exists:</p>
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <strong>${existingCustomer.name}</strong><br>
                        ${existingCustomer.contact ? existingCustomer.contact + '<br>' : ''}
                        ${existingCustomer.email ? existingCustomer.email + '<br>' : ''}
                        ${existingCustomer.phone ? existingCustomer.phone : ''}
                    </div>
                    <button class="btn btn-primary" onclick="editExistingCustomer('${existingCustomer.id}'); closeModal('customModal');">âœï¸ Edit Customer</button>
                    <button class="btn btn-secondary" onclick="closeModal('customModal');">Close</button>
                `);
                return;
            }
            
            // Pre-fill customer form with scanned data
            openModal('customerModal');
            if (customer.companyName || customer.name) document.getElementById('customerName').value = customer.companyName || customer.name;
            if (customer.contactPerson) document.getElementById('customerContact').value = customer.contactPerson;
            if (customer.phone || customer.mobile) document.getElementById('customerPhone').value = customer.phone || customer.mobile;
            if (customer.email) document.getElementById('customerEmail').value = customer.email;
            if (customer.address) document.getElementById('customerAddress').value = customer.address;
            
            showToast('âœ… Customer details pre-filled from scan! Click Save to add.', 'success');
        }
        
        function editExistingCustomer(customerId) {
            const customer = customers.find(c => c.id == customerId);
            if (!customer) return;
            
            openModal('customerModal');
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerContact').value = customer.contact || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('editCustomerId').value = customer.id;
        }

        // Import scanned products to catalog
        function importScannedProducts(scannedProducts) {
            let imported = 0;
            scannedProducts.forEach(p => {
                // Check if product already exists
                const exists = products.find(prod => prod.sku === p.sku || prod.name === p.name);
                if (!exists) {
                    products.push({
                        sku: p.sku || `SCAN-${Date.now()}-${imported}`,
                        name: p.name,
                        category: p.category || 'Imported',
                        landedCost: p.price,
                        supplier: p.supplier,
                        brand: p.supplier
                    });
                    imported++;
                }
            });
            
            saveToStorage(getBusinessKey('aweh_products'), products);
            showToast(`âœ… Imported ${imported} new products!`, 'success');
        }

        // ========================================
        // AI CHATBOT FUNCTIONS
        // ========================================

        let chatHistory = [];

        // Send message to AI chatbot
        async function sendChatMessage(message) {
            try {
                // Build context from current state
                const context = {
                    invoiceCount: invoices.length,
                    outstandingAmount: invoices.filter(inv => inv.status !== 'paid').reduce((sum, inv) => sum + inv.total, 0),
                    customerCount: customers.length,
                    todayRevenue: invoices.filter(inv => {
                        const today = new Date().toDateString();
                        return new Date(inv.date).toDateString() === today;
                    }).reduce((sum, inv) => sum + inv.total, 0),
                    overdueCount: invoices.filter(inv => {
                        if (inv.status === 'paid') return false;
                        return new Date(inv.dueDate) < new Date();
                    }).length
                };

                const response = await fetch('/api/ai-chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: context,
                        conversationHistory: chatHistory.slice(-5) // Last 5 messages for context
                    })
                });
                
                const result = await response.json();
                
                // Add to history
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: result.message });
                
                return result;
            } catch (error) {
                console.error('Chatbot error:', error);
                return {
                    message: "Sorry, I'm having trouble right now. Please try again!",
                    action: null
                };
            }
        }

        // Show chatbot UI
        function openChatbot() {
            const chatModal = showCustomModal(`
                <div style="display: flex; flex-direction: column; height: 500px;">
                    <h2 style="margin-bottom: 1rem;">ðŸ’¬ AI Assistant</h2>
                    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="opacity: 0.7; text-align: center;">
                            ðŸ‘‹ Hi! I'm your AI assistant. Ask me anything!<br>
                            <small>Try: "What's my revenue today?" or "Create invoice for Beach Bums"</small>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="chatInput" placeholder="Ask me anything..." style="flex: 1;" onkeypress="if(event.key==='Enter') sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()">Send</button>
                    </div>
                </div>
            `);
            
            // Focus input
            setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
        }

        // Send chat message (UI handler)
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input
            input.value = '';
            
            // Add user message to UI
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML += `
                <div style="margin-bottom: 1rem; text-align: right;">
                    <div style="display: inline-block; background: var(--primary); padding: 0.75rem; border-radius: 8px; max-width: 70%;">
                        ${message}
                    </div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Get AI response
            const result = await sendChatMessage(message);
            
            // Add AI response to UI
            chatContainer.innerHTML += `
                <div style="margin-bottom: 1rem;">
                    <div style="display: inline-block; background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 8px; max-width: 70%;">
                        ${result.message}
                        ${result.suggestions ? `
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${result.suggestions.map(s => `<button class="btn btn-sm btn-outline" onclick="document.getElementById('chatInput').value='${s}'; sendChat();">${s}</button>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ========================================
        // PAYMENT LINK FUNCTIONS
        // ========================================

        // Generate payment links based on configured payment methods
        function generatePaymentLinks(invoice) {
            const links = {};
            const amount = Math.round(invoice.total || 0);
            
            // Stripe Payment Link (requires manual setup in dashboard)
            if (settings.enableStripe && settings.stripePublishableKey) {
                links.stripe = {
                    needsSetup: true,
                    setupUrl: 'https://dashboard.stripe.com/payment-links',
                    instructions: 'Create a Payment Link in your Stripe Dashboard and share it with your customer.'
                };
            }
            
            // PayPal.me Link (instant setup)
            if (settings.enablePayPal && settings.paypalEmail) {
                const username = settings.paypalEmail.split('@')[0];
                links.paypal = {
                    url: `https://paypal.me/${username}/${amount}ZAR`,
                    type: 'paypal.me',
                    qrCode: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(`https://paypal.me/${username}/${amount}ZAR`)}`
                };
            }
            
            return links;
        }

        // Send payment link via WhatsApp
        function sendPaymentLink() {
            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('âš ï¸ Please select a customer first', 'error');
                return;
            }

            if (!customer.phone) {
                showToast('âš ï¸ Customer has no phone number saved', 'error');
                return;
            }

            const paymentLinks = generatePaymentLinks(currentInvoice);
            
            if (!paymentLinks.stripe && !paymentLinks.paypal) {
                showToast('âš ï¸ No payment methods configured. Set up Stripe or PayPal in Settings â†’ Payment Integration', 'error');
                return;
            }

            // Build message with payment links
            let message = `ðŸ„â€â™‚ï¸ Howzit ${customer.name}!\n\n`;
            message += `Invoice #${currentInvoice.number}\n`;
            message += `Amount Due: R${currentInvoice.total}\n\n`;
            message += `ðŸ’³ Pay securely online:\n\n`;
            
            if (paymentLinks.paypal) {
                message += `ðŸ’° PayPal: ${paymentLinks.paypal.url}\n`;
            }
            
            if (paymentLinks.stripe && paymentLinks.stripe.needsSetup) {
                message += `ðŸ’³ Stripe: [Add your Stripe Payment Link here]\n`;
            }
            
            message += `\nThanks! ðŸŒŠ`;

            // Send via WhatsApp
            const cleanPhone = customer.phone.replace(/[^0-9+]/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('âœ… Payment link opened in WhatsApp', 'success');
        }

        // Show payment link modal with QR codes
        function showPaymentLinkModal() {
            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('âš ï¸ Please select a customer first', 'error');
                return;
            }

            const paymentLinks = generatePaymentLinks(currentInvoice);
            
            if (!paymentLinks.stripe && !paymentLinks.paypal) {
                showToast('âš ï¸ No payment methods configured. Set up Stripe or PayPal in Settings â†’ Payment Integration', 'error');
                return;
            }

            let modalContent = `
                <div style="padding: 2rem;">
                    <h2 style="margin-bottom: 1.5rem;">ðŸ’³ Payment Links</h2>
                    <p style="opacity: 0.8; margin-bottom: 1.5rem;">
                        Invoice #${currentInvoice.number} - R${currentInvoice.total}
                    </p>
            `;

            if (paymentLinks.paypal) {
                modalContent += `
                    <div style="background: rgba(0, 112, 210, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="color: #0070d2; margin-bottom: 1rem;">PayPal</h3>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <img src="${paymentLinks.paypal.qrCode}" alt="PayPal QR Code" style="max-width: 200px; border-radius: 8px;">
                        </div>
                        <input type="text" value="${paymentLinks.paypal.url}" readonly style="width: 100%; margin-bottom: 0.5rem;" onclick="this.select()">
                        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${paymentLinks.paypal.url}'); showToast('Copied!', 'success');">
                            ðŸ“‹ Copy Link
                        </button>
                    </div>
                `;
            }

            if (paymentLinks.stripe) {
                modalContent += `
                    <div style="background: rgba(99, 91, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="color: #635bff; margin-bottom: 1rem;">Stripe</h3>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">
                            âš ï¸ Stripe Payment Links must be created manually in your dashboard.
                        </p>
                        <a href="${paymentLinks.stripe.setupUrl}" target="_blank" class="btn btn-primary">
                            Open Stripe Dashboard
                        </a>
                    </div>
                `;
            }

            modalContent += `
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-success" onclick="sendPaymentLink()">
                            ðŸ“± Send via WhatsApp
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('customModal')">
                            Close
                        </button>
                    </div>
                </div>
            `;

            showCustomModal(modalContent);
        }

        // Show custom modal
        function showCustomModal(content) {
            let modal = document.getElementById('customModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div id="customModalContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('customModalContent').innerHTML = content;
            openModal('customModal');
        }

        // Reports Functions
        function openReportsModal() {
            openModal('reportsModal');
            generateReports();
        }

        function generateReports() {
            // Check for overdue invoices first
            checkOverdueInvoices();

            // Total invoices
            const totalInvoices = invoices.length;
            document.getElementById('reportTotalInvoices').textContent = totalInvoices;

            // Total revenue
            const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            document.getElementById('reportTotalRevenue').textContent = 'R ' + formatNumber(Math.round(totalRevenue));

            // Outstanding balance
            const totalPaid = invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const outstanding = totalRevenue - totalPaid;
            document.getElementById('reportOutstanding').textContent = 'R ' + formatNumber(Math.round(outstanding));

            // Overdue invoices
            const overdueCount = invoices.filter(inv => inv.status === 'overdue').length;
            document.getElementById('reportOverdue').textContent = overdueCount;

            // Status breakdown
            const statusCounts = {
                draft: 0,
                sent: 0,
                partial: 0,
                paid: 0,
                overdue: 0,
                cancelled: 0
            };

            invoices.forEach(inv => {
                const status = inv.status || 'draft';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statusBreakdownHTML = Object.entries(statusCounts).map(([status, count]) => {
                if (count === 0) return '';
                return `
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        ${getStatusBadge(status)}
                        <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;">${count}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('statusBreakdown').innerHTML = statusBreakdownHTML;

            // Top customers by revenue
            const customerRevenue = {};
            invoices.forEach(inv => {
                const customer = inv.customer || 'Unknown';
                customerRevenue[customer] = (customerRevenue[customer] || 0) + (inv.total || 0);
            });

            const topCustomers = Object.entries(customerRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const topCustomersHTML = topCustomers.map(([customer, revenue], index) => `
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.5rem;">
                    <span><strong>${index + 1}.</strong> ${customer}</span>
                    <span style="color: var(--success); font-weight: 700;">R ${formatNumber(Math.round(revenue))}</span>
                </div>
            `).join('');

            document.getElementById('topCustomers').innerHTML = topCustomersHTML || '<p style="text-align: center; opacity: 0.5;">No customer data yet</p>';

            // Monthly revenue (last 6 months)
            const monthlyData = {};
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[monthKey] = { name: monthName, revenue: 0 };
            }

            invoices.forEach(inv => {
                const monthKey = inv.date?.slice(0, 7);
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].revenue += inv.total || 0;
                }
            });

            const maxRevenue = Math.max(...Object.values(monthlyData).map(m => m.revenue), 1);

            const monthlyHTML = Object.values(monthlyData).map(month => {
                const percentage = (month.revenue / maxRevenue) * 100;
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>${month.name}</span>
                            <span style="color: var(--success); font-weight: 700;">R ${formatNumber(Math.round(month.revenue))}</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); height: 30px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--primary), var(--success)); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('monthlyRevenue').innerHTML = monthlyHTML;
        }

        function exportReportData() {
            const reportData = {
                generatedDate: new Date().toISOString(),
                summary: {
                    totalInvoices: invoices.length,
                    totalRevenue: invoices.reduce((sum, inv) => sum + (inv.total || 0), 0),
                    totalPaid: invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0),
                    outstanding: invoices.reduce((sum, inv) => sum + ((inv.total || 0) - (inv.amountPaid || 0)), 0),
                    overdueCount: invoices.filter(inv => inv.status === 'overdue').length
                },
                invoices: invoices.map(inv => ({
                    number: inv.number,
                    date: inv.date,
                    dueDate: inv.dueDate,
                    customer: inv.customer,
                    type: inv.type,
                    status: inv.status,
                    total: inv.total,
                    amountPaid: inv.amountPaid || 0,
                    balance: (inv.total || 0) - (inv.amountPaid || 0)
                }))
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `business-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Report exported successfully!', 'success');
        }

        function validateRequired(value, fieldName) {
            if (!value || value.trim() === '') {
                showToast(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        // Safe LocalStorage Operations (Legacy - kept for backward compatibility)
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('Storage quota exceeded. Please export your data and clear old invoices.', 'error');
                } else {
                    showToast('Failed to save data: ' + e.message, 'error');
                }
                console.error('LocalStorage error:', e);
                return false;
            }
        }

        function safeGetItem(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Error reading from localStorage:', e);
                return defaultValue;
            }
        }

        // Google Drive Storage Operations (Async)
        async function saveToStorage(key, data) {
            console.log(`ðŸ’¾ Saving ${key}:`, data);
            try {
                // Always save to localStorage first as backup
                const localSaved = safeSetItem(key, JSON.stringify(data));
                console.log(`âœ… Saved to localStorage: ${key} (${localSaved ? 'success' : 'failed'})`);
                
                // Check if driveStorage is available and initialized
                if (typeof driveStorage !== 'undefined' && driveStorage.isSignedIn) {
                    await driveStorage.setItem(key, data);
                    console.log(`âœ… Saved to Google Drive: ${key}`);
                    
                    // Update sync status indicator
                    updateSyncStatus('synced');
                    
                    return true;
                } else {
                    // Update sync status indicator
                    updateSyncStatus('local');
                    console.log(`ðŸ’¾ ${key} saved to localStorage only (not signed in to Drive)`);
                    return localSaved;
                }
            } catch (error) {
                console.error(`âŒ Error saving ${key} to storage:`, error);
                // Try localStorage one more time
                updateSyncStatus('local');
                const fallbackSaved = safeSetItem(key, JSON.stringify(data));
                console.log(`ðŸ”„ Fallback localStorage save: ${fallbackSaved ? 'success' : 'FAILED'}`);
                return fallbackSaved;
            }
        }
        
        // Update sync status indicator
        function updateSyncStatus(status) {
            const syncBtn = document.getElementById('syncGoogleBtn');
            if (!syncBtn) return;
            
            if (status === 'synced') {
                syncBtn.textContent = 'âœ… Synced';
                syncBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                syncBtn.title = 'Data synced to Google Drive - accessible on all your devices';
            } else if (status === 'local') {
                syncBtn.textContent = 'ðŸ’¾ Local Only';
                syncBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                syncBtn.title = 'Data saved locally only - click to sync to Google Drive';
            } else {
                syncBtn.textContent = 'ðŸ”— Sync Google';
                syncBtn.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)';
                syncBtn.title = 'Click to set up Google Drive sync';
            }
        }

        async function loadFromStorage(key, defaultValue = null) {
            try {
                // Check if driveStorage is available and initialized
                if (typeof driveStorage !== 'undefined' && driveStorage.isSignedIn) {
                    const data = await driveStorage.getItem(key, defaultValue);
                    console.log(`ðŸ“¥ Loaded ${key} from Google Drive:`, data?.length || 0, 'items');
                    return data;
                } else {
                    // Fallback to localStorage
                    const data = safeGetItem(key, defaultValue);
                    console.log(`ðŸ“¥ Loaded ${key} from localStorage:`, data?.length || 0, 'items');
                    return data;
                }
            } catch (error) {
                console.error(`âŒ Error loading ${key} from storage:`, error);
                // Fallback to localStorage on error
                const data = safeGetItem(key, defaultValue);
                console.log(`ðŸ”„ Fallback loaded ${key} from localStorage:`, data?.length || 0, 'items');
                return data;
            }
        }
        
        // Get business-specific storage key
        function getBusinessKey(baseKey) {
            const businessId = localStorage.getItem('aweh_currentBusiness') || 'default';
            // Keep businesses list global, everything else is business-specific
            if (baseKey === 'aweh_businesses') return baseKey;
            
            // Check if this business shares products with a parent
            const business = businesses?.find(b => b.id === businessId);
            if (baseKey === 'aweh_products' && business?.shareProducts && business?.parentId) {
                // Use parent's product catalog
                return `${baseKey}_${business.parentId}`;
            }
            
            return `${baseKey}_${businessId}`;
        }

        function isDiggBusiness(business) {
            const normalize = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const name = normalize(business?.name);
            const tradingAs = normalize(business?.tradingAs);
            return name.includes('digg') || tradingAs.includes('digg');
        }

        function buildDiggSeedProducts() {
            return [
                {
                    sku: 'DIGG-ARCH-COUNCIL',
                    name: 'Architectural Design & Council Approvals',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 90000,
                    description: 'Complete design, working drawings, municipal submissions (597mÂ² @ R150/mÂ²)'
                },
                {
                    sku: 'DIGG-DESIGN-DEV',
                    name: 'Design Development & Construction Details',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 20000,
                    description: 'Detailed construction drawings and technical specifications'
                },
                {
                    sku: 'DIGG-PM-SERV',
                    name: 'Project Management Services',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 60000,
                    description: 'Site coordination, trade management, progress monitoring (10 weeks Ã— 8 hours/week @ R750/hour)'
                },
                {
                    sku: 'DIGG-SPEC-COORD',
                    name: 'Specialist Coordination (HVAC, Electrical, Structural)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 10000,
                    description: 'Engineering coordination, consultant liaison, technical oversight'
                },
                {
                    sku: 'DIGG-MEDIA-TECH',
                    name: 'Media Studio Technical Oversight (Client-handled)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 0,
                    description: 'Green screen, cyclorama, lighting grid coordination (to be handled by client)'
                },
                {
                    sku: 'DIGG-COUNCIL-INVOICE',
                    name: 'Council Invoice (Variable)',
                    brand: 'DIGG',
                    category: 'Disbursements',
                    landedCost: 0,
                    description: 'Use for municipal/council proforma invoices. Update the unit price per project.'
                },
                {
                    sku: 'DIGG-CCT-BUILDING-APP',
                    name: 'City of Cape Town - Building Application (Variable)',
                    brand: 'DIGG',
                    category: 'Disbursements',
                    landedCost: 0,
                    description: 'Example: Internal Alterations Non Residential (QS estimate based). Update unit price per council proforma.'
                },
                {
                    sku: 'DIGG-PROF-FEES-TOTAL',
                    name: 'Total Professional Fees (Excl. VAT)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 180000,
                    description: 'Professional fees total from schedule (Architectural + Design Development + Project Management + Specialist Coordination)'
                },
                {
                    sku: 'DIGG-MILESTONE-SUBMISSION',
                    name: 'Milestone Payment - Submission (30%)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 54000,
                    description: '30% of R 180,000 due on submission of municipal plans (excl. VAT)'
                },
                {
                    sku: 'DIGG-MILESTONE-APPROVAL',
                    name: 'Milestone Payment - Approval (30%)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 54000,
                    description: '30% of R 180,000 due on council approval (excl. VAT)'
                },
                {
                    sku: 'DIGG-MILESTONE-OCCUPATION',
                    name: 'Milestone Payment - Occupation Certificate (30%)',
                    brand: 'DIGG',
                    category: 'Services',
                    landedCost: 54000,
                    description: '30% of R 180,000 due on occupation certificate / completion (excl. VAT)'
                }
            ];
        }

        async function ensureDiggProductsSeededIfEmpty() {
            if (!isDiggBusiness(currentBusiness)) return;
            const key = getBusinessKey('aweh_products');
            const existing = await loadFromStorage(key, null);
            // Always seed if empty or null
            if (!Array.isArray(existing) || existing.length === 0) {
                console.log('ðŸ”§ Seeding DIGG products...');
                products = buildDiggSeedProducts();
                await saveToStorage(key, products);
                console.log('âœ… DIGG products seeded:', products.length, 'products');
            } else {
                products = existing;
                console.log('ðŸ“¦ Loaded existing DIGG products:', products.length);
            }
        }
        
        // Get all linked business IDs (parent + children)
        function getLinkedBusinessIds(businessId) {
            const business = businesses?.find(b => b.id === businessId);
            if (!business) return [businessId];
            
            const linkedIds = [businessId];
            
            // If this business has a parent, include parent and siblings
            if (business.parentId) {
                linkedIds.push(business.parentId);
                // Find siblings (other businesses with same parent)
                businesses.forEach(b => {
                    if (b.parentId === business.parentId && b.id !== businessId) {
                        linkedIds.push(b.id);
                    }
                });
            }
            
            // Find children (businesses that have this as parent)
            businesses.forEach(b => {
                if (b.parentId === businessId) {
                    linkedIds.push(b.id);
                }
            });
            
            return [...new Set(linkedIds)];
        }
        
        // Business switcher toggle
        function toggleBusinessSwitcher() {
            const dropdown = document.getElementById('businessSwitcherDropdown');
            if (!dropdown) return;
            
            const isVisible = dropdown.style.display !== 'none';
            dropdown.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                renderBusinessSwitcherList();
            }
        }
        
        // Mobile menu toggle
        function toggleMobileMenu() {
            const headerActions = document.querySelector('.header-actions');
            const menuIcon = document.getElementById('mobileMenuIcon');
            if (!headerActions) return;
            
            const isOpen = headerActions.classList.toggle('mobile-open');
            if (menuIcon) {
                menuIcon.textContent = isOpen ? 'âœ•' : 'â˜°';
            }
            
            // Prevent body scroll when menu is open
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const headerActions = document.querySelector('.header-actions');
            const menuToggle = document.querySelector('.mobile-menu-toggle');
            if (headerActions && headerActions.classList.contains('mobile-open')) {
                if (!headerActions.contains(e.target) && !menuToggle.contains(e.target)) {
                    toggleMobileMenu();
                }
            }
        });
        
        // Render business list in dropdown
        function renderBusinessSwitcherList() {
            const listDiv = document.getElementById('businessSwitcherList');
            if (!listDiv) return;
            
            const currentId = localStorage.getItem('aweh_currentBusiness') || 'default';
            
            listDiv.innerHTML = businesses.map(business => {
                const isActive = business.id === currentId;
                const logoHtml = business.logo 
                    ? `<img src="${business.logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">` 
                    : 'ðŸ¢';
                return `
                    <div onclick="quickSwitchBusiness('${business.id}')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s; ${isActive ? 'background: rgba(0, 212, 255, 0.2);' : ''} border-left: 3px solid ${isActive ? 'var(--primary)' : 'transparent'};" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='${isActive ? 'rgba(0, 212, 255, 0.2)' : 'transparent'}'">
                        <div style="width: 36px; height: 36px; background: ${business.logo ? 'transparent' : (isActive ? 'var(--primary)' : 'rgba(255,255,255,0.1)')}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; overflow: hidden;">${logoHtml}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: ${isActive ? '600' : '400'}; color: ${isActive ? 'var(--primary)' : 'inherit'};">${business.name}</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">${business.tradingAs || business.type || ''}</div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleBusinessSwitcher(); openCreateBusinessModal('${business.id}')" style="background: none; border: none; cursor: pointer; padding: 0.25rem; opacity: 0.6; font-size: 0.9rem;" title="Edit">âœï¸</button>
                        ${isActive ? '<span style="color: var(--success);">âœ“</span>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Quick switch without modal
        async function quickSwitchBusiness(businessId) {
            if (businessId === (localStorage.getItem('aweh_currentBusiness') || 'default')) {
                toggleBusinessSwitcher();
                return;
            }
            
            const business = businesses.find(b => b.id === businessId);
            if (!business) {
                showToast('Business not found', 'error');
                return;
            }

            // Do NOT auto-save settings on switch.
            // Auto-saving here can copy another business' details into this business.
            
            // Switch to new business
            localStorage.setItem('aweh_currentBusiness', businessId);
            currentBusiness = business;
            
            toggleBusinessSwitcher();
            showToast(`Switching to ${business.name}...`, 'info');
            
            // Reload to load new business data
            setTimeout(() => location.reload(), 300);
        }
        
        // Update header with current business
        function updateHeaderBusiness() {
            const currentId = localStorage.getItem('aweh_currentBusiness') || 'default';
            const business = businesses.find(b => b.id === currentId) || businesses[0];
            
            if (business) {
                const headerName = document.getElementById('headerBusinessName');
                const headerShort = document.getElementById('headerBusinessShort');
                
                if (headerName) {
                    // If business has a logo, show it in the header
                    if (business.logo || settings?.logo) {
                        const logoSrc = business.logo || settings?.logo;
                        headerName.innerHTML = `<img src="${logoSrc}" alt="${business.name}" style="height: 40px; width: auto; margin-right: 0.5rem; vertical-align: middle;"><span>${business.name}</span>`;
                    } else {
                        headerName.textContent = business.name;
                    }
                }
                if (headerShort) {
                    // Show short name (first word or abbreviation)
                    const shortName = business.name.split(' ')[0];
                    headerShort.textContent = shortName.length > 10 ? shortName.substring(0, 8) + '...' : shortName;
                }
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const switcher = document.querySelector('.business-switcher');
            const dropdown = document.getElementById('businessSwitcherDropdown');
            if (switcher && dropdown && !switcher.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        let settings = {
            logo: '',
            primaryColor: '#00d4ff',
            secondaryColor: '#ff006e',
            accentColor: '#7209b7',
            companyName: '',
            tradingAs: '',
            email: '',
            phone: '',
            website: '',
            whatsappTemplate: `Hi {customerName}! ðŸ‘‹

Your invoice is ready from {companyName}!

ðŸ“„ Invoice #{invoiceNumber}
ðŸ’° Total: R {total}
ðŸ“… Due: {dueDate}

ðŸ›’ Items:
{items}

ðŸ’³ Payment Details:
{bankDetails}

Thank you for your business!

{companyName}
{phone}
{email}`,
            emailSubject: 'Invoice {invoiceNumber} from {companyName}',
            emailTemplate: `Dear {customerName},

Please find your invoice details below:

Invoice #: {invoiceNumber}
Total Amount: R {total}
Due Date: {dueDate}

Items:
{items}

Payment Details:
{bankDetails}

If you have any questions, please don't hesitate to contact us.

Best regards,
{companyName}
{phone}
{email}`,
            aiProvider: '',
            aiApiKey: '',
            aiModel: 'gpt-4',
            enableAIFollowups: false,
            enableAIRecommendations: true,
            enableAIInsights: false,
            followupDaysOverdue: 3,
            followupFrequency: 7,
            maxFollowupAttempts: 3,
            aiFollowupPrompt: 'You are a friendly payment reminder assistant for {companyName}. Send a polite but firm follow-up message to {customerName} regarding overdue invoice {invoiceNumber} of R{total}. Keep it professional.',
            // Payment Integration
            enableStripe: false,
            stripePublishableKey: '',
            stripeSecretKey: '',
            enablePayPal: false,
            paypalClientId: '',
            paypalEmail: '',
            // Recurring Invoices
            enableRecurring: false,
            recurringDay: 1,
            // AI Features (FREE - hosted on Vercel)
            enableAIInsights: true,
            enableAIRecommendations: true,
            enableAIFollowups: true,
            vat: '',
            address: '',
            bankName: '',
            accountHolder: '',
            accountNumber: '',
            branchCode: '',
            showBanking: true
        };

        // Initialize Products - ALL 217 PRODUCTS WITH CORRECT NAMES AND COSTS
        function initializeProducts() {
            products = [
                // ========== AWAKE COMPLETE JETBOARDS ==========
                {sku: '99RE-21XR-GL', name: 'RÃ„VIK Explore XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 155323, description: 'Entry-level electric jetboard with XR4 battery'},
                {sku: '99R3-21XR-GL', name: 'RÃ„VIK Adventure XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 224814, description: 'Mid-range performance jetboard with XR4 battery'},
                {sku: '99RU-21XR-GL', name: 'RÃ„VIK Ultimate XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 259560, description: 'High-performance jetboard with XR4 battery'},
                {sku: '99R3-BRABUS-08BP-GL', name: 'BRABUS Shadow (Limited)', brand: 'Awake', category: 'Jetboards', landedCost: 291282, description: 'Limited edition BRABUS performance jetboard'},
                
                // ========== AWAKE EFOILS ==========
                {sku: '99VA-22LR-GL', name: 'VINGA Adventure LR 4', brand: 'Awake', category: 'eFoils', landedCost: 207441, description: 'Entry-level eFoil with LR4 battery'},
                {sku: '99VA-21XR-GL', name: 'VINGA Adventure XR 4', brand: 'Awake', category: 'eFoils', landedCost: 233500, description: 'Entry-level eFoil with XR4 battery'},
                {sku: '99VU-22LR-GL', name: 'VINGA Ultimate LR 4', brand: 'Awake', category: 'eFoils', landedCost: 224814, description: 'Professional eFoil with LR4 battery'},
                {sku: '99VU-21XR-GL', name: 'VINGA Ultimate XR 4', brand: 'Awake', category: 'eFoils', landedCost: 250873, description: 'Professional eFoil with XR4 battery'},
                
                // ========== AWAKE BATTERIES ==========
                {sku: '99CL-22LR', name: 'Flex Battery LR 4 (90 min)', brand: 'Awake', category: 'Batteries', landedCost: 50734, description: 'Long range battery - 90 min runtime'},
                {sku: '99CL-21XR', name: 'Flex Battery XR 4 (65 min)', brand: 'Awake', category: 'Batteries', landedCost: 78530, description: 'Extended range battery - 65 min runtime'},
                
                // ========== AWAKE BOARDS (EX BATTERY) ==========
                {sku: '99RE-GL', name: 'RÃ„VIK Explore (board only)', brand: 'Awake', category: 'Boards', landedCost: 85626, description: 'Explore board only, no battery or accessories'},
                {sku: '99RA-GL', name: 'RÃ„VIK Adventure (board only)', brand: 'Awake', category: 'Boards', landedCost: 137744, description: 'Adventure board only, no battery or accessories'},
                {sku: '99RU-GL', name: 'RÃ„VIK Ultimate (board only)', brand: 'Awake', category: 'Boards', landedCost: 155117, description: 'Ultimate board only, no battery or accessories'},
                {sku: '99VA-GL', name: 'VINGA Adventure (board only)', brand: 'Awake', category: 'Boards', landedCost: 155117, description: 'VINGA Adventure board only'},
                {sku: '99VU-GL', name: 'VINGA Ultimate (board only)', brand: 'Awake', category: 'Boards', landedCost: 163804, description: 'VINGA Ultimate board only'},
                
                // ========== AWAKE BAGS (20% Duty) ==========
                {sku: '99CL-09AY-31', name: 'Board Bag Kit (RÃ„VIK/VINGA)', brand: 'Awake', category: 'Bags', landedCost: 12500, description: 'Protective travel bag for boards'},
                {sku: '99CL-09AY-32', name: 'Battery Bag', brand: 'Awake', category: 'Bags', landedCost: 6196, description: 'Protective battery transport bag'},
                {sku: '99CL-09AY-33', name: 'Premium Travel Bag', brand: 'Awake', category: 'Bags', landedCost: 10415, description: 'Premium complete travel bag set'},
                {sku: '99CL-24HC', name: 'Flex Hand Controller', brand: 'Awake', category: 'Electronics', landedCost: 10450, description: 'Wireless hand controller'},
                
                // ========== VINGA WING KITS ==========
                {sku: '99L-19FD-WG-05', name: 'CRUISE 1600 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 17499, description: 'Complete CRUISE 1600 wing kit'},
                {sku: '99CL-19FD-WG-02', name: 'POWDER 1800 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 17499, description: 'Complete POWDER 1800 wing kit'},
                {sku: '99CL-19FD-WG-01', name: 'POWDER 1400 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 17499, description: 'Complete POWDER 1400 wing kit'},
                {sku: '99CL-19FD-WG-04', name: 'FLUID 1300 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 17499, description: 'Complete FLUID 1300 wing kit'},
                {sku: '99CL-19FD-WG-03', name: 'FLUID 1000 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 17499, description: 'Complete FLUID 1000 wing kit'},
                
                // ========== FINS & PERFORMANCE PARTS (0% Duty) ==========
                {sku: '99CL-09AY-03', name: 'RÃ„VIK Fins (Set of 3)', brand: 'Awake', category: 'Parts', landedCost: 3625, description: 'Standard fins set of 3'},
                {sku: '99CL-09AY-04', name: 'Carbon Fins (Set of 3)', brand: 'Awake', category: 'Parts', landedCost: 5188, description: 'Carbon fiber performance fins set of 3'},
                {sku: '99CL-09AY-02', name: 'Foot Straps', brand: 'Awake', category: 'Parts', landedCost: 5362, description: 'Adjustable foot straps'},
                
                // ========== SAFETY & STORAGE (20% Duty) ==========
                {sku: '99CL-LF-02', name: 'Life Vest (CE Certified)', brand: 'Awake', category: 'Safety', landedCost: 6196, description: 'CE certified life vest'},
                {sku: '99CL-09AY-49', name: 'Awake Dock (Floating)', brand: 'Awake', category: 'Storage', landedCost: 50433, description: 'Floating dock system'},
                {sku: '99CL-17WM-ALL', name: 'Wall Mount', brand: 'Awake', category: 'Storage', landedCost: 19013, description: 'Wall mounting bracket'},
                {sku: '09AY-54', name: 'Board Stand', brand: 'Awake', category: 'Storage', landedCost: 10415, description: 'Vertical display stand'},
                
                // ========== ELECTRONICS (0% Duty) ==========
                {sku: '99CL-07CH-GL', name: 'Battery Charger', brand: 'Awake', category: 'Electronics', landedCost: 15885, description: 'Fast charger for Flex batteries'},
                {sku: '99CL-06IN-GL', name: 'Controller Charger', brand: 'Awake', category: 'Electronics', landedCost: 3625, description: 'Charger for hand controller'},
                
                // ========== APPAREL (45% Duty) ==========
                {sku: '99CL-TS-01', name: 'T-shirt', brand: 'Awake', category: 'Apparel', landedCost: 2115, description: 'Official branded t-shirt'},
                {sku: '99CL-CP-02', name: 'Cap', brand: 'Awake', category: 'Apparel', landedCost: 1088, description: 'Branded cap'},
                {sku: '99CL-BM-01', name: 'Beach Mat', brand: 'Awake', category: 'Apparel', landedCost: 3616, description: 'Awake branded beach mat'},
                
                // ========== AQUA MARINA ISUPS (31 products) ==========
                {sku: 'AM-RACE-14', name: 'Race 14\'0" Racing SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 8500, description: 'Professional racing board'},
                {sku: 'AM-BEAST-18', name: 'Beast 18\'0" XXL SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 10500, description: 'Extra large capacity board'},
                {sku: 'AM-VAPOR-10', name: 'Vapor 10\'10" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Versatile all-round board'},
                {sku: 'AM-MAGMA-11', name: 'Magma 11\'2" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5200, description: 'Long distance touring'},
                {sku: 'AM-FUSION-10', name: 'Fusion 10\'10" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Family friendly board'},
                {sku: 'AM-HYPER-11', name: 'Hyper 11\'6" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5800, description: 'High performance touring'},
                {sku: 'AM-DRIFT-10', name: 'Drift 10\'10" Fishing', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6200, description: 'Fishing specific features'},
                {sku: 'AM-MONSTER-12', name: 'Monster 12\'0" Multi-Person', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 7500, description: 'Multi-person capacity'},
                {sku: 'AM-BREEZE-9', name: 'Breeze 9\'9" Compact', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3800, description: 'Compact travel board'},
                {sku: 'AM-BLADE-10', name: 'Blade 10\'6" Wind SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6500, description: 'Windsurf capable'},
                {sku: 'AM-ECHO-10', name: 'Echo 10\'6" Kids', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3500, description: 'Youth specific board'},
                {sku: 'AM-PEACE-10', name: 'Peace 10\'0" Yoga', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Yoga and fitness'},
                {sku: 'AM-LIQUID-10', name: 'Liquid 10\'4" Surf', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Wave riding performance'},
                {sku: 'AM-CHAMPION-14', name: 'Champion 14\'0" Racing', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 9500, description: 'Competition ready'},
                {sku: 'AM-ATLAS-12', name: 'Atlas 12\'0" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5800, description: 'Premium all-round'},
                {sku: 'AM-RAPID-12', name: 'Rapid 12\'6" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6200, description: 'Fast touring board'},
                {sku: 'AM-AQUA-GLIDE-11', name: 'Aqua Glide 11\'2" Family', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Family board'},
                {sku: 'AM-VIBRANT-8', name: 'Vibrant 8\'0" Youth', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2800, description: 'Kids starter board'},
                {sku: 'AM-SUPER-TRIP-12', name: 'Super Trip 12\'2" Family', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6800, description: 'Extra wide family board'},
                {sku: 'AM-ALL-AROUND-EIGHT-10', name: 'All Around Eight 10\'', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3200, description: 'Budget all-round'},
                {sku: 'AM-DHYANA-11', name: 'Dhyana 11\'0" Yoga', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Premium yoga board'},
                {sku: 'AM-TOMAHAWK-AIR-9', name: 'Tomahawk AIR 9\'9" Surf', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Surf style board'},
                {sku: 'AM-LEISURE-9', name: 'Leisure 9\'9" Beginner', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2800, description: 'Entry level board'},
                {sku: 'AM-SLIDE-10', name: 'Slide 10\'2" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3500, description: 'Mid-range all-round'},
                {sku: 'AM-CASCADE-10', name: 'Cascade 10\'0" River', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Whitewater capable'},
                {sku: 'AM-MEGA-19', name: 'Mega 19\'0" Party', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 15000, description: 'Giant party platform'},
                {sku: 'AM-EVOLUTION-10', name: 'Evolution 10\'10"', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Progressive design'},
                {sku: 'AM-CORAL-10', name: 'Coral 10\'2" Youth', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3200, description: 'Teen board'},
                {sku: 'AM-STREAM-9', name: 'Stream 9\'9" Compact', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3000, description: 'Small storage board'},
                {sku: 'AM-LIBERTY-9', name: 'Liberty 9\'9" Kids', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2500, description: 'Basic kids board'},
                {sku: 'AM-TRITON-11', name: 'Triton 11\'2" Advanced', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5500, description: 'Advanced rider board'},
                
                // ========== AQUA MARINA KAYAKS (17 products) ==========
                {sku: 'AM-K1-TANDEM', name: 'K1 Tandem Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6500, description: '2-person inflatable kayak'},
                {sku: 'AM-K2-SOLO', name: 'K2 Solo Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 4200, description: '1-person kayak'},
                {sku: 'AM-LAXO-285', name: 'Laxo-285 Family Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 5800, description: '2-3 person kayak'},
                {sku: 'AM-LAXO-320', name: 'Laxo-320 Touring', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6800, description: 'Long distance touring'},
                {sku: 'AM-STEAM-312', name: 'Steam-312 Fishing', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 7200, description: 'Fishing kayak'},
                {sku: 'AM-MEMBA-330', name: 'Memba-330 Tandem', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6200, description: 'Tandem touring kayak'},
                {sku: 'AM-BETTA-312', name: 'Betta-312 Advanced', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 5500, description: 'Performance kayak'},
                {sku: 'AM-TOMAHAWK-375', name: 'Tomahawk-375 Whitewater', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 7800, description: 'Whitewater kayak'},
                {sku: 'AM-VISTA-380', name: 'Vista-380 3-Person', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 8500, description: 'Family 3-person'},
                {sku: 'AM-KAYAK-SEAT', name: 'Kayak Seat Deluxe', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 850, description: 'Padded kayak seat'},
                {sku: 'AM-PADDLE-230', name: 'Kayak Paddle 230cm', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 650, description: 'Adjustable paddle'},
                {sku: 'AM-KAYAK-PUMP', name: 'Kayak High Pressure Pump', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 950, description: 'HP electric pump'},
                {sku: 'AM-KAYAK-BAG', name: 'Kayak Transport Bag', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1200, description: 'Wheeled bag'},
                {sku: 'AM-OUTRIGGER', name: 'Kayak Outrigger Kit', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1800, description: 'Stability outriggers'},
                {sku: 'AM-FISHING-ROD-HOLDER', name: 'Fishing Rod Holder', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 450, description: 'Rod mount'},
                {sku: 'AM-KAYAK-CART', name: 'Kayak Transport Cart', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1500, description: 'Wheeled cart'},
                {sku: 'AM-ANCHOR-KIT', name: 'Kayak Anchor Kit', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 850, description: 'Anchor and line'},
                
                // ========== AQUA MARINA BOATS (8 products) ==========
                {sku: 'AM-DELUXE-230', name: 'Deluxe 230 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 3500, description: '2-person raft'},
                {sku: 'AM-DELUXE-277', name: 'Deluxe 277 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 4800, description: '3-person raft'},
                {sku: 'AM-DELUXE-300', name: 'Deluxe 300 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 5500, description: '4-person raft'},
                {sku: 'AM-DELUXE-330', name: 'Deluxe 330 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 6500, description: '5-person raft'},
                {sku: 'AM-RACING-BOAT-300', name: 'Racing Boat 300', brand: 'Aqua Marina', category: 'Boats', landedCost: 7200, description: 'Sport racing boat'},
                {sku: 'AM-FISHING-BOAT-249', name: 'Fishing Boat 249', brand: 'Aqua Marina', category: 'Boats', landedCost: 5800, description: 'Fishing platform'},
                {sku: 'AM-DIVE-BOAT', name: 'Dive Support Boat', brand: 'Aqua Marina', category: 'Boats', landedCost: 6800, description: 'Diving support craft'},
                {sku: 'AM-RIB-FLOOR', name: 'RIB Floor Kit', brand: 'Aqua Marina', category: 'Boat Accessories', landedCost: 2200, description: 'Rigid floor insert'},
                
                // ========== MOTORS & BATTERIES (7 products) ==========
                {sku: 'AM-MOTOR-S1', name: 'S1 Electric Motor', brand: 'Aqua Marina', category: 'Motors', landedCost: 8500, description: 'Entry electric motor'},
                {sku: 'AM-MOTOR-S2', name: 'S2 Electric Motor Pro', brand: 'Aqua Marina', category: 'Motors', landedCost: 12000, description: 'Pro electric motor'},
                {sku: 'AM-BATTERY-40AH', name: '40Ah Battery Pack', brand: 'Aqua Marina', category: 'Batteries', landedCost: 4500, description: 'Rechargeable battery'},
                {sku: 'AM-BATTERY-60AH', name: '60Ah Battery Pack', brand: 'Aqua Marina', category: 'Batteries', landedCost: 6500, description: 'Extended battery'},
                {sku: 'AM-CHARGER-SMART', name: 'Smart Battery Charger', brand: 'Aqua Marina', category: 'Accessories', landedCost: 1200, description: 'Fast charger'},
                {sku: 'AM-MOTOR-MOUNT', name: 'Universal Motor Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 850, description: 'Motor bracket'},
                {sku: 'AM-PROPELLER-SPARE', name: 'Spare Propeller', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Replacement prop'},
                
                // ========== PADDLES (15 products) ==========
                {sku: 'AM-PADDLE-CARBON-ADJ', name: 'Carbon Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1800, description: 'Premium carbon'},
                {sku: 'AM-PADDLE-ALLOY-ADJ', name: 'Aluminum Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 950, description: 'Standard alloy'},
                {sku: 'AM-PADDLE-FIBREGLASS', name: 'Fiberglass Fixed Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1200, description: 'Fixed length'},
                {sku: 'AM-PADDLE-KIDS', name: 'Kids Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 650, description: 'Youth size'},
                {sku: 'AM-PADDLE-3PC', name: '3-Piece Travel Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1100, description: 'Portable paddle'},
                {sku: 'AM-PADDLE-TOURING', name: 'Touring Carbon Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 2200, description: 'Long distance'},
                {sku: 'AM-PADDLE-RACING', name: 'Racing Carbon Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 2800, description: 'Competition'},
                {sku: 'AM-PADDLE-SURF', name: 'Surf Paddle Short', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1400, description: 'Wave riding'},
                {sku: 'AM-PADDLE-ALLROUND', name: 'All-Round Basic Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 750, description: 'Entry level'},
                {sku: 'AM-PADDLE-MULTI-ADJUST', name: 'Multi-Position Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1300, description: 'Variable angles'},
                {sku: 'AM-PADDLE-FLOATING', name: 'Floating Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 850, description: 'High visibility'},
                {sku: 'AM-PADDLE-TELESCOPIC', name: 'Telescopic Compact Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 950, description: 'Ultra compact'},
                {sku: 'AM-PADDLE-BLADE-SPARE', name: 'Spare Paddle Blade', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Replacement blade'},
                {sku: 'AM-PADDLE-GRIP', name: 'Paddle Grip Upgrade', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Comfort grip'},
                {sku: 'AM-PADDLE-BAG', name: 'Paddle Travel Bag', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Protective bag'},
                
                // ========== PUMPS (5 products) ==========
                {sku: 'AM-PUMP-ELECTRIC-20PSI', name: 'Electric Pump 20 PSI', brand: 'Aqua Marina', category: 'Pumps', landedCost: 1800, description: 'High pressure electric'},
                {sku: 'AM-PUMP-DUAL-ACTION', name: 'Dual Action Hand Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 650, description: 'Manual pump'},
                {sku: 'AM-PUMP-TURBO', name: 'Turbo Electric Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 2500, description: 'Fast inflation'},
                {sku: 'AM-PUMP-12V', name: '12V Car Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 950, description: 'Vehicle powered'},
                {sku: 'AM-PUMP-RECHARGEABLE', name: 'Rechargeable Electric Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 2200, description: 'Cordless pump'},
                
                // ========== ACCESSORIES (40+ products) ==========
                {sku: 'AM-LEASH-COIL', name: 'Coiled SUP Leash', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Safety leash'},
                {sku: 'AM-LEASH-STRAIGHT', name: 'Straight SUP Leash', brand: 'Aqua Marina', category: 'Accessories', landedCost: 320, description: 'Standard leash'},
                {sku: 'AM-FIN-TOURING', name: 'Touring Center Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Large touring fin'},
                {sku: 'AM-FIN-ALLROUND', name: 'All-Round Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Standard fin'},
                {sku: 'AM-FIN-RACE', name: 'Racing Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Performance fin'},
                {sku: 'AM-FIN-SET-3PC', name: '3-Piece Fin Set', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Thruster setup'},
                {sku: 'AM-REPAIR-KIT', name: 'Repair Kit Pro', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Comprehensive repair'},
                {sku: 'AM-BACKPACK', name: 'SUP Backpack Deluxe', brand: 'Aqua Marina', category: 'Bags', landedCost: 1200, description: 'Wheeled backpack'},
                {sku: 'AM-DRYBAG-10L', name: 'Dry Bag 10L', brand: 'Aqua Marina', category: 'Bags', landedCost: 350, description: 'Waterproof bag'},
                {sku: 'AM-DRYBAG-20L', name: 'Dry Bag 20L', brand: 'Aqua Marina', category: 'Bags', landedCost: 450, description: 'Large dry bag'},
                {sku: 'AM-PHONE-CASE', name: 'Waterproof Phone Case', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Phone protection'},
                {sku: 'AM-GOPRO-MOUNT', name: 'GoPro Camera Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Camera bracket'},
                {sku: 'AM-DECK-PAD', name: 'EVA Deck Pad', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Traction pad'},
                {sku: 'AM-ROOF-RACK-PADS', name: 'Roof Rack Pads', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Car transport pads'},
                {sku: 'AM-TIE-DOWN-STRAPS', name: 'Tie-Down Straps', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Secure straps'},
                {sku: 'AM-WATERPROOF-SPEAKER', name: 'Bluetooth Waterproof Speaker', brand: 'Aqua Marina', category: 'Accessories', landedCost: 850, description: 'Music system'},
                {sku: 'AM-COOLER-BAG', name: 'Floating Cooler Bag', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Insulated bag'},
                {sku: 'AM-SEAT-CONVERSION', name: 'Kayak Seat Conversion Kit', brand: 'Aqua Marina', category: 'Accessories', landedCost: 950, description: 'SUP to kayak'},
                {sku: 'AM-FISHING-MOUNT', name: 'Fishing Rod Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Rod holder'},
                {sku: 'AM-CARGO-NET', name: 'Deck Cargo Net', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Storage net'},
                {sku: 'AM-BUNGEE-CORD', name: 'Bungee Cord Set', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Elastic cords'},
                {sku: 'AM-VALVE-ADAPTER', name: 'Valve Adapter Kit', brand: 'Aqua Marina', category: 'Accessories', landedCost: 180, description: 'Universal adapters'},
                {sku: 'AM-PRESSURE-GAUGE', name: 'Digital Pressure Gauge', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'PSI meter'},
                {sku: 'AM-ANCHOR-FOLDING', name: 'Folding Anchor', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Compact anchor'},
                {sku: 'AM-WATERPROOF-LIGHTS', name: 'LED Waterproof Lights', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Safety lights'},
                {sku: 'AM-COMPASS', name: 'Marine Compass', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Navigation compass'},
                {sku: 'AM-WHISTLE', name: 'Safety Whistle', brand: 'Aqua Marina', category: 'Safety', landedCost: 120, description: 'Emergency whistle'},
                {sku: 'AM-PFD-ADULT', name: 'Adult Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 850, description: 'Buoyancy vest'},
                {sku: 'AM-PFD-YOUTH', name: 'Youth Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 650, description: 'Kids life vest'},
                {sku: 'AM-PFD-CHILD', name: 'Child Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 550, description: 'Toddler vest'},
                {sku: 'AM-HELMET', name: 'Water Sports Helmet', brand: 'Aqua Marina', category: 'Safety', landedCost: 750, description: 'Protection helmet'},
                {sku: 'AM-GLOVES', name: 'Paddling Gloves', brand: 'Aqua Marina', category: 'Apparel', landedCost: 350, description: 'Grip gloves'},
                {sku: 'AM-WETSUIT-SHORTY', name: 'Shorty Wetsuit', brand: 'Aqua Marina', category: 'Apparel', landedCost: 1200, description: 'Short wetsuit'},
                {sku: 'AM-WETSUIT-FULLSUIT', name: 'Full Wetsuit', brand: 'Aqua Marina', category: 'Apparel', landedCost: 1800, description: 'Full body wetsuit'},
                {sku: 'AM-RASH-GUARD', name: 'Rash Guard Shirt', brand: 'Aqua Marina', category: 'Apparel', landedCost: 550, description: 'Sun protection'},
                {sku: 'AM-BOARDSHORTS', name: 'Quick-Dry Boardshorts', brand: 'Aqua Marina', category: 'Apparel', landedCost: 450, description: 'Swim shorts'},
                {sku: 'AM-SUNGLASSES', name: 'Polarized Sunglasses', brand: 'Aqua Marina', category: 'Apparel', landedCost: 650, description: 'Water sunglasses'},
                {sku: 'AM-HAT', name: 'Quick-Dry Cap', brand: 'Aqua Marina', category: 'Apparel', landedCost: 280, description: 'Sun hat'},
                {sku: 'AM-TOWEL', name: 'Microfiber Towel', brand: 'Aqua Marina', category: 'Apparel', landedCost: 350, description: 'Quick-dry towel'},
                {sku: 'AM-CHANGING-MAT', name: 'Changing Mat', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Wetsuit changing mat'}
            ];
            
            console.log(`âœ… Loaded ${products.length} products`);
            displayProducts();
            updateProductCount();
            
            // Initialize view toggle buttons
            const savedView = localStorage.getItem('aweh_product_view') || 'grid';
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (savedView === 'list') {
                listBtn.className = 'btn btn-sm';
                listBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
                listBtn.style.border = 'none';
                gridBtn.className = 'btn btn-sm btn-outline';
                gridBtn.style.background = '';
            }
        }

        // Initialize Customers - SAMPLE CUSTOMERS
        function initializeCustomers() {
            customers = [
                {
                    id: 1,
                    name: 'Wave Dominator',
                    company: 'Cape Town Surf School',
                    email: 'info@ctsurf.co.za',
                    phone: '+27 82 123 4567',
                    address: 'Camps Bay Beach\nCape Town, 8005',
                    vat: '4987654321',
                    tier: 'rental'
                },
                {
                    id: 2,
                    name: 'John Smith',
                    company: '',
                    email: 'john.smith@email.com',
                    phone: '+27 83 234 5678',
                    address: 'Clifton, Cape Town',
                    vat: '',
                    tier: 'retail'
                },
                {
                    id: 3,
                    name: 'Sarah Johnson',
                    company: 'Luxury Marine Sports',
                    email: 'sarah@luxmarine.co.za',
                    phone: '+27 84 345 6789',
                    address: 'V&A Waterfront\nCape Town, 8001',
                    vat: '4112233445',
                    tier: 'gold'
                },
                {
                    id: 4,
                    name: 'Allan Stuart',
                    company: '',
                    email: 'allan.stuart@gmail.com',
                    phone: '+27 76 456 7890',
                    address: 'Blouberg, Cape Town',
                    vat: '',
                    tier: 'retail'
                }
            ];
            
            loadCustomers();
        }

        // Tab Switching with smooth animation
        function switchTab(tabName, clickedTab) {
            // Get the clicked tab element (from event or passed directly)
            const navTab = clickedTab || (event ? event.target.closest('.nav-tab') : null);
            
            // Scroll to top of page for better UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Hide all tabs with fade out
            document.querySelectorAll('.tab-content').forEach(tab => {
                if (tab.classList.contains('active')) {
                    tab.style.opacity = '0';
                    tab.style.transform = 'translateY(10px)';
                }
            });
            
            // Short delay for animation, then switch
            setTimeout(() => {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.opacity = '';
                    tab.style.transform = '';
                });
                
                // Remove active from all nav tabs and update ARIA
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                
                // Show selected tab with fade in
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // Make nav tab active and update ARIA
                if (navTab) {
                    navTab.classList.add('active');
                    navTab.setAttribute('aria-selected', 'true');
                }
                
                // Refresh data for specific tabs
                if (tabName === 'invoices') {
                    loadAllInvoices();
                } else if (tabName === 'customers') {
                    loadCustomers();
                } else if (tabName === 'products') {
                    const activeFilter = document.querySelector('.filter-tag.active')?.dataset?.filter || 'all';
                    displayProducts(activeFilter);
                } else if (tabName === 'dashboard') {
                    updateDashboard();
                }
            }, 150);
        }

        // ==================== AI FEATURES ====================
        
        // Smart Search with RAGFlow
        async function runSmartSearch() {
            const searchInput = document.getElementById('aiSmartSearch');
            const resultsDiv = document.getElementById('smartSearchResults');
            const query = searchInput.value.trim();
            
            if (!query) {
                showToast('Please enter a search query', 'warning');
                return;
            }
            
            resultsDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">ðŸ” Searching...</p>';
            
            try {
                const response = await fetch('/api/rag-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        invoices: invoices,
                        customers: customers
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    resultsDiv.innerHTML = `<p style="color: var(--danger);">Error: ${result.error}</p>`;
                    return;
                }
                
                // Display results
                let html = `<div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 1rem;">
                    <strong>ðŸ’¡ ${result.answer}</strong>
                </div>`;
                
                if (result.data && result.data.invoices && result.data.invoices.length > 0) {
                    html += '<div style="margin-top: 1rem;"><strong>Invoices:</strong></div>';
                    html += '<div style="display: grid; gap: 0.75rem; margin-top: 0.75rem;">';
                    
                    result.data.invoices.forEach(inv => {
                        html += `<div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${inv.number}</strong> - ${inv.customer}<br>
                                <span style="font-size: 0.85rem; opacity: 0.8;">${inv.date} â€¢ ${inv.status}</span>
                            </div>
                            <div style="text-align: right;">
                                <strong style="font-size: 1.1rem; color: var(--success);">R ${formatNumber(Math.round(inv.total))}</strong><br>
                                <span style="font-size: 0.85rem; opacity: 0.8;">Balance: R ${formatNumber(Math.round(inv.balance))}</span>
                            </div>
                        </div>`;
                    });
                    
                    html += '</div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Smart search error:', error);
                resultsDiv.innerHTML = `<p style="color: var(--danger);">Search failed. Please try again.</p>`;
            }
        }
        
        // Run Individual AI Agent
        async function runAgent(agentType) {
            const statusEl = document.getElementById(`${agentType}Status`);
            const resultsEl = document.getElementById(`${agentType}Results`);
            
            statusEl.textContent = 'Status: Running...';
            resultsEl.innerHTML = '';
            
            try {
                const response = await fetch('/api/crew-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent: agentType,
                        invoices: invoices,
                        customer: customers[0] || {},
                        history: invoices
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    statusEl.textContent = 'Status: Error';
                    resultsEl.innerHTML = `<p style="color: var(--danger);">${result.error}</p>`;
                    return;
                }
                
                statusEl.textContent = 'Status: Complete âœ…';
                
                // Display agent-specific results
                if (agentType === 'analyst') {
                    displayAnalystResults(result, resultsEl);
                } else if (agentType === 'collector') {
                    displayCollectorResults(result, resultsEl);
                } else if (agentType === 'organizer') {
                    displayOrganizerResults(result, resultsEl);
                }
                
                showToast(`${result.agent} completed successfully!`, 'success');
                
            } catch (error) {
                console.error('Agent error:', error);
                statusEl.textContent = 'Status: Failed';
                resultsEl.innerHTML = `<p style="color: var(--danger);">Agent failed. Please try again.</p>`;
            }
        }
        
        function displayAnalystResults(result, container) {
            if (!result.insights || result.insights.length === 0) {
                container.innerHTML = '<p>No insights available</p>';
                return;
            }
            
            let html = '';
            result.insights.forEach(insight => {
                html += `<div style="background: rgba(0, 212, 255, 0.1); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid var(--primary);">
                    <strong>${insight.title}</strong><br>`;
                
                if (insight.data) {
                    Object.entries(insight.data).forEach(([key, value]) => {
                        html += `<span style="font-size: 0.85rem;">${key}: <strong>${value}</strong></span><br>`;
                    });
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function displayCollectorResults(result, container) {
            if (!result.followups || result.followups.length === 0) {
                container.innerHTML = '<p style="color: var(--success);">âœ… No overdue invoices - no follow-ups needed!</p>';
                return;
            }
            
            let html = `<p><strong>${result.count}</strong> follow-up(s) drafted:</p>`;
            result.followups.forEach((followup, index) => {
                html += `<div style="background: rgba(6, 255, 165, 0.1); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid var(--success);">
                    <strong>Invoice ${followup.invoice}</strong> (R ${followup.amount.toFixed(2)})<br>
                    <span style="font-size: 0.85rem;">Tone: ${followup.tone}</span><br>
                    <details style="margin-top: 0.5rem;">
                        <summary style="cursor: pointer; opacity: 0.8;">View message</summary>
                        <pre style="white-space: pre-wrap; margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85rem;">${followup.message}</pre>
                    </details>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function displayOrganizerResults(result, container) {
            container.innerHTML = `<div style="background: rgba(255, 190, 11, 0.1); padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--warning);">
                <strong>Issues Found:</strong> ${result.issues_found}<br>
                <strong>Issues Fixed:</strong> ${result.issues_fixed}<br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Status: ${result.status}</span>
            </div>`;
        }
        
        // Run All Agents
        async function runAllAgents() {
            showToast('Running all AI agents...', 'info');
            await runAgent('analyst');
            await runAgent('collector');
            await runAgent('organizer');
            showToast('All agents completed!', 'success');
        }

        // Display Products
        function displayProducts(filter = 'all') {
            const grid = document.getElementById('productGrid');
            if (!grid) return; // Exit if element doesn't exist
            
            const searchInput = document.getElementById('productSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const viewMode = localStorage.getItem('aweh_product_view') || 'grid';
            
            let filteredProducts = products || [];
            
            // Apply brand filter
            if (filter !== 'all') {
                const brandMap = {
                    awake: 'Awake',
                    aquamarina: 'Aqua Marina',
                    digg: 'DIGG'
                };
                const targetBrand = brandMap[filter] || filter;
                filteredProducts = filteredProducts.filter(p => String(p.brand || '').toLowerCase() === String(targetBrand).toLowerCase());
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (p.sku && p.sku.toLowerCase().includes(searchTerm)) ||
                    (p.category && p.category.toLowerCase().includes(searchTerm))
                );
            }
            
            // Update grid class based on view mode
            if (viewMode === 'list') {
                grid.className = 'product-list';
                grid.innerHTML = `
                    <div class="list-header" style="display: grid; grid-template-columns: 1fr 150px 200px 150px 150px; gap: 1rem; padding: 1rem; background: var(--glass); border-radius: 8px; margin-bottom: 1rem; font-weight: 600; color: var(--primary);">
                        <div>Product Details</div>
                        <div>Category</div>
                        <div>Pricing</div>
                        <div>SKU</div>
                        <div>Actions</div>
                    </div>
                    ${filteredProducts.map(product => {
                        const costExclVAT = product.landedCost;
                        const vatAmount = costExclVAT * 0.15;
                        const costInclVAT = costExclVAT + vatAmount;
                        
                        return `
                            <div class="product-list-item" style="display: grid; grid-template-columns: 1fr 150px 200px 150px 150px; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, var(--darker), var(--dark)); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 8px; margin-bottom: 0.5rem; align-items: center; transition: all 0.3s ease;">
                                <div>
                                    <div class="product-brand" style="margin-bottom: 0.5rem;">${product.brand}</div>
                                    <div class="product-name" style="font-size: 1rem;">${product.name}</div>
                                    <div class="product-description" style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">${product.description || ''}</div>
                                </div>
                                <div style="color: rgba(255,255,255,0.7);">${product.category}</div>
                                <div>
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Excl. VAT: <strong style="color: var(--success);">R ${formatNumber(Math.round(costExclVAT))}</strong></div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">VAT (15%): R ${formatNumber(Math.round(vatAmount))}</div>
                                    <div style="font-size: 0.9rem; color: var(--accent); margin-top: 0.25rem; font-weight: 600;">Incl. VAT: R ${formatNumber(Math.round(costInclVAT))}</div>
                                </div>
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">${product.sku}</div>
                                <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addProductToInvoice('${product.sku}');" style="width: 100%;">Add to Invoice</button>
                                    <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); openEditProductModal('${product.sku}');" style="width: 100%;">âœï¸ Edit</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            } else {
                // Grid view
                grid.className = 'product-grid';
                grid.innerHTML = filteredProducts.map(product => {
                    const costExclVAT = product.landedCost;
                    const vatAmount = costExclVAT * 0.15;
                    const costInclVAT = costExclVAT + vatAmount;
                    
                    return `
                        <div class="product-card">
                            <div class="product-brand">${product.brand}</div>
                            <div class="product-name">${product.name}</div>
                            <div class="product-sku">SKU: ${product.sku}</div>
                            <div class="product-description" style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0.5rem 0; min-height: 2.5rem;">${product.description || ''}</div>
                            <div style="margin: 1rem 0; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border-left: 3px solid var(--success);">
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.25rem;">Cost (excl. VAT):</div>
                                <div class="product-price">R ${formatNumber(Math.round(costExclVAT))}</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.5rem;">VAT (15%): R ${formatNumber(Math.round(vatAmount))}</div>
                                <div style="font-size: 0.9rem; color: var(--accent); margin-top: 0.25rem; font-weight: 600;">Incl. VAT: R ${formatNumber(Math.round(costInclVAT))}</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="addProductToInvoice('${product.sku}')" style="width: 100%; margin-bottom: 0.5rem;">Add to Invoice</button>
                            <button class="btn btn-outline btn-sm" onclick="openEditProductModal('${product.sku}')" style="width: 100%;">âœï¸ Edit Product</button>
                        </div>
                    `;
                }).join('');
            }
            
            updateProductCount(filteredProducts.length);
        }

        // Update Product Count
        function updateProductCount(visible = null) {
            const totalEl = document.getElementById('totalProducts');
            const visibleEl = document.getElementById('visibleProducts');
            if (totalEl) totalEl.textContent = (products || []).length;
            if (visible !== null && visibleEl) {
                visibleEl.textContent = visible;
            } else if (visibleEl) {
                visibleEl.textContent = (products || []).length;
            }
        }

        // Filter Tags
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    displayProducts(e.target.dataset.filter);
                });
            });
            
            // Product Search
            const productSearchInput = document.getElementById('productSearch');
            if (productSearchInput) {
                productSearchInput.addEventListener('input', () => {
                    const activeFilterTag = document.querySelector('.filter-tag.active');
                    const activeFilter = activeFilterTag ? activeFilterTag.dataset.filter : 'all';
                    displayProducts(activeFilter);
                });
            }
        });

        // Format Number with spaces
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Calculate and display storage usage
        function updateStorageUsage() {
            try {
                let totalBytes = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalBytes += localStorage[key].length + key.length;
                    }
                }
                
                const usedMB = (totalBytes / 1024 / 1024).toFixed(2);
                const limitMB = 5; // Most browsers allow 5-10MB
                const percentage = Math.min((usedMB / limitMB * 100), 100).toFixed(1);
                
                const textEl = document.getElementById('storageUsageText');
                const percentEl = document.getElementById('storagePercentText');
                const barEl = document.getElementById('storageProgressBar');
                
                if (textEl) textEl.textContent = `${usedMB} MB used of ~${limitMB} MB`;
                if (percentEl) percentEl.textContent = `${percentage}%`;
                if (barEl) {
                    barEl.style.width = percentage + '%';
                    // Change color based on usage
                    if (percentage > 80) {
                        barEl.style.background = 'linear-gradient(90deg, #f72585, #ff006e)';
                        showToast('âš ï¸ Storage almost full! Consider exporting data.', 'warning');
                    } else if (percentage > 60) {
                        barEl.style.background = 'linear-gradient(90deg, #ffbe0b, #fb5607)';
                    } else {
                        barEl.style.background = 'linear-gradient(90deg, var(--success), var(--primary))';
                    }
                }
            } catch (e) {
                console.log('Storage calculation error:', e);
            }
        }

        // Switch Product View (Grid/List)
        function switchProductView(viewMode) {
            localStorage.setItem('aweh_product_view', viewMode);
            
            // Update button styles
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (viewMode === 'grid') {
                gridBtn.className = 'btn btn-sm';
                gridBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
                gridBtn.style.border = 'none';
                listBtn.className = 'btn btn-sm btn-outline';
                listBtn.style.background = '';
            } else {
                listBtn.className = 'btn btn-sm';
                listBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
                listBtn.style.border = 'none';
                gridBtn.className = 'btn btn-sm btn-outline';
                gridBtn.style.background = '';
            }
            
            // Refresh display with current filter
            const activeFilter = document.querySelector('.filter-tag.active').dataset.filter;
            displayProducts(activeFilter);
        }

        // Open Edit Product Modal
        function openEditProductModal(sku) {
            const productIndex = products.findIndex(p => p.sku === sku);
            if (productIndex === -1) {
                showToast('Product not found', 'error');
                return;
            }
            
            const product = products[productIndex];
            
            // Populate form
            document.getElementById('editProductIndex').value = productIndex;
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductBrand').value = product.brand || '';
            document.getElementById('editProductSKU').value = product.sku || '';
            document.getElementById('editProductCategory').value = product.category || 'Custom';
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editProductCost').value = product.landedCost || 0;
            
            // Calculate and show VAT
            updateEditProductCalculations();
            
            // Add event listener for cost changes
            document.getElementById('editProductCost').addEventListener('input', updateEditProductCalculations);
            
            openModal('editProductModal');
        }

        // Update VAT calculations in edit modal
        function updateEditProductCalculations() {
            const cost = parseFloat(document.getElementById('editProductCost').value) || 0;
            const vat = cost * 0.15;
            const total = cost + vat;
            
            document.getElementById('editProductVAT').value = 'R ' + formatNumber(Math.round(vat));
            document.getElementById('editProductTotal').value = 'R ' + formatNumber(Math.round(total));
        }

        // Save Edited Product
        async function saveEditedProduct() {
            const productIndex = parseInt(document.getElementById('editProductIndex').value);
            
            if (productIndex < 0 || productIndex >= products.length) {
                showToast('Invalid product', 'error');
                return;
            }
            
            const name = document.getElementById('editProductName').value.trim();
            const cost = parseFloat(document.getElementById('editProductCost').value);
            
            if (!name) {
                showToast('Product name is required', 'error');
                return;
            }
            
            if (!cost || cost < 0) {
                showToast('Valid cost price is required', 'error');
                return;
            }
            
            // Get current user for owner tracking
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            
            // Update product
            products[productIndex] = {
                ...products[productIndex],
                name: name,
                brand: document.getElementById('editProductBrand').value.trim() || products[productIndex].brand,
                category: document.getElementById('editProductCategory').value,
                description: document.getElementById('editProductDescription').value.trim(),
                landedCost: cost,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser ? (currentUser.username || currentUser.email) : 'unknown'
            };
            
            // Save to storage
            await saveToStorage(getBusinessKey('aweh_products'), products);
            
            // Refresh display
            const activeFilter = document.querySelector('.filter-tag.active').dataset.filter;
            displayProducts(activeFilter);
            
            closeModal('editProductModal');
            showToast('Product updated successfully!', 'success');
            logActivity(`Product updated: ${name}`, currentUser ? currentUser.username : 'unknown');
        }

        // ========================================
        // STOCK RECEIVING & PAYABLES SYSTEM
        // ========================================

        // Global state for receiving
        let payables = [];
        let receivingHistory = [];
        let exchangeRates = { USD: 18.50, EUR: 20.20, GBP: 23.50, SEK: 1.75, CNY: 2.55 };
        let receivingDocuments = [];
        let receivingItems = [];
        let currentReceivingStep = 1;

        // Initialize payables and receiving data
        async function initializeReceivingData() {
            try {
                payables = safeGetItem('aweh_payables', []);
                receivingHistory = safeGetItem('aweh_receiving_history', []);
                const savedRates = safeGetItem('aweh_exchange_rates', null);
                if (savedRates && savedRates.rates) {
                    exchangeRates = savedRates.rates;
                    const ratesUpdatedEl = document.getElementById('ratesLastUpdated');
                    if (ratesUpdatedEl) {
                        ratesUpdatedEl.textContent = new Date(savedRates.lastUpdated).toLocaleDateString();
                    }
                }
                updateExchangeRateDisplay();
                updatePayablesDisplay();
                updateReceivingHistoryDisplay();
            } catch (error) {
                console.warn('Receiving data initialization skipped:', error);
            }
        }

        // Refresh Exchange Rates (using free API)
        async function refreshExchangeRates() {
            const btn = document.getElementById('refreshRatesBtn');
            if (!btn) return;
            btn.textContent = 'â³ Updating...';
            btn.disabled = true;
            
            try {
                // Using frankfurter.app - free, no API key needed
                const response = await fetch('https://api.frankfurter.app/latest?from=ZAR&to=USD,EUR,GBP,SEK,CNY');
                const data = await response.json();
                
                // Convert to ZAR (rates are from ZAR, so we need inverse)
                exchangeRates = {
                    USD: (1 / data.rates.USD).toFixed(2),
                    EUR: (1 / data.rates.EUR).toFixed(2),
                    GBP: (1 / data.rates.GBP).toFixed(2),
                    SEK: (1 / data.rates.SEK).toFixed(2),
                    CNY: (1 / data.rates.CNY).toFixed(2)
                };
                
                const ratesData = {
                    rates: exchangeRates,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('aweh_exchange_rates', JSON.stringify(ratesData));
                
                updateExchangeRateDisplay();
                const ratesUpdatedEl = document.getElementById('ratesLastUpdated');
                if (ratesUpdatedEl) ratesUpdatedEl.textContent = new Date().toLocaleDateString();
                showToast('Exchange rates updated!', 'success');
            } catch (error) {
                console.error('Failed to fetch exchange rates:', error);
                showToast('Could not fetch rates. Using cached values.', 'warning');
            }
            
            btn.textContent = 'ðŸ”„ Refresh Rates';
            btn.disabled = false;
        }

        function updateExchangeRateDisplay() {
            const rateUSD = document.getElementById('rateUSD');
            const rateEUR = document.getElementById('rateEUR');
            const rateGBP = document.getElementById('rateGBP');
            const rateSEK = document.getElementById('rateSEK');
            const rateCNY = document.getElementById('rateCNY');
            
            if (rateUSD) rateUSD.textContent = 'R ' + exchangeRates.USD;
            if (rateEUR) rateEUR.textContent = 'R ' + exchangeRates.EUR;
            if (rateGBP) rateGBP.textContent = 'R ' + exchangeRates.GBP;
            if (rateSEK) rateSEK.textContent = 'R ' + exchangeRates.SEK;
            if (rateCNY) rateCNY.textContent = 'R ' + exchangeRates.CNY;
        }

        function convertToZAR(amount, currency) {
            if (currency === 'ZAR') return amount;
            const rate = parseFloat(exchangeRates[currency]) || 1;
            return amount * rate;
        }

        // Open Stock Receiving Modal
        function openStockReceivingModal(scanType = 'auto') {
            document.getElementById('receivingScanType').value = scanType;
            receivingDocuments = [];
            receivingItems = [];
            currentReceivingStep = 1;
            
            // Update title based on scan type
            const titles = {
                'auto': 'ðŸ¤– AI Auto-Scan (Detects Document Type)',
                'supplier-invoice': 'ðŸ“‹ Scan Supplier Invoice',
                'customs': 'ðŸ›ƒ Scan Customs Declaration',
                'delivery': 'ðŸšš Scan Delivery Note',
                'shipping': 'ðŸš¢ Scan Shipping Invoice'
            };
            document.getElementById('receivingTypeTitle').textContent = titles[scanType] || titles['auto'];
            
            // Reset UI
            updateReceivingStepUI();
            document.getElementById('uploadedDocsList').innerHTML = '';
            document.getElementById('receivingContent1').style.display = 'block';
            document.getElementById('receivingContent2').style.display = 'none';
            document.getElementById('receivingContent3').style.display = 'none';
            document.getElementById('receivingContent4').style.display = 'none';
            
            // Populate supplier dropdown
            const supplierSelect = document.getElementById('receivingSupplier');
            supplierSelect.innerHTML = '<option value="">Select or detected automatically</option>' +
                suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            openModal('stockReceivingModal');
        }

        function updateReceivingStepUI() {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`receivingStep${i}`);
                const spanEl = stepEl.querySelector('span:first-child');
                if (i <= currentReceivingStep) {
                    stepEl.style.opacity = '1';
                    if (i === currentReceivingStep) {
                        spanEl.style.background = 'var(--primary)';
                    } else {
                        spanEl.style.background = 'var(--success)';
                    }
                } else {
                    stepEl.style.opacity = '0.5';
                    spanEl.style.background = 'rgba(255,255,255,0.2)';
                }
            }
            
            // Update buttons
            document.getElementById('receivingBackBtn').style.display = currentReceivingStep > 1 ? 'inline-flex' : 'none';
            document.getElementById('receivingNextBtn').style.display = currentReceivingStep < 4 ? 'inline-flex' : 'none';
            document.getElementById('receivingConfirmBtn').style.display = currentReceivingStep === 4 ? 'inline-flex' : 'none';
            
            // Update next button text
            if (currentReceivingStep === 1) {
                document.getElementById('receivingNextBtn').textContent = 'Process with AI â†’';
            } else if (currentReceivingStep === 2) {
                document.getElementById('receivingNextBtn').textContent = 'Review â†’';
            } else if (currentReceivingStep === 3) {
                document.getElementById('receivingNextBtn').textContent = 'Calculate Landed Cost â†’';
            }
        }

        // Handle document upload for receiving
        async function handleReceivingUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const docData = {
                    id: Date.now(),
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                };
                receivingDocuments.push(docData);
                updateUploadedDocsList();
            };
            reader.readAsDataURL(file);
            
            // Reset input for same file selection
            event.target.value = '';
        }

        function updateUploadedDocsList() {
            const container = document.getElementById('uploadedDocsList');
            if (receivingDocuments.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong style="color: var(--success);">ðŸ“„ ${receivingDocuments.length} document(s) ready for processing:</strong>
                    <div style="margin-top: 0.5rem;">
                        ${receivingDocuments.map((doc, i) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-top: 0.5rem;">
                                <span>ðŸ“„ ${doc.name}</span>
                                <button class="btn btn-sm btn-outline" onclick="removeReceivingDoc(${i})" style="padding: 0.25rem 0.5rem;">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function removeReceivingDoc(index) {
            receivingDocuments.splice(index, 1);
            updateUploadedDocsList();
        }

        // Navigation
        function receivingNextStep() {
            if (currentReceivingStep === 1) {
                if (receivingDocuments.length === 0) {
                    showToast('Please upload at least one document', 'error');
                    return;
                }
                // Start AI processing
                processReceivingDocuments();
            } else if (currentReceivingStep === 2) {
                // Move to review (handled by AI processing completion)
            } else if (currentReceivingStep === 3) {
                // Validate items
                if (receivingItems.length === 0) {
                    showToast('Please add at least one item', 'error');
                    return;
                }
                currentReceivingStep = 4;
                showReceivingStep4();
            }
        }

        function receivingPreviousStep() {
            if (currentReceivingStep > 1) {
                currentReceivingStep--;
                document.getElementById(`receivingContent${currentReceivingStep + 1}`).style.display = 'none';
                document.getElementById(`receivingContent${currentReceivingStep}`).style.display = 'block';
                updateReceivingStepUI();
            }
        }

        // AI Processing
        async function processReceivingDocuments() {
            currentReceivingStep = 2;
            document.getElementById('receivingContent1').style.display = 'none';
            document.getElementById('receivingContent2').style.display = 'block';
            updateReceivingStepUI();
            
            const statusEl = document.getElementById('aiProcessingStatus');
            
            try {
                statusEl.textContent = 'Sending documents to AI...';
                
                // Process each document
                let allItems = [];
                let detectedSupplier = '';
                let detectedInvoiceNumber = '';
                let detectedDate = '';
                let detectedCurrency = 'ZAR';
                let detectedDueDate = '';
                
                for (let i = 0; i < receivingDocuments.length; i++) {
                    statusEl.textContent = `Processing document ${i + 1} of ${receivingDocuments.length}...`;
                    
                    const doc = receivingDocuments[i];
                    const scanType = document.getElementById('receivingScanType').value;
                    
                    try {
                        const response = await fetch('/api/ocr-stock-receipt', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: doc.data,
                                scanType: scanType,
                                fileName: doc.name
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            if (result.supplier && !detectedSupplier) detectedSupplier = result.supplier;
                            if (result.invoiceNumber && !detectedInvoiceNumber) detectedInvoiceNumber = result.invoiceNumber;
                            if (result.date && !detectedDate) detectedDate = result.date;
                            if (result.currency && result.currency !== 'ZAR') detectedCurrency = result.currency;
                            if (result.dueDate && !detectedDueDate) detectedDueDate = result.dueDate;
                            
                            if (result.items && result.items.length > 0) {
                                allItems = allItems.concat(result.items);
                            }
                            
                            // Store extracted costs for landed cost calculation
                            if (result.documentType === 'customs') {
                                document.getElementById('landedCustomsDuties').value = result.totalDuties || 0;
                                document.getElementById('landedImportVAT').value = result.importVAT || 0;
                            } else if (result.documentType === 'shipping') {
                                document.getElementById('landedShipping').value = result.shippingCost || 0;
                            }
                        }
                    } catch (err) {
                        console.error('OCR error for document:', err);
                    }
                }
                
                // Use extracted data or defaults
                receivingItems = allItems.length > 0 ? allItems : [{
                    sku: '',
                    description: 'Item from scanned document',
                    quantity: 1,
                    unitPrice: 0,
                    total: 0,
                    matchedProduct: null
                }];
                
                // Populate form with detected data
                if (detectedSupplier) {
                    const matchedSupplier = suppliers.find(s => 
                        s.name.toLowerCase().includes(detectedSupplier.toLowerCase()) ||
                        detectedSupplier.toLowerCase().includes(s.name.toLowerCase())
                    );
                    if (matchedSupplier) {
                        document.getElementById('receivingSupplier').value = matchedSupplier.id;
                    }
                }
                
                document.getElementById('receivingInvoiceNumber').value = detectedInvoiceNumber;
                document.getElementById('receivingInvoiceDate').value = detectedDate || new Date().toISOString().split('T')[0];
                document.getElementById('receivingDueDate').value = detectedDueDate || '';
                document.getElementById('receivingCurrency').value = detectedCurrency;
                
                statusEl.textContent = 'Processing complete!';
                
                setTimeout(() => {
                    currentReceivingStep = 3;
                    document.getElementById('receivingContent2').style.display = 'none';
                    document.getElementById('receivingContent3').style.display = 'block';
                    updateReceivingStepUI();
                    renderReceivingItems();
                }, 500);
                
            } catch (error) {
                console.error('AI processing error:', error);
                statusEl.textContent = 'AI processing encountered an issue. Proceeding with manual entry...';
                
                // Still allow manual entry
                receivingItems = [{
                    sku: '',
                    description: '',
                    quantity: 1,
                    unitPrice: 0,
                    total: 0,
                    matchedProduct: null
                }];
                
                setTimeout(() => {
                    currentReceivingStep = 3;
                    document.getElementById('receivingContent2').style.display = 'none';
                    document.getElementById('receivingContent3').style.display = 'block';
                    updateReceivingStepUI();
                    renderReceivingItems();
                }, 1500);
            }
        }

        function renderReceivingItems() {
            const tbody = document.getElementById('receivingItemsBody');
            tbody.innerHTML = receivingItems.map((item, i) => `
                <tr>
                    <td>
                        <input type="text" class="form-control" value="${item.sku || ''}" 
                            onchange="updateReceivingItem(${i}, 'sku', this.value)" 
                            placeholder="SKU" style="min-width: 100px;">
                    </td>
                    <td>
                        <input type="text" class="form-control" value="${item.description || ''}" 
                            onchange="updateReceivingItem(${i}, 'description', this.value)" 
                            placeholder="Description" style="min-width: 150px;">
                    </td>
                    <td>
                        <input type="number" class="form-control" value="${item.quantity || 1}" 
                            onchange="updateReceivingItem(${i}, 'quantity', parseFloat(this.value))" 
                            style="width: 70px;" min="1">
                    </td>
                    <td>
                        <input type="number" class="form-control" value="${item.unitPrice || 0}" 
                            onchange="updateReceivingItem(${i}, 'unitPrice', parseFloat(this.value))" 
                            style="width: 100px;" step="0.01">
                    </td>
                    <td style="font-weight: 600;">${formatNumber(Math.round(item.quantity * item.unitPrice))}</td>
                    <td>
                        <select class="form-control" onchange="matchProductToReceiving(${i}, this.value)" style="min-width: 150px;">
                            <option value="">No match</option>
                            ${products.map(p => `
                                <option value="${p.sku}" ${item.matchedProduct === p.sku ? 'selected' : ''}>
                                    ${p.name} (${p.sku})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function updateReceivingItem(index, field, value) {
            receivingItems[index][field] = value;
            if (field === 'quantity' || field === 'unitPrice') {
                receivingItems[index].total = receivingItems[index].quantity * receivingItems[index].unitPrice;
            }
            renderReceivingItems();
        }

        function matchProductToReceiving(index, sku) {
            receivingItems[index].matchedProduct = sku || null;
        }

        function addReceivingLineItem() {
            receivingItems.push({
                sku: '',
                description: '',
                quantity: 1,
                unitPrice: 0,
                total: 0,
                matchedProduct: null
            });
            renderReceivingItems();
        }

        function showReceivingStep4() {
            document.getElementById('receivingContent3').style.display = 'none';
            document.getElementById('receivingContent4').style.display = 'block';
            
            const currency = document.getElementById('receivingCurrency').value;
            const supplierTotal = receivingItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const supplierTotalZAR = convertToZAR(supplierTotal, currency);
            
            document.getElementById('landedSupplierTotal').textContent = `R ${formatNumber(Math.round(supplierTotalZAR))}`;
            calculateLandedCost();
            updateReceivingStepUI();
        }

        function calculateLandedCost() {
            const currency = document.getElementById('receivingCurrency').value;
            const supplierTotal = receivingItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const supplierTotalZAR = convertToZAR(supplierTotal, currency);
            
            const customsDuties = parseFloat(document.getElementById('landedCustomsDuties').value) || 0;
            const importVAT = parseFloat(document.getElementById('landedImportVAT').value) || 0;
            const shipping = parseFloat(document.getElementById('landedShipping').value) || 0;
            const clearingFees = parseFloat(document.getElementById('landedClearingFees').value) || 0;
            
            const totalLandedCost = supplierTotalZAR + customsDuties + importVAT + shipping + clearingFees;
            document.getElementById('landedTotalCost').textContent = `R ${formatNumber(Math.round(totalLandedCost))}`;
        }

        function updateReceivingTotals() {
            if (currentReceivingStep === 4) {
                showReceivingStep4();
            }
        }

        // Confirm and save receiving
        async function confirmStockReceiving() {
            const currency = document.getElementById('receivingCurrency').value;
            const supplierId = document.getElementById('receivingSupplier').value;
            const invoiceNumber = document.getElementById('receivingInvoiceNumber').value || `RCV-${Date.now()}`;
            const invoiceDate = document.getElementById('receivingInvoiceDate').value;
            const dueDate = document.getElementById('receivingDueDate').value;
            const markAsPaid = document.getElementById('receivingMarkAsPaid').checked;
            
            const supplierTotal = receivingItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const supplierTotalZAR = convertToZAR(supplierTotal, currency);
            
            const customsDuties = parseFloat(document.getElementById('landedCustomsDuties').value) || 0;
            const importVAT = parseFloat(document.getElementById('landedImportVAT').value) || 0;
            const shipping = parseFloat(document.getElementById('landedShipping').value) || 0;
            const clearingFees = parseFloat(document.getElementById('landedClearingFees').value) || 0;
            const totalLandedCost = supplierTotalZAR + customsDuties + importVAT + shipping + clearingFees;
            
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            const supplier = suppliers.find(s => s.id == supplierId);
            
            // Create receiving record
            const receivingRecord = {
                id: Date.now(),
                invoiceNumber: invoiceNumber,
                date: invoiceDate,
                dueDate: dueDate,
                supplierId: supplierId,
                supplierName: supplier ? supplier.name : 'Unknown',
                currency: currency,
                originalAmount: supplierTotal,
                zarAmount: supplierTotalZAR,
                customsDuties: customsDuties,
                importVAT: importVAT,
                shipping: shipping,
                clearingFees: clearingFees,
                totalLandedCost: totalLandedCost,
                items: receivingItems,
                documents: receivingDocuments.map(d => ({ name: d.name, type: d.type })),
                status: markAsPaid ? 'paid' : 'unpaid',
                paidAmount: markAsPaid ? totalLandedCost : 0,
                createdAt: new Date().toISOString(),
                createdBy: currentUser ? currentUser.username : 'unknown'
            };
            
            receivingHistory.push(receivingRecord);
            await saveToStorage('aweh_receiving_history', receivingHistory);
            
            // Create payable if not marked as paid
            if (!markAsPaid) {
                const payable = {
                    id: Date.now(),
                    receivingId: receivingRecord.id,
                    invoiceNumber: invoiceNumber,
                    date: invoiceDate,
                    dueDate: dueDate,
                    supplierId: supplierId,
                    supplierName: supplier ? supplier.name : 'Unknown',
                    currency: currency,
                    originalAmount: supplierTotal,
                    zarAmount: totalLandedCost,
                    itemCount: receivingItems.length,
                    status: 'unpaid',
                    paidAmount: 0,
                    payments: [],
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser ? currentUser.username : 'unknown'
                };
                payables.push(payable);
                await saveToStorage('aweh_payables', payables);
            }
            
            // Update product costs and stock for matched items
            const totalUnits = receivingItems.reduce((sum, item) => sum + item.quantity, 0);
            const landedCostPerUnit = totalUnits > 0 ? totalLandedCost / totalUnits : 0;
            
            for (const item of receivingItems) {
                if (item.matchedProduct) {
                    const productIndex = products.findIndex(p => p.sku === item.matchedProduct);
                    if (productIndex !== -1) {
                        // Update landed cost
                        products[productIndex].landedCost = Math.round(landedCostPerUnit);
                        products[productIndex].stockQuantity = (products[productIndex].stockQuantity || 0) + item.quantity;
                        products[productIndex].lastReceived = new Date().toISOString();
                        products[productIndex].costHistory = products[productIndex].costHistory || [];
                        products[productIndex].costHistory.push({
                            date: new Date().toISOString(),
                            cost: Math.round(landedCostPerUnit),
                            source: invoiceNumber
                        });
                    }
                }
            }
            await saveToStorage(getBusinessKey('aweh_products'), products);
            
            closeModal('stockReceivingModal');
            showToast('Stock received and costs updated!', 'success');
            updatePayablesDisplay();
            updateReceivingHistoryDisplay();
            logActivity(`Stock received: ${invoiceNumber} - R ${formatNumber(Math.round(totalLandedCost))}`, currentUser ? currentUser.username : 'unknown');
        }

        // Payables Display
        function updatePayablesDisplay() {
            const tbody = document.getElementById('payablesTableBody');
            if (!tbody) return; // Exit if element doesn't exist
            
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let totalOutstanding = 0;
            let overdueAmount = 0;
            let weekDueAmount = 0;
            let paidThisMonth = 0;
            
            const unpaidPayables = payables.filter(p => p.status !== 'paid');
            
            unpaidPayables.forEach(p => {
                const balance = p.zarAmount - (p.paidAmount || 0);
                totalOutstanding += balance;
                
                if (p.dueDate && new Date(p.dueDate) < now) {
                    overdueAmount += balance;
                } else if (p.dueDate && new Date(p.dueDate) <= weekFromNow) {
                    weekDueAmount += balance;
                }
            });
            
            // Calculate paid this month
            payables.filter(p => p.status === 'paid').forEach(p => {
                if (p.payments && p.payments.length > 0) {
                    p.payments.forEach(pay => {
                        if (new Date(pay.date) >= startOfMonth) {
                            paidThisMonth += pay.amount;
                        }
                    });
                }
            });
            
            const totalPayablesEl = document.getElementById('totalPayables');
            const overduePayablesEl = document.getElementById('overduePayables');
            const weekPayablesEl = document.getElementById('weekPayables');
            const paidThisMonthEl = document.getElementById('paidThisMonth');
            
            if (totalPayablesEl) totalPayablesEl.textContent = `R ${formatNumber(Math.round(totalOutstanding))}`;
            if (overduePayablesEl) overduePayablesEl.textContent = `R ${formatNumber(Math.round(overdueAmount))}`;
            if (weekPayablesEl) weekPayablesEl.textContent = `R ${formatNumber(Math.round(weekDueAmount))}`;
            if (paidThisMonthEl) paidThisMonthEl.textContent = `R ${formatNumber(Math.round(paidThisMonth))}`;
            
            if (unpaidPayables.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 2rem; opacity: 0.6;">
                            No outstanding payables. All invoices are paid! ðŸŽ‰
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = unpaidPayables.map(p => {
                const isOverdue = p.dueDate && new Date(p.dueDate) < now;
                const balance = p.zarAmount - (p.paidAmount || 0);
                
                return `
                    <tr style="${isOverdue ? 'background: rgba(255, 0, 0, 0.1);' : ''}">
                        <td>${p.date || '-'}</td>
                        <td>${p.supplierName}</td>
                        <td>${p.invoiceNumber}</td>
                        <td>${p.itemCount || 0} items</td>
                        <td>${p.currency}</td>
                        <td>${p.currency} ${formatNumber(Math.round(p.originalAmount))}</td>
                        <td style="font-weight: 600;">R ${formatNumber(Math.round(balance))}</td>
                        <td style="${isOverdue ? 'color: #ff6b6b; font-weight: bold;' : ''}">${p.dueDate || '-'}</td>
                        <td>${getPayableStatusBadge(p, isOverdue)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="openPaymentModal(${p.id})">ðŸ’³ Pay</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getPayableStatusBadge(payable, isOverdue) {
            if (payable.status === 'paid') {
                return '<span style="background: rgba(0,255,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: #06ffa5;">âœ… Paid</span>';
            } else if (isOverdue) {
                return '<span style="background: rgba(255,0,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: #ff6b6b;">âš ï¸ Overdue</span>';
            } else if (payable.paidAmount > 0) {
                return '<span style="background: rgba(255,165,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: #ffbe0b;">ðŸ”„ Partial</span>';
            } else {
                return '<span style="background: rgba(0,212,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: #00d4ff;">ðŸ“‹ Unpaid</span>';
            }
        }

        function updateReceivingHistoryDisplay() {
            const tbody = document.getElementById('receivingHistoryBody');
            if (!tbody) return; // Exit if element doesn't exist
            
            if (receivingHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.6;">
                            No receiving records yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = receivingHistory.slice().reverse().map(r => `
                <tr>
                    <td>${r.date || '-'}</td>
                    <td>${r.currency !== 'ZAR' ? 'ðŸ“¦ Import' : 'ðŸ“‹ Local'}</td>
                    <td>${r.supplierName}</td>
                    <td>${r.items ? r.items.length : 0} items</td>
                    <td style="font-weight: 600;">R ${formatNumber(Math.round(r.totalLandedCost))}</td>
                    <td>${r.documents ? r.documents.length : 0} docs</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewReceivingDetails(${r.id})">ðŸ‘ï¸ View</button>
                    </td>
                </tr>
            `).join('');
        }

        // Payment Modal
        function openPaymentModal(payableId) {
            const payable = payables.find(p => p.id === payableId);
            if (!payable) {
                showToast('Payable not found', 'error');
                return;
            }
            
            const balance = payable.zarAmount - (payable.paidAmount || 0);
            
            document.getElementById('paymentPayableId').value = payableId;
            document.getElementById('paymentSupplierName').textContent = payable.supplierName;
            document.getElementById('paymentInvoiceNum').textContent = payable.invoiceNumber;
            document.getElementById('paymentAmountDue').textContent = `R ${formatNumber(Math.round(balance))}`;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = Math.round(balance);
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';
            
            selectPaymentMethod('manual');
            openModal('paymentPOPModal');
        }

        function selectPaymentMethod(method) {
            document.getElementById('manualPaymentSection').style.display = method === 'manual' ? 'block' : 'none';
            document.getElementById('popUploadSection').style.display = method === 'scan' ? 'block' : 'none';
            
            document.getElementById('payMethodManual').className = method === 'manual' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('payMethodScan').className = method === 'scan' ? 'btn btn-primary' : 'btn btn-outline';
        }

        async function handlePOPUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Show preview
                document.getElementById('popPreview').style.display = 'block';
                document.getElementById('popPreviewImage').src = e.target.result;
                
                // Process with AI
                document.getElementById('popProcessingStatus').style.display = 'block';
                
                try {
                    const response = await fetch('/api/ocr-stock-receipt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: e.target.result,
                            scanType: 'payment',
                            fileName: file.name
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.paymentAmount) {
                            document.getElementById('paymentAmount').value = result.paymentAmount;
                        }
                        if (result.paymentDate) {
                            document.getElementById('paymentDate').value = result.paymentDate;
                        }
                        if (result.reference) {
                            document.getElementById('paymentReference').value = result.reference;
                        }
                        
                        showToast('Payment details extracted!', 'success');
                    }
                } catch (err) {
                    console.error('POP OCR error:', err);
                    showToast('Could not extract details automatically. Please enter manually.', 'warning');
                }
                
                document.getElementById('popProcessingStatus').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        async function confirmPayment() {
            const payableId = parseInt(document.getElementById('paymentPayableId').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentReference = document.getElementById('paymentReference').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (!paymentAmount || paymentAmount <= 0) {
                showToast('Please enter a valid payment amount', 'error');
                return;
            }
            
            const payableIndex = payables.findIndex(p => p.id === payableId);
            if (payableIndex === -1) {
                showToast('Payable not found', 'error');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            
            // Record payment
            const payment = {
                id: Date.now(),
                date: paymentDate,
                amount: paymentAmount,
                method: paymentMethod,
                reference: paymentReference,
                notes: paymentNotes,
                recordedBy: currentUser ? currentUser.username : 'unknown',
                recordedAt: new Date().toISOString()
            };
            
            payables[payableIndex].payments = payables[payableIndex].payments || [];
            payables[payableIndex].payments.push(payment);
            payables[payableIndex].paidAmount = (payables[payableIndex].paidAmount || 0) + paymentAmount;
            
            // Check if fully paid
            if (payables[payableIndex].paidAmount >= payables[payableIndex].zarAmount) {
                payables[payableIndex].status = 'paid';
            } else {
                payables[payableIndex].status = 'partial';
            }
            
            await saveToStorage('aweh_payables', payables);
            
            closeModal('paymentPOPModal');
            showToast(`Payment of R ${formatNumber(Math.round(paymentAmount))} recorded!`, 'success');
            updatePayablesDisplay();
            logActivity(`Payment recorded: R ${formatNumber(Math.round(paymentAmount))} to ${payables[payableIndex].supplierName}`, currentUser ? currentUser.username : 'unknown');
        }

        function exportReceivingHistory() {
            if (receivingHistory.length === 0) {
                showToast('No receiving history to export', 'warning');
                return;
            }
            
            const csv = [
                ['Date', 'Supplier', 'Invoice #', 'Currency', 'Original Amount', 'Landed Cost (ZAR)', 'Status'].join(','),
                ...receivingHistory.map(r => [
                    r.date,
                    r.supplierName,
                    r.invoiceNumber,
                    r.currency,
                    r.originalAmount,
                    r.totalLandedCost,
                    r.status
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receiving-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function viewReceivingDetails(id) {
            const record = receivingHistory.find(r => r.id === id);
            if (!record) return;
            
            alert(`Receiving Details:\n\nInvoice: ${record.invoiceNumber}\nSupplier: ${record.supplierName}\nDate: ${record.date}\nCurrency: ${record.currency}\nOriginal: ${record.currency} ${record.originalAmount}\nLanded Cost: R ${record.totalLandedCost}\n\nItems: ${record.items ? record.items.length : 0}\nDocuments: ${record.documents ? record.documents.length : 0}`);
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            console.log('closeModal called with:', modalId);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }

            // Remove active class AND force display none
            modal.classList.remove('active');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';

            // Reset supplier modal form when closing
            if (modalId === 'supplierModal') {
                console.log('Resetting supplier form');
                resetSupplierForm();
            }
            console.log('Modal closed successfully');
        }

        function resetSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierWebsite').value = '';
            document.getElementById('supplierCategory').value = 'jetboards';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
            document.getElementById('supplierLogoUpload').value = '';
            document.getElementById('supplierLogoPreview').src = '';
            document.getElementById('supplierLogoPreview').style.display = 'none';
        }

        // ========================================
        // QUICK ADD PRODUCT FUNCTIONS
        // ========================================

        function openQuickAddProductModal() {
            document.getElementById('quickProductName').value = '';
            document.getElementById('quickProductSKU').value = '';
            document.getElementById('quickProductCost').value = '';
            document.getElementById('quickProductCategory').value = 'Custom';
            document.getElementById('quickProductDescription').value = '';
            openModal('quickAddProductModal');
        }

        async function saveQuickProduct() {
            const name = document.getElementById('quickProductName').value.trim();
            const cost = parseFloat(document.getElementById('quickProductCost').value);
            
            if (!name) {
                showToast('Product name is required', 'error');
                return;
            }
            
            if (!cost || cost <= 0) {
                showToast('Valid cost price is required', 'error');
                return;
            }
            
            let sku = document.getElementById('quickProductSKU').value.trim();
            if (!sku) {
                // Auto-generate SKU
                const prefix = document.getElementById('quickProductCategory').value.substring(0, 3).toUpperCase();
                sku = `${prefix}-${Date.now()}`;
            }
            
            // Check if SKU already exists
            if (products.some(p => p.sku === sku)) {
                showToast('SKU already exists. Please use a different SKU.', 'error');
                return;
            }
            
            const product = {
                sku: sku,
                name: name,
                landedCost: cost,
                category: document.getElementById('quickProductCategory').value,
                description: document.getElementById('quickProductDescription').value.trim(),
                brand: 'Custom',
                stock: 0,
                createdAt: new Date().toISOString()
            };
            
            products.push(product);
            await saveToStorage(getBusinessKey('aweh_products'), products);
            
            // Add to current invoice
            addProductToInvoice(product);
            
            closeModal('quickAddProductModal');
            showToast(`ðŸ„â€â™‚ï¸ Product "${name}" added successfully!`, 'success');
        }

        // ========================================
        // GOOGLE DRIVE SETUP WIZARD FUNCTIONS
        // ========================================

        let currentWizardStep = 1;
        const totalWizardSteps = 5;

        function openSetupWizard() {
            currentWizardStep = 1;
            updateWizardStep();
            openModal('setupWizardModal');
        }

        function openSimpleOAuthSetupGuide() {
            const guideHtml = `
                <div style="max-width: 600px; margin: 0 auto; padding: 2rem; line-height: 1.8;">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; text-align: center;">
                        ðŸ” Easy Cloud Sync Setup (5 Minutes)
                    </h2>
                    
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border-left: 4px solid var(--primary);">
                        <h3 style="margin-top: 0; color: var(--primary);">ðŸ“‹ Quick Steps:</h3>
                        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
                            <li><strong>Create Google Cloud Project</strong> (1 min)</li>
                            <li><strong>Enable Google Drive API</strong> (30 sec)</li>
                            <li><strong>Create OAuth Client</strong> (2 min)</li>
                            <li><strong>Copy Client ID & Save</strong> (30 sec)</li>
                            <li><strong>Done! Click to Login</strong> âœ…</li>
                        </ol>
                    </div>

                    <h3 style="color: var(--accent);">Step 1: Create Google Cloud Project</h3>
                    <ol style="margin-bottom: 2rem;">
                        <li>Go to <a href="https://console.cloud.google.com/" target="_blank" style="color: var(--primary);">Google Cloud Console</a></li>
                        <li>Click <strong>"Create Project"</strong></li>
                        <li>Name: <strong>"Aweh Invoice System"</strong></li>
                        <li>Click <strong>Create</strong></li>
                    </ol>

                    <h3 style="color: var(--accent);">Step 2: Enable Google Drive API</h3>
                    <ol style="margin-bottom: 2rem;">
                        <li>Go to <strong>APIs & Services â†’ Library</strong></li>
                        <li>Search: <strong>"Google Drive API"</strong></li>
                        <li>Click <strong>"Enable"</strong></li>
                    </ol>

                    <h3 style="color: var(--accent);">Step 3: Create OAuth Client</h3>
                    <ol style="margin-bottom: 2rem;">
                        <li>Go to <strong>APIs & Services â†’ Credentials</strong></li>
                        <li>Click <strong>"+ CREATE CREDENTIALS" â†’ OAuth client ID</strong></li>
                        <li>If needed, configure consent screen:
                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                <li>User Type: <strong>External</strong></li>
                                <li>App name: <strong>Aweh Invoice System</strong></li>
                                <li>Your email for support & developer contact</li>
                                <li>Save and continue through steps</li>
                            </ul>
                        </li>
                        <li>Application type: <strong>Web application</strong></li>
                        <li>Name: <strong>Aweh Invoice Web Client</strong></li>
                        <li><strong>âš ï¸ CRITICAL!</strong> Copy these URLs exactly:
                            <div style="background: rgba(255, 64, 129, 0.1); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; border: 2px solid var(--danger);">
                                <div style="margin-bottom: 1rem; color: var(--danger); font-weight: 600;">
                                    ðŸ“‹ You MUST add these URLs to your OAuth Client:
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: var(--primary);">
                                        âœ… Authorized JavaScript origins (add ALL 3):
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('${window.location.origin}')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success); word-break: break-all;">${window.location.origin}</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('https://aweh-invoice-system.vercel.app')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success);">https://aweh-invoice-system.vercel.app</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px;">
                                        <code style="color: var(--success);">https://aweh-invoice-system-*.vercel.app</code>
                                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">
                                            (Type exactly as shown - the * is a wildcard)
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: var(--primary);">
                                        âœ… Authorized redirect URIs (add ALL 6):
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('${window.location.origin}')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success); word-break: break-all;">${window.location.origin}</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('${window.location.origin}/')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success); word-break: break-all;">${window.location.origin}/</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('${window.location.origin}/COMPLETE-INVOICE-SYSTEM.html')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success); word-break: break-all;">${window.location.origin}/COMPLETE-INVOICE-SYSTEM.html</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('https://aweh-invoice-system.vercel.app')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success);">https://aweh-invoice-system.vercel.app</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <button onclick="navigator.clipboard.writeText('https://aweh-invoice-system.vercel.app/')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success);">https://aweh-invoice-system.vercel.app/</code>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.4); padding: 0.75rem; border-radius: 6px;">
                                        <button onclick="navigator.clipboard.writeText('https://aweh-invoice-system.vercel.app/COMPLETE-INVOICE-SYSTEM.html')" 
                                            style="float: right; padding: 0.25rem 0.5rem; background: var(--primary); border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem;">
                                            Copy
                                        </button>
                                        <code style="color: var(--success);">https://aweh-invoice-system.vercel.app/COMPLETE-INVOICE-SYSTEM.html</code>
                                    </div>
                                    <div style="background: rgba(255, 64, 129, 0.15); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; border-left: 3px solid var(--danger);">
                                        <strong>âš ï¸ Critical:</strong> Add ALL 6 redirect URIs above or you'll get "redirect_uri_mismatch" error!
                                    </div>
                                </div>

                                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255, 190, 11, 0.15); border-radius: 6px; border-left: 3px solid var(--warning);">
                                    <strong>ðŸ’¡ Pro Tip:</strong> Use the "Copy" buttons to avoid typos!
                                </div>
                            </div>
                        </li>
                        <li>Click <strong>Create</strong></li>
                    </ol>

                    <h3 style="color: var(--accent);">Step 4: Save Client ID</h3>
                    <div style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="margin: 0 0 1rem 0;">Copy your Client ID (looks like this):</p>
                        <code style="background: rgba(0, 0, 0, 0.3); padding: 0.5rem; border-radius: 4px; display: block;">
                            1234567890-abc123def456.apps.googleusercontent.com
                        </code>
                    </div>
                    
                    <div style="margin: 2rem 0;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Paste your Client ID here:</label>
                        <input type="text" id="oauthClientIdInput" placeholder="Your Client ID from Google Cloud Console" 
                            style="width: 100%; padding: 0.75rem; background: var(--glass); border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 8px; color: var(--light); font-size: 1rem;" />
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="saveOAuthClientId()" class="btn btn-success" style="flex: 1;">
                            âœ… Save & Enable Cloud Sync
                        </button>
                        <button onclick="closeModal('oauthSetupModal')" class="btn btn-outline">
                            Cancel
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 190, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                        <strong>ðŸ’¡ After Setup:</strong>
                        <p style="margin: 0.5rem 0 0 0;">Click "Sync Google" â†’ Login with your Google account â†’ Accept permissions â†’ Done! Your data will auto-sync to Google Drive.</p>
                    </div>

                    <div style="margin-top: 1.5rem; text-align: center;">
                        <a href="GOOGLE-OAUTH-SETUP.md" target="_blank" style="color: var(--primary);">
                            ðŸ“„ View Detailed Setup Guide
                        </a>
                    </div>
                </div>
            `;

            // Create or get modal
            let modal = document.getElementById('oauthSetupModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'oauthSetupModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <span class="close-modal" onclick="closeModal('oauthSetupModal')">&times;</span>
                        <div id="oauthSetupContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('oauthSetupContent').innerHTML = guideHtml;
            openModal('oauthSetupModal');
        }

        function saveOAuthClientId() {
            const input = document.getElementById('oauthClientIdInput');
            const clientId = input.value.trim();

            if (!clientId) {
                showToast('Please enter your Client ID', 'error');
                return;
            }

            if (!clientId.includes('.apps.googleusercontent.com')) {
                showToast('Invalid Client ID format. Should end with .apps.googleusercontent.com', 'error');
                return;
            }

            // Save to localStorage
            localStorage.setItem('google_drive_client_id', clientId);
            
            // Update driveStorage if available
            if (typeof driveStorage !== 'undefined') {
                driveStorage.CLIENT_ID = clientId;
            }

            showToast('âœ… Client ID saved! Click "Sync Google" to login and start syncing.', 'success');
            closeModal('oauthSetupModal');
        }

        function openQuickGoogleSetup() {
            const originInput = document.getElementById('quickOriginCopy');
            if (originInput) originInput.value = location.origin;

            const input = document.getElementById('quickClientIdInput');
            if (input) {
                input.value = localStorage.getItem('google_drive_client_id') || '';
                validateQuickClientId(input.value);
            }

            const resultDiv = document.getElementById('quickConnectionResult');
            if (resultDiv) {
                resultDiv.classList.add('is-hidden');
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';
            }

            openModal('quickGoogleSetupModal');
        }

        async function syncGoogle() {
            console.log('syncGoogle called');
            
            // Check if user is business owner - only owners can sync
            if (!isBusinessOwner()) {
                const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
                if (currentBusiness?.ownerEmail) {
                    showToast(`ðŸ”’ Only the business owner (${currentBusiness.ownerEmail}) can sync data to Google Drive`, 'warning');
                } else {
                    // No owner yet - allow this user to claim ownership
                    const claim = confirm(
                        'ðŸ“‹ This business has no owner yet.\\n\\n' +
                        'As owner, you will:\\n' +
                        'â€¢ Link YOUR Google Drive for data backup\\n' +
                        'â€¢ Control which users can access data\\n' +
                        'â€¢ Be responsible for all business data\\n\\n' +
                        'Claim ownership of "' + (currentBusiness?.name || 'this business') + '"?'
                    );
                    if (claim) {
                        const claimed = await claimBusinessOwnership();
                        if (!claimed) return;
                    } else {
                        return;
                    }
                }
                if (!isBusinessOwner()) return;
            }
            
            try {
                if (typeof driveStorage === 'undefined') {
                    showToast('âš ï¸ Google Drive module not loaded. Your data is saved locally.', 'warning');
                    console.error('driveStorage is undefined');
                    return;
                }

                // Ensure driveStorage is initialized first
                if (typeof driveStorage.init === 'function' && !driveStorage._initPromise) {
                    showToast('ðŸ”„ Initializing Google Driveâ€¦', 'info');
                    try {
                        await driveStorage.init();
                        console.log('driveStorage initialized');
                    } catch (initError) {
                        console.error('Drive init error:', initError);
                        showToast('âš ï¸ Google Drive requires one-time setup. Click "Sync Google" again after setup.', 'warning');
                        openSimpleOAuthSetupGuide();
                        return;
                    }
                }

                // If not configured yet, show simple setup guide
                if (!driveStorage.isClientConfigured || !driveStorage.isClientConfigured()) {
                    console.log('Client not configured, showing setup guide');
                    showToast('ðŸ”§ Google Drive needs quick setup (5 min)', 'info');
                    openSimpleOAuthSetupGuide();
                    return;
                }
                
                // Set business-specific folder name
                if (currentBusiness?.name) {
                    driveStorage.folderName = `Aweh Invoice System - ${currentBusiness.name}`;
                }

                // One button flow:
                // - if not signed in: pop up login/consent and auto-sync
                // - if signed in: just sync
                if (!driveStorage.isSignedIn) {
                    console.log('Not signed in, starting sign-in flow');
                    showToast('ðŸ” Opening Google sign-in popupâ€¦', 'info');

                    const ok = await driveStorage.signIn();
                    if (!ok) {
                        showToast('Google sign-in failed. See status bar for details or try again.', 'error');
                    } else {
                        // Mark business as Drive configured
                        if (currentBusiness) {
                            currentBusiness.driveConfigured = true;
                            await saveToStorage('aweh_businesses', businesses);
                        }
                        showToast('âœ… Signed in! Syncing dataâ€¦', 'success');
                    }
                    return;
                }

                // Signed in: just sync
                showToast('ðŸ”„ Syncing to Google Driveâ€¦', 'info');
                if (typeof driveStorage.ensureFolder === 'function') {
                    await driveStorage.ensureFolder();
                }
                await driveStorage.syncAll();
                showToast('âœ… Sync complete!', 'success');
            } catch (error) {
                console.error('syncGoogle error:', error);
                const msg = error?.message || String(error);
                if (typeof driveStorage !== 'undefined' && typeof driveStorage.updateSyncStatus === 'function') {
                    driveStorage.updateSyncStatus(`âŒ Sync failed: ${msg}`, 'error');
                }
                showToast(`âŒ Sync failed: ${msg}`, 'error');
            }
        }

        function validateQuickClientId(clientId) {
            const validation = document.getElementById('quickClientIdValidation');
            const connectBtn = document.getElementById('quickConnectBtn');

            const isValid = clientId.trim().length > 0 &&
                           clientId.includes('-') &&
                           clientId.endsWith('.apps.googleusercontent.com');

            if (isValid) {
                validation?.classList.remove('invalid');
                validation?.classList.add('valid');
                if (connectBtn) connectBtn.disabled = false;
            } else {
                validation?.classList.remove('valid');
                validation?.classList.add('invalid');
                if (connectBtn) connectBtn.disabled = true;
            }
        }

        async function quickConnectGoogleDrive() {
            const clientId = document.getElementById('quickClientIdInput')?.value?.trim() || '';
            const resultDiv = document.getElementById('quickConnectionResult');
            const connectBtn = document.getElementById('quickConnectBtn');

            if (!clientId) {
                showToast('Please enter your Client ID first', 'error');
                return;
            }

            if (connectBtn) {
                connectBtn.disabled = true;
                connectBtn.textContent = 'ðŸ”„ Connecting...';
            }
            if (resultDiv) {
                resultDiv.classList.remove('is-hidden');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div class="wizard-alert">â³ Opening Google sign-in...</div>';
            }

            try {
                if (typeof driveStorage === 'undefined') {
                    throw new Error('Google Drive module not loaded');
                }

                driveStorage.CLIENT_ID = clientId;

                // Force a clean init if the module initialized with a placeholder
                if (driveStorage._initPromise) {
                    driveStorage._initPromise = null;
                }
                if ('tokenClient' in driveStorage) {
                    driveStorage.tokenClient = null;
                }

                localStorage.setItem('google_drive_client_id', clientId);

                const ok = await driveStorage.signIn();
                if (!ok) {
                    throw new Error('Sign-in was cancelled or blocked. Please allow popups and try again.');
                }

                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="wizard-success">
                            <h3>âœ… Connected!</h3>
                            <p style="margin-top: 0.5rem;">Google Drive is ready. Click â€œSync Googleâ€ any time.</p>
                        </div>
                    `;
                }

                const syncGoogleBtn = document.getElementById('syncGoogleBtn');
                if (syncGoogleBtn) syncGoogleBtn.style.animation = '';

                showToast('âœ… Google Drive connected', 'success');
                closeModal('quickGoogleSetupModal');
            } catch (error) {
                console.error('quickConnectGoogleDrive failed:', error);
                if (resultDiv) {
                    resultDiv.classList.remove('is-hidden');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div class="wizard-alert">
                            <strong>âš ï¸ Connection Failed</strong><br>
                            <p style="margin-top: 0.5rem;">${error?.message || error}</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                                <strong>Fix:</strong><br>
                                â€¢ In Google Cloud â†’ OAuth Client â†’ add this origin: <strong>${location.origin}</strong><br>
                                â€¢ Then try again
                            </p>
                        </div>
                    `;
                }
                showToast('Connection failed. Check the message.', 'error');
            } finally {
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'ðŸ”— Connect Google';
                }
            }
        }

        /**
         * Show Google Drive diagnostic information for troubleshooting
         */
        function showGoogleDriveDiagnostics() {
            let diagnosticInfo = 'Google Drive Diagnostics\n';
            diagnosticInfo += '========================\n\n';

            if (typeof driveStorage === 'undefined') {
                diagnosticInfo += 'âŒ driveStorage module is NOT loaded\n';
                diagnosticInfo += 'This means google-drive-sync.js failed to load.\n';
            } else {
                const status = typeof driveStorage.getStatus === 'function'
                    ? driveStorage.getStatus()
                    : {
                        clientConfigured: driveStorage.isClientConfigured?.() || false,
                        isSignedIn: driveStorage.isSignedIn,
                        isOnline: driveStorage.isOnline,
                        disabled: driveStorage.disabled,
                        folderId: driveStorage.folderId,
                        lastError: driveStorage.lastError || 'N/A'
                    };

                diagnosticInfo += `Client ID Configured: ${status.clientConfigured ? 'âœ… Yes' : 'âŒ No'}\n`;
                diagnosticInfo += `Signed In: ${status.isSignedIn ? 'âœ… Yes' : 'âŒ No'}\n`;
                diagnosticInfo += `Online: ${status.isOnline ? 'âœ… Yes' : 'âŒ No'}\n`;
                diagnosticInfo += `Module Disabled: ${status.disabled ? 'âš ï¸ Yes' : 'âœ… No'}\n`;
                diagnosticInfo += `Folder ID: ${status.folderId || 'Not created yet'}\n`;
                diagnosticInfo += `GAPI Loaded: ${status.gapiLoaded ? 'âœ… Yes' : 'âŒ No'}\n`;
                diagnosticInfo += `GIS Loaded: ${status.gisLoaded ? 'âœ… Yes' : 'âŒ No'}\n`;
                diagnosticInfo += `Last Error: ${status.lastError || 'None'}\n`;
                diagnosticInfo += `Init Attempts: ${status.initAttempts || 0}\n`;
            }

            diagnosticInfo += '\n--- Browser Info ---\n';
            diagnosticInfo += `Current Origin: ${window.location.origin}\n`;
            diagnosticInfo += `Navigator Online: ${navigator.onLine}\n`;
            diagnosticInfo += `Saved Client ID: ${localStorage.getItem('google_drive_client_id') ? 'Present' : 'Not set'}\n`;

            console.log(diagnosticInfo);
            alert(diagnosticInfo);
        }

        function wizardNextStep() {
            if (currentWizardStep < totalWizardSteps) {
                currentWizardStep++;
                updateWizardStep();
            }
        }

        function wizardPrevStep() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                updateWizardStep();
            }
        }

        function updateWizardStep() {
            // Update progress indicators
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNum === currentWizardStep) {
                    step.classList.add('active');
                } else if (stepNum < currentWizardStep) {
                    step.classList.add('completed');
                }
            });

            // Update content visibility
            document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
                const stepNum = index + 1;
                content.classList.remove('active');

                if (stepNum === currentWizardStep) {
                    content.classList.add('active');
                }
            });

            // Update button visibility
            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const finishBtn = document.getElementById('wizardFinishBtn');

            if (currentWizardStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }

            if (currentWizardStep === totalWizardSteps) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
            }
        }

        function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            document.execCommand('copy');
            showToast('ðŸ“‹ Copied to clipboard!', 'success');
        }

        function validateClientId(clientId) {
            const validation = document.getElementById('clientIdValidation');
            const testBtn = document.getElementById('testConnectionBtn');

            // Check if it matches Google OAuth Client ID format
            const isValid = clientId.trim().length > 0 &&
                           clientId.includes('-') &&
                           clientId.endsWith('.apps.googleusercontent.com');

            if (isValid) {
                validation.classList.remove('invalid');
                validation.classList.add('valid');
                testBtn.disabled = false;
            } else {
                validation.classList.remove('valid');
                validation.classList.add('invalid');
                testBtn.disabled = true;
            }
        }

        async function testGoogleDriveConnection() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            const resultDiv = document.getElementById('connectionResult');
            const testBtn = document.getElementById('testConnectionBtn');

            if (!clientId) {
                showToast('Please enter your Client ID first', 'error');
                return;
            }

            testBtn.disabled = true;
            testBtn.textContent = 'ðŸ”„ Testing...';
            if (resultDiv) {
                resultDiv.classList.remove('is-hidden');
                resultDiv.style.display = 'block';
            }
            resultDiv.innerHTML = '<div class="wizard-alert">â³ Connecting to Google Drive...</div>';

            try {
                // Update the google-drive-sync.js with the new Client ID
                if (typeof driveStorage !== 'undefined') {
                    driveStorage.CLIENT_ID = clientId;

                    // Re-initialize if previously initialized with a different Client ID
                    if (driveStorage._initPromise) {
                        driveStorage._initPromise = null;
                        driveStorage.tokenClient = null;
                    }

                    // Try to initialize and sign in
                    await driveStorage.init();
                    await driveStorage.signIn();

                    resultDiv.innerHTML = `
                        <div class="wizard-success">
                            <h3>âœ… Connection Successful!</h3>
                            <p style="margin-top: 0.5rem;">Your invoice system is now connected to Google Drive!</p>
                            <p style="margin-top: 0.5rem; opacity: 0.8;">You can close this window and start using cloud storage.</p>
                        </div>
                    `;

                    // Save the Client ID to localStorage for persistence
                    localStorage.setItem('google_drive_client_id', clientId);

                    // Stop pulsing the header button now that we're configured
                    const syncGoogleBtn = document.getElementById('syncGoogleBtn');
                    if (syncGoogleBtn) {
                        syncGoogleBtn.style.animation = '';
                    }

                    showToast('âœ… Successfully connected to Google Drive!', 'success');

                    // â€œAccept and doneâ€: close the wizard automatically
                    closeModal('setupWizardModal');
                } else {
                    throw new Error('Google Drive module not loaded');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                if (resultDiv) {
                    resultDiv.classList.remove('is-hidden');
                    resultDiv.style.display = 'block';
                }
                resultDiv.innerHTML = `
                    <div class="wizard-alert">
                        <strong>âš ï¸ Connection Failed</strong><br>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                            <strong>Troubleshooting:</strong><br>
                            â€¢ Make sure you copied the entire Client ID<br>
                            â€¢ Add this exact origin to Google OAuth "Authorized JavaScript origins": <strong>${location.origin}</strong><br>
                            â€¢ Try refreshing the page and testing again
                        </p>
                    </div>
                `;
                showToast('Connection test failed. Check the error message.', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ðŸ”Œ Test Connection';
            }
        }

        function finishWizard() {
            const clientId = document.getElementById('clientIdInput').value.trim();

            if (!clientId) {
                showToast('Please complete the connection test first', 'warning');
                return;
            }

            // Update google-drive-sync.js file with the Client ID
            updateGoogleDriveSyncFile(clientId);

            closeModal('setupWizardModal');
            showToast('ðŸŽ‰ Setup complete! Your data will now sync to Google Drive.', 'success');

            // Reload to apply changes
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        function updateGoogleDriveSyncFile(clientId) {
            // Save to localStorage so it persists
            localStorage.setItem('google_drive_client_id', clientId);

            // Show instructions to update the file
            const instructions = `
                <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--primary); margin: 1rem 0;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">ðŸ“ Final Step: Update google-drive-sync.js</h3>
                    <p style="margin-bottom: 1rem;">Open the file <code>google-drive-sync.js</code> and replace line 19:</p>
                    <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 5px; font-family: monospace; margin: 1rem 0;">
                        <div style="opacity: 0.5;">// OLD:</div>
                        <div style="color: #ff006e;">this.CLIENT_ID = 'YOUR_CLIENT_ID_HERE';</div>
                        <div style="opacity: 0.5; margin-top: 1rem;">// NEW:</div>
                        <div style="color: var(--success);">this.CLIENT_ID = '${clientId}';</div>
                    </div>
                    <p style="margin-top: 1rem;">Then refresh this page to activate Google Drive sync!</p>
                </div>
            `;

            // You could show this in a modal or toast
            console.log('Client ID to use:', clientId);
        }

        function openAddSupplierModal() {
            console.log('openAddSupplierModal called');
            resetSupplierForm();
            openModal('supplierModal');
            console.log('Supplier modal opened');
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                const modalId = event.target.id;
                closeModal(modalId);
            }
        });

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3500);
        }

        // Open Create Invoice Modal
        function openCreateInvoiceModal() {
            openModal('invoiceModal');
            document.getElementById('invoiceModalTitle').textContent = 'Create New Invoice';
            loadCustomersIntoSelect();
            
            // Populate business selector
            populateInvoiceBusinessSelector();
            
            currentInvoice = {
                items: [],
                subtotal: 0,
                vat: 0,
                total: 0,
                status: 'draft',
                paymentTerms: 30,
                amountPaid: 0,
                balance: 0,
                payments: [],
                businessId: currentBusiness?.id || 'default'
            };

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            document.getElementById('paymentTerms').value = '30';
            updateDueDate();

            // Set default status
            document.getElementById('invoiceStatus').value = 'draft';

            // Hide payment section for new invoices
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('paymentTrackingSection').style.display = 'none';
            document.getElementById('togglePaymentBtn').style.display = 'none';
            document.getElementById('whatsappBtn').style.display = 'none';
            document.getElementById('emailBtn').style.display = 'none';

            document.getElementById('invoiceItemsBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td></tr>';
            document.getElementById('invoiceProductSearch').value = '';
            document.getElementById('productSearchResults').style.display = 'none';
            
            // Reset project fees fields
            if (document.getElementById('totalProjectFees')) document.getElementById('totalProjectFees').value = '';
            if (document.getElementById('previouslyBilled')) document.getElementById('previouslyBilled').value = '';
            if (document.getElementById('thisInvoiceAmount')) document.getElementById('thisInvoiceAmount').value = '';
            if (document.getElementById('thisInvoiceBillingType')) document.getElementById('thisInvoiceBillingType').value = 'percentage';
            if (document.getElementById('showProjectFeesOnInvoice')) document.getElementById('showProjectFeesOnInvoice').checked = false;
            if (document.getElementById('projectFeesSummary')) document.getElementById('projectFeesSummary').style.display = 'none';
            
            // Show project fees section for DIGG or professional services businesses
            showProjectFeesSectionIfApplicable();
            
            calculateInvoiceTotal();
        }
        
        // Show project fees section for DIGG or when setting is enabled
        function showProjectFeesSectionIfApplicable() {
            const projectFeesSection = document.getElementById('projectFeesSection');
            if (!projectFeesSection) return;
            
            const settings = getSettings();
            const showSection = isDiggBusiness(currentBusiness) || settings.showProjectFeeStyle;
            projectFeesSection.style.display = showSection ? 'block' : 'none';
        }
        
        // Update project fee reference summary
        function updateProjectFeeReference() {
            const totalProjectFees = parseFloat(document.getElementById('totalProjectFees')?.value || 0);
            const previouslyBilled = parseFloat(document.getElementById('previouslyBilled')?.value || 0);
            const thisInvoiceValue = parseFloat(document.getElementById('thisInvoiceAmount')?.value || 0);
            const billingType = document.getElementById('thisInvoiceBillingType')?.value || 'percentage';
            
            // Calculate this invoice amount based on billing type
            let thisInvoice = 0;
            if (thisInvoiceValue > 0 && totalProjectFees > 0) {
                if (billingType === 'percentage') {
                    thisInvoice = totalProjectFees * (thisInvoiceValue / 100);
                } else {
                    thisInvoice = thisInvoiceValue;
                }
            } else {
                // Fall back to current invoice subtotal if no manual entry
                thisInvoice = currentInvoice.subtotal || 0;
            }
            
            const remaining = Math.max(0, totalProjectFees - previouslyBilled - thisInvoice);
            
            const summaryDiv = document.getElementById('projectFeesSummary');
            if (summaryDiv) {
                summaryDiv.style.display = totalProjectFees > 0 ? 'block' : 'none';
                document.getElementById('pfsTotal').textContent = 'R ' + formatNumber(Math.round(totalProjectFees));
                document.getElementById('pfsPrevious').textContent = 'R ' + formatNumber(Math.round(previouslyBilled));
                document.getElementById('pfsThisInvoice').textContent = 'R ' + formatNumber(Math.round(thisInvoice)) + (billingType === 'percentage' && thisInvoiceValue > 0 ? ` (${thisInvoiceValue}%)` : '');
                document.getElementById('pfsRemaining').textContent = 'R ' + formatNumber(Math.round(remaining));
            }
            
            // Store in currentInvoice for saving/printing
            currentInvoice.projectFees = {
                total: totalProjectFees,
                previouslyBilled: previouslyBilled,
                thisInvoice: thisInvoice,
                thisInvoiceValue: thisInvoiceValue,
                billingType: billingType,
                remaining: remaining,
                showOnInvoice: document.getElementById('showProjectFeesOnInvoice')?.checked || false
            };
        }
        
        // Populate business selector in invoice modal
        function populateInvoiceBusinessSelector() {
            const select = document.getElementById('invoiceFromBusiness');
            if (!select || !businesses || businesses.length === 0) return;
            
            const currentId = currentBusiness?.id || localStorage.getItem('aweh_currentBusiness') || 'default';
            
            select.innerHTML = businesses.map(business => {
                const isSelected = business.id === currentId;
                return `<option value="${business.id}" ${isSelected ? 'selected' : ''}>${business.name}${business.tradingAs ? ' (' + business.tradingAs + ')' : ''}</option>`;
            }).join('');
            
            // Update preview for current selection
            onInvoiceBusinessChanged();
        }
        
        // Handle business selection change in invoice modal
        function onInvoiceBusinessChanged() {
            const select = document.getElementById('invoiceFromBusiness');
            const preview = document.getElementById('invoiceBusinessPreview');
            const logoDiv = document.getElementById('invoiceBusinessLogo');
            const nameDiv = document.getElementById('invoiceBusinessName');
            const detailsDiv = document.getElementById('invoiceBusinessDetails');
            
            if (!select) return;
            
            const businessId = select.value;
            const business = businesses.find(b => b.id === businessId);
            
            if (!business) return;
            
            // Update current invoice with selected business
            if (currentInvoice) {
                currentInvoice.businessId = business.id;
                currentInvoice.businessName = business.name;
            }
            
            // Update preview
            if (logoDiv) {
                if (business.logo) {
                    logoDiv.innerHTML = `<img src="${business.logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
                } else {
                    logoDiv.textContent = 'ðŸ¢';
                    logoDiv.style.background = 'var(--primary)';
                }
            }
            
            if (nameDiv) {
                nameDiv.textContent = business.name;
            }
            
            if (detailsDiv) {
                let details = [];
                if (business.tradingAs) details.push(`Trading as: ${business.tradingAs}`);
                if (business.email) details.push(business.email);
                if (business.phone) details.push(business.phone);
                if (business.vatNumber) details.push(`VAT: ${business.vatNumber}`);
                if (business.address) details.push(business.address.split('\n')[0]); // First line of address
                detailsDiv.textContent = details.join(' â€¢ ') || business.type || 'Business';
            }
            
            if (preview) {
                preview.style.display = 'flex';
            }
        }

        // Product Category & Favorites Functions
        function showProductCategory(category) {
            const resultsDiv = document.getElementById('productSearchResults');
            let productsToShow = [];
            let title = '';

            switch(category) {
                case 'favorites':
                    productsToShow = products.filter(p => favoriteProducts.includes(p.sku));
                    title = 'â­ Favorite Products';
                    break;
                case 'recent':
                    // Get unique SKUs from recent invoices
                    const recentSKUs = [...new Set(
                        invoices.slice(-10).flatMap(inv => inv.items.map(item => item.sku))
                    )].slice(0, 20);
                    productsToShow = products.filter(p => recentSKUs.includes(p.sku));
                    title = 'ðŸ• Recently Used Products';
                    break;
                case 'awake':
                    productsToShow = products.filter(p => p.brand === 'Awake');
                    title = 'ðŸ„ Awake Jetboards & E-foils';
                    break;
                case 'aqua':
                    productsToShow = products.filter(p => p.brand === 'Aqua Marina');
                    title = 'ðŸŒŠ Aqua Marina Products';
                    break;
                case 'digg':
                    productsToShow = products.filter(p => p.brand === 'DIGG');
                    title = 'DIGG';
                    break;
                case 'all':
                    productsToShow = products;
                    title = 'ðŸ“¦ All Products';
                    break;
            }

            if (productsToShow.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: rgba(255,255,255,0.5);">
                        ${category === 'favorites' ? 'No favorites yet. Click â­ on products to add them!' : 'No products found'}
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }

            resultsDiv.innerHTML = `
                <div style="padding: 0.75rem; background: rgba(0, 212, 255, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">
                    ${title} (${productsToShow.length})
                </div>
                ${productsToShow.slice(0, 20).map(p => `
                    <div class="search-result-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div onclick="addProductToInvoiceFromSearch('${p.sku}')" style="flex: 1; cursor: pointer;">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-details">
                                <span>${p.sku}</span> â€¢
                                <span>${p.brand}</span> â€¢
                                <span style="color: var(--success); font-weight: 600;">R ${formatNumber(p.landedCost)}</span>
                            </div>
                        </div>
                        <button type="button" onclick="toggleFavorite('${p.sku}')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.5rem;" title="Toggle Favorite">
                            ${favoriteProducts.includes(p.sku) ? 'â­' : 'â˜†'}
                        </button>
                    </div>
                `).join('')}
            `;

            resultsDiv.style.display = 'block';
        }

        function showProductSearchResults() {
            const searchInput = document.getElementById('invoiceProductSearch');
            if (!searchInput.value.trim()) {
                showProductCategory('recent'); // Show recent by default
            }
        }

        async function toggleFavorite(sku) {
            const index = favoriteProducts.indexOf(sku);
            if (index > -1) {
                favoriteProducts.splice(index, 1);
            } else {
                favoriteProducts.push(sku);
            }
            await saveToStorage(getBusinessKey('aweh_favorites'), favoriteProducts);

            // Refresh current view
            const resultsDiv = document.getElementById('productSearchResults');
            if (resultsDiv.style.display === 'block') {
                // Re-render current category
                const searchValue = document.getElementById('invoiceProductSearch').value;
                if (!searchValue.trim()) {
                    showProductCategory('recent');
                }
            }

            showToast(index > -1 ? 'Removed from favorites' : 'Added to favorites', 'success');
        }

        // Product Search in Invoice Modal
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('invoiceProductSearch');
            const resultsDiv = document.getElementById('productSearchResults');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().trim();
                    
                    if (term.length < 2) {
                        resultsDiv.style.display = 'none';
                        return;
                    }
                    
                    const matches = products.filter(p =>
                        p.name.toLowerCase().includes(term) ||
                        p.sku.toLowerCase().includes(term) ||
                        p.category.toLowerCase().includes(term)
                    ).slice(0, 10);
                    
                    if (matches.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-result-item" style="color: rgba(255,255,255,0.5);">No products found</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }
                    
                    resultsDiv.innerHTML = matches.map(p => `
                        <div class="search-result-item" onclick="addProductToInvoiceFromSearch('${p.sku}')">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-details">
                                <span>${p.sku}</span> â€¢ 
                                <span>${p.brand}</span> â€¢ 
                                <span>${p.category}</span> â€¢ 
                                <span style="color: var(--success); font-weight: 600;">R ${formatNumber(p.landedCost)}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    resultsDiv.style.display = 'block';
                });
                
                // Close search results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                        resultsDiv.style.display = 'none';
                    }
                });
            }
        });

        // Add Product from Search
        function addProductToInvoiceFromSearch(sku) {
            addProductToInvoice(sku);
            document.getElementById('invoiceProductSearch').value = '';
            document.getElementById('productSearchResults').style.display = 'none';

            // Show AI product recommendations after adding a product
            setTimeout(() => showProductRecommendations(), 100);
        }

        // Load Customers into Select
        function loadCustomersIntoSelect() {
            const select = document.getElementById('invoiceCustomer');
            if (!select) return; // Exit if element doesn't exist yet
            select.innerHTML = '<option value="">Select Customer...</option>' +
                (customers || []).map(c => `<option value="${c.id}">${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('');
        }

        // Add Product to Invoice
        function addProductToInvoice(sku) {
            const product = products.find(p => p.sku === sku);
            if (!product) return;
            
            // Check if product already in invoice
            const existing = currentInvoice.items.find(item => item.sku === sku);
            if (existing) {
                existing.qty++;
                existing.total = existing.qty * existing.unitPrice;
            } else {
                const tier = document.getElementById('invoiceTier').value;
                const unitPrice = calculatePrice(product.landedCost, tier);
                const baseCost = product.landedCost || 0;
                const markupPercent = baseCost > 0 ? Math.round(((unitPrice - baseCost) / baseCost) * 100) : 0;
                
                currentInvoice.items.push({
                    product: product.name,
                    sku: product.sku,
                    qty: 1,
                    unitPrice: unitPrice,
                    baseCost: baseCost,
                    markupPercent: markupPercent,
                    total: unitPrice
                });
            }
            
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
            showToast(`Added ${product.name} to invoice`, 'success');
        }

        // Get tier-specific cost multiplier
        function getTierCostMultiplier(tier) {
            const settings = getSettings();
            const tierCostMultipliers = settings.tierCostMultipliers || {
                retail: 1.0,
                platinum: 0.95,
                gold: 0.90,
                silver: 0.85,
                rental: 0.80,
                custom: 1.0
            };
            return tierCostMultipliers[tier] || 1.0;
        }

        // Calculate adjusted cost based on tier
        function getAdjustedCost(baseCost, tier) {
            const costMultiplier = getTierCostMultiplier(tier);
            return baseCost * costMultiplier;
        }

        // Calculate Price based on Tier (with tier-specific cost adjustments)
        function calculatePrice(cost, tier) {
            // First, adjust the cost based on tier (e.g., bulk purchase discounts)
            const adjustedCost = getAdjustedCost(cost, tier);

            // Then apply the pricing multiplier
            const pricingTiers = {
                'retail': 1.35,           // +35% margin
                'platinum': 1.08,         // -20% off retail
                'gold': 1.1475,           // -15% off retail
                'silver': 1.188,          // -12% off retail
                'rental': 1.0125,         // -25% off retail
                'custom': 1.30            // Default 30%
            };

            return Math.round(adjustedCost * pricingTiers[tier]);
        }

        // Update tier cost display (for settings sliders)
        function updateTierCostDisplay(tier, value) {
            const displayElement = document.getElementById(`tierCost${tier.charAt(0).toUpperCase() + tier.slice(1)}Display`);
            if (displayElement) {
                displayElement.textContent = parseFloat(value).toFixed(2) + 'x';
            }
        }

        // Update Invoice Items Table
        function updateInvoiceItemsTable() {
            const tbody = document.getElementById('invoiceItemsBody');

            if (currentInvoice.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td></tr>';
                return;
            }

            tbody.innerHTML = currentInvoice.items.map((item, index) => {
                // Find product to get base cost
                const product = products.find(p => p.sku === item.sku);
                const baseCost = product?.landedCost || 0;

                // Get current tier and calculate adjusted cost
                const currentTier = document.getElementById('invoiceTier')?.value || 'retail';
                const adjustedUnitCost = getAdjustedCost(baseCost, currentTier);
                const totalCost = adjustedUnitCost * item.qty;

                // Calculate profit based on adjusted cost
                const itemProfit = item.total - totalCost;
                const itemMargin = item.total > 0 ? (itemProfit / item.total) * 100 : 0;

                // Color code profit margin
                let profitColor = '#06ffa5'; // Green
                if (itemMargin < 20) profitColor = '#ff006e'; // Red
                else if (itemMargin < 40) profitColor = '#ffbe0b'; // Yellow

                // Calculate and store markup percentage
                const currentMarkup = baseCost > 0 ? Math.round(((item.unitPrice - baseCost) / baseCost) * 100) : 0;
                item.markupPercent = currentMarkup;
                item.baseCost = baseCost;

                return `
                <tr>
                    <td>${item.product}</td>
                    <td>${item.sku}</td>
                    <td>
                        <input type="number" class="form-control editable" value="${item.qty}" min="1"
                            onchange="updateItemQuantity(${index}, this.value)" style="width: 80px;">
                    </td>
                    <td style="color: #ffbe0b;">R ${formatNumber(Math.round(totalCost))}</td>
                    <td>
                        <input type="number" class="form-control editable" value="${item.unitPrice}"
                            onchange="updateItemPrice(${index}, this.value)" style="width: 120px;">
                    </td>
                    <td style="color: ${currentMarkup > 0 ? '#06ffa5' : '#999'}; font-weight: 600;">+${currentMarkup}%</td>
                    <td>R ${formatNumber(item.total)}</td>
                    <td style="color: ${profitColor}; font-weight: 600;">
                        R ${formatNumber(Math.round(itemProfit))} (${itemMargin.toFixed(0)}%)
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm btn-icon" onclick="removeInvoiceItem(${index})">ðŸ—‘ï¸</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Update Item Quantity
        function updateItemQuantity(index, qty) {
            const validQty = Math.max(1, parseInt(qty) || 1); // Minimum quantity is 1
            currentInvoice.items[index].qty = validQty;
            currentInvoice.items[index].total = validQty * currentInvoice.items[index].unitPrice;
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
        }

        // Update Item Price
        function updateItemPrice(index, price) {
            const validPrice = Math.max(0, parseInt(price) || 0); // Minimum price is 0
            currentInvoice.items[index].unitPrice = validPrice;
            currentInvoice.items[index].total = currentInvoice.items[index].qty * validPrice;
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
        }

        // Remove Invoice Item
        function removeInvoiceItem(index) {
            currentInvoice.items.splice(index, 1);
            updateInvoiceItemsTable();
            calculateInvoiceTotal();

            // Update AI product recommendations
            setTimeout(() => showProductRecommendations(), 100);
        }

        // Calculate Invoice Total
        function calculateInvoiceTotal() {
            const subtotal = currentInvoice.items.reduce((sum, item) => sum + item.total, 0);
            const discountAmount = parseFloat(document.getElementById('discountAmount')?.value || 0);
            const discountType = document.getElementById('discountType')?.value || 'percentage';
            const shippingCost = parseFloat(document.getElementById('shippingCost')?.value || 0);
            const vatOption = document.getElementById('invoiceVAT')?.value || 'include';

            // Apply discount to subtotal FIRST
            let discountedAmount = 0;
            if (discountAmount > 0) {
                if (discountType === 'percentage') {
                    discountedAmount = subtotal * (discountAmount / 100);
                } else {
                    discountedAmount = Math.min(discountAmount, subtotal); // Can't discount more than subtotal
                }
            }

            // Calculate final subtotal: (subtotal - discount) + shipping
            let finalSubtotal = (subtotal - discountedAmount) + shippingCost;

            // Calculate VAT based on option
            let vat = 0;
            let total = finalSubtotal;

            if (vatOption === 'include') {
                // VAT is already included in the prices - extract the VAT portion
                vat = finalSubtotal * (15 / 115);
                total = finalSubtotal; // Total stays the same
            } else if (vatOption === 'exclude') {
                // VAT must be added on top
                vat = finalSubtotal * 0.15;
                total = finalSubtotal + vat;
            } else {
                // No VAT
                vat = 0;
                total = finalSubtotal;
            }

            // Calculate deposit/amount paid
            const depositValue = parseFloat(document.getElementById('depositAmount')?.value || 0);
            const depositType = document.getElementById('depositType')?.value || 'fixed';
            let amountPaid = 0;
            if (depositValue > 0) {
                if (depositType === 'percentage') {
                    amountPaid = total * (depositValue / 100);
                } else {
                    amountPaid = Math.min(depositValue, total); // Can't pay more than total
                }
            }
            const balance = Math.max(0, total - amountPaid);

            currentInvoice.subtotal = finalSubtotal;
            currentInvoice.vat = vat;
            currentInvoice.total = total;
            currentInvoice.amountPaid = amountPaid;
            currentInvoice.balance = balance;

            document.getElementById('invoiceSubtotal').textContent = 'R ' + formatNumber(Math.round(finalSubtotal));
            document.getElementById('invoiceVATAmount').textContent = 'R ' + formatNumber(Math.round(vat));
            document.getElementById('invoiceTotal').textContent = 'R ' + formatNumber(Math.round(total));
            
            // Update payment tracking section
            const paymentSection = document.getElementById('paymentTrackingSection');
            const balanceEl = document.getElementById('invoiceBalance');
            const paidEl = document.getElementById('invoiceAmountPaid');
            
            if (paymentSection) {
                paymentSection.style.display = amountPaid > 0 ? 'block' : 'none';
            }
            if (balanceEl) {
                balanceEl.textContent = 'R ' + formatNumber(Math.round(balance));
            }
            if (paidEl) {
                paidEl.textContent = 'R ' + formatNumber(Math.round(amountPaid));
            }

            // Calculate and display profit margins
            calculateProfitMargins();
            
            // Update project fee reference if section is visible
            if (document.getElementById('projectFeesSection')?.style.display !== 'none') {
                updateProjectFeeReference();
            }
        }

        // Calculate Profit Margins (with tier-adjusted costs)
        function calculateProfitMargins() {
            // Get current tier
            const currentTier = document.getElementById('invoiceTier')?.value || 'retail';

            // Calculate total cost from all items using tier-adjusted costs
            let totalCost = 0;
            currentInvoice.items.forEach(item => {
                const product = products.find(p => p.sku === item.sku);
                if (product && product.landedCost) {
                    // Use tier-adjusted cost instead of base landed cost
                    const adjustedCost = getAdjustedCost(product.landedCost, currentTier);
                    totalCost += adjustedCost * item.qty;
                }
            });

            // Revenue is the subtotal (before VAT, after discount)
            const revenue = currentInvoice.items.reduce((sum, item) => sum + item.total, 0);

            // Calculate profit
            const grossProfit = revenue - totalCost;
            const profitMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

            // Store in currentInvoice for later use
            currentInvoice.totalCost = totalCost;
            currentInvoice.grossProfit = grossProfit;
            currentInvoice.profitMargin = profitMargin;

            // Update display
            document.getElementById('invoiceTotalCost').textContent = 'R ' + formatNumber(Math.round(totalCost));
            document.getElementById('invoiceTotalRevenue').textContent = 'R ' + formatNumber(Math.round(revenue));
            document.getElementById('invoiceGrossProfit').textContent = 'R ' + formatNumber(Math.round(grossProfit));
            document.getElementById('invoiceProfitMargin').textContent = profitMargin.toFixed(1) + '%';

            // Color code the profit margin
            const marginElement = document.getElementById('invoiceProfitMargin');
            if (profitMargin < 20) {
                marginElement.style.color = '#ff006e'; // Red for low margin
            } else if (profitMargin < 40) {
                marginElement.style.color = '#ffbe0b'; // Yellow for medium margin
            } else {
                marginElement.style.color = '#06ffa5'; // Green for good margin
            }
        }

        // Save Invoice (handles both create and edit)
        async function saveInvoice() {
            try {
            const customer = document.getElementById('invoiceCustomer').value;
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }
            
            if (currentInvoice.items.length === 0) {
                showToast('Please add at least one product', 'error');
                return;
            }

            // Validate numeric inputs
            const discountAmount = sanitizeNumber(document.getElementById('discountAmount').value, 0);
            const shippingCost = sanitizeNumber(document.getElementById('shippingCost').value, 0);
            const depositAmount = sanitizeNumber(document.getElementById('depositAmount').value, 0);
            const depositType = document.getElementById('depositType')?.value || 'fixed';
            
            // Get selected business for the invoice
            const selectedBusinessId = document.getElementById('invoiceFromBusiness')?.value || currentBusiness?.id || 'default';
            const selectedBusiness = businesses.find(b => b.id === selectedBusinessId) || currentBusiness;
            
            const invoiceData = {
                customerId: customer,
                customer: customers.find(c => c.id == customer)?.name || '',
                type: document.getElementById('invoiceType').value,
                tier: document.getElementById('invoiceTier').value,
                vatOption: document.getElementById('invoiceVAT').value,
                status: document.getElementById('invoiceStatus').value,
                paymentTerms: parseInt(document.getElementById('paymentTerms').value || 30),
                dueDate: document.getElementById('invoiceDueDate').value,
                items: [...currentInvoice.items],
                discount: {
                    amount: discountAmount,
                    type: document.getElementById('discountType').value
                },
                shipping: shippingCost,
                deposit: {
                    amount: depositAmount,
                    type: depositType
                },
                projectFees: currentInvoice.projectFees || null,
                subtotal: currentInvoice.subtotal,
                vat: currentInvoice.vat,
                total: currentInvoice.total,
                amountPaid: currentInvoice.amountPaid || 0,
                balance: currentInvoice.total - (currentInvoice.amountPaid || 0),
                payments: currentInvoice.payments || [],
                businessId: selectedBusinessId,
                businessName: selectedBusiness?.name || '',
                businessDetails: {
                    logo: selectedBusiness?.logo || '',
                    tradingAs: selectedBusiness?.tradingAs || '',
                    vatNumber: selectedBusiness?.vatNumber || '',
                    email: selectedBusiness?.email || '',
                    phone: selectedBusiness?.phone || '',
                    address: selectedBusiness?.address || ''
                }
            };
            
            if (currentInvoice.id) {
                // Editing existing invoice
                const index = invoices.findIndex(inv => inv.id === currentInvoice.id);
                if (index !== -1) {
                    invoices[index] = {
                        ...invoices[index],
                        ...invoiceData
                    };
                    showToast('Invoice updated successfully!', 'success');
                }
            } else {
                // Creating new invoice
                const timestamp = Date.now();
                const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
                const newInvoice = {
                    id: timestamp,
                    number: 'INV-' + new Date().getFullYear() + '-' + String(timestamp).slice(-8),
                    date: document.getElementById('invoiceDate').value || new Date().toISOString().split('T')[0],
                    ...invoiceData,
                    createdAt: timestamp,
                    createdBy: currentUser ? (currentUser.username || currentUser.email) : 'unknown',
                    owner: currentUser ? (currentUser.username || currentUser.email) : 'unknown'
                };
                invoices.push(newInvoice);
                showToast('Invoice created successfully!', 'success');
            }
            
            await saveToStorage(getBusinessKey('aweh_invoices'), invoices);

            closeModal('invoiceModal');
            loadRecentInvoices();
            loadAllInvoices(); // Update invoices tab
            updateDashboard();
            } catch (error) {
                console.error('âŒ Error saving invoice:', error);
                showToast('Error saving invoice: ' + error.message, 'error');
            }
        }

        // Dashboard view mode
        let dashboardViewMode = 'current';
        
        // Toggle between current business, linked businesses, and all businesses view
        async function toggleDashboardView(mode) {
            dashboardViewMode = mode;
            const summaryDiv = document.getElementById('allBusinessesSummary');
            const titleEl = document.getElementById('dashBusinessTitle');
            const subtitleEl = document.getElementById('dashBusinessSubtitle');
            const logoEl = document.getElementById('dashBusinessLogo');
            
            if (mode === 'all') {
                summaryDiv.style.display = 'block';
                titleEl.textContent = 'Combined Financial Overview';
                subtitleEl.textContent = `Viewing all ${businesses.length} business${businesses.length > 1 ? 'es' : ''} combined`;
                logoEl.textContent = 'ðŸŒ';
                await updateConsolidatedDashboard();
            } else if (mode === 'linked') {
                // Get linked businesses for current business
                const linkedIds = getLinkedBusinessIds(currentBusiness?.id);
                const linkedCount = linkedIds.length;
                
                if (linkedCount <= 1) {
                    summaryDiv.style.display = 'none';
                    titleEl.textContent = currentBusiness?.name || 'Dashboard';
                    subtitleEl.textContent = 'No linked businesses found';
                    logoEl.innerHTML = currentBusiness?.logo 
                        ? `<img src="${currentBusiness.logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px;">`
                        : 'ðŸ”—';
                    updateDashboard();
                    showToast('This business has no linked businesses. Use "Link to Parent Company" when editing a business to connect them.', 'info');
                } else {
                    summaryDiv.style.display = 'block';
                    
                    // Get parent business name if exists
                    const parentBusiness = currentBusiness?.parentId 
                        ? businesses.find(b => b.id === currentBusiness.parentId)
                        : currentBusiness;
                    
                    titleEl.textContent = parentBusiness?.name || 'Linked Businesses';
                    subtitleEl.textContent = `Combined view of ${linkedCount} linked business${linkedCount > 1 ? 'es' : ''}`;
                    logoEl.innerHTML = parentBusiness?.logo 
                        ? `<img src="${parentBusiness.logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px;">`
                        : 'ðŸ”—';
                    await updateConsolidatedDashboard(linkedIds);
                }
            } else {
                summaryDiv.style.display = 'none';
                titleEl.textContent = currentBusiness?.name || 'Dashboard';
                subtitleEl.textContent = 'Viewing current business data';
                logoEl.innerHTML = currentBusiness?.logo 
                    ? `<img src="${currentBusiness.logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px;">`
                    : 'ðŸ¢';
                updateDashboard();
            }
        }
        
        // Load all data from all businesses for consolidated view
        async function getAllBusinessesData(filterBusinessIds = null) {
            const allData = {
                invoices: [],
                customers: [],
                expenses: [],
                businesses: []
            };
            
            // Filter businesses if specific IDs provided
            const businessesToProcess = filterBusinessIds 
                ? businesses.filter(b => filterBusinessIds.includes(b.id))
                : businesses;
            
            for (const business of businessesToProcess) {
                const businessInvoices = safeGetItem(`aweh_invoices_${business.id}`, []);
                const businessCustomers = safeGetItem(`aweh_customers_${business.id}`, []);
                const businessExpenses = safeGetItem(`aweh_expenses_${business.id}`, []);
                
                // Tag each item with its business
                businessInvoices.forEach(inv => {
                    inv._businessId = business.id;
                    inv._businessName = business.name;
                    allData.invoices.push(inv);
                });
                
                businessCustomers.forEach(cust => {
                    cust._businessId = business.id;
                    cust._businessName = business.name;
                    allData.customers.push(cust);
                });
                
                businessExpenses.forEach(exp => {
                    exp._businessId = business.id;
                    exp._businessName = business.name;
                    allData.expenses.push(exp);
                });
                
                // Calculate business totals
                const totalIncome = businessInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                const totalPaid = businessInvoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
                const totalExpenses = businessExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
                
                allData.businesses.push({
                    ...business,
                    totalIncome,
                    totalPaid,
                    totalExpenses,
                    netProfit: totalPaid - totalExpenses,
                    invoiceCount: businessInvoices.length,
                    customerCount: businessCustomers.length
                });
            }
            
            return allData;
        }
        
        // Update dashboard with consolidated data from all businesses
        async function updateConsolidatedDashboard(filterBusinessIds = null) {
            const allData = await getAllBusinessesData(filterBusinessIds);
            
            // Calculate totals
            const totalIncome = allData.invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const totalPaid = allData.invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const totalExpenses = allData.expenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            const netProfit = totalPaid - totalExpenses;
            const profitMargin = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;
            const availableFunds = totalPaid - totalExpenses;
            const pendingIncome = totalIncome - totalPaid;
            
            // This month calculations
            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const monthInvoices = allData.invoices.filter(inv => inv.date?.startsWith(thisMonth));
            const monthIncome = monthInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const monthExpenses = allData.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === now.getFullYear() && expDate.getMonth() === now.getMonth();
            });
            const monthExpenseTotal = monthExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            const monthCashFlow = monthIncome - monthExpenseTotal;
            
            // Update UI
            const formatCurrency = (val) => 'R ' + (val || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            document.getElementById('dashTotalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('dashIncomeInvoices').textContent = `${allData.invoices.length} invoices across ${businesses.length} businesses`;
            
            document.getElementById('dashTotalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('dashExpenseCount').textContent = `${allData.expenses.length} total`;
            
            document.getElementById('dashNetProfit').textContent = formatCurrency(netProfit);
            document.getElementById('dashProfitMargin').textContent = `${profitMargin}% combined margin`;
            
            const availFundsEl = document.getElementById('dashAvailableFunds');
            if (availFundsEl) availFundsEl.textContent = formatCurrency(availableFunds);
            
            const pendingEl = document.getElementById('dashPendingIncome');
            if (pendingEl) pendingEl.textContent = `+${formatCurrency(pendingIncome)} pending`;
            
            const monthFlowEl = document.getElementById('dashMonthCashFlow');
            if (monthFlowEl) monthFlowEl.textContent = formatCurrency(monthCashFlow);
            
            // Render business breakdown
            renderBusinessBreakdown(allData.businesses);
        }
        
        // Render individual business breakdown
        function renderBusinessBreakdown(businessesData) {
            const listDiv = document.getElementById('businessBreakdownList');
            if (!listDiv) return;
            
            const formatCurrency = (val) => 'R ' + (val || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            listDiv.innerHTML = businessesData.map(b => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="width: 50px; height: 50px; background: ${b.logo ? 'transparent' : 'var(--primary)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${b.logo ? `<img src="${b.logo}" style="width: 100%; height: 100%; object-fit: contain;">` : 'ðŸ¢'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${b.name}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">${b.invoiceCount} invoices â€¢ ${b.customerCount} customers</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: var(--success); font-weight: 600;">${formatCurrency(b.totalIncome)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">Income</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: ${b.netProfit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${formatCurrency(b.netProfit)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">Profit</div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="switchToBusiness('${b.id}')" title="Switch to this business">
                        ðŸ‘ï¸ View
                    </button>
                </div>
            `).join('');
        }

        // Load Recent Invoices
        function loadRecentInvoices() {
            const tbody = document.querySelector('#recentInvoicesTable tbody');
            if (!tbody) return; // Exit if element doesn't exist
            
            const recentInvoices = (invoices || []).slice(-10).reverse();
            
            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices yet. Create your first invoice!</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentInvoices.map(inv => `
                <tr>
                    <td>${inv.number}</td>
                    <td>${inv.date}</td>
                    <td>${inv.customer}</td>
                    <td>R ${formatNumber(Math.round(inv.total))}</td>
                    <td>${getStatusBadge(inv.status || 'draft')}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewInvoice(${inv.id})">ðŸ‘ï¸</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editInvoice(${inv.id})">âœï¸</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteInvoice(${inv.id})">ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update Dashboard Stats
        function updateDashboard() {
            // Check for overdue invoices
            checkOverdueInvoices();
            
            // Update storage usage indicator
            updateStorageUsage();

            const today = new Date().toISOString().split('T')[0];
            const todayInvoices = invoices.filter(inv => inv.date === today);
            const todayRevenue = todayInvoices.reduce((sum, inv) => sum + inv.total, 0);

            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthInvoices = invoices.filter(inv => inv.date.startsWith(thisMonth));

            const totalRevenue = (invoices || []).reduce((sum, inv) => sum + inv.total, 0);
            const totalPaid = (invoices || []).reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const totalOutstanding = totalRevenue - totalPaid;

            const todayInvEl = document.getElementById('todayInvoices');
            const todayRevEl = document.getElementById('todayRevenue');
            const monthInvEl = document.getElementById('monthInvoices');
            const totalRevEl = document.getElementById('totalRevenue');
            
            if (todayInvEl) todayInvEl.textContent = todayInvoices.length;
            if (todayRevEl) todayRevEl.textContent = 'R ' + formatNumber(Math.round(todayRevenue));
            if (monthInvEl) monthInvEl.textContent = monthInvoices.length;
            if (totalRevEl) totalRevEl.textContent = 'R ' + formatNumber(Math.round(totalRevenue));

            // Update outstanding balance if element exists
            const outstandingEl = document.getElementById('totalOutstanding');
            if (outstandingEl) {
                outstandingEl.textContent = 'R ' + formatNumber(Math.round(totalOutstanding));
            }

            // Update financial dashboard
            updateFinancialDashboard();
        }

        function updateFinancialDashboard() {
            const expenses = JSON.parse(localStorage.getItem(getBusinessKey('aweh_expenses')) || '[]');
            
            // Calculate income
            const totalIncome = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const paidIncome = invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const pendingIncome = totalIncome - paidIncome;
            
            // Calculate expenses
            const totalExpenses = expenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            
            // Calculate profit
            const netProfit = paidIncome - totalExpenses;
            const profitMargin = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;
            
            // Available funds (paid income - expenses)
            const availableFunds = paidIncome - totalExpenses;
            
            // This month's cash flow
            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const monthInvoices = invoices.filter(inv => inv.date.startsWith(thisMonth));
            const monthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === now.getFullYear() && expDate.getMonth() === now.getMonth();
            });
            
            const monthIncome = monthInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const monthExpenseTotal = monthExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            const monthCashFlow = monthIncome - monthExpenseTotal;
            
            // Calculate last month for comparison
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().slice(0, 7);
            const lastMonthInvoices = invoices.filter(inv => inv.date.startsWith(lastMonthStr));
            const lastMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === lastMonth.getFullYear() && expDate.getMonth() === lastMonth.getMonth();
            });
            const lastMonthIncome = lastMonthInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const lastMonthExpenseTotal = lastMonthExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            const lastMonthCashFlow = lastMonthIncome - lastMonthExpenseTotal;
            
            const monthChange = lastMonthCashFlow !== 0 
                ? (((monthCashFlow - lastMonthCashFlow) / Math.abs(lastMonthCashFlow)) * 100).toFixed(1)
                : 0;
            
            // Update UI
            const formatCurrency = (val) => 'R ' + val.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            document.getElementById('dashTotalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('dashIncomeInvoices').textContent = `${invoices.length} invoices`;
            
            document.getElementById('dashTotalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('dashExpenseCount').textContent = `${expenses.length} scanned`;
            
            document.getElementById('dashNetProfit').textContent = formatCurrency(netProfit);
            document.getElementById('dashProfitMargin').textContent = `${profitMargin}% margin`;
            
            document.getElementById('dashAvailableFunds').textContent = formatCurrency(availableFunds);
            document.getElementById('dashPendingIncome').textContent = `+${formatCurrency(pendingIncome)} pending`;
            
            document.getElementById('dashMonthCashFlow').textContent = formatCurrency(monthCashFlow);
            const changeSymbol = monthChange >= 0 ? '+' : '';
            document.getElementById('dashMonthChange').textContent = `${changeSymbol}${monthChange}% vs last month`;
            
            // Draw income vs expenses chart
            drawIncomeExpensesChart();
        }

        function drawIncomeExpensesChart() {
            const chart = document.getElementById('incomeExpensesChart');
            if (!chart) return;
            
            const expenses = JSON.parse(localStorage.getItem(getBusinessKey('aweh_expenses')) || '[]');
            const now = new Date();
            const months = [];
            
            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStr = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                
                const monthInvoices = invoices.filter(inv => inv.date.startsWith(monthStr));
                const monthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getFullYear() === date.getFullYear() && expDate.getMonth() === date.getMonth();
                });
                
                const income = monthInvoices.reduce((sum, inv) => sum + inv.total, 0);
                const expense = monthExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
                
                months.push({ name: monthName, income, expense });
            }
            
            const maxValue = Math.max(...months.map(m => Math.max(m.income, m.expense)));
            
            chart.innerHTML = `
                <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 100%; gap: 0.5rem;">
                    ${months.map(month => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                            <div style="display: flex; gap: 4px; align-items: flex-end; height: 150px; width: 100%;">
                                <div style="flex: 1; background: linear-gradient(to top, #06ffa5, #00d4ff); border-radius: 4px 4px 0 0; height: ${maxValue > 0 ? (month.income / maxValue * 100) : 0}%; min-height: 4px;" title="Income: R ${month.income.toFixed(2)}"></div>
                                <div style="flex: 1; background: linear-gradient(to top, #f72585, #7209b7); border-radius: 4px 4px 0 0; height: ${maxValue > 0 ? (month.expense / maxValue * 100) : 0}%; min-height: 4px;" title="Expenses: R ${month.expense.toFixed(2)}"></div>
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${month.name}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem; font-size: 0.85rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #06ffa5, #00d4ff); border-radius: 4px;"></div>
                        <span>Income</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #f72585, #7209b7); border-radius: 4px;"></div>
                        <span>Expenses</span>
                    </div>
                </div>
            `;
        }

        async function categorizeInvoices() {
            const container = document.getElementById('invoicesByTopic');
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Analyzing invoices with AI...</p></div>';
            
            try {
                // Group invoices by customer and analyze patterns
                const customerGroups = {};
                invoices.forEach(inv => {
                    if (!customerGroups[inv.customer]) {
                        customerGroups[inv.customer] = [];
                    }
                    customerGroups[inv.customer].push(inv);
                });
                
                // Simple categorization based on items and patterns
                const categories = {
                    'Retail': [],
                    'Hospitality': [],
                    'Services': [],
                    'Wholesale': [],
                    'Other': []
                };
                
                Object.entries(customerGroups).forEach(([customer, invs]) => {
                    const items = invs.flatMap(inv => inv.items || []);
                    const itemNames = items.map(i => i.description?.toLowerCase() || '').join(' ');
                    
                    // Categorize based on keywords
                    if (itemNames.includes('retail') || itemNames.includes('shop') || itemNames.includes('store')) {
                        categories['Retail'].push({ customer, invoices: invs, total: invs.reduce((s, i) => s + i.total, 0) });
                    } else if (itemNames.includes('restaurant') || itemNames.includes('cafe') || itemNames.includes('bar')) {
                        categories['Hospitality'].push({ customer, invoices: invs, total: invs.reduce((s, i) => s + i.total, 0) });
                    } else if (itemNames.includes('service') || itemNames.includes('consulting')) {
                        categories['Services'].push({ customer, invoices: invs, total: invs.reduce((s, i) => s + i.total, 0) });
                    } else if (invs.length > 10 || invs.reduce((s, i) => s + i.total, 0) > 50000) {
                        categories['Wholesale'].push({ customer, invoices: invs, total: invs.reduce((s, i) => s + i.total, 0) });
                    } else {
                        categories['Other'].push({ customer, invoices: invs, total: invs.reduce((s, i) => s + i.total, 0) });
                    }
                });
                
                // Update filter dropdown
                const topicFilter = document.getElementById('topicFilter');
                topicFilter.innerHTML = '<option value="all">All Categories</option>' + 
                    Object.keys(categories).map(cat => 
                        `<option value="${cat}">${cat} (${categories[cat].length})</option>`
                    ).join('');
                
                // Display categories
                displayCategorizedInvoices(categories);
                
            } catch (error) {
                console.error('Categorization error:', error);
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 2rem;"><p>Failed to categorize. Try again.</p></div>';
            }
        }

        function displayCategorizedInvoices(categories) {
            const container = document.getElementById('invoicesByTopic');
            
            let html = '';
            for (const [category, groups] of Object.entries(categories)) {
                if (groups.length === 0) continue;
                
                const categoryTotal = groups.reduce((sum, g) => sum + g.total, 0);
                const categoryInvoices = groups.reduce((sum, g) => sum + g.invoices.length, 0);
                
                html += `
                    <div class="category-section" data-category="${category}" style="margin-bottom: 2rem;">
                        <h3 style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 1rem;">
                            <span>ðŸ·ï¸ ${category}</span>
                            <span style="font-size: 0.9rem; opacity: 0.8;">${categoryInvoices} invoices â€¢ R ${categoryTotal.toFixed(2)}</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                            ${groups.map(group => `
                                <div class="card" style="padding: 1rem; cursor: pointer;" onclick="switchTab('invoices'); setTimeout(() => { document.getElementById('customerFilter').value = '${group.customer.replace(/'/g, "\\'")}'; filterInvoices(); }, 100);">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">${group.customer}</h4>
                                    <p style="margin: 0.25rem 0; font-size: 0.85rem; opacity: 0.8;">${group.invoices.length} invoices</p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 1.2rem; font-weight: bold; color: var(--primary);">R ${group.total.toFixed(2)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div style="text-align: center; opacity: 0.7; padding: 2rem;"><p>No invoices to categorize</p></div>';
        }

        function filterByTopic() {
            const selectedCategory = document.getElementById('topicFilter').value;
            const categorySections = document.querySelectorAll('.category-section');
            
            if (selectedCategory === 'all') {
                categorySections.forEach(section => section.style.display = 'block');
            } else {
                categorySections.forEach(section => {
                    section.style.display = section.dataset.category === selectedCategory ? 'block' : 'none';
                });
            }
        }

        // ==================== BANK STATEMENT IMPORT & MANAGEMENT ACCOUNTS ====================

        let pendingBankTransactions = [];

        function openBankImportModal() {
            document.getElementById('bankImportProgress').style.display = 'none';
            document.getElementById('bankImportResults').style.display = 'none';
            openModal('bankImportModal');
        }

        async function processBankStatement(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('bankImportProgress').style.display = 'block';
            document.getElementById('bankImportResults').style.display = 'none';
            document.getElementById('bankImportStatus').textContent = 'Reading file...';

            try {
                const fileType = file.name.split('.').pop().toLowerCase();
                let transactions = [];

                if (fileType === 'csv') {
                    transactions = await parseCSVBankStatement(file);
                } else if (fileType === 'pdf') {
                    transactions = await parsePDFBankStatement(file);
                } else if (['xlsx', 'xls'].includes(fileType)) {
                    transactions = await parseExcelBankStatement(file);
                }

                if (transactions.length === 0) {
                    showToast('No transactions found in file', 'error');
                    document.getElementById('bankImportProgress').style.display = 'none';
                    return;
                }

                // Enhanced date extraction with AI
                document.getElementById('bankImportStatus').textContent = 'Extracting dates with AI...';
                transactions = await enhanceDatesWithAI(transactions);

                // Match transactions to invoices
                document.getElementById('bankImportStatus').textContent = 'Matching to invoices...';
                transactions = matchTransactionsToInvoices(transactions);

                pendingBankTransactions = transactions;
                displayBankPreview(transactions);

                document.getElementById('bankImportProgress').style.display = 'none';
                document.getElementById('bankImportResults').style.display = 'block';

            } catch (error) {
                console.error('Bank import error:', error);
                showToast('Failed to import: ' + error.message, 'error');
                document.getElementById('bankImportProgress').style.display = 'none';
            }
        }

        async function parseCSVBankStatement(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\\n');
                    const transactions = [];

                    // Try to detect header row
                    const headers = lines[0].toLowerCase().split(',');
                    const dateCol = headers.findIndex(h => h.includes('date'));
                    const descCol = headers.findIndex(h => h.includes('desc') || h.includes('detail') || h.includes('reference'));
                    const amountCol = headers.findIndex(h => h.includes('amount') || h.includes('credit') || h.includes('debit'));

                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < 3) continue;

                        const date = dateCol >= 0 ? cols[dateCol].trim() : cols[0].trim();
                        const description = descCol >= 0 ? cols[descCol].trim() : cols[1].trim();
                        let amount = amountCol >= 0 ? cols[amountCol].trim() : cols[cols.length - 1].trim();
                        
                        // Clean amount
                        amount = parseFloat(amount.replace(/[^0-9.-]/g, ''));
                        
                        if (!isNaN(amount) && amount !== 0) {
                            transactions.push({
                                date: parseDate(date),
                                description: description.replace(/['"]/g, ''),
                                amount: Math.abs(amount),
                                type: amount > 0 ? 'credit' : 'debit',
                                matched: false
                            });
                        }
                    }

                    resolve(transactions);
                };
                reader.readAsText(file);
            });
        }

        async function parsePDFBankStatement(file) {
            // Use OCR + AI for PDF statements
            const reader = new FileReader();
            return new Promise((resolve) => {
                reader.onload = async (e) => {
                    const dataUrl = e.target.result;
                    
                    try {
                        // OCR extract text
                        const text = await performOCR(dataUrl);
                        
                        // Use AI to extract structured transactions
                        const transactions = await extractTransactionsWithAI(text);
                        resolve(transactions);
                    } catch (error) {
                        console.error('PDF parsing error:', error);
                        resolve([]);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        async function parseExcelBankStatement(file) {
            // Simplified Excel parsing (would need library like SheetJS in production)
            showToast('Excel import coming soon. Please use CSV format.', 'info');
            return [];
        }

        async function extractTransactionsWithAI(text) {
            // AI extracts transactions from bank statement text
            const transactions = [];
            
            // Basic regex extraction as fallback
            const lines = text.split('\\n');
            const dateRegex = /\\b\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4}\\b/;
            const amountRegex = /R?\\s?\\d+[,.]?\\d*\\.\\d{2}/;
            
            for (const line of lines) {
                const dateMatch = line.match(dateRegex);
                const amountMatch = line.match(amountRegex);
                
                if (dateMatch && amountMatch) {
                    const amount = parseFloat(amountMatch[0].replace(/[^0-9.-]/g, ''));
                    if (!isNaN(amount) && amount !== 0) {
                        transactions.push({
                            date: parseDate(dateMatch[0]),
                            description: line.replace(dateMatch[0], '').replace(amountMatch[0], '').trim(),
                            amount: Math.abs(amount),
                            type: amount > 0 ? 'credit' : 'debit',
                            matched: false
                        });
                    }
                }
            }
            
            return transactions;
        }

        async function enhanceDatesWithAI(transactions) {
            // AI improves date detection and standardizes formats
            return transactions.map(t => {
                if (t.date && t.date !== 'Invalid Date') {
                    return t;
                }
                
                // Try to extract date from description using AI patterns
                const datePatterns = [
                    /\\b(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})\\b/,
                    /\\b(\\d{4})[\\/\\-](\\d{1,2})[\\/\\-](\\d{1,2})\\b/,
                    /\\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\s+(\\d{1,2}),?\\s+(\\d{4})\\b/i
                ];
                
                for (const pattern of datePatterns) {
                    const match = t.description.match(pattern);
                    if (match) {
                        t.date = parseDate(match[0]);
                        break;
                    }
                }
                
                return t;
            });
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // Handle various date formats
            const cleaned = dateStr.replace(/['"]/g, '').trim();
            const date = new Date(cleaned);
            
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            // Try DD/MM/YYYY or DD-MM-YYYY
            const parts = cleaned.split(/[\\/\\-]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                const fullYear = year < 100 ? 2000 + year : year;
                
                const parsedDate = new Date(fullYear, month, day);
                if (!isNaN(parsedDate.getTime())) {
                    return parsedDate.toISOString().split('T')[0];
                }
            }
            
            return new Date().toISOString().split('T')[0];
        }

        function matchTransactionsToInvoices(transactions) {
            return transactions.map(transaction => {
                // Try to match credit transactions to invoices
                if (transaction.type === 'credit') {
                    const matchedInvoice = invoices.find(inv => {
                        const amountMatch = Math.abs(inv.total - transaction.amount) < 1;
                        const dateMatch = Math.abs(new Date(inv.date) - new Date(transaction.date)) < 30 * 24 * 60 * 60 * 1000; // Within 30 days
                        const descMatch = transaction.description.toLowerCase().includes(inv.customer.toLowerCase()) ||
                                        transaction.description.toLowerCase().includes(inv.invoiceNumber?.toLowerCase() || '');
                        
                        return amountMatch && (dateMatch || descMatch);
                    });
                    
                    if (matchedInvoice) {
                        transaction.matched = true;
                        transaction.matchedInvoice = matchedInvoice.invoiceNumber;
                        transaction.matchedCustomer = matchedInvoice.customer;
                    }
                }
                
                return transaction;
            });
        }

        function displayBankPreview(transactions) {
            const tbody = document.getElementById('bankPreviewBody');
            
            tbody.innerHTML = transactions.map(t => `
                <tr style="${t.matched ? 'background: rgba(6, 255, 165, 0.1);' : ''}">
                    <td>${t.date}</td>
                    <td>${t.description}</td>
                    <td style="color: ${t.type === 'credit' ? '#06ffa5' : '#f72585'};">
                        ${t.type === 'credit' ? '+' : '-'}R ${t.amount.toFixed(2)}
                    </td>
                    <td>${t.matched ? `âœ“ ${t.matchedInvoice}` : 'â€”'}</td>
                </tr>
            `).join('');
        }

        function saveBankTransactions() {
            const existing = JSON.parse(localStorage.getItem('aweh_bank_transactions') || '[]');
            const combined = [...existing, ...pendingBankTransactions];
            
            localStorage.setItem('aweh_bank_transactions', JSON.stringify(combined));
            
            // Update matched invoices as paid
            pendingBankTransactions.filter(t => t.matched).forEach(t => {
                const invoice = invoices.find(inv => inv.invoiceNumber === t.matchedInvoice);
                if (invoice) {
                    invoice.amountPaid = (invoice.amountPaid || 0) + t.amount;
                    if (invoice.amountPaid >= invoice.total) {
                        invoice.status = 'PAID';
                    }
                }
            });
            
            localStorage.setItem('aweh_invoices', JSON.stringify(invoices));
            
            showToast(`Imported ${pendingBankTransactions.length} transactions, ${pendingBankTransactions.filter(t => t.matched).length} matched`, 'success');
            
            closeModal('bankImportModal');
            updateBankReconciliationStats();
            updateDashboard();
        }

        function viewBankTransactions() {
            const transactions = JSON.parse(localStorage.getItem('aweh_bank_transactions') || '[]');
            const tbody = document.getElementById('bankTransactionsBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No transactions imported yet</td></tr>';
            } else {
                tbody.innerHTML = transactions.map(t => `
                    <tr>
                        <td>${t.date}</td>
                        <td>${t.description}</td>
                        <td style="color: ${t.type === 'credit' ? '#06ffa5' : '#f72585'};">
                            ${t.type === 'credit' ? '+' : '-'}R ${t.amount.toFixed(2)}
                        </td>
                        <td>${t.matched ? `âœ“ ${t.matchedInvoice}` : 'â€”'}</td>
                        <td>
                            ${!t.matched ? `<button class="btn btn-sm btn-outline" onclick="manualMatchTransaction('${t.date}', ${t.amount})">Match</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }
            
            openModal('bankTransactionsModal');
        }

        function filterBankTransactions() {
            const filter = document.getElementById('transactionFilter').value;
            const rows = document.querySelectorAll('#bankTransactionsBody tr');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'matched') {
                    row.style.display = row.innerHTML.includes('âœ“') ? '' : 'none';
                } else if (filter === 'unmatched') {
                    row.style.display = row.innerHTML.includes('âœ“') ? 'none' : '';
                }
            });
        }

        function autoMatchTransactions() {
            const transactions = JSON.parse(localStorage.getItem('aweh_bank_transactions') || '[]');
            const updated = matchTransactionsToInvoices(transactions);
            localStorage.setItem('aweh_bank_transactions', JSON.stringify(updated));
            
            viewBankTransactions();
            updateBankReconciliationStats();
            showToast('Auto-matching complete', 'success');
        }

        function updateBankReconciliationStats() {
            const transactions = JSON.parse(localStorage.getItem('aweh_bank_transactions') || '[]');
            const matched = transactions.filter(t => t.matched).length;
            const unmatched = transactions.length - matched;
            
            document.getElementById('bankTransCount').textContent = transactions.length;
            document.getElementById('bankMatchedCount').textContent = matched;
            document.getElementById('bankUnmatchedCount').textContent = unmatched;
        }

        function exportManagementAccounts() {
            const expenses = JSON.parse(localStorage.getItem(getBusinessKey('aweh_expenses')) || '[]');
            const bankTransactions = JSON.parse(localStorage.getItem(getBusinessKey('aweh_bank_transactions')) || '[]');
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // Generate comprehensive financial report
            const report = generateManagementReport(monthStart, monthEnd);
            
            // Export as formatted text file
            const content = formatManagementReport(report);
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Management-Accounts-${now.toISOString().slice(0, 7)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Management accounts exported successfully', 'success');
        }

        function generateManagementReport(startDate, endDate) {
            const monthInvoices = invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate >= startDate && invDate <= endDate;
            });
            
            const expenses = JSON.parse(localStorage.getItem(getBusinessKey('aweh_expenses')) || '[]');
            const monthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= startDate && expDate <= endDate;
            });
            
            const revenue = monthInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const paidRevenue = monthInvoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const totalExpenses = monthExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
            const netProfit = paidRevenue - totalExpenses;
            const profitMargin = revenue > 0 ? ((netProfit / revenue) * 100).toFixed(2) : 0;
            
            // Assets = Cash + Receivables
            const totalReceivables = invoices.reduce((sum, inv) => sum + (inv.total - (inv.amountPaid || 0)), 0);
            const bankTransactions = JSON.parse(localStorage.getItem('aweh_bank_transactions') || '[]');
            const cashBalance = bankTransactions.reduce((sum, t) => sum + (t.type === 'credit' ? t.amount : -t.amount), 0);
            
            return {
                period: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
                profitLoss: {
                    revenue,
                    paidRevenue,
                    expenses: totalExpenses,
                    grossProfit: revenue - totalExpenses,
                    netProfit,
                    profitMargin
                },
                balanceSheet: {
                    cash: cashBalance,
                    receivables: totalReceivables,
                    totalAssets: cashBalance + totalReceivables,
                    liabilities: 0, // Would need to track
                    equity: cashBalance + totalReceivables
                },
                cashFlow: {
                    operating: paidRevenue - totalExpenses,
                    investing: 0,
                    financing: 0,
                    netCashFlow: paidRevenue - totalExpenses
                },
                kpis: {
                    invoiceCount: monthInvoices.length,
                    avgInvoiceValue: revenue / (monthInvoices.length || 1),
                    collectionRate: revenue > 0 ? ((paidRevenue / revenue) * 100).toFixed(2) : 0,
                    expenseRatio: revenue > 0 ? ((totalExpenses / revenue) * 100).toFixed(2) : 0
                }
            };
        }

        function formatManagementReport(report) {
            return `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           AWEH BE LEKKER - MANAGEMENT ACCOUNTS                â•‘
â•‘           Period: ${report.period.padEnd(42)} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“Š PROFIT & LOSS STATEMENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Revenue (Invoiced):                           R ${report.profitLoss.revenue.toFixed(2)}
Revenue (Collected):                          R ${report.profitLoss.paidRevenue.toFixed(2)}
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Gross Revenue:                                R ${report.profitLoss.revenue.toFixed(2)}

Less: Operating Expenses                     (R ${report.profitLoss.expenses.toFixed(2)})
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Net Profit:                                   R ${report.profitLoss.netProfit.toFixed(2)}
                                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Profit Margin:                                ${report.profitLoss.profitMargin}%


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ’¼ BALANCE SHEET
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ASSETS:
  Cash & Bank:                                R ${report.balanceSheet.cash.toFixed(2)}
  Accounts Receivable:                        R ${report.balanceSheet.receivables.toFixed(2)}
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total Assets:                               R ${report.balanceSheet.totalAssets.toFixed(2)}
                                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LIABILITIES:
  Current Liabilities:                        R ${report.balanceSheet.liabilities.toFixed(2)}
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

EQUITY:
  Owner's Equity:                             R ${report.balanceSheet.equity.toFixed(2)}
                                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ’° CASH FLOW STATEMENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Operating Activities:                         R ${report.cashFlow.operating.toFixed(2)}
Investing Activities:                         R ${report.cashFlow.investing.toFixed(2)}
Financing Activities:                         R ${report.cashFlow.financing.toFixed(2)}
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Net Cash Flow:                                R ${report.cashFlow.netCashFlow.toFixed(2)}
                                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“ˆ KEY PERFORMANCE INDICATORS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Total Invoices:                               ${report.kpis.invoiceCount}
Average Invoice Value:                        R ${report.kpis.avgInvoiceValue.toFixed(2)}
Collection Rate:                              ${report.kpis.collectionRate}%
Expense Ratio:                                ${report.kpis.expenseRatio}%


Generated: ${new Date().toLocaleString()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
        }

        // ==================== END BANK & MANAGEMENT ACCOUNTS ====================

        async function persistSettingsToStorage() {
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            return await saveToStorage(storageKey, settings);
        }

        // Logo Upload - Enhanced with dual persistence (settings + business object)
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showToast('Logo must be under 5MB', 'error');
                return;
            }

            // Validate file type
            if (!file.type.match(/^image\/(png|jpeg|jpg|gif|webp)$/)) {
                showToast('Please upload a valid image file (PNG, JPG, GIF, WebP)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onerror = function() {
                showToast('Error reading file. Please try again.', 'error');
            };
            reader.onload = async function(e) {
                const logoData = e.target.result;

                // Update settings with new logo
                settings.logo = logoData;

                // Update UI immediately for visual feedback
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    logoPreview.src = logoData;
                    logoPreview.classList.add('active');
                }

                try {
                    // Save to settings storage
                    const settingsSaved = await persistSettingsToStorage();

                    // CRITICAL FIX: Also save logo to the business object to ensure persistence
                    let businessSaved = true;
                    if (currentBusiness) {
                        currentBusiness.logo = logoData;
                        const businessIndex = businesses.findIndex(b => b.id === currentBusiness.id);
                        if (businessIndex !== -1) {
                            businesses[businessIndex].logo = logoData;
                            businesses[businessIndex].updatedAt = new Date().toISOString();
                            businessSaved = await saveToStorage('aweh_businesses', businesses);
                        }
                    }

                    if (settingsSaved && businessSaved) {
                        if (typeof updateCurrentBusinessDisplay === 'function') {
                            updateCurrentBusinessDisplay();
                        }
                        showToast('Logo uploaded and saved successfully!', 'success');
                        console.log('[Logo] Saved to both settings and business object');
                    } else if (settingsSaved) {
                        showToast('Logo saved to settings (business sync pending)', 'warning');
                    } else {
                        showToast('Logo upload failed to save. Storage quota may be exceeded.', 'error');
                    }
                } catch (error) {
                    console.error('[Logo] Save error:', error);
                    showToast('Error saving logo: ' + (error.message || 'Unknown error'), 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        // Remove Logo - Enhanced with dual cleanup
        async function removeLogo() {
            settings.logo = '';
            document.getElementById('logoPreview').classList.remove('active');
            document.getElementById('logoUpload').value = '';

            try {
                const settingsSaved = await persistSettingsToStorage();

                // CRITICAL FIX: Also remove logo from business object
                let businessSaved = true;
                if (currentBusiness) {
                    currentBusiness.logo = '';
                    const businessIndex = businesses.findIndex(b => b.id === currentBusiness.id);
                    if (businessIndex !== -1) {
                        businesses[businessIndex].logo = '';
                        businesses[businessIndex].updatedAt = new Date().toISOString();
                        businessSaved = await saveToStorage('aweh_businesses', businesses);
                    }
                }

                if (settingsSaved && businessSaved) {
                    if (typeof updateCurrentBusinessDisplay === 'function') {
                        updateCurrentBusinessDisplay();
                    }
                    showToast('Logo removed', 'info');
                } else {
                    showToast('Failed to save logo removal. Storage quota may be exceeded.', 'error');
                }
            } catch (error) {
                console.error('[Logo] Remove error:', error);
                showToast('Error removing logo: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Update Colors
        function updateColors() {
            settings.primaryColor = document.getElementById('primaryColor').value;
            settings.secondaryColor = document.getElementById('secondaryColor').value;
            settings.accentColor = document.getElementById('accentColor').value;
            
            document.documentElement.style.setProperty('--primary', settings.primaryColor);
            document.documentElement.style.setProperty('--secondary', settings.secondaryColor);
            document.documentElement.style.setProperty('--accent', settings.accentColor);
            
            saveSettings();
        }

        // Reset Colors
        function resetColors() {
            document.getElementById('primaryColor').value = '#00d4ff';
            document.getElementById('secondaryColor').value = '#ff006e';
            document.getElementById('accentColor').value = '#7209b7';
            updateColors();
            showToast('Colors reset to default', 'info');
        }

        // Toggle AI Key section based on provider selection
        function toggleAIKeySection() {
            const provider = document.getElementById('aiProvider')?.value;
            const keySection = document.getElementById('aiKeySection');
            const modelSection = document.getElementById('aiModelSection');
            
            if (provider && provider !== '') {
                if (keySection) keySection.style.display = 'block';
                if (modelSection) modelSection.style.display = 'block';
            } else {
                if (keySection) keySection.style.display = 'none';
                if (modelSection) modelSection.style.display = 'none';
            }
        }

        // Test AI Connection
        async function testAIConnection() {
            const provider = document.getElementById('aiProvider')?.value;
            const apiKey = document.getElementById('aiApiKey')?.value;
            const resultEl = document.getElementById('aiTestResult');
            
            if (!provider || provider === '') {
                resultEl.innerHTML = '<span style="color: var(--success);">âœ… Using FREE Together AI</span>';
                return;
            }
            
            if (!apiKey) {
                resultEl.innerHTML = '<span style="color: var(--danger);">âŒ Please enter API key</span>';
                return;
            }
            
            resultEl.innerHTML = '<span style="color: var(--primary);">â³ Testing...</span>';
            
            try {
                let testUrl, testBody, testHeaders;
                
                if (provider === 'anthropic') {
                    // Test Claude API via our endpoint
                    const response = await fetch('/api/ai-claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'chat',
                            message: 'Say "Connection successful" in 3 words or less.',
                            apiKey: apiKey
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        resultEl.innerHTML = `<span style="color: var(--success);">âœ… Connected! Model: ${data.model || 'Claude'}</span>`;
                    } else {
                        const error = await response.json();
                        resultEl.innerHTML = `<span style="color: var(--danger);">âŒ ${error.message || 'Connection failed'}</span>`;
                    }
                } else if (provider === 'openai') {
                    // Direct test to OpenAI
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    
                    if (response.ok) {
                        resultEl.innerHTML = '<span style="color: var(--success);">âœ… OpenAI Connected!</span>';
                    } else {
                        resultEl.innerHTML = '<span style="color: var(--danger);">âŒ Invalid API key</span>';
                    }
                } else {
                    resultEl.innerHTML = '<span style="color: var(--warning);">âš ï¸ Manual test required</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span style="color: var(--danger);">âŒ Error: ${error.message}</span>`;
            }
        }

        // ==================== OCR SETTINGS FUNCTIONS ====================

        // OCR Configuration object
        let ocrConfig = {
            mode: 'offline', // 'offline', 'hybrid', 'online'
            togetherApiKey: '',
            hunyuanOcrUrl: '',
            paddleOcrUrl: '',
            showConfidence: true
        };

        function toggleOCRSettings() {
            const mode = document.getElementById('ocrMode')?.value || 'offline';
            const onlineSettings = document.getElementById('ocrOnlineSettings');
            if (onlineSettings) {
                onlineSettings.style.display = (mode === 'offline') ? 'none' : 'block';
            }
        }

        function loadOCRSettings() {
            const saved = localStorage.getItem('aweh_ocr_config');
            if (saved) {
                ocrConfig = { ...ocrConfig, ...JSON.parse(saved) };
            }

            // Populate form fields
            if (document.getElementById('ocrMode')) {
                document.getElementById('ocrMode').value = ocrConfig.mode || 'offline';
                toggleOCRSettings();
            }
            if (document.getElementById('togetherApiKey')) {
                document.getElementById('togetherApiKey').value = ocrConfig.togetherApiKey || '';
            }
            if (document.getElementById('hunyuanOcrUrl')) {
                document.getElementById('hunyuanOcrUrl').value = ocrConfig.hunyuanOcrUrl || '';
            }
            if (document.getElementById('paddleOcrUrl')) {
                document.getElementById('paddleOcrUrl').value = ocrConfig.paddleOcrUrl || '';
            }
            if (document.getElementById('showOcrConfidence')) {
                document.getElementById('showOcrConfidence').checked = ocrConfig.showConfidence !== false;
            }
        }

        function saveOCRSettings() {
            ocrConfig.mode = document.getElementById('ocrMode')?.value || 'offline';
            ocrConfig.togetherApiKey = document.getElementById('togetherApiKey')?.value || '';
            ocrConfig.hunyuanOcrUrl = document.getElementById('hunyuanOcrUrl')?.value || '';
            ocrConfig.paddleOcrUrl = document.getElementById('paddleOcrUrl')?.value || '';
            ocrConfig.showConfidence = document.getElementById('showOcrConfidence')?.checked !== false;

            localStorage.setItem('aweh_ocr_config', JSON.stringify(ocrConfig));
            showToast('ðŸ’¾ OCR settings saved!', 'success');
        }

        async function testOCRConnection() {
            const resultEl = document.getElementById('ocrTestResult');
            if (!resultEl) return;

            resultEl.innerHTML = '<span style="color: var(--warning);">â³ Testing...</span>';

            const mode = document.getElementById('ocrMode')?.value || 'offline';

            // Always test Tesseract.js first
            if (typeof Tesseract !== 'undefined') {
                resultEl.innerHTML = '<span style="color: var(--success);">âœ… Tesseract.js loaded (offline ready)</span>';
            } else {
                resultEl.innerHTML = '<span style="color: var(--danger);">âŒ Tesseract.js not loaded</span>';
                return;
            }

            if (mode === 'offline') {
                return;
            }

            // Test online APIs
            let results = ['âœ… Tesseract.js (offline)'];

            // Test Together AI
            const togetherKey = document.getElementById('togetherApiKey')?.value;
            if (togetherKey) {
                try {
                    const resp = await fetch('https://api.together.xyz/v1/models', {
                        headers: { 'Authorization': `Bearer ${togetherKey}` }
                    });
                    if (resp.ok) {
                        results.push('âœ… Together AI');
                    } else {
                        results.push('âŒ Together AI (invalid key)');
                    }
                } catch (e) {
                    results.push('âŒ Together AI (connection failed)');
                }
            }

            // Test HunyuanOCR
            const hunyuanUrl = document.getElementById('hunyuanOcrUrl')?.value;
            if (hunyuanUrl) {
                try {
                    const resp = await fetch(`${hunyuanUrl}/health`, { method: 'GET' });
                    if (resp.ok) {
                        results.push('âœ… HunyuanOCR');
                    } else {
                        results.push('âš ï¸ HunyuanOCR (no health endpoint)');
                    }
                } catch (e) {
                    results.push('âŒ HunyuanOCR (not reachable)');
                }
            }

            // Test PaddleOCR
            const paddleUrl = document.getElementById('paddleOcrUrl')?.value;
            if (paddleUrl) {
                try {
                    const resp = await fetch(`${paddleUrl}/health`, { method: 'GET' });
                    if (resp.ok) {
                        results.push('âœ… PaddleOCR');
                    } else {
                        results.push('âš ï¸ PaddleOCR (no health endpoint)');
                    }
                } catch (e) {
                    results.push('âŒ PaddleOCR (not reachable)');
                }
            }

            resultEl.innerHTML = results.join('<br>');
        }

        // Get OCR config for API calls
        function getOCRConfig() {
            const saved = localStorage.getItem('aweh_ocr_config');
            if (saved) {
                return JSON.parse(saved);
            }
            return { mode: 'offline', togetherApiKey: '', hunyuanOcrUrl: '', paddleOcrUrl: '' };
        }

        // ==================== END OCR SETTINGS ====================

        // Save Settings
        async function saveSettings() {
            const email = document.getElementById('companyEmail').value.trim();
            if (email && !validateEmail(email)) {
                showToast('Please enter a valid company email address', 'error');
                return;
            }

            const phone = document.getElementById('companyPhone').value.trim();
            if (phone && !validatePhone(phone)) {
                showToast('Please enter a valid company phone number', 'error');
                return;
            }

            settings.companyName = document.getElementById('companyName').value.trim();
            settings.tradingAs = document.getElementById('tradingAs').value.trim();
            settings.email = email;
            settings.phone = phone;
            settings.website = document.getElementById('companyWebsite').value;
            settings.vat = document.getElementById('companyVAT').value;
            settings.address = document.getElementById('companyAddress').value;
            settings.bankName = document.getElementById('bankName').value;
            settings.accountHolder = document.getElementById('accountHolder').value;
            settings.accountNumber = document.getElementById('accountNumber').value;
            settings.branchCode = document.getElementById('branchCode').value;
            settings.showBanking = document.getElementById('showBanking').checked;
            settings.whatsappTemplate = document.getElementById('whatsappTemplate')?.value || settings.whatsappTemplate;
            settings.emailSubject = document.getElementById('emailSubject')?.value || settings.emailSubject;
            settings.emailTemplate = document.getElementById('emailTemplate')?.value || settings.emailTemplate;
            settings.aiProvider = document.getElementById('aiProvider')?.value || '';
            settings.aiApiKey = document.getElementById('aiApiKey')?.value || '';
            settings.aiModel = document.getElementById('aiModel')?.value || 'gpt-4';
            settings.enableAIFollowups = document.getElementById('enableAIFollowups')?.checked || false;
            settings.enableAIRecommendations = document.getElementById('enableAIRecommendations')?.checked || true;
            settings.enableAIInsights = document.getElementById('enableAIInsights')?.checked || false;
            settings.followupDaysOverdue = parseInt(document.getElementById('followupDaysOverdue')?.value || '3');
            settings.followupFrequency = parseInt(document.getElementById('followupFrequency')?.value || '7');
            settings.maxFollowupAttempts = parseInt(document.getElementById('maxFollowupAttempts')?.value || '3');
            settings.aiFollowupPrompt = document.getElementById('aiFollowupPrompt')?.value || settings.aiFollowupPrompt;

            // Payment Integration Settings
            settings.enableStripe = document.getElementById('enableStripe')?.checked || false;
            settings.stripePublishableKey = document.getElementById('stripePublishableKey')?.value || '';
            settings.stripeSecretKey = document.getElementById('stripeSecretKey')?.value || '';
            settings.enablePayPal = document.getElementById('enablePayPal')?.checked || false;
            settings.paypalClientId = document.getElementById('paypalClientId')?.value || '';
            settings.paypalEmail = document.getElementById('paypalEmail')?.value || '';
            settings.enableRecurring = document.getElementById('enableRecurring')?.checked || false;
            settings.recurringDay = parseInt(document.getElementById('recurringDay')?.value || '1');

            // Invoice Theme Settings
            settings.logoPosition = document.getElementById('logoPosition')?.value || 'top-left';
            settings.logoSize = document.getElementById('logoSize')?.value || 'medium';
            settings.invoiceLayout = document.getElementById('invoiceLayout')?.value || 'modern';
            settings.fontStyle = document.getElementById('fontStyle')?.value || 'sans-serif';
            settings.fontSize = document.getElementById('fontSize')?.value || 'medium';
            settings.showLogo = document.getElementById('showLogo')?.checked ?? true;
            settings.showCompanyDetails = document.getElementById('showCompanyDetails')?.checked ?? true;
            settings.showCustomerDetails = document.getElementById('showCustomerDetails')?.checked ?? true;
            settings.showItemImages = document.getElementById('showItemImages')?.checked ?? false;
            settings.showNotes = document.getElementById('showNotes')?.checked ?? true;
            settings.showPageNumbers = document.getElementById('showPageNumbers')?.checked ?? true;
            settings.invoiceHeaderColor = document.getElementById('invoiceHeaderColor')?.value || '#00d4ff';
            settings.invoiceTextColor = document.getElementById('invoiceTextColor')?.value || '#000000';
            settings.invoiceAccentColor = document.getElementById('invoiceAccentColor')?.value || '#ff006e';
            settings.invoiceFooter = document.getElementById('invoiceFooter')?.value || 'Thank you for your business!';

            // Profit Margin Settings
            settings.showProfitOnPrint = document.getElementById('showProfitOnPrint')?.checked ?? false;
            settings.showMarkupColumn = document.getElementById('showMarkupColumn')?.checked ?? false;
            settings.showProjectFeeStyle = document.getElementById('showProjectFeeStyle')?.checked ?? false;

            // Tier Cost Adjustments
            settings.tierCostMultipliers = {
                retail: parseFloat(document.getElementById('tierCostRetail')?.value || 1.0),
                platinum: parseFloat(document.getElementById('tierCostPlatinum')?.value || 0.95),
                gold: parseFloat(document.getElementById('tierCostGold')?.value || 0.90),
                silver: parseFloat(document.getElementById('tierCostSilver')?.value || 0.85),
                rental: parseFloat(document.getElementById('tierCostRental')?.value || 0.80),
                custom: parseFloat(document.getElementById('tierCostCustom')?.value || 1.0)
            };

            // Use business-specific storage key
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            await saveToStorage(storageKey, settings);
            
            // Also update the business object with logo and name
            if (currentBusiness) {
                currentBusiness.logo = settings.logo;
                currentBusiness.name = settings.companyName || currentBusiness.name;
                currentBusiness.tradingAs = settings.tradingAs || currentBusiness.tradingAs;
                await saveToStorage('aweh_businesses', businesses);
                updateCurrentBusinessDisplay();
                updateHeaderBusiness();
            }
            
            showToast('Settings saved successfully!', 'success');
        }

        function syncSettingsIdentityFromBusiness(settingsObj, businessObj) {
            if (!settingsObj || typeof settingsObj !== 'object') return settingsObj;
            if (!businessObj) return settingsObj;

            // Treat the Business Entity record as the source of truth for identity fields.
            settingsObj.companyName = businessObj.name || settingsObj.companyName || '';
            settingsObj.tradingAs = businessObj.tradingAs || settingsObj.tradingAs || '';
            settingsObj.email = businessObj.email || settingsObj.email || '';
            settingsObj.phone = businessObj.phone || settingsObj.phone || '';
            settingsObj.address = businessObj.address || settingsObj.address || '';
            settingsObj.vat = businessObj.vatNumber || settingsObj.vat || '';
            settingsObj.logo = businessObj.logo || settingsObj.logo || '';
            return settingsObj;
        }

        // Helper function to get settings for current business
        async function getSettings() {
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            return await loadFromStorage(storageKey, {});
        }

        // Apply Invoice Template
        function applyTemplate(templateName) {
            const templates = {
                'modern-blue': {
                    name: 'Modern Blue',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'modern',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#00d4ff',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#0099cc',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'classic-black': {
                    name: 'Classic Black',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'classic',
                    fontStyle: 'serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#000000',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#333333',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'bold-red': {
                    name: 'Bold Red',
                    logoPosition: 'top-center',
                    logoSize: 'large',
                    invoiceLayout: 'bold',
                    fontStyle: 'sans-serif',
                    fontSize: 'large',
                    invoiceHeaderColor: '#ff006e',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#cc0055',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'elegant-purple': {
                    name: 'Elegant Purple',
                    logoPosition: 'top-center',
                    logoSize: 'medium',
                    invoiceLayout: 'elegant',
                    fontStyle: 'serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#7209b7',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#560bad',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'ocean-teal': {
                    name: 'Ocean Teal',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'modern',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#06ffa5',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#00b377',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'sunset-orange': {
                    name: 'Sunset Orange',
                    logoPosition: 'top-right',
                    logoSize: 'large',
                    invoiceLayout: 'bold',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#ff9500',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#ff6b00',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                }
            };

            const template = templates[templateName];
            if (!template) return;

            // Apply template settings to form
            document.getElementById('logoPosition').value = template.logoPosition;
            document.getElementById('logoSize').value = template.logoSize;
            document.getElementById('invoiceLayout').value = template.invoiceLayout;
            document.getElementById('fontStyle').value = template.fontStyle;
            document.getElementById('fontSize').value = template.fontSize;
            document.getElementById('invoiceHeaderColor').value = template.invoiceHeaderColor;
            document.getElementById('invoiceTextColor').value = template.invoiceTextColor;
            document.getElementById('invoiceAccentColor').value = template.invoiceAccentColor;
            document.getElementById('showLogo').checked = template.showLogo;
            document.getElementById('showCompanyDetails').checked = template.showCompanyDetails;
            document.getElementById('showCustomerDetails').checked = template.showCustomerDetails;
            document.getElementById('showNotes').checked = template.showNotes;
            document.getElementById('showPageNumbers').checked = template.showPageNumbers;

            // Save settings
            saveSettings();

            showToast(`âœ¨ ${template.name} template applied!`, 'success');
        }

        // Preview Invoice Theme
        function previewInvoiceTheme() {
            // Save current settings first
            saveSettings();

            showToast('Opening preview... Create a test invoice to see the theme in action!', 'info');

            // Switch to invoices tab and suggest creating a test invoice
            setTimeout(() => {
                switchTab('invoices');
                showToast('ðŸ’¡ Tip: Create a test invoice and click Print to see your theme!', 'info');
            }, 1500);
        }

        // Load Settings
        async function loadSettings() {
            // Use business-specific storage key
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            const saved = await loadFromStorage(storageKey, null);
            if (saved) {
                settings = saved;

                // Ensure Settings always reflects the selected Business Entity identity.
                syncSettingsIdentityFromBusiness(settings, currentBusiness);

                // DIGG default: show a clear Project Fees statement in Notes/Terms.
                if (isDiggBusiness(currentBusiness)) {
                    const footer = String(settings.invoiceFooter || '').trim();
                    const looksDefault = !footer || footer.toLowerCase().includes('thank you for your business');
                    if (looksDefault) {
                        settings.invoiceFooter =
                            'Project Fees Statement (excl. VAT): Total Project Management Fee: R 180,000.<br>' +
                            'Payment Schedule (30 day payment window):<br>' +
                            'â€¢ 30% upon submission date (R 30,000)<br>' +
                            'â€¢ 30% upon approval of building plans (R 30,000)<br>' +
                            'â€¢ 30% upon issuing occupation certificate (R 30,000)<br>' +
                            'â€¢ Design development + project management invoiced over 3 months (R 30,000/month)<br>' +
                            'Council fees are billed separately as a variable disbursement.';
                    }
                }

                document.getElementById('companyName').value = settings.companyName || '';
                document.getElementById('tradingAs').value = settings.tradingAs || '';
                document.getElementById('companyEmail').value = settings.email || '';
                document.getElementById('companyPhone').value = settings.phone || '';
                document.getElementById('companyWebsite').value = settings.website || '';
                document.getElementById('companyVAT').value = settings.vat || '';
                document.getElementById('companyAddress').value = settings.address || '';
                document.getElementById('bankName').value = settings.bankName || '';
                document.getElementById('accountHolder').value = settings.accountHolder || '';
                document.getElementById('accountNumber').value = settings.accountNumber || '';
                document.getElementById('branchCode').value = settings.branchCode || '';
                document.getElementById('showBanking').checked = settings.showBanking !== false;
                if (document.getElementById('whatsappTemplate')) {
                    document.getElementById('whatsappTemplate').value = settings.whatsappTemplate || '';
                }
                if (document.getElementById('aiProvider')) {
                    document.getElementById('aiProvider').value = settings.aiProvider || '';
                }
                if (document.getElementById('aiApiKey')) {
                    document.getElementById('aiApiKey').value = settings.aiApiKey || '';
                }
                // Call toggle AFTER setting values so sections display correctly
                toggleAIKeySection();
                if (document.getElementById('aiModel')) {
                    document.getElementById('aiModel').value = settings.aiModel || 'claude-3-5-sonnet-20241022';
                }
                if (document.getElementById('enableAIFollowups')) {
                    document.getElementById('enableAIFollowups').checked = settings.enableAIFollowups || false;
                }
                if (document.getElementById('enableAIRecommendations')) {
                    document.getElementById('enableAIRecommendations').checked = settings.enableAIRecommendations !== false;
                }
                if (document.getElementById('enableAIInsights')) {
                    document.getElementById('enableAIInsights').checked = settings.enableAIInsights || false;
                }
                if (document.getElementById('followupDaysOverdue')) {
                    document.getElementById('followupDaysOverdue').value = settings.followupDaysOverdue || 3;
                }
                if (document.getElementById('followupFrequency')) {
                    document.getElementById('followupFrequency').value = settings.followupFrequency || 7;
                }
                if (document.getElementById('maxFollowupAttempts')) {
                    document.getElementById('maxFollowupAttempts').value = settings.maxFollowupAttempts || 3;
                }
                if (document.getElementById('followupDaysOverdue')) {
                    document.getElementById('followupDaysOverdue').value = settings.followupDaysOverdue || 3;
                }
                if (document.getElementById('followupFrequency')) {
                    document.getElementById('followupFrequency').value = settings.followupFrequency || 7;
                }
                if (document.getElementById('aiFollowupPrompt')) {
                    document.getElementById('aiFollowupPrompt').value = settings.aiFollowupPrompt || '';
                }

                // Load Payment Integration Settings
                if (document.getElementById('enableStripe')) {
                    document.getElementById('enableStripe').checked = settings.enableStripe || false;
                    document.getElementById('stripePublishableKey').value = settings.stripePublishableKey || '';
                    document.getElementById('stripeSecretKey').value = settings.stripeSecretKey || '';
                }
                if (document.getElementById('enablePayPal')) {
                    document.getElementById('enablePayPal').checked = settings.enablePayPal || false;
                    document.getElementById('paypalClientId').value = settings.paypalClientId || '';
                    document.getElementById('paypalEmail').value = settings.paypalEmail || '';
                }
                if (document.getElementById('enableRecurring')) {
                    document.getElementById('enableRecurring').checked = settings.enableRecurring || false;
                    document.getElementById('recurringDay').value = settings.recurringDay || 1;
                }

                document.getElementById('primaryColor').value = settings.primaryColor || '#00d4ff';
                document.getElementById('secondaryColor').value = settings.secondaryColor || '#ff006e';
                document.getElementById('accentColor').value = settings.accentColor || '#7209b7';

                // Load Invoice Theme Settings
                if (document.getElementById('logoPosition')) {
                    document.getElementById('logoPosition').value = settings.logoPosition || 'top-left';
                    document.getElementById('logoSize').value = settings.logoSize || 'medium';
                    document.getElementById('invoiceLayout').value = settings.invoiceLayout || 'modern';
                    document.getElementById('fontStyle').value = settings.fontStyle || 'sans-serif';
                    document.getElementById('fontSize').value = settings.fontSize || 'medium';
                    document.getElementById('showLogo').checked = settings.showLogo !== false;
                    document.getElementById('showCompanyDetails').checked = settings.showCompanyDetails !== false;
                    document.getElementById('showCustomerDetails').checked = settings.showCustomerDetails !== false;
                    document.getElementById('showItemImages').checked = settings.showItemImages || false;
                    document.getElementById('showNotes').checked = settings.showNotes !== false;
                    document.getElementById('showPageNumbers').checked = settings.showPageNumbers !== false;
                    document.getElementById('invoiceHeaderColor').value = settings.invoiceHeaderColor || '#00d4ff';
                    document.getElementById('invoiceTextColor').value = settings.invoiceTextColor || '#000000';
                    document.getElementById('invoiceAccentColor').value = settings.invoiceAccentColor || '#ff006e';
                    document.getElementById('invoiceFooter').value = settings.invoiceFooter || 'Thank you for your business!';
                }

                // Load Profit Margin Settings
                if (document.getElementById('showProfitOnPrint')) {
                    document.getElementById('showProfitOnPrint').checked = settings.showProfitOnPrint || false;
                }
                if (document.getElementById('showMarkupColumn')) {
                    document.getElementById('showMarkupColumn').checked = settings.showMarkupColumn || false;
                }
                if (document.getElementById('showProjectFeeStyle')) {
                    document.getElementById('showProjectFeeStyle').checked = settings.showProjectFeeStyle || false;
                }

                // Load Tier Cost Adjustments
                const tierCostMultipliers = settings.tierCostMultipliers || {
                    retail: 1.0,
                    platinum: 0.95,
                    gold: 0.90,
                    silver: 0.85,
                    rental: 0.80,
                    custom: 1.0
                };

                if (document.getElementById('tierCostRetail')) {
                    document.getElementById('tierCostRetail').value = tierCostMultipliers.retail;
                    document.getElementById('tierCostPlatinum').value = tierCostMultipliers.platinum;
                    document.getElementById('tierCostGold').value = tierCostMultipliers.gold;
                    document.getElementById('tierCostSilver').value = tierCostMultipliers.silver;
                    document.getElementById('tierCostRental').value = tierCostMultipliers.rental;
                    document.getElementById('tierCostCustom').value = tierCostMultipliers.custom;

                    // Update displays
                    updateTierCostDisplay('retail', tierCostMultipliers.retail);
                    updateTierCostDisplay('platinum', tierCostMultipliers.platinum);
                    updateTierCostDisplay('gold', tierCostMultipliers.gold);
                    updateTierCostDisplay('silver', tierCostMultipliers.silver);
                    updateTierCostDisplay('rental', tierCostMultipliers.rental);
                    updateTierCostDisplay('custom', tierCostMultipliers.custom);
                }

                // Load logo - check settings first, then fallback to business object
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    // Priority: settings.logo > currentBusiness.logo
                    const logoToUse = settings.logo || currentBusiness?.logo || '';
                    if (logoToUse) {
                        logoPreview.src = logoToUse;
                        logoPreview.classList.add('active');
                        // Sync settings.logo with the loaded logo if not already set
                        if (!settings.logo && currentBusiness?.logo) {
                            settings.logo = currentBusiness.logo;
                            console.log('[Logo] Synced from business object to settings');
                        }
                    } else {
                        logoPreview.classList.remove('active');
                        logoPreview.src = '';
                    }
                }

                updateColors();

                // Reflect logo/name changes in the multi-business header
                if (typeof updateCurrentBusinessDisplay === 'function') {
                    updateCurrentBusinessDisplay();
                }

                // If the saved settings had the wrong identity (copied from another entity),
                // persist the corrected identity back to this business' settings key.
                try {
                    const needsPersist = Boolean(
                        currentBusiness &&
                        (saved.companyName !== settings.companyName ||
                         saved.tradingAs !== settings.tradingAs ||
                         saved.email !== settings.email ||
                         saved.phone !== settings.phone ||
                         saved.address !== settings.address ||
                         saved.vat !== settings.vat ||
                         saved.logo !== settings.logo)
                    );
                    if (needsPersist) {
                        await saveToStorage(storageKey, settings);
                    }
                } catch (e) {
                    console.warn('Failed to persist corrected settings identity:', e);
                }
            } else {
                // No saved settings - populate form with current business details
                settings = {};
                
                if (currentBusiness) {
                    document.getElementById('companyName').value = currentBusiness.name || '';
                    document.getElementById('tradingAs').value = currentBusiness.tradingAs || '';
                    document.getElementById('companyEmail').value = currentBusiness.email || '';
                    document.getElementById('companyPhone').value = currentBusiness.phone || '';
                    document.getElementById('companyAddress').value = currentBusiness.address || '';
                    document.getElementById('companyVAT').value = currentBusiness.vatNumber || '';
                    
                    // Set logo if business has one
                    if (currentBusiness.logo) {
                        document.getElementById('logoPreview').src = currentBusiness.logo;
                        document.getElementById('logoPreview').classList.add('active');
                    } else {
                        document.getElementById('logoPreview').src = '';
                        document.getElementById('logoPreview').classList.remove('active');
                    }
                } else {
                    // Clear all fields if no business
                    document.getElementById('companyName').value = '';
                    document.getElementById('tradingAs').value = '';
                    document.getElementById('companyEmail').value = '';
                    document.getElementById('companyPhone').value = '';
                    document.getElementById('companyAddress').value = '';
                    document.getElementById('companyVAT').value = '';
                    document.getElementById('logoPreview').src = '';
                    document.getElementById('logoPreview').classList.remove('active');
                }
                
                // Clear other fields that don't come from business
                document.getElementById('companyWebsite').value = '';
                document.getElementById('bankName').value = '';
                document.getElementById('accountHolder').value = '';
                document.getElementById('accountNumber').value = '';
                document.getElementById('branchCode').value = '';
                document.getElementById('showBanking').checked = true;

                // Ensure Notes/Terms fields do not carry over from another business
                if (document.getElementById('showNotes')) {
                    document.getElementById('showNotes').checked = true;
                }
                if (document.getElementById('invoiceFooter')) {
                    const defaultFooter = isDiggBusiness(currentBusiness)
                        ? 'Project Fees Statement (excl. VAT): Total Project Management Fee: R 180,000. Payment schedule is milestone-based (30 day terms). Council fees billed separately.'
                        : 'Thank you for your business!';
                    document.getElementById('invoiceFooter').value = defaultFooter;
                    settings.invoiceFooter = defaultFooter;
                }
                settings.showNotes = true;
                
                // Set default colors
                document.getElementById('primaryColor').value = '#00d4ff';
                document.getElementById('secondaryColor').value = '#ff006e';
                document.getElementById('accentColor').value = '#7209b7';
                
                updateColors();
            }
        }

        // Save Customer (handles both create and edit)
        // Extra contacts management
        let extraContactsCount = 0;

        function addExtraContactField() {
            extraContactsCount++;
            const container = document.getElementById('extraContactsContainer');
            const contactDiv = document.createElement('div');
            contactDiv.className = 'form-row';
            contactDiv.id = `extraContact_${extraContactsCount}`;
            contactDiv.innerHTML = `
                <div class="form-group">
                    <input type="text" class="form-control extra-contact-name" placeholder="Contact Name" data-id="${extraContactsCount}">
                </div>
                <div class="form-group">
                    <input type="email" class="form-control extra-contact-email" placeholder="Email" data-id="${extraContactsCount}">
                </div>
                <div class="form-group">
                    <input type="tel" class="form-control extra-contact-phone" placeholder="Phone" data-id="${extraContactsCount}">
                </div>
                <button type="button" class="btn btn-outline btn-sm" onclick="removeExtraContact(${extraContactsCount})" style="height: fit-content;">âŒ</button>
            `;
            container.appendChild(contactDiv);
        }

        function removeExtraContact(id) {
            const element = document.getElementById(`extraContact_${id}`);
            if (element) {
                element.remove();
            }
        }

        function getExtraContacts() {
            const contacts = [];
            document.querySelectorAll('.extra-contact-name').forEach(input => {
                const id = input.dataset.id;
                const name = input.value.trim();
                const email = document.querySelector(`.extra-contact-email[data-id="${id}"]`)?.value.trim();
                const phone = document.querySelector(`.extra-contact-phone[data-id="${id}"]`)?.value.trim();
                if (name || email || phone) {
                    contacts.push({ name, email, phone });
                }
            });
            return contacts;
        }

        function loadExtraContacts(contacts) {
            const container = document.getElementById('extraContactsContainer');
            container.innerHTML = '';
            extraContactsCount = 0;
            if (contacts && contacts.length > 0) {
                contacts.forEach(contact => {
                    addExtraContactField();
                    const id = extraContactsCount;
                    document.querySelector(`.extra-contact-name[data-id="${id}"]`).value = contact.name || '';
                    document.querySelector(`.extra-contact-email[data-id="${id}"]`).value = contact.email || '';
                    document.querySelector(`.extra-contact-phone[data-id="${id}"]`).value = contact.phone || '';
                });
            }
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            if (!validateRequired(name, 'Customer name')) {
                return;
            }

            const email = document.getElementById('customerEmail').value.trim();
            if (email && !validateEmail(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            const phone = document.getElementById('customerPhone').value.trim();
            if (phone && !validatePhone(phone)) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const customerData = {
                name: name,
                company: document.getElementById('customerCompany').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                vat: document.getElementById('customerVAT').value,
                tier: document.getElementById('customerTier').value,
                extraContacts: getExtraContacts()
            };
            
            const editId = document.getElementById('customerModal').dataset.editId;
            
            if (editId) {
                // Editing existing customer
                const index = customers.findIndex(c => c.id == editId);
                if (index !== -1) {
                    customers[index] = {
                        ...customers[index],
                        ...customerData
                    };
                    showToast('Customer updated successfully!', 'success');
                }
                delete document.getElementById('customerModal').dataset.editId;
            } else {
                // Creating new customer
                const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
                const customer = {
                    id: Date.now(),
                    ...customerData,
                    createdBy: currentUser ? (currentUser.username || currentUser.email) : 'unknown',
                    owner: currentUser ? (currentUser.username || currentUser.email) : 'unknown'
                };
                customers.push(customer);
                showToast('Customer added successfully!', 'success');
            }
            
            if (!await saveToStorage(getBusinessKey('aweh_customers'), customers)) {
                return; // Stop if save failed
            }
            
            closeModal('customerModal');
            loadCustomers();
            loadCustomersIntoSelect(); // Refresh dropdown in invoice modal
            
            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerVAT').value = '';
        }

        // Load Customers
        function loadCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            if (!tbody) return; // Exit if element doesn't exist
            
            tbody.innerHTML = (customers || []).map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.email}</td>
                    <td>${c.phone}</td>
                    <td><span style="padding: 0.25rem 0.75rem; background: rgba(0, 212, 255, 0.2); border-radius: 20px; font-size: 0.85rem;">${c.tier}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm btn-icon" onclick="editCustomer(${c.id})">âœï¸</button>
                        <button class="btn btn-danger btn-sm btn-icon" onclick="deleteCustomer(${c.id})">ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        // Open Add Customer Modal
        function openAddCustomerModal() {
            openModal('customerModal');
            document.getElementById('customerModalTitle').textContent = 'Add New Customer';
            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerVAT').value = '';
            document.getElementById('customerTier').value = 'retail';
            loadExtraContacts([]);
            // Clear edit ID
            delete document.getElementById('customerModal').dataset.editId;
        }

        function openEditCustomerModal(customerId) {
            const customer = customers.find(c => c.id == customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            
            openModal('customerModal');
            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('customerName').value = customer.name || '';
            document.getElementById('customerCompany').value = customer.company || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerVAT').value = customer.vat || '';
            document.getElementById('customerTier').value = customer.tier || 'retail';
            loadExtraContacts(customer.extraContacts || []);
            // Set edit ID
            document.getElementById('customerModal').dataset.editId = customerId;
        }

        // Export Data
        function exportData() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                settings: settings,
                invoices: invoices,
                customers: customers
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aweh-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showToast('Data exported successfully!', 'success');
        }
        
        // Import Data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Validate backup file structure
                        if (!data.version) {
                            throw new Error('Invalid backup file - missing version number');
                        }

                        if (data.invoices && !Array.isArray(data.invoices)) {
                            throw new Error('Invalid backup file - invoices data is corrupted');
                        }

                        if (data.customers && !Array.isArray(data.customers)) {
                            throw new Error('Invalid backup file - customers data is corrupted');
                        }

                        if (data.settings && typeof data.settings !== 'object') {
                            throw new Error('Invalid backup file - settings data is corrupted');
                        }

                        if (confirm('âš ï¸ IMPORT DATA\n\nThis will replace all current data!\n\nAre you sure you want to continue?')) {
                            // Create automatic backup before import
                            const backupData = {
                                version: '1.0',
                                backupDate: new Date().toISOString(),
                                settings: settings,
                                invoices: invoices,
                                customers: customers
                            };
                            safeSetItem('aweh_last_backup', JSON.stringify(backupData));
                            
                            if (data.settings) {
                                settings = data.settings;
                                await saveToStorage(getBusinessKey('aweh_settings'), settings);
                            }
                            if (data.invoices) {
                                invoices = data.invoices;
                                await saveToStorage(getBusinessKey('aweh_invoices'), invoices);
                            }
                            if (data.customers) {
                                customers = data.customers;
                                await saveToStorage(getBusinessKey('aweh_customers'), customers);
                            }
                            
                            showToast('Data imported successfully! Reloading...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        }
                    } catch (err) {
                        showToast('Error importing data: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Open Settings Modal
        function openSettingsModal() {
            switchTab('settings');
        }

        function buildInvoiceDocumentHtml(invoice, customer, options = {}) {
            const {
                autoPrint = false,
                titlePrefix = ''
            } = options;

            // Use business-specific settings for the invoice being rendered.
            // This prevents the preview/print from showing another entity's theme/banking/website.
            // Note: We use 'invoiceSettings' to avoid shadowing the global 'settings' variable.
            let invoiceSettings = (typeof settings === 'object' && settings) ? {...settings} : {};
            try {
                const invoiceBusinessId = invoice?.businessId || currentBusiness?.id || localStorage.getItem('aweh_currentBusiness') || 'default';
                const stored = safeGetItem(`aweh_settings_${invoiceBusinessId}`, null);
                if (stored && typeof stored === 'object') {
                    invoiceSettings = { ...invoiceSettings, ...stored };
                }
                // Also ensure identity fields match the business entity.
                const invoiceBusiness = businesses?.find(b => b.id === invoiceBusinessId) || null;
                if (invoiceBusiness) {
                    invoiceSettings.companyName = invoiceBusiness.name || invoiceSettings.companyName || '';
                    invoiceSettings.tradingAs = invoiceBusiness.tradingAs || invoiceSettings.tradingAs || '';
                    invoiceSettings.email = invoiceBusiness.email || invoiceSettings.email || '';
                    invoiceSettings.phone = invoiceBusiness.phone || invoiceSettings.phone || '';
                    invoiceSettings.address = invoiceBusiness.address || invoiceSettings.address || '';
                    invoiceSettings.vat = invoiceBusiness.vatNumber || invoiceSettings.vat || '';
                    invoiceSettings.logo = invoiceBusiness.logo || invoiceSettings.logo || '';
                }
            } catch (e) {
                // Keep global settings fallback
            }
            
            // Use invoice's business details if available, otherwise fall back to invoiceSettings
            const businessDetails = invoice?.businessDetails || {};
            const business = invoice?.businessId ? businesses.find(b => b.id === invoice.businessId) : null;
            
            // Get company info from invoice's business, or fall back to invoiceSettings
            const companyLogo = businessDetails.logo || business?.logo || invoiceSettings.logo;
            const companyName = invoice?.businessName || business?.name || invoiceSettings.companyName;
            const companyTradingAs = businessDetails.tradingAs || business?.tradingAs || invoiceSettings.tradingAs;
            const companyAddress = businessDetails.address || business?.address || invoiceSettings.address;
            const companyPhone = businessDetails.phone || business?.phone || invoiceSettings.phone;
            const companyEmail = businessDetails.email || business?.email || invoiceSettings.email;
            const companyVat = businessDetails.vatNumber || business?.vatNumber || invoiceSettings.vat;

            const invoiceNumber = invoice?.number || 'DRAFT';
            const invoiceTypeRaw = (invoice?.type || 'invoice');
            const invoiceType = String(invoiceTypeRaw).toUpperCase().replace('_', ' ');
            const date = invoice?.date || new Date().toISOString().split('T')[0];
            const dueDate = invoice?.dueDate || '';
            const paymentTerms = (invoice?.paymentTerms ?? '') !== '' ? String(invoice.paymentTerms) : '';
            const invoiceStatus = invoice?.status ? String(invoice.status).toUpperCase() : '';

            const items = Array.isArray(invoice?.items) ? invoice.items : [];
            const subtotal = Number(invoice?.subtotal ?? 0);
            const vat = Number(invoice?.vat ?? 0);
            const total = Number(invoice?.total ?? 0);
            const amountPaid = Number(invoice?.amountPaid ?? 0);
            const balanceDue = Math.max(0, total - amountPaid);

            const showBankingBlock = Boolean(
                settings?.showBanking &&
                (invoiceSettings.bankName || invoiceSettings.accountHolder || invoiceSettings.accountNumber || invoiceSettings.branchCode)
            );

            const paymentReference = invoiceNumber;

            let printHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${titlePrefix ? titlePrefix + ' ' : ''}${invoiceType} #${invoiceNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @page { margin: 14mm; }
        body {
            font-family: ${invoiceSettings.fontStyle === 'serif' ? 'Georgia, serif' : invoiceSettings.fontStyle === 'monospace' ? 'Courier New, monospace' : 'Arial, sans-serif'};
            padding: 0;
            color: ${invoiceSettings.invoiceTextColor || '#333'};
            background: white;
            font-size: ${invoiceSettings.fontSize === 'small' ? '10pt' : invoiceSettings.fontSize === 'large' ? '14pt' : '12pt'};
        }
        .page {
            padding: 6mm 2mm;
        }
        .invoice-header {
            display: flex;
            justify-content: ${invoiceSettings.logoPosition === 'top-center' ? 'center' : 'space-between'};
            align-items: ${invoiceSettings.logoPosition === 'top-center' ? 'center' : 'flex-start'};
            flex-direction: ${invoiceSettings.logoPosition === 'top-center' ? 'column' : 'row'};
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 6px solid ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
        }
        .company-info {
            flex: 1;
            ${invoiceSettings.logoPosition === 'top-right' ? 'order: 2; text-align: right;' : ''}
            ${invoiceSettings.logoPosition === 'top-center' ? 'text-align: center;' : ''}
        }
        .company-logo {
            max-width: ${invoiceSettings.logoSize === 'small' ? '100px' : invoiceSettings.logoSize === 'large' ? '200px' : '150px'};
            max-height: ${invoiceSettings.logoSize === 'small' ? '60px' : invoiceSettings.logoSize === 'large' ? '120px' : '80px'};
            margin-bottom: 10px;
            ${!invoiceSettings.showLogo ? 'display: none;' : ''}
        }
        .company-name {
            font-size: ${invoiceSettings.invoiceLayout === 'bold' ? '28px' : '24px'};
            font-weight: bold;
            color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            margin-bottom: 5px;
        }
        .company-details {
            font-size: ${invoiceSettings.fontSize === 'small' ? '10px' : invoiceSettings.fontSize === 'large' ? '14px' : '12px'};
            line-height: 1.6;
            color: #666;
            ${!invoiceSettings.showCompanyDetails ? 'display: none;' : ''}
        }
        .invoice-info {
            text-align: ${invoiceSettings.logoPosition === 'top-right' ? 'left' : invoiceSettings.logoPosition === 'top-center' ? 'center' : 'right'};
            ${invoiceSettings.logoPosition === 'top-right' ? 'order: 1;' : ''}
            ${invoiceSettings.logoPosition === 'top-center' ? 'margin-top: 20px;' : ''}
        }
        .invoice-title {
            font-size: 36px;
            font-weight: bold;
            color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        .invoice-details {
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
            line-height: 1.8;
        }
        .customer-section {
            margin: 30px 0;
            padding: 18px;
            background: #f7f7f7;
            border-left: 6px solid ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            ${!invoiceSettings.showCustomerDetails ? 'display: none;' : ''}
        }
        .section-title {
            font-size: ${invoiceSettings.fontSize === 'small' ? '12px' : invoiceSettings.fontSize === 'large' ? '16px' : '14px'};
            font-weight: bold;
            color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .customer-details {
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
            line-height: 1.6;
        }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        th {
            background: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
            text-transform: uppercase;
        }
        td {
            padding: 12px 12px;
            border-bottom: 1px solid #eee;
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
        }
        tr:hover { background: #f9f9f9; }
        .text-right { text-align: right; }
        .totals-wrap { display: flex; justify-content: flex-end; margin-top: 20px; }
        .totals-section { width: 400px; }
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            font-size: ${invoiceSettings.fontSize === 'small' ? '12px' : invoiceSettings.fontSize === 'large' ? '16px' : '14px'};
        }
        .totals-row.subtotal { background: #f9f9f9; }
        .totals-row.total {
            background: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor};
            color: white;
            font-weight: bold;
            font-size: ${invoiceSettings.fontSize === 'small' ? '16px' : invoiceSettings.fontSize === 'large' ? '20px' : '18px'};
            margin-top: 5px;
        }
        .banking-section {
            clear: both;
            margin-top: 50px;
            padding: 20px;
            background: #f9f9f9;
            border-left: 6px solid ${invoiceSettings.invoiceAccentColor || invoiceSettings.secondaryColor};
        }
        .banking-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
        }
        .payment-instructions {
            margin-top: 18px;
            padding: 16px;
            background: #f4f4f4;
            border: 2px solid #e9e9e9;
            border-left: 6px solid ${invoiceSettings.invoiceAccentColor || invoiceSettings.secondaryColor};
        }
        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: ${invoiceSettings.fontSize === 'small' ? '11px' : invoiceSettings.fontSize === 'large' ? '15px' : '13px'};
            line-height: 1.6;
        }
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            text-align: center;
            font-size: ${invoiceSettings.fontSize === 'small' ? '10px' : invoiceSettings.fontSize === 'large' ? '14px' : '12px'};
            color: #999;
            ${!invoiceSettings.showNotes ? 'display: none;' : ''}
        }
        @media print {
            body { padding: 0; }
            .no-print { display: none; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            tr, td, th { page-break-inside: avoid; }
            .totals-wrap, .totals-section, .customer-section, .banking-section { break-inside: avoid; }
            .payment-instructions { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="page">
    <div class="invoice-header">
        <div class="company-info">
            ${companyLogo ? `<img src="${companyLogo}" class="company-logo" alt="Company Logo">` : ''}
            <div class="company-name">${companyName}</div>
            ${companyTradingAs ? `<div style="font-size: 14px; color: #666; margin-bottom: 10px;">Trading as: ${companyTradingAs}</div>` : ''}
            <div class="company-details">
                ${companyAddress ? companyAddress.replace(/\n/g, '<br>') + '<br>' : ''}
                ${companyPhone ? 'Tel: ' + companyPhone + '<br>' : ''}
                ${companyEmail ? 'Email: ' + companyEmail + '<br>' : ''}
                ${invoiceSettings.website ? 'Web: ' + invoiceSettings.website + '<br>' : ''}
                ${companyVat ? 'VAT#: ' + companyVat : ''}
            </div>
        </div>
        <div class="invoice-info">
            <div class="invoice-title">${invoiceType}</div>
            <div class="invoice-details">
                <strong>Number:</strong> ${invoiceNumber}<br>
                <strong>Date:</strong> ${date}<br>
                ${dueDate ? `<strong>Due Date:</strong> ${dueDate}<br>` : ''}
                ${paymentTerms ? `<strong>Payment Terms:</strong> ${paymentTerms} days<br>` : ''}
                ${invoice?.tier ? `<strong>Pricing Tier:</strong> ${String(invoice.tier).toUpperCase()}<br>` : ''}
                ${invoice?.vatOption ? `<strong>VAT:</strong> ${invoice.vatOption === 'include' ? 'Inclusive' : invoice.vatOption === 'exclude' ? 'Exclusive' : 'None'}` : ''}
                ${(invoiceStatus && (invoiceStatus === 'DRAFT' || invoiceStatus === 'OVERDUE')) ? `<br><strong style="color: ${invoiceStatus === 'OVERDUE' ? '#f72585' : '#999'};">Status:</strong> <strong style="color: ${invoiceStatus === 'OVERDUE' ? '#f72585' : '#999'};">${String(invoiceStatus).toUpperCase()}</strong>` : ''}
            </div>
        </div>
    </div>

    <div class="customer-section">
        <div class="section-title">Bill To</div>
        <div class="customer-details">
            <strong>${customer?.name || invoice?.customer || ''}</strong><br>
            ${customer?.company ? customer.company + '<br>' : ''}
            ${customer?.address ? customer.address.replace(/\n/g, '<br>') + '<br>' : ''}
            ${customer?.email ? 'Email: ' + customer.email + '<br>' : ''}
            ${customer?.phone ? 'Tel: ' + customer.phone + '<br>' : ''}
            ${customer?.vat ? 'VAT#: ' + customer.vat : ''}
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: ${invoiceSettings.showMarkupColumn ? '35%' : '40%'};">Product</th>
                <th style="width: ${invoiceSettings.showMarkupColumn ? '12%' : '15%'};">SKU</th>
                <th style="width: ${invoiceSettings.showMarkupColumn ? '8%' : '10%'};" class="text-right">Qty</th>
                <th style="width: 15%;" class="text-right">Unit Price</th>
                ${invoiceSettings.showMarkupColumn ? '<th style="width: 10%;" class="text-right">Markup</th>' : ''}
                <th style="width: 20%;" class="text-right">Total</th>
            </tr>
        </thead>
        <tbody>
            ${items.map(item => {
                const markupPct = item.markupPercent || 0;
                return `
                <tr>
                    <td>${item.product || item.name || ''}</td>
                    <td>${item.sku || ''}</td>
                    <td class="text-right">${Number(item.qty ?? item.quantity ?? 0)}</td>
                    <td class="text-right">R ${formatNumber(Math.round(Number(item.unitPrice ?? item.price ?? 0)))}</td>
                    ${invoiceSettings.showMarkupColumn ? `<td class="text-right" style="color: ${markupPct > 0 ? '#28a745' : '#666'};">${markupPct > 0 ? '+' + markupPct.toFixed(0) + '%' : '-'}</td>` : ''}
                    <td class="text-right">R ${formatNumber(Math.round(Number(item.total ?? (Number(item.unitPrice ?? item.price ?? 0) * Number(item.qty ?? item.quantity ?? 0)))))}</td>
                </tr>
            `;
            }).join('')}
        </tbody>
    </table>

    <div class="totals-wrap"><div class="totals-section">
        <div class="totals-row subtotal">
            <span>Subtotal:</span>
            <span>R ${formatNumber(Math.round(subtotal))}</span>
        </div>
        ${invoice?.discount?.amount > 0 ? `
        <div class="totals-row">
            <span>Discount (${invoice.discount.amount}${invoice.discount.type === 'percentage' ? '%' : ''}):</span>
            <span>- R ${formatNumber(Math.round(invoice.discount.type === 'percentage' ? subtotal * (parseFloat(invoice.discount.amount) / 100) : parseFloat(invoice.discount.amount)))}</span>
        </div>
        ` : ''}
        ${Number(invoice?.shipping ?? 0) > 0 ? `
        <div class="totals-row">
            <span>Shipping:</span>
            <span>R ${formatNumber(Math.round(Number(invoice.shipping)))}</span>
        </div>
        ` : ''}
        ${invoice?.vatOption === 'include' ? `
        <div class="totals-row">
            <span>VAT (15%):</span>
            <span>R ${formatNumber(Math.round(vat))}</span>
        </div>
        ` : ''}
        <div class="totals-row total">
            <span>${invoiceSettings.showProjectFeeStyle ? 'PROJECT FEE TOTAL' : 'TOTAL'}:</span>
            <span>R ${formatNumber(Math.round(total))}</span>
        </div>
        ${!invoiceSettings.showProjectFeeStyle ? `
        ${amountPaid > 0 ? `
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;"></div>
        <div class="totals-row" style="font-size: 0.95em;">
            <span>Deposit${invoice?.deposit?.type === 'percentage' ? ` (${invoice.deposit.amount}%)` : ''}:</span>
            <span style="color: #28a745;">- R ${formatNumber(Math.round(amountPaid))}</span>
        </div>
        <div class="totals-row total" style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 5px;">
            <span style="font-weight: bold; color: #dc3545;">BALANCE DUE:</span>
            <span style="font-weight: bold; color: #dc3545;">R ${formatNumber(Math.round(balanceDue))}</span>
        </div>
        ` : `
        <div class="totals-row total" style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 5px;">
            <span style="font-weight: bold;">AMOUNT DUE:</span>
            <span style="font-weight: bold;">R ${formatNumber(Math.round(total))}</span>
        </div>
        `}
        ` : ''}
    </div></div>

    ${invoiceSettings.showProjectFeeStyle ? `
    <!-- Project Fee Due & Payable Section -->
    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 3px solid ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor || '#00d4ff'}; border-radius: 12px; text-align: center;">
        <div style="font-size: 14px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px;">Project Fee Due & Payable</div>
        ${amountPaid > 0 ? `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
            <span style="font-size: 14px; color: #28a745;">âœ“ Deposit Received${invoice?.deposit?.type === 'percentage' ? ` (${invoice.deposit.amount}%)` : ''}:</span>
            <span style="font-size: 18px; font-weight: bold; color: #28a745;">R ${formatNumber(Math.round(amountPaid))}</span>
        </div>
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">BALANCE OUTSTANDING</div>
        <div style="font-size: 36px; font-weight: bold; color: #dc3545; margin-bottom: 5px;">R ${formatNumber(Math.round(balanceDue))}</div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">Payment due upon completion of project</div>
        ` : `
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">TOTAL AMOUNT DUE</div>
        <div style="font-size: 36px; font-weight: bold; color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor || '#00d4ff'}; margin-bottom: 5px;">R ${formatNumber(Math.round(total))}</div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">Payment due as per terms stated above</div>
        `}
    </div>
    ` : ''}

    ${invoice?.projectFees?.showOnInvoice && invoice?.projectFees?.total > 0 ? `
    <!-- Project Fees Summary Reference -->
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px solid ${invoiceSettings.invoiceHeaderColor || '#00d4ff'}; border-radius: 8px;">
        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; font-weight: 600;">ðŸ“‹ Project Fees Summary</div>
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px 0; color: #333;">Total Project Fees (Excl. VAT)</td>
                <td style="padding: 8px 0; text-align: right; font-weight: 600; color: #333;">R ${formatNumber(Math.round(invoice.projectFees.total))}</td>
            </tr>
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px 0; color: #28a745;">Previously Billed</td>
                <td style="padding: 8px 0; text-align: right; color: #28a745;">R ${formatNumber(Math.round(invoice.projectFees.previouslyBilled))}</td>
            </tr>
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px 0; color: ${invoiceSettings.invoiceHeaderColor || '#00d4ff'}; font-weight: 600;">This Invoice</td>
                <td style="padding: 8px 0; text-align: right; color: ${invoiceSettings.invoiceHeaderColor || '#00d4ff'}; font-weight: 600;">R ${formatNumber(Math.round(invoice.projectFees.thisInvoice))}</td>
            </tr>
            <tr style="background: rgba(255, 190, 11, 0.1);">
                <td style="padding: 10px 0; font-weight: 700; color: #333;">Remaining Balance</td>
                <td style="padding: 10px 0; text-align: right; font-weight: 700; color: #f59e0b; font-size: 16px;">R ${formatNumber(Math.round(invoice.projectFees.remaining))}</td>
            </tr>
        </table>
    </div>
    ` : ''}

    ${invoiceSettings.showProfitOnPrint ? `
    <div class="profit-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.1)); border-radius: 8px; border: 2px solid rgba(6, 255, 165, 0.3);">
        <div class="section-title" style="color: #06ffa5; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 700;">ðŸ’° Profit Analysis</div>
        <div style="display: grid; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <span style="font-weight: 600;">Total Cost:</span>
                <span style="color: #ffbe0b; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.totalCost))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <span style="font-weight: 600;">Total Revenue:</span>
                <span style="color: #00d4ff; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.subtotal))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(6, 255, 165, 0.15); border-radius: 4px; font-size: 1.1rem;">
                <span style="font-weight: 700;">Gross Profit:</span>
                <span style="color: #06ffa5; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.grossProfit))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(6, 255, 165, 0.15); border-radius: 4px; font-size: 1.1rem;">
                <span style="font-weight: 700;">Profit Margin:</span>
                <span style="color: #06ffa5; font-weight: 700;">${currentInvoice.profitMargin.toFixed(1)}%</span>
            </div>
        </div>
    </div>
    ` : ''}

    ${showBankingBlock ? `
    <div class="banking-section">
        <div class="section-title">ðŸ’° Banking Details</div>
        <div class="banking-details">
            <div><strong>Bank:</strong> ${invoiceSettings.bankName}</div>
            <div><strong>Account Holder:</strong> ${invoiceSettings.accountHolder}</div>
            <div><strong>Account Number:</strong> ${invoiceSettings.accountNumber}</div>
            <div><strong>Branch Code:</strong> ${invoiceSettings.branchCode}</div>
        </div>
        <div class="payment-instructions" style="margin-top: 20px;">
            <div class="section-title" style="font-size: 13px; margin-bottom: 12px;">ðŸ“‹ Payment Instructions</div>
            <div class="payment-grid">
                <div><strong>Payment Reference:</strong><br><span style="color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor}; font-size: 16px; font-weight: bold;">${paymentReference}</span></div>
                <div><strong>Amount Due:</strong><br><span style="color: ${invoiceSettings.invoiceHeaderColor || invoiceSettings.primaryColor}; font-size: 16px; font-weight: bold;">R ${formatNumber(Math.round(balanceDue))}</span></div>
                <div style="grid-column: 1 / -1; margin-top: 10px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;"><strong>âš ï¸ Important:</strong> Please use <strong>${paymentReference}</strong> as your payment reference so we can allocate your payment correctly.</div>
            </div>
        </div>
    </div>
    ` : ''}

    ${invoiceSettings.showNotes ? `
    <div class="footer">
        <p>${invoiceSettings.invoiceFooter || 'Thank you for your business!'}</p>
    </div>
    ` : ''}

    ${autoPrint ? `
    <script>
        window.onload = function() {
            setTimeout(function() {
                window.print();
            }, 400);
        };
    <\/script>
    ` : ''}
</body>
</html>`;

            return printHtml;
        }

        function openInvoicePrintWindow(invoice, customer, options = {}) {
            const html = buildInvoiceDocumentHtml(invoice, customer, options);
            const w = window.open('', '_blank');
            if (!w) {
                showToast('Popup blocked. Please allow popups to print/download PDF.', 'error');
                return;
            }
            w.document.write(html);
            w.document.close();
        }

        function getCustomerForInvoice(invoice) {
            if (!invoice) return null;
            // Try to match by customer name (older invoices store a string)
            const name = invoice.customer || '';
            if (!name) return null;
            return customers.find(c => (c.name || '').toLowerCase() === String(name).toLowerCase()) || null;
        }

        // Print current (in-modal) invoice with Company Branding
        function printInvoice() {
            try {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before printing', 'error');
                return;
            }

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }

            // Get the saved invoice number if this invoice was already saved
            let invoiceNumber;
            if (currentInvoice.id) {
                const savedInvoice = invoices.find(inv => inv.id === currentInvoice.id);
                invoiceNumber = savedInvoice?.number || 'DRAFT';
            } else {
                invoiceNumber = 'DRAFT';
            }
            
            // Get selected business for the invoice
            const selectedBusinessId = document.getElementById('invoiceFromBusiness')?.value || currentBusiness?.id || 'default';
            const selectedBusiness = businesses.find(b => b.id === selectedBusinessId) || currentBusiness;
            
            const invoice = {
                number: invoiceNumber,
                type: document.getElementById('invoiceType')?.value || 'invoice',
                customer: customer.name,
                tier: document.getElementById('invoiceTier')?.value || '',
                vatOption: document.getElementById('invoiceVAT')?.value || 'include',
                status: document.getElementById('invoiceStatus')?.value || 'draft',
                paymentTerms: parseInt(document.getElementById('paymentTerms')?.value || '0', 10),
                date: document.getElementById('invoiceDate')?.value || new Date().toISOString().split('T')[0],
                dueDate: document.getElementById('invoiceDueDate')?.value || '',
                discount: {
                    amount: parseFloat(document.getElementById('discountAmount')?.value || '0'),
                    type: document.getElementById('discountType')?.value || 'percentage'
                },
                shipping: parseFloat(document.getElementById('shippingCost')?.value || '0'),
                items: currentInvoice.items || [],
                subtotal: currentInvoice.subtotal || 0,
                vat: currentInvoice.vat || 0,
                total: currentInvoice.total || 0,
                amountPaid: parseFloat(document.getElementById('depositAmount')?.value || '0') || 0,
                businessId: selectedBusinessId,
                businessName: selectedBusiness?.name || '',
                businessDetails: {
                    logo: selectedBusiness?.logo || '',
                    tradingAs: selectedBusiness?.tradingAs || '',
                    vatNumber: selectedBusiness?.vatNumber || '',
                    email: selectedBusiness?.email || '',
                    phone: selectedBusiness?.phone || '',
                    address: selectedBusiness?.address || ''
                }
            };

            openInvoicePrintWindow(invoice, customer, { autoPrint: true });
            } catch (error) {
                console.error('âŒ Error printing invoice:', error);
                showToast('Error printing invoice: ' + error.message, 'error');
            }
        }

        // Invoice Preview + PDF/Print
        function renderInvoicePreview(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                showToast('Invoice not found', 'error');
                return;
            }

            const customer = getCustomerForInvoice(invoice);
            const html = buildInvoiceDocumentHtml(invoice, customer, { autoPrint: false, titlePrefix: 'Preview' });

            const titleEl = document.getElementById('invoicePreviewTitle');
            if (titleEl) titleEl.textContent = `Invoice Preview #${invoice.number || invoice.id}`;

            const frame = document.getElementById('invoicePreviewFrame');
            if (frame) {
                frame.srcdoc = html;
            }

            const modal = document.getElementById('invoicePreviewModal');
            if (modal) {
                modal.dataset.invoiceId = String(invoiceId);
            }
        }

        function viewInvoice(id) {
            openModal('invoicePreviewModal');
            renderInvoicePreview(id);
        }

        function printInvoiceFromPreview() {
            const modal = document.getElementById('invoicePreviewModal');
            const invoiceId = modal?.dataset?.invoiceId ? parseInt(modal.dataset.invoiceId, 10) : null;
            if (!invoiceId) return;
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            const customer = getCustomerForInvoice(invoice);
            openInvoicePrintWindow(invoice, customer, { autoPrint: true });
        }

        function downloadInvoicePdfFromPreview() {
            // Uses the browser print dialog so the user can Save as PDF.
            printInvoiceFromPreview();
        }

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Open modal
            openModal('invoiceModal');
            document.getElementById('invoiceModalTitle').textContent = 'Edit Invoice #' + invoice.number;
            
            // Load customers
            loadCustomersIntoSelect();
            
            // Set customer
            const customerSelect = document.getElementById('invoiceCustomer');
            const customer = customers.find(c => c.name === invoice.customer);
            if (customer) {
                customerSelect.value = customer.id;
            }
            
            // Set other fields
            document.getElementById('invoiceTier').value = invoice.tier || 'retail';
            document.getElementById('invoiceType').value = invoice.type || 'invoice';
            document.getElementById('invoiceVAT').value = invoice.vatOption || 'include';
            document.getElementById('invoiceStatus').value = invoice.status || 'draft';
            document.getElementById('paymentTerms').value = invoice.paymentTerms || 30;
            document.getElementById('invoiceDate').value = invoice.date || new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('discountAmount').value = invoice.discount?.amount || 0;
            document.getElementById('discountType').value = invoice.discount?.type || 'percentage';
            document.getElementById('shippingCost').value = invoice.shipping || 0;
            // Handle both old format (number) and new format (object with amount/type)
            if (typeof invoice.deposit === 'object' && invoice.deposit !== null) {
                document.getElementById('depositAmount').value = invoice.deposit.amount || 0;
                document.getElementById('depositType').value = invoice.deposit.type || 'fixed';
            } else {
                document.getElementById('depositAmount').value = invoice.deposit || 0;
                document.getElementById('depositType').value = 'fixed';
            }

            // Load items
            currentInvoice = {
                id: invoice.id,
                items: [...invoice.items],
                subtotal: invoice.subtotal,
                vat: invoice.vat,
                total: invoice.total,
                status: invoice.status || 'draft',
                paymentTerms: invoice.paymentTerms || 30,
                dueDate: invoice.dueDate || '',
                amountPaid: invoice.amountPaid || 0,
                balance: invoice.balance || invoice.total,
                payments: invoice.payments || [],
                projectFees: invoice.projectFees || null
            };

            // Load project fees data if present
            if (invoice.projectFees) {
                document.getElementById('totalProjectFees').value = invoice.projectFees.total || '';
                document.getElementById('previouslyBilled').value = invoice.projectFees.previouslyBilled || '';
                document.getElementById('thisInvoiceAmount').value = invoice.projectFees.thisInvoiceValue || '';
                document.getElementById('thisInvoiceBillingType').value = invoice.projectFees.billingType || 'percentage';
                document.getElementById('showProjectFeesOnInvoice').checked = invoice.projectFees.showOnInvoice || false;
            } else {
                document.getElementById('totalProjectFees').value = '';
                document.getElementById('previouslyBilled').value = '';
                document.getElementById('thisInvoiceAmount').value = '';
                document.getElementById('thisInvoiceBillingType').value = 'percentage';
                document.getElementById('showProjectFeesOnInvoice').checked = false;
            }
            
            // Show project fees section if applicable
            showProjectFeesSectionIfApplicable();

            // Show payment section if invoice is saved
            if (invoice.id) {
                document.getElementById('togglePaymentBtn').style.display = 'inline-block';
                document.getElementById('whatsappBtn').style.display = 'inline-block';
                document.getElementById('emailBtn').style.display = 'inline-block';
            }

            updateInvoiceItemsTable();
            calculateInvoiceTotal();
            updateProjectFeeReference();
            updatePaymentDisplay();

            showToast('Invoice loaded for editing', 'info');
        }

        async function deleteInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Protect paid invoices from deletion
            if (invoice.status === 'paid') {
                showToast('âŒ Cannot delete a paid invoice! You can only mark it as cancelled.', 'error');
                return;
            }
            
            // Protect invoices with payments
            if (invoice.payments && invoice.payments.length > 0) {
                const totalPaid = invoice.payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                if (!confirm(`âš ï¸ WARNING: This invoice has payments recorded!\n\nInvoice #${invoice.number}\nTotal Paid: R ${formatNumber(totalPaid)}\n\nDeleting will also delete payment records.\n\nAre you ABSOLUTELY sure?`)) {
                    return;
                }
            }
            
            // Check if invoice is older than 30 days
            const invoiceDate = new Date(invoice.date);
            const daysSinceCreation = Math.floor((new Date() - invoiceDate) / (1000 * 60 * 60 * 24));
            
            if (daysSinceCreation > 30) {
                if (!confirm(`âš ï¸ OLD INVOICE WARNING!\n\nThis invoice is ${daysSinceCreation} days old.\n\nInvoice #${invoice.number}\nCustomer: ${invoice.customer}\nDate: ${invoice.date}\n\nFor auditing purposes, consider marking as 'cancelled' instead.\n\nDelete anyway?`)) {
                    return;
                }
            }
            
            // Standard confirmation
            if (!confirm(`âš ï¸ DELETE INVOICE?\n\nInvoice #${invoice.number}\nCustomer: ${invoice.customer}\nTotal: R ${formatNumber(Math.round(invoice.total))}\n\nThis cannot be undone!`)) {
                return;
            }
            
            invoices = invoices.filter(inv => inv.id !== id);
            await saveToStorage(getBusinessKey('aweh_invoices'), invoices);
            loadRecentInvoices();
            updateDashboard();
            showToast('Invoice deleted permanently', 'success');
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            openModal('customerModal');
            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerCompany').value = customer.company || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerVAT').value = customer.vat || '';
            document.getElementById('customerTier').value = customer.tier || 'retail';
            
            // Store ID for updating
            document.getElementById('customerModal').dataset.editId = id;
        }

        async function deleteCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            if (confirm(`âš ï¸ DELETE CUSTOMER?\n\nName: ${customer.name}\n${customer.company ? 'Company: ' + customer.company + '\n' : ''}Are you sure?`)) {
                customers = customers.filter(c => c.id !== id);
                if (await saveToStorage(getBusinessKey('aweh_customers'), customers)) {
                    loadCustomers();
                    showToast('Customer deleted', 'success');
                }
            }
        }

        // Profile Management
        function saveProfile() {
            const name = prompt('Enter profile name:');
            if (!name) return;
            
            const profiles = JSON.parse(localStorage.getItem('aweh_profiles') || '[]');
            profiles.push({
                id: Date.now(),
                name: name,
                settings: {...settings}
            });
            
            if (safeSetItem('aweh_profiles', JSON.stringify(profiles))) {
                loadProfiles();
                showToast('Profile saved!', 'success');
            }
        }

        function loadProfile() {
            const profileId = document.getElementById('profileSelector').value;
            if (!profileId) return;
            
            const profiles = JSON.parse(localStorage.getItem('aweh_profiles') || '[]');
            const profile = profiles.find(p => p.id == profileId);
            
            if (profile && confirm('Load profile "' + profile.name + '"? Current settings will be replaced.')) {
                settings = {...profile.settings};
                const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
                if (safeSetItem(storageKey, JSON.stringify(settings))) {
                    location.reload();
                }
            }
        }

        function deleteProfile() {
            const profileId = document.getElementById('profileSelector').value;
            if (!profileId) return;
            
            if (confirm('Delete this profile?')) {
                let profiles = safeGetItem('aweh_profiles', []);
                profiles = profiles.filter(p => p.id != profileId);
                if (safeSetItem('aweh_profiles', JSON.stringify(profiles))) {
                    loadProfiles();
                    showToast('Profile deleted', 'success');
                }
            }
        }

        function loadProfiles() {
            const profiles = safeGetItem('aweh_profiles', []);
            const select = document.getElementById('profileSelector');
            if (select) {
                select.innerHTML = '<option value="">Select a profile...</option>' +
                    profiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
            // profileSelector is optional - no warning needed
        }

        // Auto-sync with Google if user logged in via Google AND is business owner
        async function autoSyncGoogleDrive() {
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            const autoSyncPending = localStorage.getItem('google_auto_sync_pending');
            const googleToken = currentUser?.googleToken || localStorage.getItem('google_access_token');
            
            // Only sync for Google users who are business owners
            if (currentUser?.provider !== 'google' || !googleToken || typeof driveStorage === 'undefined') {
                return false;
            }
            
            // Check if this user is the business owner
            const isOwner = isBusinessOwner();
            
            if (!isOwner) {
                console.log('ðŸ‘¤ User is not business owner - sync disabled for privacy');
                // Show non-owners that data is managed by owner
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = 'ðŸ”’ Data managed by business owner';
                    syncStatus.style.color = 'var(--warning)';
                }
                return false;
            }
            
            console.log('ðŸ” Business owner detected, setting up auto-sync...');
            
            try {
                // Set the token for Drive API
                if (gapi?.client?.setToken) {
                    gapi.client.setToken({ access_token: googleToken });
                }
                driveStorage.isSignedIn = true;
                driveStorage.pendingTokenResponse = { access_token: googleToken };
                
                // Use business-specific folder
                driveStorage.folderName = `Aweh Invoice System - ${currentBusiness?.name || 'Business'}`;
                
                await driveStorage.ensureFolder();
                
                // Store Drive token on business for future reference
                if (currentBusiness && !currentBusiness.driveConfigured) {
                    currentBusiness.driveConfigured = true;
                    currentBusiness.driveToken = googleToken;
                    await saveToStorage('aweh_businesses', businesses);
                }
                
                if (autoSyncPending === 'true') {
                    console.log('ðŸ”„ Auto-syncing from Google Drive (first login)...');
                    updateLoadingProgress(35, 'Syncing your data from cloud...');
                    localStorage.removeItem('google_auto_sync_pending');
                    
                    // Sync down first to get any existing data
                    if (typeof driveStorage.syncDown === 'function') {
                        await driveStorage.syncDown();
                    }
                    // Then sync up any local changes
                    if (typeof driveStorage.syncAll === 'function') {
                        await driveStorage.syncAll();
                    }
                    console.log('âœ… Google Drive auto-sync complete');
                    driveStorage.updateSyncStatus('â˜ï¸ Synced with Google Drive', 'success');
                }
                
                driveStorage.updateSignInStatus();
                return true;
            } catch (error) {
                console.warn('âš ï¸ Auto-sync setup failed:', error);
                return false;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Initializing ConiCore Invoicing System...');
            
            // Run data migration first
            migrateLocalStorageKeys();
            
            try {
                // Step 1: Load businesses (10%)
                updateLoadingProgress(10, 'Loading businesses...');
                if (typeof loadBusinesses === 'function') {
                    await loadBusinesses();
                }

                // Step 2: Check Google Drive config (20%)
                updateLoadingProgress(20, 'Checking cloud sync...');
                const savedClientId = localStorage.getItem('google_drive_client_id');
                const syncGoogleBtn = document.getElementById('syncGoogleBtn');

                const isValidClientId = Boolean(
                    savedClientId &&
                    typeof savedClientId === 'string' &&
                    savedClientId.includes('-') &&
                    savedClientId.endsWith('.apps.googleusercontent.com')
                );

                if (isValidClientId && typeof driveStorage !== 'undefined') {
                    if (syncGoogleBtn) {
                        syncGoogleBtn.style.display = 'inline-flex';
                        syncGoogleBtn.style.animation = '';
                    }
                    driveStorage.CLIENT_ID = savedClientId;
                    if (driveStorage._initPromise) {
                        driveStorage._initPromise = null;
                        driveStorage.tokenClient = null;
                    }
                } else {
                    if (savedClientId && !isValidClientId) {
                        localStorage.removeItem('google_drive_client_id');
                    }
                    if (syncGoogleBtn) {
                        syncGoogleBtn.style.display = 'inline-flex';
                        syncGoogleBtn.style.animation = 'pulse 2s infinite';
                    }
                }

                // Step 3: Initialize Google Drive (30%) - with timeout
                updateLoadingProgress(30, 'Connecting to Google Drive...');
                if (typeof driveStorage !== 'undefined') {
                    try {
                        // Add 3 second timeout to prevent hanging
                        const initPromise = driveStorage.init();
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Google Drive init timeout')), 3000)
                        );
                        
                        await Promise.race([initPromise, timeoutPromise]);
                        console.log('âœ… Google Drive initialized');
                        
                        // Try auto-sync for Google login users
                        const autoSynced = await autoSyncGoogleDrive();
                        
                        if (!autoSynced && driveStorage.isSignedIn) {
                            updateLoadingProgress(40, 'Syncing from cloud...');
                            try {
                                console.log('ðŸ”„ Auto-syncing from Google Drive...');
                                if (typeof driveStorage.syncDown === 'function') {
                                    await driveStorage.syncDown();
                                }
                                console.log('âœ… Auto-sync complete');
                            } catch (syncError) {
                                console.warn('âš ï¸ Auto-sync failed (continuing with local data):', syncError);
                            }
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Google Drive initialization failed, using localStorage only:', error);
                    }
                }

                // Step 4: Load business-specific data (50%)
                updateLoadingProgress(50, 'Loading products...');
                // Load products from storage first
                const storedProducts = await loadFromStorage(getBusinessKey('aweh_products'), null);
                
                // For DIGG business, always ensure products are seeded
                if (isDiggBusiness(currentBusiness)) {
                    if (!Array.isArray(storedProducts) || storedProducts.length === 0) {
                        console.log('ðŸ”§ DIGG business with no products - seeding...');
                        products = buildDiggSeedProducts();
                        await saveToStorage(getBusinessKey('aweh_products'), products);
                        console.log('âœ… DIGG products seeded:', products.length);
                    } else {
                        products = storedProducts;
                        console.log('ðŸ“¦ Loaded DIGG products:', products.length);
                    }
                } else if (Array.isArray(storedProducts) && storedProducts.length > 0) {
                    products = storedProducts;
                } else if (!currentBusiness || currentBusiness.id === 'default' || currentBusiness.name?.toLowerCase().includes('aweh')) {
                    // Only initialize Awake products for the default/Aweh business
                    initializeProducts();
                } else {
                    // Other businesses start with empty catalog
                    products = [];
                }
                
                // Step 5: Load customers (60%)
                updateLoadingProgress(60, 'Loading customers...');
                customers = await loadFromStorage(getBusinessKey('aweh_customers'), []);
                if (!Array.isArray(customers)) customers = [];
                
                // Only seed sample customers for Aweh/default business with empty list
                if (customers.length === 0) {
                    const normalize = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                    const name = normalize(currentBusiness?.name);
                    const tradingAs = normalize(currentBusiness?.tradingAs);
                    const shouldSeedSampleCustomers = (currentBusiness?.id === 'default') || name.includes('aweh') || tradingAs.includes('awake');
                    if (shouldSeedSampleCustomers) {
                        initializeCustomers();
                    }
                }
                
                // Step 6: Load settings (70%)
                updateLoadingProgress(70, 'Loading settings...');
                await loadSettings();
                loadProfiles();
                await initializeReceivingData();

                // Step 7: Load remaining saved data (80%)
                updateLoadingProgress(80, 'Loading invoices & data...');
                invoices = await loadFromStorage(getBusinessKey('aweh_invoices'), []);
                suppliers = await loadFromStorage(getBusinessKey('aweh_suppliers'), []);
                favoriteProducts = await loadFromStorage(getBusinessKey('aweh_favorites'), []);

                // Refresh products UI after loading per-business catalog
                try {
                    displayProducts();
                    updateProductCount();
                } catch (e) {
                    // Ignore if UI isn't ready yet
                }

                if (typeof loadSuppliers === 'function') {
                    loadSuppliers();
                }

                // Step 8: Render UI (90%)
                updateLoadingProgress(90, 'Rendering dashboard...');
                loadRecentInvoices();
                updateDashboard();
                loadCustomers();
                loadAllInvoices();
                
                // Step 9: Initialize features (95%)
                updateLoadingProgress(95, 'Initializing features...');
                checkAuthentication();
                initializeAI();
                initPullToRefresh();

                // Load ConiCore features
                loadPlatformBranding();
                loadInvoiceTemplateSelection();
                loadAIConfig();
                loadOCRSettings(); // Initialize OCR settings

                // Check if AI wizard should show on first run
                if (typeof checkAIWizardFirstRun === 'function') {
                    checkAIWizardFirstRun();
                }
                
                // Apply platform branding colors if set
                const platformBranding = JSON.parse(localStorage.getItem('conicore_platform_branding') || '{}');
                if (platformBranding.primaryColor) {
                    document.documentElement.style.setProperty('--primary', platformBranding.primaryColor);
                }
                if (platformBranding.secondaryColor) {
                    document.documentElement.style.setProperty('--secondary', platformBranding.secondaryColor);
                }
                if (platformBranding.accentColor) {
                    document.documentElement.style.setProperty('--accent', platformBranding.accentColor);
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Escape - Close modals
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal.active').forEach(modal => {
                            closeModal(modal.id);
                        });
                        hideGlobalSearchResults();
                    }
                    
                    // Ctrl/Cmd + / - Focus global search
                    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                        e.preventDefault();
                        document.getElementById('globalSearchInput')?.focus();
                    }
                    
                    // Ctrl/Cmd shortcuts
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 'n':
                                e.preventDefault();
                                openCreateInvoiceModal();
                                break;
                            case 's':
                                if (document.getElementById('settings').classList.contains('active')) {
                                    e.preventDefault();
                                    saveSettings();
                                }
                                break;
                            case 'e':
                                e.preventDefault();
                                exportData();
                                break;
                            case 'p':
                                // Allow default print for invoices
                                break;
                            case 'r':
                                e.preventDefault();
                                quickRefresh();
                                break;
                            case 'd':
                                e.preventDefault();
                                toggleTheme();
                                break;
                        }
                    }
                    
                    // Alt + number for quick tab switching
                    if (e.altKey && !e.ctrlKey && !e.metaKey) {
                        const tabMap = {
                            '1': 'dashboard',
                            '2': 'products',
                            '3': 'invoices',
                            '4': 'customers',
                            '5': 'settings'
                        };
                        if (tabMap[e.key]) {
                            e.preventDefault();
                            const tabs = document.querySelectorAll('.nav-tab');
                            tabs.forEach(tab => {
                                if (tab.textContent.toLowerCase().includes(tabMap[e.key]) || 
                                    (tabMap[e.key] === 'dashboard' && tab.textContent.includes('Dashboard'))) {
                                    tab.click();
                                }
                            });
                        }
                    }
                });

                // Search/filter listeners
                document.getElementById('invoiceSearch')?.addEventListener('input', loadAllInvoices);
                document.getElementById('invoiceFilter')?.addEventListener('change', loadAllInvoices);

                // Complete! (100%)
                console.log('âœ… System ready! Loaded', products.length, 'products');
                hideGlobalLoading();
                
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                updateLoadingProgress(100, 'Error loading - refreshing...');
                setTimeout(() => {
                    hideGlobalLoading();
                    showToast('Some features may not have loaded correctly', 'warning');
                }, 1000);
            }
        });
        
        // Load All Invoices
        function loadAllInvoices() {
            const tbody = document.querySelector('#allInvoicesTable tbody');
            const searchTerm = document.getElementById('invoiceSearch')?.value.toLowerCase() || '';
            const filterType = document.getElementById('invoiceFilter')?.value || 'all';
            const filterStatus = document.getElementById('statusFilter')?.value || 'all';

            let filtered = invoices;

            if (filterType !== 'all') {
                filtered = filtered.filter(inv => inv.type === filterType);
            }

            if (filterStatus !== 'all') {
                filtered = filtered.filter(inv => (inv.status || 'draft') === filterStatus);
            }

            if (searchTerm) {
                filtered = filtered.filter(inv =>
                    inv.number.toLowerCase().includes(searchTerm) ||
                    inv.customer.toLowerCase().includes(searchTerm) ||
                    inv.type.toLowerCase().includes(searchTerm) ||
                    (inv.status || 'draft').toLowerCase().includes(searchTerm)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.reverse().map(inv => {
                const balance = (inv.total || 0) - (inv.amountPaid || 0);
                return `
                <tr>
                    <td>${inv.number}</td>
                    <td>${inv.date}</td>
                    <td>${inv.dueDate || '-'}</td>
                    <td>${inv.customer}</td>
                    <td><span style="padding: 0.25rem 0.75rem; background: rgba(6, 255, 165, 0.2); border-radius: 20px; font-size: 0.85rem;">${inv.type}</span></td>
                    <td>${getStatusBadge(inv.status || 'draft')}</td>
                    <td>R ${formatNumber(Math.round(inv.total))}</td>
                    <td style="color: ${balance > 0 ? 'var(--accent)' : 'var(--success)'};">R ${formatNumber(Math.round(balance))}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewInvoice(${inv.id})" title="View">ðŸ‘ï¸</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editInvoice(${inv.id})" title="Edit">âœï¸</button>
                        <button type="button" class="btn btn-success btn-sm btn-icon" onclick="duplicateInvoice(${inv.id})" title="Duplicate">ðŸ“‹</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteInvoice(${inv.id})" title="Delete">ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // Duplicate Invoice
        async function duplicateInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const timestamp = Date.now();
            const newInvoice = {
                ...invoice,
                id: timestamp,
                number: 'INV-' + new Date().getFullYear() + '-' + String(timestamp).slice(-8),
                date: new Date().toISOString().split('T')[0],
                status: 'draft',
                amountPaid: 0,
                payments: [],
                createdAt: timestamp
            };

            invoices.push(newInvoice);
            await saveToStorage(getBusinessKey('aweh_invoices'), invoices);
            loadRecentInvoices();
            loadAllInvoices();
            updateDashboard();
            showToast('Invoice duplicated successfully!', 'success');
        }

        // Generate AI Follow-up Message
        async function generateAIFollowup(customer, invoice) {
            const provider = settings.aiProvider || '';
            const apiKey = settings.aiApiKey || '';
            
            // Get customer history
            const customerInvoices = invoices.filter(inv => inv.customerId === customer.id || inv.customer === customer.name);
            const customerHistory = {
                invoiceCount: customerInvoices.length,
                totalSpent: customerInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0),
                paymentRate: customerInvoices.length > 0 
                    ? Math.round(customerInvoices.filter(inv => inv.status === 'paid').length / customerInvoices.length * 100) 
                    : 100,
                tier: customer.tier || 'retail'
            };
            
            // Calculate days overdue
            const dueDate = new Date(invoice.dueDate || invoice.date);
            const today = new Date();
            const daysOverdue = Math.max(0, Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)));
            
            const requestData = {
                customer: customer,
                invoice: { ...invoice, daysOverdue },
                customerHistory: customerHistory,
                business: {
                    name: settings.companyName || 'Aweh Be Lekker',
                    tone: 'friendly South African surfer vibe'
                }
            };
            
            try {
                let endpoint = '/api/ai-followup'; // Default free endpoint
                
                if (provider === 'anthropic' && apiKey) {
                    endpoint = '/api/ai-claude';
                    requestData.action = 'followup';
                    requestData.apiKey = apiKey;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, message: data.message, source: data.source || 'ai' };
                } else {
                    return { success: false, message: 'AI request failed', source: 'error' };
                }
            } catch (error) {
                console.error('AI follow-up error:', error);
                return { success: false, message: error.message, source: 'error' };
            }
        }

        // ============================================
        // SUPPLIER MANAGEMENT FUNCTIONS
        // ============================================

        function openAddSupplierModal() {
            document.getElementById('supplierModal').style.display = 'flex';
            // Clear form
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierWebsite').value = '';
            document.getElementById('supplierCategory').value = 'jetboards';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
            document.getElementById('supplierLogoUpload').value = '';
            document.getElementById('supplierLogoPreview').style.display = 'none';
        }

        function handleSupplierLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 500KB)
            if (file.size > 500000) {
                showToast('Logo file is too large. Please use an image under 500KB.', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('supplierLogoPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            if (!name) {
                showToast('Please enter supplier name', 'error');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            const supplier = {
                id: Date.now(),
                name: name,
                contact: document.getElementById('supplierContact').value.trim(),
                email: document.getElementById('supplierEmail').value.trim(),
                phone: document.getElementById('supplierPhone').value.trim(),
                website: document.getElementById('supplierWebsite').value.trim(),
                category: document.getElementById('supplierCategory').value,
                address: document.getElementById('supplierAddress').value.trim(),
                notes: document.getElementById('supplierNotes').value.trim(),
                logo: document.getElementById('supplierLogoPreview').src || '',
                products: [],
                createdAt: Date.now(),
                lastUpdated: new Date().toISOString().split('T')[0],
                createdBy: currentUser ? (currentUser.username || currentUser.email) : 'unknown',
                owner: currentUser ? (currentUser.username || currentUser.email) : 'unknown'
            };

            suppliers.push(supplier);
            if (await saveToStorage(getBusinessKey('aweh_suppliers'), suppliers)) {
                loadSuppliers();
                closeModal('supplierModal');
                showToast('Supplier added successfully!', 'success');
            }
        }

        function loadSuppliers() {
            const tbody = document.querySelector('#suppliersTable tbody');
            if (!tbody) return;

            if (suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No suppliers yet. Add your first supplier!</td></tr>';
                return;
            }

            tbody.innerHTML = (suppliers || []).map(s => `
                <tr>
                    <td>
                        ${s.logo ? `<img src="${s.logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 4px;" alt="${s.name} logo">` : 'ðŸ¢'}
                    </td>
                    <td>
                        <strong>${s.name}</strong><br>
                        <small style="opacity: 0.7;">${s.category}</small>
                    </td>
                    <td>
                        ${s.contact ? `<div>${s.contact}</div>` : ''}
                        ${s.email ? `<div style="font-size: 0.85rem; opacity: 0.8;">${s.email}</div>` : ''}
                        ${s.phone ? `<div style="font-size: 0.85rem; opacity: 0.8;">${s.phone}</div>` : ''}
                    </td>
                    <td>${(s.products || []).length} products</td>
                    <td>${s.lastUpdated || '-'}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewSupplier(${s.id})" title="View">ðŸ‘ï¸</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editSupplier(${s.id})" title="Edit">âœï¸</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteSupplier(${s.id})" title="Delete">ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            showToast(`Viewing ${supplier.name}`, 'info');
            // TODO: Implement supplier detail view
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            showToast(`Editing ${supplier.name}`, 'info');
            // TODO: Implement supplier editing
        }

        async function deleteSupplier(id) {
            if (!confirm('Are you sure you want to delete this supplier?')) return;

            suppliers = suppliers.filter(s => s.id !== id);
            if (await saveToStorage(getBusinessKey('aweh_suppliers'), suppliers)) {
                loadSuppliers();
                showToast('Supplier deleted successfully!', 'success');
            }
        }

        // ============================================
        // OCR SCANNING FUNCTIONS
        // ============================================

        let currentStream = null;
        let currentScanType = 'invoice'; // 'invoice', 'pricelist', 'receipt'

        function scanPriceList() {
            currentScanType = 'pricelist';
            document.getElementById('scannerModalTitle').textContent = 'ðŸ“· Scan Price List';
            openModal('scannerModal');
        }

        function scanInvoice() {
            currentScanType = 'invoice';
            document.getElementById('scannerModalTitle').textContent = 'ðŸ“· Scan Invoice';
            openModal('scannerModal');
        }

        function scanCustomerDoc() {
            currentScanType = 'customer';
            document.getElementById('scannerModalTitle').textContent = 'ðŸ“· Scan Customer Document';
            openModal('scannerModal');
        }

        function uploadPriceList() {
            showToast('Price list upload feature coming soon! For now, use the scan feature.', 'info');
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                currentStream = stream;

                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;

                document.getElementById('cameraView').style.display = 'block';
                document.querySelector('#scannerContent > div').style.display = 'none';
            } catch (error) {
                showToast('Camera access denied or not available. Please use file upload instead.', 'error');
                console.error('Camera error:', error);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraView').style.display = 'none';
            document.querySelector('#scannerContent > div').style.display = 'block';
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('capturedCanvas');
            const context = canvas.getContext('2d');

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            context.drawImage(video, 0, 0);

            // Stop camera
            stopCamera();

            // Show captured image
            document.getElementById('capturedImageView').style.display = 'block';
        }

        function handleScanFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('capturedCanvas');
                    const context = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);

                    document.querySelector('#scannerContent > div').style.display = 'none';
                    document.getElementById('capturedImageView').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function processOCR() {
            // Check if Tesseract.js is loaded
            if (typeof Tesseract === 'undefined') {
                showToast('OCR library not loaded. Please check your internet connection.', 'error');
                return;
            }

            const canvas = document.getElementById('capturedCanvas');
            const progressDiv = document.getElementById('ocrProgress');
            const statusDiv = document.getElementById('ocrStatus');
            const progressBar = document.getElementById('ocrProgressBar');
            const processBtn = document.getElementById('processBtn');

            progressDiv.style.display = 'block';
            processBtn.disabled = true;

            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            statusDiv.textContent = `Recognizing text... ${progress}%`;
                            progressBar.style.width = progress + '%';
                        } else {
                            statusDiv.textContent = m.status;
                        }
                    }
                });

                await worker.loadLanguage('eng');
                await worker.initialize('eng');

                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                // Show results
                document.getElementById('ocrText').textContent = text;
                document.getElementById('capturedImageView').style.display = 'none';
                document.getElementById('ocrResults').style.display = 'block';

                showToast('Text extracted successfully!', 'success');
            } catch (error) {
                showToast('OCR processing failed. Please try again.', 'error');
                console.error('OCR error:', error);
                processBtn.disabled = false;
                progressDiv.style.display = 'none';
            }
        }

        // ============================================
        // AI INVOICE ANALYSIS FUNCTIONS
        // ============================================

        let analysisResults = {
            supplier: null,
            products: [],
            priceChanges: [],
            newProducts: []
        };

        function analyzeSupplierInvoice() {
            const text = document.getElementById('ocrText').textContent;

            // Close scanner modal and open analysis modal
            closeModal('scannerModal');
            openModal('invoiceAnalysisModal');

            // Start analysis
            performSupplierRecognition(text);
            performProductAnalysis(text);
        }

        // Supplier Recognition using AI pattern matching
        function performSupplierRecognition(text) {
            const resultDiv = document.getElementById('supplierRecognitionResult');

            // Extract potential supplier names (look for common patterns)
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Common supplier name indicators
            const supplierKeywords = ['pty', 'ltd', 'limited', 'inc', 'corp', 'company', 'suppliers', 'trading'];

            // Look for company names in first 10 lines (usually at top of invoice)
            let potentialSuppliers = [];
            for (let i = 0; i < Math.min(10, lines.length); i++) {
                const line = lines[i].toLowerCase();
                if (supplierKeywords.some(keyword => line.includes(keyword))) {
                    potentialSuppliers.push(lines[i]);
                }
            }

            // Also look for email domains and phone numbers
            const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            const phoneMatch = text.match(/\+?\d{1,4}[\s-]?\(?\d{1,4}\)?[\s-]?\d{1,4}[\s-]?\d{1,9}/);

            // Try to match against existing suppliers
            let matchedSupplier = null;
            let matchScore = 0;

            suppliers.forEach(supplier => {
                let score = 0;

                // Check name match
                potentialSuppliers.forEach(potential => {
                    if (potential.toLowerCase().includes(supplier.name.toLowerCase()) ||
                        supplier.name.toLowerCase().includes(potential.toLowerCase())) {
                        score += 10;
                    }
                });

                // Check email match
                if (emailMatch && supplier.email &&
                    emailMatch[0].toLowerCase().includes(supplier.email.toLowerCase().split('@')[1])) {
                    score += 5;
                }

                // Check phone match
                if (phoneMatch && supplier.phone) {
                    const cleanPhone = supplier.phone.replace(/\D/g, '');
                    const scannedPhone = phoneMatch[0].replace(/\D/g, '');
                    if (scannedPhone.includes(cleanPhone.slice(-7)) || cleanPhone.includes(scannedPhone.slice(-7))) {
                        score += 5;
                    }
                }

                if (score > matchScore) {
                    matchScore = score;
                    matchedSupplier = supplier;
                }
            });

            // Display results
            if (matchedSupplier && matchScore >= 5) {
                analysisResults.supplier = matchedSupplier;
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        ${matchedSupplier.logo ? `<img src="${matchedSupplier.logo}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: white; padding: 0.5rem;">` : '<div style="width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">ðŸ“¦</div>'}
                        <div style="flex: 1;">
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--success); margin-bottom: 0.25rem;">
                                âœ… Supplier Identified
                            </div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">${matchedSupplier.name}</div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                ${matchedSupplier.email || ''} ${matchedSupplier.phone ? 'â€¢ ' + matchedSupplier.phone : ''}
                            </div>
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(6, 255, 165, 0.1); border-radius: 4px; font-size: 0.85rem;">
                                <strong>Match Confidence:</strong> ${Math.min(100, matchScore * 10)}%
                            </div>
                        </div>
                    </div>
                `;
            } else {
                analysisResults.supplier = null;
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">â“</div>
                        <div style="font-size: 1.1rem; color: var(--warning); margin-bottom: 0.5rem;">Supplier Not Recognized</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;">
                            Could not match this invoice to any existing supplier in your database.
                        </div>
                        ${potentialSuppliers.length > 0 ? `
                            <div style="text-align: left; margin-top: 1rem; padding: 1rem; background: rgba(255,190,11,0.1); border-radius: 8px;">
                                <strong>Detected company names:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${potentialSuppliers.slice(0, 3).map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <button type="button" class="btn btn-primary" onclick="switchTab('suppliers')" style="margin-top: 1rem;">
                            âž• Add New Supplier
                        </button>
                    </div>
                `;
            }
        }

        // Product Analysis and Price Change Detection
        function performProductAnalysis(text) {
            const resultDiv = document.getElementById('productAnalysisResult');

            // Parse invoice lines looking for product patterns
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Common patterns for invoice line items:
            // SKU | Product Name | Qty | Price
            // Product Name | SKU | Price
            // etc.

            let detectedProducts = [];

            // Look for SKU patterns (alphanumeric with dashes)
            const skuPattern = /\b[A-Z0-9]{2,}[-][A-Z0-9]{2,}[-]?[A-Z0-9]*\b/g;

            // Look for price patterns (R followed by number, or just numbers with decimals)
            const pricePattern = /R?\s*(\d{1,3}(?:[,\s]\d{3})*(?:\.\d{2})?)/g;

            lines.forEach((line, index) => {
                const skuMatches = line.match(skuPattern);
                const priceMatches = [...line.matchAll(pricePattern)];

                if (skuMatches && priceMatches.length > 0) {
                    skuMatches.forEach(sku => {
                        // Extract price (last number on line is usually the total)
                        const price = priceMatches[priceMatches.length - 1][1].replace(/[,\s]/g, '');

                        // Try to extract product name (text between SKU and price)
                        let productName = line.replace(sku, '').replace(priceMatches[priceMatches.length - 1][0], '').trim();

                        // Clean up product name
                        productName = productName.replace(/^\d+\s*/, ''); // Remove leading numbers
                        productName = productName.replace(/\s+/g, ' '); // Normalize spaces

                        if (productName.length > 3) {
                            detectedProducts.push({
                                sku: sku,
                                name: productName,
                                price: parseFloat(price),
                                rawLine: line
                            });
                        }
                    });
                }
            });

            // Match detected products against catalog
            analysisResults.priceChanges = [];
            analysisResults.newProducts = [];

            detectedProducts.forEach(detected => {
                // Try exact SKU match first
                let catalogProduct = products.find(p => p.sku === detected.sku);

                // If no exact match, try fuzzy matching on name
                if (!catalogProduct) {
                    catalogProduct = products.find(p => {
                        const nameSimilarity = calculateSimilarity(p.name.toLowerCase(), detected.name.toLowerCase());
                        const skuSimilarity = calculateSimilarity(p.sku.toLowerCase(), detected.sku.toLowerCase());
                        return nameSimilarity > 0.7 || skuSimilarity > 0.8;
                    });
                }

                if (catalogProduct) {
                    // Product exists - check for price changes
                    const oldPrice = catalogProduct.landedCost;
                    const newPrice = detected.price;
                    const priceDiff = newPrice - oldPrice;
                    const percentChange = ((priceDiff / oldPrice) * 100).toFixed(1);

                    if (Math.abs(priceDiff) > 0.01) { // Price changed
                        analysisResults.priceChanges.push({
                            product: catalogProduct,
                            oldPrice: oldPrice,
                            newPrice: newPrice,
                            difference: priceDiff,
                            percentChange: percentChange,
                            detected: detected
                        });
                    }
                } else {
                    // New product not in catalog
                    analysisResults.newProducts.push(detected);
                }
            });

            // Display results
            displayProductAnalysisResults();
        }

        // Calculate string similarity (Levenshtein distance based)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        function displayProductAnalysisResults() {
            const resultDiv = document.getElementById('productAnalysisResult');
            const applyBtn = document.getElementById('applyUpdatesBtn');

            let html = '';

            // Price Changes Section
            if (analysisResults.priceChanges.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--warning); margin-bottom: 1rem;">âš ï¸ Price Changes Detected (${analysisResults.priceChanges.length})</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">Product</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">SKU</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Old Price</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">New Price</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Change</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.2);">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                analysisResults.priceChanges.forEach((change, index) => {
                    const isIncrease = change.difference > 0;
                    const changeColor = isIncrease ? '#ff006e' : '#06ffa5';
                    const changeIcon = isIncrease ? 'ðŸ“ˆ' : 'ðŸ“‰';

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">${change.product.name}</td>
                            <td style="padding: 0.75rem; font-family: monospace;">${change.product.sku}</td>
                            <td style="padding: 0.75rem; text-align: right;">R ${formatNumber(Math.round(change.oldPrice))}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">R ${formatNumber(Math.round(change.newPrice))}</td>
                            <td style="padding: 0.75rem; text-align: right; color: ${changeColor}; font-weight: 600;">
                                ${changeIcon} ${isIncrease ? '+' : ''}R ${formatNumber(Math.round(change.difference))} (${change.percentChange}%)
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="price-update-checkbox" data-index="${index}" checked>
                                    <span style="font-size: 0.9rem;">Update</span>
                                </label>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                applyBtn.style.display = 'inline-block';
            }

            // New Products Section
            if (analysisResults.newProducts.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">ðŸ†• New Products Detected (${analysisResults.newProducts.length})</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">Product Name</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">SKU</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Price</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.2);">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                analysisResults.newProducts.forEach((product, index) => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">${product.name}</td>
                            <td style="padding: 0.75rem; font-family: monospace;">${product.sku}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">R ${formatNumber(Math.round(product.price))}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button type="button" class="btn btn-sm btn-primary" onclick="addNewProductFromScan(${index})">
                                    âž• Add to Catalog
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // No changes detected
            if (analysisResults.priceChanges.length === 0 && analysisResults.newProducts.length === 0) {
                html = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ”</div>
                        <div style="font-size: 1.1rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">No Products Detected</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.5);">
                            Could not identify any products or prices on this invoice.<br>
                            The invoice format may not be recognized, or the OCR quality may be low.
                        </div>
                        <button type="button" class="btn btn-outline" onclick="resetScanner(); closeModal('invoiceAnalysisModal');" style="margin-top: 1rem;">
                            Try Again
                        </button>
                    </div>
                `;
            }

            resultDiv.innerHTML = html;
        }

        function resetScanner() {
            stopCamera();
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('capturedImageView').style.display = 'none';
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
            document.querySelector('#scannerContent > div').style.display = 'block';
        }

        // Apply Price Updates from Scanned Invoice
        function applyPriceUpdates() {
            const checkboxes = document.querySelectorAll('.price-update-checkbox:checked');
            let updatedCount = 0;

            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const change = analysisResults.priceChanges[index];

                // Find product in catalog and update price
                const productIndex = products.findIndex(p => p.sku === change.product.sku);
                if (productIndex !== -1) {
                    products[productIndex].landedCost = change.newPrice;
                    updatedCount++;
                }
            });

            // Save updated products to localStorage
            if (updatedCount > 0) {
                localStorage.setItem(getBusinessKey('aweh_products'), JSON.stringify(products));
                showToast(`âœ… Updated ${updatedCount} product price${updatedCount > 1 ? 's' : ''}!`, 'success');

                // Log the update
                console.log(`Price update from supplier invoice:`, {
                    supplier: analysisResults.supplier?.name || 'Unknown',
                    updatedProducts: updatedCount,
                    timestamp: new Date().toISOString()
                });
            }

            // Close modal and reset
            closeModal('invoiceAnalysisModal');
            resetScanner();

            // Refresh product display if on products tab
            if (document.querySelector('[onclick="switchTab(\'products\')"]').parentElement.classList.contains('active')) {
                // Trigger product list refresh if needed
                showToast('ðŸ’¡ Product prices updated. Refresh the page to see changes in product list.', 'info');
            }
        }

        // Add New Product from Scanned Invoice
        function addNewProductFromScan(index) {
            const newProduct = analysisResults.newProducts[index];

            // Determine category and brand based on supplier
            let category = 'General';
            let brand = 'Unknown';

            if (analysisResults.supplier) {
                // Try to infer category from supplier
                const supplierName = analysisResults.supplier.name.toLowerCase();
                if (supplierName.includes('awake')) {
                    category = 'Jetboards';
                    brand = 'Awake';
                } else if (supplierName.includes('aqua') || supplierName.includes('marina')) {
                    category = 'Aqua Marina';
                    brand = 'Aqua Marina';
                }

                // Use supplier category if available
                if (analysisResults.supplier.category) {
                    category = analysisResults.supplier.category;
                }
            }

            // Create new product object
            const product = {
                sku: newProduct.sku,
                name: newProduct.name,
                brand: brand,
                category: category,
                landedCost: newProduct.price,
                description: `Imported from supplier invoice on ${new Date().toLocaleDateString()}`
            };

            // Add to products array
            products.push(product);

            // Save to localStorage
            localStorage.setItem(getBusinessKey('aweh_products'), JSON.stringify(products));

            // Remove from new products list
            analysisResults.newProducts.splice(index, 1);

            // Refresh display
            displayProductAnalysisResults();

            showToast(`âœ… Added "${product.name}" to catalog!`, 'success');
        }

        // ============================================
        // MULTI-BUSINESS MANAGEMENT
        // ============================================

        async function loadBusinesses() {
            businesses = await loadFromStorage('aweh_businesses', []);
            if (!Array.isArray(businesses)) {
                businesses = [];
            }
            
            // Remove any duplicate businesses (by id)
            const uniqueBusinesses = [];
            const seenIds = new Set();
            for (const business of businesses) {
                if (!seenIds.has(business.id)) {
                    seenIds.add(business.id);
                    uniqueBusinesses.push(business);
                }
            }
            
            // If duplicates were found, save cleaned list
            if (uniqueBusinesses.length !== businesses.length) {
                console.log(`Removed ${businesses.length - uniqueBusinesses.length} duplicate business(es)`);
                businesses = uniqueBusinesses;
                await saveToStorage('aweh_businesses', businesses);
            }

            // If no businesses exist, create default one
            if (businesses.length === 0) {
                const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
                const defaultJoinCode = 'AWEH-' + Math.random().toString(36).substring(2, 6).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
                businesses.push({
                    id: 'default',
                    name: 'Aweh Be Lekker',
                    tradingAs: '',
                    type: 'retail',
                    regNumber: '',
                    vatNumber: '',
                    createdAt: new Date().toISOString(),
                    // Drive sync ownership - only owner can configure/access Drive
                    ownerEmail: currentUser?.email || null,
                    ownerGoogleId: currentUser?.googleId || null,
                    driveConfigured: false,
                    driveToken: null,
                    // Authorized users who can view data (owner controls this)
                    authorizedUsers: currentUser?.email ? [currentUser.email] : [],
                    // Join code for new users to join this business
                    joinCode: defaultJoinCode
                });
                await saveToStorage('aweh_businesses', businesses);
            }

            // Load current business
            const currentId = localStorage.getItem('aweh_currentBusiness') || 'default';
            currentBusiness = businesses.find(b => b.id === currentId) || businesses[0];

            updateCurrentBusinessDisplay();
            updateHeaderBusiness();
        }

        function updateCurrentBusinessDisplay() {
            if (!currentBusiness) return;

            document.getElementById('currentBusinessName').textContent = currentBusiness.name;

            let details = [];
            if (currentBusiness.tradingAs) details.push(`Trading as: ${currentBusiness.tradingAs}`);
            if (currentBusiness.type) details.push(currentBusiness.type.charAt(0).toUpperCase() + currentBusiness.type.slice(1));
            if (currentBusiness.vatNumber) details.push(`VAT: ${currentBusiness.vatNumber}`);

            document.getElementById('currentBusinessDetails').textContent = details.join(' â€¢ ');

            // Update logo if exists
            if (currentBusiness.logo || settings?.logo) {
                const logo = currentBusiness.logo || settings?.logo;
                document.getElementById('currentBusinessLogo').innerHTML = `<img src="${logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            } else {
                document.getElementById('currentBusinessLogo').textContent = 'ðŸ¢';
            }
            
            // Update dashboard header
            const dashTitle = document.getElementById('dashBusinessTitle');
            const dashLogo = document.getElementById('dashBusinessLogo');
            if (dashTitle && dashboardViewMode === 'current') {
                dashTitle.textContent = currentBusiness.name;
            }
            if (dashLogo && dashboardViewMode === 'current') {
                if (currentBusiness.logo || settings?.logo) {
                    const logo = currentBusiness.logo || settings?.logo;
                    dashLogo.innerHTML = `<img src="${logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px;">`;
                } else {
                    dashLogo.textContent = 'ðŸ¢';
                }
            }
        }
        
        // Clean up duplicate businesses by name (keeps first, removes duplicates)
        async function cleanupDuplicateBusinesses() {
            const uniqueByName = [];
            const seenNames = new Set();
            let duplicatesRemoved = 0;
            
            for (const business of businesses) {
                const normalizedName = business.name.toLowerCase().trim();
                if (!seenNames.has(normalizedName)) {
                    seenNames.add(normalizedName);
                    uniqueByName.push(business);
                } else {
                    duplicatesRemoved++;
                    console.log(`Removing duplicate business: "${business.name}" (id: ${business.id})`);
                }
            }
            
            if (duplicatesRemoved > 0) {
                businesses = uniqueByName;
                await saveToStorage('aweh_businesses', businesses);
                showToast(`âœ… Removed ${duplicatesRemoved} duplicate business(es)`, 'success');
                
                // Reload current business reference
                const currentId = localStorage.getItem('aweh_currentBusiness') || 'default';
                currentBusiness = businesses.find(b => b.id === currentId) || businesses[0];
                
                updateCurrentBusinessDisplay();
                updateHeaderBusiness();
                renderBusinessSwitcherList();
            } else {
                showToast('No duplicate businesses found', 'info');
            }
            
            return duplicatesRemoved;
        }

        function openCreateBusinessModal(editId = null) {
            const modal = document.getElementById('businessModal');
            
            if (editId) {
                // Editing existing business
                const business = businesses.find(b => b.id === editId);
                if (!business) {
                    showToast('Business not found', 'error');
                    return;
                }
                
                document.getElementById('businessName').value = business.name || '';
                document.getElementById('businessTradingAs').value = business.tradingAs || '';
                document.getElementById('businessType').value = business.type || 'retail';
                document.getElementById('businessRegNumber').value = business.regNumber || '';
                document.getElementById('businessVatNumber').value = business.vatNumber || '';
                document.getElementById('businessEmail').value = business.email || '';
                document.getElementById('businessPhone').value = business.phone || '';
                document.getElementById('businessAddress').value = business.address || '';
                
                // Set parent business dropdown (exclude self and children)
                populateParentBusinessDropdown(editId);
                document.getElementById('businessParentId').value = business.parentId || '';
                document.getElementById('businessShareProducts').checked = business.shareProducts || false;
                
                // Set logo preview
                const preview = document.getElementById('businessLogoPreview');
                if (preview) {
                    if (business.logo) {
                        preview.innerHTML = `<img src="${business.logo}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                        preview.dataset.logo = business.logo;
                    } else {
                        preview.innerHTML = '<span style="font-size: 3rem; opacity: 0.5;">ðŸ¢</span>';
                        delete preview.dataset.logo;
                    }
                }
                
                document.getElementById('businessModalTitle').textContent = 'âœï¸ Edit Business';
                modal.dataset.editId = editId;
                
                // Show/hide upgrade section if this is a trading as
                setTimeout(() => updateUpgradeSection(), 100);
            } else {
                // Creating new business - clear all fields
                document.getElementById('businessName').value = '';
                document.getElementById('businessTradingAs').value = '';
                document.getElementById('businessType').value = 'retail';
                document.getElementById('businessRegNumber').value = '';
                document.getElementById('businessVatNumber').value = '';
                document.getElementById('businessEmail').value = '';
                document.getElementById('businessPhone').value = '';
                document.getElementById('businessAddress').value = '';
                
                // Set parent business dropdown
                populateParentBusinessDropdown(null);
                document.getElementById('businessParentId').value = '';
                document.getElementById('businessShareProducts').checked = false;
                
                // Reset logo preview
                const preview = document.getElementById('businessLogoPreview');
                if (preview) {
                    preview.innerHTML = '<span style="font-size: 3rem; opacity: 0.5;">ðŸ¢</span>';
                    delete preview.dataset.logo;
                }
                
                document.getElementById('businessModalTitle').textContent = 'âž• Add New Business';
                delete modal.dataset.editId;
            }

            openModal('businessModal');
        }

        async function saveNewBusiness() {
            const modal = document.getElementById('businessModal');
            const editId = modal?.dataset?.editId;
            const name = document.getElementById('businessName').value.trim();

            if (!name) {
                showToast('Please enter a business name', 'error');
                return;
            }
            
            // Get logo from preview
            const logoPreview = document.getElementById('businessLogoPreview');
            const logo = logoPreview?.dataset?.logo || '';
            
            // Get all field values
            const businessData = {
                name: name,
                tradingAs: document.getElementById('businessTradingAs').value.trim(),
                type: document.getElementById('businessType').value,
                regNumber: document.getElementById('businessRegNumber').value.trim(),
                vatNumber: document.getElementById('businessVatNumber').value.trim(),
                email: document.getElementById('businessEmail').value.trim(),
                phone: document.getElementById('businessPhone').value.trim(),
                address: document.getElementById('businessAddress').value.trim(),
                logo: logo,
                parentId: document.getElementById('businessParentId').value || null,
                shareProducts: document.getElementById('businessShareProducts').checked
            };
            
            if (editId) {
                // Updating existing business
                const businessIndex = businesses.findIndex(b => b.id === editId);
                if (businessIndex !== -1) {
                    // Update the business in the array
                    businesses[businessIndex] = {
                        ...businesses[businessIndex],
                        ...businessData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await saveToStorage('aweh_businesses', businesses);

                    // Keep this business' settings identity in sync with the edited business entity.
                    try {
                        const settingsKey = `aweh_settings_${editId}`;
                        const existingSettings = await loadFromStorage(settingsKey, null);
                        const nextSettings = (existingSettings && typeof existingSettings === 'object') ? existingSettings : {};
                        nextSettings.companyName = businesses[businessIndex].name || nextSettings.companyName || '';
                        nextSettings.tradingAs = businesses[businessIndex].tradingAs || nextSettings.tradingAs || '';
                        nextSettings.email = businesses[businessIndex].email || nextSettings.email || '';
                        nextSettings.phone = businesses[businessIndex].phone || nextSettings.phone || '';
                        nextSettings.address = businesses[businessIndex].address || nextSettings.address || '';
                        nextSettings.vat = businesses[businessIndex].vatNumber || nextSettings.vat || '';
                        nextSettings.logo = businesses[businessIndex].logo || nextSettings.logo || '';
                        await saveToStorage(settingsKey, nextSettings);
                    } catch (e) {
                        console.warn('Failed to sync business settings identity from edit:', e);
                    }

                    showToast(`âœ… Business "${name}" updated successfully!`, 'success');
                    
                    // Update displays if this is the current business
                    if (currentBusiness?.id === editId) {
                        currentBusiness = businesses[businessIndex];
                        updateCurrentBusinessDisplay();
                        updateHeaderBusiness();
                    }
                    
                    // Refresh business switcher to show updated name
                    renderBusinessSwitcherList();
                    
                    closeModal('businessModal');
                    return;
                }
            }

            // Creating new business
            const currentUser = JSON.parse(localStorage.getItem('aweh_user') || 'null');
            const newBusiness = {
                id: 'business_' + Date.now(),
                ...businessData,
                createdAt: new Date().toISOString(),
                // Auto-generate join code for new users
                joinCode: generateJoinCode(),
                // Set creator as owner
                ownerEmail: currentUser?.email || null,
                ownerGoogleId: currentUser?.googleId || null,
                authorizedUsers: currentUser?.email ? [currentUser.email] : [],
                driveConfigured: false
            };

            businesses.push(newBusiness);
            await saveToStorage('aweh_businesses', businesses);

            showToast(`âœ… Business "${name}" created successfully!`, 'success');
            closeModal('businessModal');
            
            // Refresh business switcher dropdown
            renderBusinessSwitcherList();

            // Ask if user wants to switch to new business
            if (confirm(`Switch to "${name}" now?`)) {
                switchToBusiness(newBusiness.id);
            }
        }
        
        // Populate parent business dropdown (excluding self and children to prevent circular references)
        function populateParentBusinessDropdown(excludeId = null) {
            const select = document.getElementById('businessParentId');
            if (!select) return;
            
            // Get IDs to exclude (self and any children)
            const excludeIds = new Set();
            if (excludeId) {
                excludeIds.add(excludeId);
                // Exclude children
                businesses.forEach(b => {
                    if (b.parentId === excludeId) excludeIds.add(b.id);
                });
            }
            
            select.innerHTML = '<option value="">-- Independent Business (No Link) --</option>';
            
            businesses.forEach(business => {
                if (!excludeIds.has(business.id)) {
                    const linkedCount = businesses.filter(b => b.parentId === business.id).length;
                    const linkedText = linkedCount > 0 ? ` (${linkedCount} linked)` : '';
                    select.innerHTML += `<option value="${business.id}">${business.name}${linkedText}</option>`;
                }
            });
        }

        // Show/hide upgrade trading as section based on whether business has parent
        function updateUpgradeSection() {
            const modal = document.getElementById('businessModal');
            const editId = modal?.dataset?.editId;
            const upgradeSection = document.getElementById('upgradeTradeSection');
            
            if (editId) {
                const business = businesses.find(b => b.id === editId);
                if (business && business.parentId) {
                    // This is a trading as business, show upgrade option
                    upgradeSection.style.display = 'block';
                    document.getElementById('businessUpgradeRegNumber').value = business.regNumber || '';
                } else {
                    upgradeSection.style.display = 'none';
                }
            } else {
                upgradeSection.style.display = 'none';
            }
        }

        // Confirm upgrade trading as to registered entity
        async function confirmUpgradeTradingAs() {
            const modal = document.getElementById('businessModal');
            const editId = modal?.dataset?.editId;
            
            if (!editId) {
                showToast('No business selected', 'error');
                return;
            }
            
            const business = businesses.find(b => b.id === editId);
            if (!business) {
                showToast('Business not found', 'error');
                return;
            }
            
            if (!business.parentId) {
                showToast('This business is not a Trading As entity', 'error');
                return;
            }
            
            const parentBusiness = businesses.find(b => b.id === business.parentId);
            const confirmMsg = `Are you sure you want to upgrade "${business.name}" to an independent registered entity?
                
This will:
âœ“ Remove the link to ${parentBusiness?.name}
âœ“ Keep all invoices, customers, and data intact
âœ“ Make this a separate business for reporting

This action cannot be undone.`;
            
            if (confirm(confirmMsg)) {
                // Get new reg number if provided
                const newRegNumber = document.getElementById('businessUpgradeRegNumber').value.trim();
                
                // Upgrade the business
                business.parentId = null;
                if (newRegNumber) {
                    business.regNumber = newRegNumber;
                }
                business.updatedAt = new Date().toISOString();
                
                // Save to storage
                await saveToStorage('aweh_businesses', businesses);
                
                // Log the action
                console.log(`âœ… Business "${business.name}" upgraded from Trading As to independent entity`);
                
                showToast(`âœ… "${business.name}" is now an independent registered entity!`, 'success');
                
                // Close and refresh
                closeModal('businessModal');
                renderBusinessSwitcherList();
                
                // Update current business display if this is the current business
                if (currentBusiness?.id === editId) {
                    currentBusiness = business;
                    updateCurrentBusinessDisplay();
                    updateHeaderBusiness();
                }
            }
        }

        function openSwitchBusinessModal() {
            const listDiv = document.getElementById('businessSwitchList');

            listDiv.innerHTML = businesses.map(business => {
                const isActive = business.id === currentBusiness.id;
                const logoHtml = business.logo 
                    ? `<img src="${business.logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">` 
                    : 'ðŸ¢';
                
                // Get linked businesses info
                const childCount = businesses.filter(b => b.parentId === business.id).length;
                const parentBusiness = business.parentId ? businesses.find(b => b.id === business.parentId) : null;
                
                let linkInfo = '';
                if (parentBusiness) {
                    linkInfo = `<span style="color: var(--primary); font-size: 0.8rem;">ðŸ”— Linked to ${parentBusiness.name}</span>`;
                } else if (childCount > 0) {
                    linkInfo = `<span style="color: var(--success); font-size: 0.8rem;">ðŸ‘¥ ${childCount} linked business${childCount > 1 ? 'es' : ''}</span>`;
                }
                
                return `
                    <div style="padding: 1rem; background: ${isActive ? 'rgba(0, 212, 255, 0.2)' : 'rgba(0,0,0,0.3)'}; border-radius: 8px; border: 2px solid ${isActive ? 'var(--primary)' : 'transparent'}; cursor: pointer; transition: all 0.3s; margin-bottom: 0.5rem;" onclick="switchToBusiness('${business.id}')">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: ${business.logo ? 'transparent' : 'var(--primary)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden;">
                                ${logoHtml}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    ${business.name} ${isActive ? '<span style="color: var(--success); font-size: 0.9rem;">âœ“ Active</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                    ${business.tradingAs ? business.tradingAs + ' â€¢ ' : ''}${business.type ? business.type.charAt(0).toUpperCase() + business.type.slice(1) : 'Business'}
                                    ${business.vatNumber ? ' â€¢ VAT: ' + business.vatNumber : ''}
                                </div>
                                ${linkInfo ? `<div style="margin-top: 0.25rem;">${linkInfo}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-outline btn-sm" onclick="event.stopPropagation(); closeModal('switchBusinessModal'); openCreateBusinessModal('${business.id}')" title="Edit">âœï¸</button>
                                ${!isActive ? `<button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); switchToBusiness('${business.id}')">Switch</button>` : ''}
                                ${business.id !== 'default' ? `<button type="button" class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteBusiness('${business.id}')" title="Delete">ðŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            openModal('switchBusinessModal');
        }

        function switchToBusiness(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (!business) {
                showToast('Business not found', 'error');
                return;
            }

            // Do NOT auto-save settings on switch.
            // Auto-saving here can copy another business' default/company details into this business.

            // Switch to new business
            currentBusiness = business;
            localStorage.setItem('aweh_currentBusiness', businessId);

            // Load settings for new business
            loadSettings();

            // Update display
            updateCurrentBusinessDisplay();

            showToast(`âœ… Switched to "${business.name}"`, 'success');
            closeModal('switchBusinessModal');

            // Reload page to refresh all data
            setTimeout(() => {
                location.reload();
            }, 500);
        }
        
        // Business logo preview - Enhanced with validation
        function previewBusinessLogo(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Logo file must be under 5MB', 'error');
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.match(/^image\/(png|jpeg|jpg|gif|webp)$/)) {
                    showToast('Please upload a valid image file (PNG, JPG, GIF, WebP)', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onerror = function() {
                    showToast('Error reading file. Please try again.', 'error');
                };
                reader.onload = function(e) {
                    const preview = document.getElementById('businessLogoPreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                        preview.dataset.logo = e.target.result;
                        console.log('[Business Logo] Preview updated, data length:', e.target.result.length);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Delete a business
        async function deleteBusiness(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (!business) return;
            
            if (businessId === 'default') {
                showToast('Cannot delete the default business', 'error');
                return;
            }
            
            if (currentBusiness.id === businessId) {
                showToast('Cannot delete the currently active business. Switch first.', 'error');
                return;
            }
            
            if (!confirm(`âš ï¸ Delete "${business.name}"?\\n\\nThis will permanently delete:\\nâ€¢ All invoices\\nâ€¢ All customers\\nâ€¢ All settings\\n\\nThis cannot be undone!`)) {
                return;
            }
            
            // Remove from businesses array
            businesses = businesses.filter(b => b.id !== businessId);
            await saveToStorage('aweh_businesses', businesses);
            
            // Clear all data for this business
            localStorage.removeItem(`aweh_invoices_${businessId}`);
            localStorage.removeItem(`aweh_customers_${businessId}`);
            localStorage.removeItem(`aweh_suppliers_${businessId}`);
            localStorage.removeItem(`aweh_settings_${businessId}`);
            localStorage.removeItem(`aweh_favorites_${businessId}`);
            
            showToast(`âœ… "${business.name}" deleted`, 'success');
            openSwitchBusinessModal(); // Refresh the list
        }
        
        // Open merge business modal
        function openMergeBusinessModal() {
            closeModal('switchBusinessModal');
            
            const sourceSelect = document.getElementById('mergeSourceBusiness');
            const targetSelect = document.getElementById('mergeTargetBusiness');
            
            const options = businesses.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            sourceSelect.innerHTML = '<option value="">Select source...</option>' + options;
            targetSelect.innerHTML = '<option value="">Select target...</option>' + options;
            
            openModal('mergeBusinessModal');
        }
        
        // Execute business merge
        async function executeBusinessMerge() {
            const sourceId = document.getElementById('mergeSourceBusiness').value;
            const targetId = document.getElementById('mergeTargetBusiness').value;
            const deleteSource = document.getElementById('deleteSourceAfterMerge').checked;
            
            if (!sourceId || !targetId) {
                showToast('Please select both source and target businesses', 'error');
                return;
            }
            
            if (sourceId === targetId) {
                showToast('Source and target must be different', 'error');
                return;
            }
            
            const source = businesses.find(b => b.id === sourceId);
            const target = businesses.find(b => b.id === targetId);
            
            if (!confirm(`Merge all data from "${source.name}" into "${target.name}"?\\n\\nThis will combine:\\nâ€¢ All invoices\\nâ€¢ All customers\\nâ€¢ All suppliers\\n\\n${deleteSource ? 'The source business will be deleted after merge.' : 'The source business will remain.'}`)) {
                return;
            }
            
            showToast('Merging businesses...', 'info');
            
            try {
                // Load source data
                const sourceInvoices = await loadFromStorage(`aweh_invoices_${sourceId}`, []);
                const sourceCustomers = await loadFromStorage(`aweh_customers_${sourceId}`, []);
                const sourceSuppliers = await loadFromStorage(`aweh_suppliers_${sourceId}`, []);
                
                // Load target data
                const targetInvoices = await loadFromStorage(`aweh_invoices_${targetId}`, []);
                const targetCustomers = await loadFromStorage(`aweh_customers_${targetId}`, []);
                const targetSuppliers = await loadFromStorage(`aweh_suppliers_${targetId}`, []);
                
                // Merge (avoiding duplicates by ID)
                const existingInvoiceIds = new Set(targetInvoices.map(i => i.id));
                const existingCustomerIds = new Set(targetCustomers.map(c => c.id));
                const existingSupplierIds = new Set(targetSuppliers.map(s => s.id));
                
                const mergedInvoices = [...targetInvoices, ...sourceInvoices.filter(i => !existingInvoiceIds.has(i.id))];
                const mergedCustomers = [...targetCustomers, ...sourceCustomers.filter(c => !existingCustomerIds.has(c.id))];
                const mergedSuppliers = [...targetSuppliers, ...sourceSuppliers.filter(s => !existingSupplierIds.has(s.id))];
                
                // Save merged data to target
                await saveToStorage(`aweh_invoices_${targetId}`, mergedInvoices);
                await saveToStorage(`aweh_customers_${targetId}`, mergedCustomers);
                await saveToStorage(`aweh_suppliers_${targetId}`, mergedSuppliers);
                
                // Optionally delete source business
                if (deleteSource) {
                    businesses = businesses.filter(b => b.id !== sourceId);
                    await saveToStorage('aweh_businesses', businesses);
                    
                    // Clear source data
                    localStorage.removeItem(`aweh_invoices_${sourceId}`);
                    localStorage.removeItem(`aweh_customers_${sourceId}`);
                    localStorage.removeItem(`aweh_suppliers_${sourceId}`);
                    localStorage.removeItem(`aweh_settings_${sourceId}`);
                }
                
                closeModal('mergeBusinessModal');
                showToast(`âœ… Merged ${sourceInvoices.length} invoices, ${sourceCustomers.length} customers, ${sourceSuppliers.length} suppliers`, 'success');
                
                // Switch to target business
                if (confirm(`Switch to "${target.name}" now?`)) {
                    localStorage.setItem('aweh_currentBusiness', targetId);
                    location.reload();
                }
            } catch (error) {
                console.error('Merge error:', error);
                showToast('Merge failed: ' + error.message, 'error');
            }
        }
        

        // ============================================
        // AI SMART FUNCTIONS
        // ============================================

        // Customer Selection AI
        function onCustomerSelected() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                document.getElementById('aiQuickActions').style.display = 'none';
                document.getElementById('customerInsight').style.display = 'none';
                document.getElementById('tierSuggestion').style.display = 'none';
                document.getElementById('aiSuggestionsBar').style.display = 'none';
                return;
            }

            const customer = customers.find(c => c.id == customerId);
            if (!customer) return;

            // Show quick actions
            document.getElementById('aiQuickActions').style.display = 'block';

            // Get customer insights
            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);
            const insights = analyzeCustomer(customerId);

            // Show customer insight
            const insightEl = document.getElementById('customerInsight');
            if (customerInvoices.length > 0) {
                insightEl.textContent = `ðŸ’¡ ${customerInvoices.length} previous invoice${customerInvoices.length > 1 ? 's' : ''} â€¢ Avg: R ${formatNumber(insights.avgInvoiceValue)} â€¢ Last: ${insights.daysSinceLastInvoice} days ago`;
                insightEl.style.display = 'block';
            }

            // Suggest pricing tier
            if (customer.pricingTier && customer.pricingTier !== document.getElementById('invoiceTier').value) {
                const tierEl = document.getElementById('tierSuggestion');
                tierEl.textContent = `ðŸ’¡ This customer usually uses "${customer.pricingTier}" tier`;
                tierEl.style.display = 'block';

                // Auto-select customer's preferred tier
                document.getElementById('invoiceTier').value = customer.pricingTier;
            }

            // Check for duplicate risk
            checkDuplicateRisk(customerId);

            // Show AI suggestions
            showAISuggestions(customerId, insights);

            // Predict payment date
            predictPaymentDate(customerId);
        }

        function analyzeCustomer(customerId) {
            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);

            if (customerInvoices.length === 0) {
                return {
                    avgInvoiceValue: 0,
                    totalRevenue: 0,
                    invoiceCount: 0,
                    daysSinceLastInvoice: null,
                    avgPaymentDays: null,
                    commonProducts: [],
                    preferredTier: null
                };
            }

            // Calculate average invoice value
            const totalRevenue = customerInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const avgInvoiceValue = totalRevenue / customerInvoices.length;

            // Days since last invoice
            const lastInvoice = customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            const daysSinceLastInvoice = Math.floor((new Date() - new Date(lastInvoice.date)) / (1000 * 60 * 60 * 24));

            // Average payment days
            const paidInvoices = customerInvoices.filter(inv => inv.status === 'paid' && inv.payments && inv.payments.length > 0);
            let avgPaymentDays = null;
            if (paidInvoices.length > 0) {
                const paymentDays = paidInvoices.map(inv => {
                    const invoiceDate = new Date(inv.date);
                    const paymentDate = new Date(inv.payments[0].date);
                    return Math.floor((paymentDate - invoiceDate) / (1000 * 60 * 60 * 24));
                });
                avgPaymentDays = Math.round(paymentDays.reduce((sum, days) => sum + days, 0) / paymentDays.length);
            }

            // Find common products
            const productFrequency = {};
            customerInvoices.forEach(inv => {
                if (inv.items) {
                    inv.items.forEach(item => {
                        productFrequency[item.sku] = (productFrequency[item.sku] || 0) + 1;
                    });
                }
            });

            const commonProducts = Object.entries(productFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([sku, count]) => ({ sku, count }));

            return {
                avgInvoiceValue,
                totalRevenue,
                invoiceCount: customerInvoices.length,
                daysSinceLastInvoice,
                avgPaymentDays,
                commonProducts,
                preferredTier: lastInvoice.tier || null
            };
        }

        function showAISuggestions(customerId, insights) {
            const suggestionsBar = document.getElementById('aiSuggestionsBar');
            const suggestionsContent = document.getElementById('aiSuggestionsContent');

            const suggestions = [];

            // Suggest based on time since last invoice
            if (insights.daysSinceLastInvoice !== null) {
                if (insights.daysSinceLastInvoice > 90) {
                    suggestions.push(`â° It's been ${insights.daysSinceLastInvoice} days since last order. Consider offering a special discount to re-engage.`);
                } else if (insights.daysSinceLastInvoice < 7) {
                    suggestions.push(`âš ï¸ Last invoice was only ${insights.daysSinceLastInvoice} days ago. Check for potential duplicate.`);
                }
            }

            // Suggest based on payment history
            if (insights.avgPaymentDays !== null) {
                if (insights.avgPaymentDays > 45) {
                    suggestions.push(`ðŸ’° This customer typically pays in ${insights.avgPaymentDays} days. Consider shorter payment terms or upfront deposit.`);
                } else if (insights.avgPaymentDays < 15) {
                    suggestions.push(`âœ… Great payer! Average payment time: ${insights.avgPaymentDays} days.`);
                }
            }

            // Suggest based on order value
            if (insights.avgInvoiceValue > 0) {
                suggestions.push(`ðŸ“Š Average order value: R ${formatNumber(insights.avgInvoiceValue)}. Total lifetime value: R ${formatNumber(insights.totalRevenue)}`);
            }

            if (suggestions.length > 0) {
                suggestionsContent.innerHTML = suggestions.map(s => `<div style="padding: 0.25rem 0;">${s}</div>`).join('');
                suggestionsBar.style.display = 'block';
            } else {
                suggestionsBar.style.display = 'none';
            }
        }

        function checkDuplicateRisk(customerId) {
            const recentInvoices = invoices.filter(inv => {
                const daysSince = Math.floor((new Date() - new Date(inv.date)) / (1000 * 60 * 60 * 24));
                return inv.customerId == customerId && daysSince < 7;
            });

            if (recentInvoices.length > 0) {
                const lastInvoice = recentInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                // Show duplicate warning modal with options
                showDuplicateWarningModal(lastInvoice, recentInvoices.length, customerId);
            }
            return true;
        }
        
        function showDuplicateWarningModal(lastInvoice, invoiceCount, customerId) {
            // Create warning modal
            const existingWarning = document.getElementById('duplicateWarningModal');
            if (existingWarning) existingWarning.remove();
            
            const customer = customers.find(c => c.id == customerId);
            const customerName = customer ? customer.name : 'Customer';
            
            const warningModal = document.createElement('div');
            warningModal.id = 'duplicateWarningModal';
            warningModal.innerHTML = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: rgba(10, 14, 39, 0.98); border: 2px solid rgba(255, 165, 0, 0.5); border-radius: 16px; padding: 2rem; max-width: 500px; width: 100%; box-shadow: 0 0 40px rgba(255, 165, 0, 0.2);">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <span style="font-size: 3rem;">âš ï¸</span>
                            <h3 style="color: var(--warning); margin-top: 1rem;">Recent Invoice Found!</h3>
                        </div>
                        
                        <p style="margin-bottom: 1rem; text-align: center; opacity: 0.9;">
                            <strong>${customerName}</strong> has <strong>${invoiceCount}</strong> invoice(s) in the last 7 days.
                        </p>
                        
                        <div style="background: rgba(255,165,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <p style="margin-bottom: 0.5rem;"><strong>Last Invoice:</strong> #${lastInvoice.number}</p>
                            <p style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${lastInvoice.date}</p>
                            <p style="margin-bottom: 0.5rem;"><strong>Amount:</strong> R ${formatNumber(lastInvoice.total)}</p>
                            <p><strong>Status:</strong> ${lastInvoice.status || 'draft'}</p>
                        </div>
                        
                        <p style="text-align: center; font-size: 0.95rem; margin-bottom: 1.5rem;">What would you like to do?</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button onclick="closeDuplicateWarning(); editInvoice(${lastInvoice.id})" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                                âœï¸ Edit Existing Invoice #${lastInvoice.number}
                            </button>
                            <button onclick="closeDuplicateWarning()" class="btn btn-success" style="width: 100%; padding: 1rem;">
                                âž• Continue Creating New Invoice
                            </button>
                            <button onclick="closeDuplicateWarning(); closeModal('invoiceModal')" class="btn btn-outline" style="width: 100%; padding: 0.75rem;">
                                âŒ Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(warningModal);
        }
        
        function closeDuplicateWarning() {
            const modal = document.getElementById('duplicateWarningModal');
            if (modal) modal.remove();
        }

        function predictPaymentDate(customerId) {
            const insights = analyzeCustomer(customerId);

            if (insights.avgPaymentDays !== null) {
                const invoiceDate = document.getElementById('invoiceDate').value || new Date().toISOString().split('T')[0];
                const predictedDate = new Date(invoiceDate);
                predictedDate.setDate(predictedDate.getDate() + insights.avgPaymentDays);

                // Show prediction in due date field hint
                const dueDateField = document.getElementById('invoiceDueDate');
                dueDateField.title = `ðŸ’¡ Predicted payment date based on history: ${predictedDate.toISOString().split('T')[0]} (${insights.avgPaymentDays} days)`;
            }
        }

        // Quick Actions
        function repeatLastInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);
            if (customerInvoices.length === 0) {
                showToast('No previous invoices found for this customer', 'info');
                return;
            }

            // Get last invoice
            const lastInvoice = customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            // Copy items
            if (lastInvoice.items && lastInvoice.items.length > 0) {
                currentInvoice.items = JSON.parse(JSON.stringify(lastInvoice.items));
                renderInvoiceItems();
                calculateInvoiceTotal();
                showToast(`Added ${lastInvoice.items.length} items from last invoice`, 'success');
            } else {
                showToast('Last invoice has no items', 'info');
            }
        }

        function addRecommendedProducts() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const insights = analyzeCustomer(customerId);

            if (insights.commonProducts.length === 0) {
                showToast('No product history found for this customer', 'info');
                return;
            }

            // Add top 3 most common products
            let added = 0;
            insights.commonProducts.slice(0, 3).forEach(({ sku }) => {
                const product = products.find(p => p.sku === sku);
                if (product && !currentInvoice.items.find(item => item.sku === sku)) {
                    addProductToInvoiceFromSearch(sku);
                    added++;
                }
            });

            if (added > 0) {
                showToast(`Added ${added} commonly ordered product(s)`, 'success');
            } else {
                showToast('All common products already added', 'info');
            }
        }

        function showCustomerHistory() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const customer = customers.find(c => c.id == customerId);
            const insights = analyzeCustomer(customerId);

            let historyHTML = `
                <strong>${customer.name}</strong><br><br>
                ðŸ“Š Total Invoices: ${insights.invoiceCount}<br>
                ðŸ’° Total Revenue: R ${formatNumber(insights.totalRevenue)}<br>
                ðŸ“ˆ Average Invoice: R ${formatNumber(insights.avgInvoiceValue)}<br>
            `;

            if (insights.daysSinceLastInvoice !== null) {
                historyHTML += `â° Last Invoice: ${insights.daysSinceLastInvoice} days ago<br>`;
            }

            if (insights.avgPaymentDays !== null) {
                historyHTML += `ðŸ’³ Avg Payment Time: ${insights.avgPaymentDays} days<br>`;
            }

            if (insights.commonProducts.length > 0) {
                historyHTML += `<br><strong>Most Ordered Products:</strong><br>`;
                insights.commonProducts.forEach(({ sku, count }) => {
                    const product = products.find(p => p.sku === sku);
                    if (product) {
                        historyHTML += `â€¢ ${product.name} (${count}x)<br>`;
                    }
                });
            }

            alert(historyHTML.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, ''));
        }

        // Product Recommendations AI
        function showProductRecommendations() {
            if (currentInvoice.items.length === 0) {
                document.getElementById('aiProductRecommendations').style.display = 'none';
                return;
            }

            // Get SKUs of current items
            const currentSKUs = currentInvoice.items.map(item => item.sku);

            // Find products that are frequently bought together
            const recommendations = findRelatedProducts(currentSKUs);

            if (recommendations.length === 0) {
                document.getElementById('aiProductRecommendations').style.display = 'none';
                return;
            }

            // Show recommendations
            const listEl = document.getElementById('recommendedProductsList');
            listEl.innerHTML = recommendations.slice(0, 5).map(({ product, score }) => `
                <button type="button" class="btn btn-outline btn-sm" onclick="addProductToInvoiceFromSearch('${product.sku}')" title="Add ${product.name}">
                    âž• ${product.name.length > 30 ? product.name.substring(0, 30) + '...' : product.name}
                </button>
            `).join('');

            document.getElementById('aiProductRecommendations').style.display = 'block';
        }

        function findRelatedProducts(currentSKUs) {
            // Find invoices that contain any of the current products
            const relatedInvoices = invoices.filter(inv =>
                inv.items && inv.items.some(item => currentSKUs.includes(item.sku))
            );

            // Count frequency of other products in those invoices
            const productFrequency = {};
            relatedInvoices.forEach(inv => {
                inv.items.forEach(item => {
                    if (!currentSKUs.includes(item.sku) && !currentInvoice.items.find(i => i.sku === item.sku)) {
                        productFrequency[item.sku] = (productFrequency[item.sku] || 0) + 1;
                    }
                });
            });

            // Convert to array and sort by frequency
            const recommendations = Object.entries(productFrequency)
                .map(([sku, count]) => {
                    const product = products.find(p => p.sku === sku);
                    return product ? { product, score: count } : null;
                })
                .filter(r => r !== null)
                .sort((a, b) => b.score - a.score);

            return recommendations;
        }

        function onPricingTierChanged() {
            // Recalculate all prices when tier changes
            if (currentInvoice.items.length > 0) {
                renderInvoiceItems();
                calculateInvoiceTotal();
            }
        }
    </script>

    <!-- Tesseract.js OCR Library -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <!-- Google API Client Library for Google Drive Integration -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Microsoft Authentication Library (MSAL) for OneDrive -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

    <!-- Google Drive Sync Module -->
    <script src="google-drive-sync.js"></script>
    
    <!-- Fallback: ensure driveStorage exists even if external script fails to load -->
    <script>
        if (typeof driveStorage === 'undefined') {
            console.warn('google-drive-sync.js failed to load - creating stub driveStorage');
            window.driveStorage = {
                isSignedIn: false,
                disabled: true,
                init: function() { return Promise.resolve(); },
                signIn: function() { 
                    alert('Google Drive sync is not available. The sync module failed to load.\\n\\nYour data is saved locally to your browser.');
                    return Promise.resolve(false);
                },
                signOut: function() { return Promise.resolve(true); },
                isClientConfigured: function() { return false; },
                syncAll: function() { return Promise.resolve(); },
                ensureFolder: function() { return Promise.resolve(); },
                updateSyncStatus: function(msg, type) { console.log('[DriveSync Stub]', msg); },
                getItem: function(key, defaultValue) { 
                    try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } 
                    catch(e) { return defaultValue; }
                },
                setItem: function(key, value) { 
                    try { localStorage.setItem(key, JSON.stringify(value)); } 
                    catch(e) { console.error('localStorage setItem failed:', e); }
                }
            };
        }
        
        // ==================== CLOUD SYNC MENU & ONEDRIVE ====================
        
        function toggleCloudSyncMenu() {
            const menu = document.getElementById('cloudSyncMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('cloudSyncMenu');
            const btn = document.getElementById('syncCloudBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        // OneDrive Sync Module
        const onedriveStorage = {
            isSignedIn: false,
            accessToken: null,
            
            async init() {
                // Check for saved token
                const currentUser = JSON.parse(localStorage.getItem('conicore_user') || '{}');
                if (currentUser.microsoftToken) {
                    this.accessToken = currentUser.microsoftToken;
                    this.isSignedIn = true;
                }
            },
            
            async signIn() {
                const msClientId = localStorage.getItem('microsoft_client_id');
                if (!msClientId) {
                    showToast('Please set up Microsoft login first on the login page.', 'warning');
                    return false;
                }
                
                try {
                    // Use MSAL for token acquisition
                    if (typeof msal !== 'undefined') {
                        const msalConfig = {
                            auth: {
                                clientId: msClientId,
                                authority: 'https://login.microsoftonline.com/common',
                                redirectUri: window.location.origin + '/'
                            }
                        };
                        
                        const msalInstance = new msal.PublicClientApplication(msalConfig);
                        
                        const tokenResponse = await msalInstance.loginPopup({
                            scopes: ['Files.ReadWrite', 'User.Read']
                        });
                        
                        if (tokenResponse && tokenResponse.accessToken) {
                            this.accessToken = tokenResponse.accessToken;
                            this.isSignedIn = true;
                            
                            // Save token
                            const currentUser = JSON.parse(localStorage.getItem('conicore_user') || '{}');
                            currentUser.microsoftToken = tokenResponse.accessToken;
                            localStorage.setItem('conicore_user', JSON.stringify(currentUser));
                            
                            return true;
                        }
                    } else {
                        showToast('Microsoft authentication library not loaded.', 'error');
                    }
                } catch (error) {
                    console.error('OneDrive sign in error:', error);
                    showToast('OneDrive sign in failed: ' + error.message, 'error');
                }
                return false;
            },
            
            async ensureFolder() {
                if (!this.accessToken) return null;
                
                try {
                    // Check if ConiCore folder exists
                    const checkResponse = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children?$filter=name eq \'ConiCore Invoicing\'', {
                        headers: { 'Authorization': 'Bearer ' + this.accessToken }
                    });
                    const checkData = await checkResponse.json();
                    
                    if (checkData.value && checkData.value.length > 0) {
                        return checkData.value[0].id;
                    }
                    
                    // Create folder
                    const createResponse = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + this.accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: 'ConiCore Invoicing',
                            folder: {},
                            '@microsoft.graph.conflictBehavior': 'fail'
                        })
                    });
                    
                    if (createResponse.ok) {
                        const folder = await createResponse.json();
                        return folder.id;
                    }
                } catch (error) {
                    console.error('OneDrive folder error:', error);
                }
                return null;
            },
            
            async uploadData(filename, data) {
                if (!this.accessToken) return false;
                
                try {
                    const folderId = await this.ensureFolder();
                    if (!folderId) return false;
                    
                    const content = JSON.stringify(data, null, 2);
                    
                    const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${folderId}:/${filename}:/content`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + this.accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: content
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('OneDrive upload error:', error);
                }
                return false;
            },
            
            async downloadData(filename) {
                if (!this.accessToken) return null;
                
                try {
                    const folderId = await this.ensureFolder();
                    if (!folderId) return null;
                    
                    const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${folderId}:/${filename}:/content`, {
                        headers: { 'Authorization': 'Bearer ' + this.accessToken }
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.error('OneDrive download error:', error);
                }
                return null;
            },
            
            async syncAll() {
                if (!this.isSignedIn) {
                    const success = await this.signIn();
                    if (!success) return;
                }
                
                showToast('â³ Syncing to OneDrive...', 'info');
                
                try {
                    // Sync all main data
                    const dataKeys = ['conicore_invoices', 'conicore_customers', 'conicore_products', 'conicore_businesses', 'conicore_users'];
                    
                    for (const key of dataKeys) {
                        const data = JSON.parse(localStorage.getItem(key) || localStorage.getItem(key.replace('conicore_', 'aweh_')) || '[]');
                        if (data.length > 0) {
                            await this.uploadData(key + '.json', data);
                        }
                    }
                    
                    showToast('âœ… Synced to OneDrive!', 'success');
                    updateSyncIcon('onedrive');
                } catch (error) {
                    console.error('OneDrive sync error:', error);
                    showToast('OneDrive sync failed', 'error');
                }
            }
        };
        
        async function syncOneDrive() {
            document.getElementById('cloudSyncMenu').style.display = 'none';
            await onedriveStorage.syncAll();
        }
        
        function updateSyncIcon(provider) {
            const icon = document.getElementById('syncStatusIcon');
            if (icon) {
                if (provider === 'google') {
                    icon.innerHTML = 'ðŸŸ¢';
                } else if (provider === 'onedrive') {
                    icon.innerHTML = 'ðŸ”µ';
                } else {
                    icon.innerHTML = 'â˜ï¸';
                }
            }
        }
        
        // Initialize OneDrive on load
        onedriveStorage.init();
        
    </script>

    <!-- Mobile Floating Action Button -->
    <div class="fab-container" id="fabContainer">
        <button class="fab" onclick="openQuickActionMenu()" aria-label="Quick actions" title="Quick Actions">
            âž•
        </button>
    </div>
    
    <!-- Quick Action Menu (Mobile) -->
    <div id="quickActionMenu" style="display: none; position: fixed; bottom: 160px; right: 1rem; z-index: 100; background: var(--card-bg, rgba(10, 14, 39, 0.98)); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(0, 212, 255, 0.3); padding: 0.5rem; min-width: 180px;">
        <button onclick="openCreateInvoiceModal(); closeQuickActionMenu()" class="btn btn-outline" style="width: 100%; justify-content: flex-start; margin-bottom: 0.5rem;">
            ðŸ“ New Invoice
        </button>
        <button onclick="openModal('customerModal'); closeQuickActionMenu()" class="btn btn-outline" style="width: 100%; justify-content: flex-start; margin-bottom: 0.5rem;">
            ðŸ‘¤ Add Customer
        </button>
        <button onclick="openModal('quickScanModal'); closeQuickActionMenu()" class="btn btn-outline" style="width: 100%; justify-content: flex-start;">
            ðŸ“· Scan Document
        </button>
    </div>
    
    <script>
        function openQuickActionMenu() {
            const menu = document.getElementById('quickActionMenu');
            const fab = document.querySelector('.fab');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                fab.textContent = 'âœ•';
                fab.style.transform = 'rotate(45deg)';
            } else {
                closeQuickActionMenu();
            }
        }
        
        function closeQuickActionMenu() {
            const menu = document.getElementById('quickActionMenu');
            const fab = document.querySelector('.fab');
            menu.style.display = 'none';
            fab.textContent = 'âž•';
            fab.style.transform = 'rotate(0deg)';
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('quickActionMenu');
            const fab = document.querySelector('.fab');
            if (menu && fab && menu.style.display !== 'none') {
                if (!menu.contains(e.target) && !fab.contains(e.target)) {
                    closeQuickActionMenu();
                }
            }
        });
    </script>

    <!-- ============================================ -->
    <!-- VOICE AI ASSISTANT MODULE -->
    <!-- ============================================ -->
    <script>
        // ==================== VOICE AI ASSISTANT ====================
        // Browser-native Speech Recognition & Text-to-Speech
        // Works offline with Web Speech API, optional cloud AI enhancement

        const voiceAI = {
            // State
            isListening: false,
            recognition: null,
            synthesis: window.speechSynthesis,
            currentUtterance: null,
            isSupported: false,
            waveformBars: [],
            animationFrame: null,

            // Settings
            settings: {
                autoSpeak: true,
                speechRate: 1.0,
                language: 'en-US',
                continuous: false,
                useWhisper: false,
                openAIKey: ''
            },

            // Cloud AI state
            mediaRecorder: null,
            audioChunks: [],

            // Initialize Voice AI
            init() {
                // Check browser support
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    console.warn('Speech Recognition not supported in this browser');
                    this.isSupported = false;
                    return;
                }

                this.isSupported = true;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = this.settings.language;

                // Setup event handlers
                this.recognition.onstart = () => this.onRecognitionStart();
                this.recognition.onend = () => this.onRecognitionEnd();
                this.recognition.onresult = (e) => this.onRecognitionResult(e);
                this.recognition.onerror = (e) => this.onRecognitionError(e);

                // Create waveform visualization
                this.createWaveform();

                // Load settings
                this.loadSettings();

                console.log('ðŸŽ™ï¸ Voice AI initialized');
            },

            // Load saved settings
            loadSettings() {
                try {
                    const saved = localStorage.getItem('voiceAISettings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                    // Load encrypted API key
                    const encKey = localStorage.getItem('voiceAI_apiKey');
                    if (encKey) {
                        this.settings.openAIKey = this.decryptKey(encKey);
                    }
                } catch(e) {}

                // Apply settings to UI
                const autoSpeak = document.getElementById('voiceAutoSpeak');
                const speechRate = document.getElementById('voiceSpeechRate');
                const useWhisper = document.getElementById('voiceUseWhisper');
                const apiKeyField = document.getElementById('voiceOpenAIKey');

                if (autoSpeak) autoSpeak.checked = this.settings.autoSpeak;
                if (speechRate) speechRate.value = this.settings.speechRate;
                if (useWhisper) useWhisper.checked = this.settings.useWhisper;
                if (apiKeyField && this.settings.openAIKey) {
                    apiKeyField.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + this.settings.openAIKey.slice(-4);
                }

                this.updateCloudStatus();
            },

            // Save settings
            saveSettings() {
                const autoSpeak = document.getElementById('voiceAutoSpeak');
                const speechRate = document.getElementById('voiceSpeechRate');
                const useWhisper = document.getElementById('voiceUseWhisper');

                if (autoSpeak) this.settings.autoSpeak = autoSpeak.checked;
                if (speechRate) this.settings.speechRate = parseFloat(speechRate.value);
                if (useWhisper) this.settings.useWhisper = useWhisper.checked;

                // Don't save API key in main settings
                const settingsToSave = { ...this.settings };
                delete settingsToSave.openAIKey;
                localStorage.setItem('voiceAISettings', JSON.stringify(settingsToSave));
            },

            // Save cloud settings with API key
            saveCloudSettings() {
                const useWhisper = document.getElementById('voiceUseWhisper');
                const apiKeyField = document.getElementById('voiceOpenAIKey');

                if (useWhisper) this.settings.useWhisper = useWhisper.checked;

                if (apiKeyField && apiKeyField.value && !apiKeyField.value.startsWith('â€¢â€¢')) {
                    this.settings.openAIKey = apiKeyField.value.trim();
                    // Encrypt and store API key separately
                    localStorage.setItem('voiceAI_apiKey', this.encryptKey(this.settings.openAIKey));
                    apiKeyField.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + this.settings.openAIKey.slice(-4);
                }

                this.saveSettings();
                this.updateCloudStatus();
                showToast('Cloud AI settings saved!', 'success');
            },

            // Simple obfuscation for API key (not true encryption, but better than plaintext)
            encryptKey(key) {
                return btoa(key.split('').reverse().join(''));
            },

            decryptKey(encrypted) {
                try {
                    return atob(encrypted).split('').reverse().join('');
                } catch(e) {
                    return '';
                }
            },

            updateCloudStatus() {
                const statusEl = document.getElementById('voiceCloudStatus');
                if (!statusEl) return;

                if (this.settings.useWhisper && this.settings.openAIKey) {
                    statusEl.innerHTML = '<span style="color: #06ffa5;">âœ“ Whisper API configured</span>';
                } else if (this.settings.useWhisper) {
                    statusEl.innerHTML = '<span style="color: #ffd700;">âš  API key required</span>';
                } else {
                    statusEl.innerHTML = '<span style="opacity: 0.5;">Using browser speech recognition</span>';
                }
            },

            // Toggle Voice AI Modal
            toggle() {
                const modal = document.getElementById('voiceAIModal');
                if (!modal) return;

                if (modal.style.display === 'none' || !modal.style.display) {
                    if (!this.isSupported) {
                        showToast('Speech recognition is not supported in your browser. Try Chrome or Edge.', 'warning');
                        return;
                    }
                    openModal('voiceAIModal');
                    this.updateStatus('Ready', 'ready');
                } else {
                    this.stopListening();
                    closeModal('voiceAIModal');
                }
            },

            // Toggle listening
            toggleListening() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            },

            // Start listening
            startListening() {
                this.stopSpeaking(); // Stop any ongoing speech

                // Use Whisper API if enabled and configured
                if (this.settings.useWhisper && this.settings.openAIKey) {
                    this.startWhisperRecording();
                    return;
                }

                // Fallback to browser speech recognition
                if (!this.isSupported || !this.recognition) {
                    showToast('Speech recognition not available', 'error');
                    return;
                }

                try {
                    this.recognition.start();
                } catch(e) {
                    console.error('Failed to start recognition:', e);
                    if (e.message.includes('already started')) {
                        this.recognition.stop();
                        setTimeout(() => this.recognition.start(), 100);
                    }
                }
            },

            // Stop listening
            stopListening() {
                // Stop Whisper recording if active
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }

                // Stop browser recognition
                if (this.recognition) {
                    try {
                        this.recognition.stop();
                    } catch(e) {}
                }
                this.isListening = false;
                this.updateMicButton(false);
                this.stopWaveformAnimation();
            },

            // ===== WHISPER API INTEGRATION =====

            async startWhisperRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    this.audioChunks = [];
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            this.audioChunks.push(e.data);
                        }
                    };

                    this.mediaRecorder.onstop = async () => {
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());

                        // Process with Whisper
                        if (this.audioChunks.length > 0) {
                            await this.processWithWhisper();
                        }
                    };

                    this.mediaRecorder.start();
                    this.isListening = true;
                    this.updateStatus('ðŸŒ Listening (Whisper)...', 'listening');
                    this.updateMicButton(true);
                    this.startWaveformAnimation();
                    this.setTranscript('<span style="opacity: 0.7;">ðŸŒ Recording with Whisper AI...</span>');

                    // Auto-stop after 30 seconds
                    setTimeout(() => {
                        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                            this.stopListening();
                        }
                    }, 30000);

                } catch(e) {
                    console.error('Failed to start Whisper recording:', e);
                    showToast('Microphone access denied', 'error');

                    // Fallback to browser recognition
                    this.settings.useWhisper = false;
                    this.startListening();
                }
            },

            async processWithWhisper() {
                this.updateStatus('ðŸŒ Processing...', 'processing');
                this.setTranscript('<span style="opacity: 0.7;">ðŸŒ Sending to Whisper AI...</span>');

                try {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });

                    // Convert to file
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'audio.webm');
                    formData.append('model', 'whisper-1');
                    formData.append('language', 'en');

                    const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.settings.openAIKey}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Whisper API error');
                    }

                    const result = await response.json();
                    const transcript = result.text?.trim();

                    if (transcript) {
                        this.setTranscript(`<strong>${transcript}</strong> <span style="font-size: 0.7rem; opacity: 0.5;">ðŸŒ Whisper</span>`);
                        this.processCommand(transcript);
                    } else {
                        this.setTranscript('<span style="opacity: 0.7;">No speech detected. Try again.</span>');
                        this.updateStatus('Ready', 'ready');
                    }

                } catch(e) {
                    console.error('Whisper API error:', e);
                    this.updateStatus('Error', 'error');

                    if (e.message.includes('API key')) {
                        showToast('Invalid OpenAI API key', 'error');
                    } else {
                        showToast(`Whisper error: ${e.message}`, 'error');
                    }

                    this.setTranscript('<span style="color: #ff4081;">Error processing audio. Check your API key.</span>');
                }

                this.isListening = false;
                this.updateMicButton(false);
                this.stopWaveformAnimation();
            },

            // Recognition started
            onRecognitionStart() {
                this.isListening = true;
                this.updateStatus('Listening...', 'listening');
                this.updateMicButton(true);
                this.startWaveformAnimation();
                this.setTranscript('<span style="opacity: 0.7;">Listening...</span>');
            },

            // Recognition ended
            onRecognitionEnd() {
                this.isListening = false;
                this.updateStatus('Ready', 'ready');
                this.updateMicButton(false);
                this.stopWaveformAnimation();
            },

            // Recognition result
            onRecognitionResult(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        finalTranscript += result[0].transcript;
                    } else {
                        interimTranscript += result[0].transcript;
                    }
                }

                // Show transcript
                if (finalTranscript) {
                    this.setTranscript(`<strong>${finalTranscript}</strong>`);
                    this.processCommand(finalTranscript);
                } else if (interimTranscript) {
                    this.setTranscript(`<span style="opacity: 0.7;">${interimTranscript}</span>`);
                }
            },

            // Recognition error
            onRecognitionError(event) {
                console.error('Speech recognition error:', event.error);

                const errorMessages = {
                    'no-speech': 'No speech detected. Please try again.',
                    'audio-capture': 'Microphone not found. Please check permissions.',
                    'not-allowed': 'Microphone access denied. Please allow microphone access.',
                    'network': 'Network error. Please check your connection.',
                    'aborted': 'Recognition was stopped.',
                    'language-not-supported': 'Language not supported.'
                };

                const message = errorMessages[event.error] || `Error: ${event.error}`;
                this.updateStatus('Error', 'error');
                showToast(message, 'error');
            },

            // Process voice command
            processCommand(text) {
                const command = text.toLowerCase().trim();
                this.updateStatus('Processing...', 'processing');

                // Parse and execute command
                const result = this.parseCommand(command);

                if (result.action) {
                    this.executeAction(result);
                } else {
                    this.respond("I didn't understand that command. Try saying 'create invoice', 'show revenue', or 'list overdue invoices'.");
                }
            },

            // Parse command to determine action
            parseCommand(command) {
                // Invoice creation commands
                if (command.includes('create') && command.includes('invoice') ||
                    command.includes('new invoice') ||
                    command.includes('make invoice')) {

                    // Try to extract customer name
                    const forMatch = command.match(/(?:for|to)\s+(.+?)(?:\s+for|\s*$)/i);
                    const customerName = forMatch ? forMatch[1].trim() : null;

                    return { action: 'createInvoice', customerName };
                }

                // Revenue queries
                if (command.includes('revenue') || command.includes('sales') || command.includes('income')) {
                    let period = 'month';
                    if (command.includes('today')) period = 'today';
                    else if (command.includes('week')) period = 'week';
                    else if (command.includes('year')) period = 'year';

                    return { action: 'getRevenue', period };
                }

                // Overdue invoices
                if (command.includes('overdue') || command.includes('unpaid') || command.includes('outstanding')) {
                    return { action: 'getOverdue' };
                }

                // Top customers
                if (command.includes('top customer') || command.includes('best customer')) {
                    return { action: 'getTopCustomers' };
                }

                // Invoice count
                if (command.includes('how many invoice')) {
                    return { action: 'getInvoiceCount' };
                }

                // Product search
                if (command.includes('find product') || command.includes('search product')) {
                    const searchMatch = command.match(/(?:find|search)\s+product\s+(.+)/i);
                    return { action: 'searchProduct', query: searchMatch ? searchMatch[1] : '' };
                }

                // Navigation commands
                if (command.includes('go to') || command.includes('show') || command.includes('open')) {
                    if (command.includes('dashboard')) return { action: 'navigate', tab: 'dashboard' };
                    if (command.includes('invoice')) return { action: 'navigate', tab: 'invoices' };
                    if (command.includes('customer')) return { action: 'navigate', tab: 'customers' };
                    if (command.includes('product')) return { action: 'navigate', tab: 'products' };
                    if (command.includes('setting')) return { action: 'navigate', tab: 'settings' };
                }

                // Cash flow
                if (command.includes('cash flow') || command.includes('cashflow')) {
                    return { action: 'getCashFlow' };
                }

                // Mark invoice as paid
                if ((command.includes('mark') || command.includes('set')) && command.includes('paid')) {
                    const invoiceMatch = command.match(/invoice\s*#?\s*(\w+)/i);
                    return { action: 'markPaid', invoiceNumber: invoiceMatch ? invoiceMatch[1] : null };
                }

                // Send invoice
                if (command.includes('send') && command.includes('invoice')) {
                    const invoiceMatch = command.match(/invoice\s*#?\s*(\w+)/i);
                    return { action: 'sendInvoice', invoiceNumber: invoiceMatch ? invoiceMatch[1] : null };
                }

                // Create customer
                if ((command.includes('add') || command.includes('create') || command.includes('new')) && command.includes('customer')) {
                    const nameMatch = command.match(/(?:named?|called?)\s+(.+?)(?:\s+with|\s*$)/i);
                    return { action: 'createCustomer', customerName: nameMatch ? nameMatch[1] : null };
                }

                // Stock/inventory queries
                if (command.includes('stock') || command.includes('inventory')) {
                    if (command.includes('low')) {
                        return { action: 'getLowStock' };
                    }
                    const productMatch = command.match(/(?:stock|inventory)\s+(?:of|for)?\s*(.+)/i);
                    return { action: 'getStock', productName: productMatch ? productMatch[1].trim() : null };
                }

                // Profit queries
                if (command.includes('profit') || command.includes('margin')) {
                    return { action: 'getProfit' };
                }

                // Today's summary
                if (command.includes('today') && (command.includes('summary') || command.includes('report'))) {
                    return { action: 'getTodaySummary' };
                }

                // Recent invoices
                if (command.includes('recent') && command.includes('invoice')) {
                    return { action: 'getRecentInvoices' };
                }

                // Customer lookup
                if (command.includes('find customer') || command.includes('search customer') || command.includes('lookup customer')) {
                    const nameMatch = command.match(/(?:find|search|lookup)\s+customer\s+(.+)/i);
                    return { action: 'findCustomer', customerName: nameMatch ? nameMatch[1] : null };
                }

                // Help
                if (command.includes('help') || command.includes('what can you do')) {
                    return { action: 'help' };
                }

                return { action: null };
            },

            // Execute parsed action
            executeAction(result) {
                switch(result.action) {
                    case 'createInvoice':
                        this.handleCreateInvoice(result.customerName);
                        break;
                    case 'getRevenue':
                        this.handleGetRevenue(result.period);
                        break;
                    case 'getOverdue':
                        this.handleGetOverdue();
                        break;
                    case 'getTopCustomers':
                        this.handleGetTopCustomers();
                        break;
                    case 'getInvoiceCount':
                        this.handleGetInvoiceCount();
                        break;
                    case 'searchProduct':
                        this.handleSearchProduct(result.query);
                        break;
                    case 'navigate':
                        this.handleNavigate(result.tab);
                        break;
                    case 'getCashFlow':
                        this.handleGetCashFlow();
                        break;
                    case 'markPaid':
                        this.handleMarkPaid(result.invoiceNumber);
                        break;
                    case 'sendInvoice':
                        this.handleSendInvoice(result.invoiceNumber);
                        break;
                    case 'createCustomer':
                        this.handleCreateCustomer(result.customerName);
                        break;
                    case 'getLowStock':
                        this.handleGetLowStock();
                        break;
                    case 'getStock':
                        this.handleGetStock(result.productName);
                        break;
                    case 'getProfit':
                        this.handleGetProfit();
                        break;
                    case 'getTodaySummary':
                        this.handleTodaySummary();
                        break;
                    case 'getRecentInvoices':
                        this.handleRecentInvoices();
                        break;
                    case 'findCustomer':
                        this.handleFindCustomer(result.customerName);
                        break;
                    case 'help':
                        this.handleHelp();
                        break;
                    default:
                        this.respond("I'm not sure how to do that yet.");
                }
            },

            // Execute command directly (from quick buttons)
            executeCommand(command) {
                this.setTranscript(`<strong>${command}</strong>`);
                this.processCommand(command);
            },

            // === ACTION HANDLERS ===

            handleCreateInvoice(customerName) {
                if (customerName) {
                    // Try to find matching customer
                    const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                    const match = customers.find(c =>
                        c.name.toLowerCase().includes(customerName.toLowerCase())
                    );

                    if (match) {
                        this.respond(`Creating invoice for ${match.name}. Opening invoice form now.`);
                        closeModal('voiceAIModal');
                        setTimeout(() => {
                            openCreateInvoiceModal();
                            // Pre-select customer if possible
                            setTimeout(() => {
                                const customerSelect = document.getElementById('invoiceCustomer');
                                if (customerSelect) {
                                    for (let option of customerSelect.options) {
                                        if (option.text.toLowerCase().includes(customerName.toLowerCase())) {
                                            customerSelect.value = option.value;
                                            customerSelect.dispatchEvent(new Event('change'));
                                            break;
                                        }
                                    }
                                }
                            }, 300);
                        }, 1500);
                    } else {
                        this.respond(`I couldn't find a customer named "${customerName}". Opening invoice form - please select a customer.`);
                        closeModal('voiceAIModal');
                        setTimeout(() => openCreateInvoiceModal(), 1500);
                    }
                } else {
                    this.respond("Opening new invoice form. Please select a customer.");
                    closeModal('voiceAIModal');
                    setTimeout(() => openCreateInvoiceModal(), 1500);
                }
            },

            handleGetRevenue(period) {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const now = new Date();
                let startDate, periodName;

                switch(period) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        periodName = 'today';
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        periodName = 'this week';
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        periodName = 'this year';
                        break;
                    default:
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        periodName = 'this month';
                }

                const revenue = invoices
                    .filter(inv => new Date(inv.date) >= startDate && inv.status !== 'cancelled')
                    .reduce((sum, inv) => sum + (inv.total || 0), 0);

                this.respond(`Your revenue ${periodName} is R ${revenue.toLocaleString('en-ZA', {minimumFractionDigits: 2})}.`);
            },

            handleGetOverdue() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const now = new Date();

                const overdue = invoices.filter(inv => {
                    if (inv.status === 'paid' || inv.status === 'cancelled') return false;
                    const dueDate = new Date(inv.dueDate || inv.date);
                    return dueDate < now;
                });

                if (overdue.length === 0) {
                    this.respond("Great news! You have no overdue invoices.");
                } else {
                    const total = overdue.reduce((sum, inv) => sum + (inv.total || 0), 0);
                    this.respond(`You have ${overdue.length} overdue invoice${overdue.length > 1 ? 's' : ''} totaling R ${total.toLocaleString('en-ZA', {minimumFractionDigits: 2})}.`);
                }
            },

            handleGetTopCustomers() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const customerTotals = {};

                invoices.forEach(inv => {
                    if (inv.customerName) {
                        customerTotals[inv.customerName] = (customerTotals[inv.customerName] || 0) + (inv.total || 0);
                    }
                });

                const sorted = Object.entries(customerTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                if (sorted.length === 0) {
                    this.respond("No customer data available yet.");
                } else {
                    const topList = sorted.map((c, i) => `${i + 1}. ${c[0]} with R ${c[1].toLocaleString('en-ZA', {minimumFractionDigits: 2})}`).join('. ');
                    this.respond(`Your top customers are: ${topList}.`);
                }
            },

            handleGetInvoiceCount() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const thisMonth = invoices.filter(inv => {
                    const d = new Date(inv.date);
                    const now = new Date();
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });

                this.respond(`You have ${invoices.length} total invoices, with ${thisMonth.length} created this month.`);
            },

            handleSearchProduct(query) {
                if (!query) {
                    this.respond("Please specify what product you're looking for.");
                    return;
                }

                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const matches = products.filter(p =>
                    p.name.toLowerCase().includes(query.toLowerCase()) ||
                    (p.sku && p.sku.toLowerCase().includes(query.toLowerCase()))
                );

                if (matches.length === 0) {
                    this.respond(`No products found matching "${query}".`);
                } else if (matches.length === 1) {
                    const p = matches[0];
                    this.respond(`Found ${p.name}. Price: R ${p.price}. Stock: ${p.stock || 0} units.`);
                } else {
                    this.respond(`Found ${matches.length} products matching "${query}". The first one is ${matches[0].name} at R ${matches[0].price}.`);
                }
            },

            handleNavigate(tab) {
                this.respond(`Navigating to ${tab}.`);
                closeModal('voiceAIModal');
                setTimeout(() => switchTab(tab), 1000);
            },

            handleGetCashFlow() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const now = new Date();
                const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                const paid = invoices
                    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= thisMonth)
                    .reduce((sum, inv) => sum + (inv.total || 0), 0);

                const pending = invoices
                    .filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled' && new Date(inv.date) >= thisMonth)
                    .reduce((sum, inv) => sum + (inv.total || 0), 0);

                this.respond(`This month: R ${paid.toLocaleString('en-ZA', {minimumFractionDigits: 2})} received, R ${pending.toLocaleString('en-ZA', {minimumFractionDigits: 2})} pending.`);
            },

            handleHelp() {
                this.respond("I can help you with: creating invoices, checking revenue, finding overdue invoices, listing top customers, searching products, marking invoices paid, checking stock levels, and navigating the app. Just ask!");
            },

            handleMarkPaid(invoiceNumber) {
                if (!invoiceNumber) {
                    this.respond("Please specify an invoice number. Say 'mark invoice INV-001 as paid'.");
                    return;
                }

                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const invoice = invoices.find(inv =>
                    inv.invoiceNumber && inv.invoiceNumber.toLowerCase().includes(invoiceNumber.toLowerCase())
                );

                if (invoice) {
                    invoice.status = 'paid';
                    invoice.paidDate = new Date().toISOString();
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    this.respond(`Invoice ${invoice.invoiceNumber} has been marked as paid. Amount: R ${(invoice.total || 0).toLocaleString('en-ZA', {minimumFractionDigits: 2})}.`);
                    // Refresh UI if on invoices tab
                    if (typeof renderInvoices === 'function') renderInvoices();
                } else {
                    this.respond(`I couldn't find invoice "${invoiceNumber}". Please check the invoice number.`);
                }
            },

            handleSendInvoice(invoiceNumber) {
                if (!invoiceNumber) {
                    this.respond("Please specify an invoice number to send.");
                    return;
                }

                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const invoice = invoices.find(inv =>
                    inv.invoiceNumber && inv.invoiceNumber.toLowerCase().includes(invoiceNumber.toLowerCase())
                );

                if (invoice) {
                    this.respond(`To send invoice ${invoice.invoiceNumber}, I'll open the invoice details. You can then use the share or email option.`);
                    closeModal('voiceAIModal');
                    setTimeout(() => {
                        switchTab('invoices');
                        // Try to open the invoice
                        if (typeof viewInvoiceDetails === 'function') {
                            viewInvoiceDetails(invoice.invoiceNumber);
                        }
                    }, 1500);
                } else {
                    this.respond(`I couldn't find invoice "${invoiceNumber}".`);
                }
            },

            handleCreateCustomer(customerName) {
                if (customerName) {
                    this.respond(`Opening new customer form for ${customerName}.`);
                } else {
                    this.respond("Opening new customer form.");
                }
                closeModal('voiceAIModal');
                setTimeout(() => {
                    switchTab('customers');
                    if (typeof openModal === 'function') {
                        openModal('newCustomerModal');
                        if (customerName) {
                            const nameField = document.getElementById('newCustomerName') || document.getElementById('customerName');
                            if (nameField) nameField.value = customerName;
                        }
                    }
                }, 1500);
            },

            handleGetLowStock() {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const lowStock = products.filter(p => (p.stock || 0) <= (p.minStock || 5));

                if (lowStock.length === 0) {
                    this.respond("All products have adequate stock levels.");
                } else {
                    const list = lowStock.slice(0, 5).map(p => `${p.name} (${p.stock || 0} left)`).join(', ');
                    this.respond(`${lowStock.length} products have low stock: ${list}${lowStock.length > 5 ? ', and more' : ''}.`);
                }
            },

            handleGetStock(productName) {
                if (!productName) {
                    this.handleGetLowStock();
                    return;
                }

                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const match = products.find(p => p.name.toLowerCase().includes(productName.toLowerCase()));

                if (match) {
                    const status = (match.stock || 0) <= (match.minStock || 5) ? 'Low stock warning!' : 'Stock OK.';
                    this.respond(`${match.name}: ${match.stock || 0} units in stock. ${status}`);
                } else {
                    this.respond(`Product "${productName}" not found.`);
                }
            },

            handleGetProfit() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const now = new Date();
                const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                const monthlyInvoices = invoices.filter(inv =>
                    new Date(inv.date) >= thisMonth && inv.status !== 'cancelled'
                );

                const revenue = monthlyInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                const cost = monthlyInvoices.reduce((sum, inv) => {
                    const items = inv.items || [];
                    return sum + items.reduce((s, item) => s + ((item.cost || 0) * (item.quantity || 1)), 0);
                }, 0);

                const profit = revenue - cost;
                const margin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;

                this.respond(`This month: Revenue R ${revenue.toLocaleString('en-ZA', {minimumFractionDigits: 2})}, estimated profit R ${profit.toLocaleString('en-ZA', {minimumFractionDigits: 2})} (${margin}% margin).`);
            },

            handleTodaySummary() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayInvoices = invoices.filter(inv => {
                    const d = new Date(inv.date);
                    d.setHours(0, 0, 0, 0);
                    return d.getTime() === today.getTime();
                });

                const revenue = todayInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                const paid = todayInvoices.filter(inv => inv.status === 'paid').length;

                this.respond(`Today: ${todayInvoices.length} invoice${todayInvoices.length !== 1 ? 's' : ''} created totaling R ${revenue.toLocaleString('en-ZA', {minimumFractionDigits: 2})}. ${paid} paid.`);
            },

            handleRecentInvoices() {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const recent = invoices
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);

                if (recent.length === 0) {
                    this.respond("No invoices found.");
                } else {
                    const list = recent.map(inv =>
                        `${inv.invoiceNumber} for ${inv.customerName || 'Unknown'} - R ${(inv.total || 0).toLocaleString('en-ZA', {minimumFractionDigits: 2})}`
                    ).join('. ');
                    this.respond(`Recent invoices: ${list}.`);
                }
            },

            handleFindCustomer(customerName) {
                if (!customerName) {
                    this.respond("Please specify a customer name to search for.");
                    return;
                }

                const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                const matches = customers.filter(c =>
                    c.name.toLowerCase().includes(customerName.toLowerCase())
                );

                if (matches.length === 0) {
                    this.respond(`No customers found matching "${customerName}".`);
                } else if (matches.length === 1) {
                    const c = matches[0];
                    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                    const customerInvoices = invoices.filter(inv => inv.customerId === c.id);
                    const total = customerInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                    this.respond(`Found ${c.name}. ${customerInvoices.length} invoices totaling R ${total.toLocaleString('en-ZA', {minimumFractionDigits: 2})}. Contact: ${c.email || c.phone || 'No contact info'}.`);
                } else {
                    const names = matches.slice(0, 3).map(c => c.name).join(', ');
                    this.respond(`Found ${matches.length} customers: ${names}${matches.length > 3 ? ', and more' : ''}.`);
                }
            },

            // === UI HELPERS ===

            respond(text) {
                this.updateStatus('Ready', 'ready');
                this.showResponse(text);

                if (this.settings.autoSpeak) {
                    this.speak(text);
                }
            },

            speak(text) {
                if (!this.synthesis) return;

                this.stopSpeaking();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = this.settings.speechRate;
                utterance.lang = this.settings.language;

                // Try to use a good voice
                const voices = this.synthesis.getVoices();
                const preferredVoice = voices.find(v =>
                    v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Microsoft'))
                ) || voices.find(v => v.lang.startsWith('en'));

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                this.currentUtterance = utterance;
                this.synthesis.speak(utterance);
            },

            stopSpeaking() {
                if (this.synthesis) {
                    this.synthesis.cancel();
                }
            },

            updateStatus(text, type) {
                const status = document.getElementById('voiceAIStatus');
                if (!status) return;

                status.textContent = text;

                const colors = {
                    ready: { bg: 'rgba(0, 212, 255, 0.2)', color: '#00d4ff' },
                    listening: { bg: 'rgba(6, 255, 165, 0.2)', color: '#06ffa5' },
                    processing: { bg: 'rgba(255, 215, 0, 0.2)', color: '#ffd700' },
                    error: { bg: 'rgba(255, 64, 129, 0.2)', color: '#ff4081' }
                };

                const c = colors[type] || colors.ready;
                status.style.background = c.bg;
                status.style.color = c.color;
            },

            updateMicButton(isActive) {
                const btn = document.getElementById('voiceMicBtn');
                const label = document.getElementById('voiceMicLabel');

                if (btn) {
                    if (isActive) {
                        btn.style.background = 'linear-gradient(135deg, #06ffa5, #00d4ff)';
                        btn.style.animation = 'pulse 1.5s infinite';
                        btn.innerHTML = 'ðŸ”´';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, #7209b7, #00d4ff)';
                        btn.style.animation = 'none';
                        btn.innerHTML = 'ðŸŽ¤';
                    }
                }

                if (label) {
                    label.textContent = isActive ? 'Listening... Click to stop' : 'Click to start listening';
                }
            },

            setTranscript(html) {
                const el = document.getElementById('voiceTranscript');
                if (el) el.innerHTML = html;
            },

            showResponse(text) {
                const container = document.getElementById('voiceAIResponse');
                const textEl = document.getElementById('voiceAIResponseText');

                if (container && textEl) {
                    textEl.textContent = text;
                    container.style.display = 'block';
                }
            },

            // === WAVEFORM VISUALIZATION ===

            createWaveform() {
                const container = document.getElementById('voiceWaveform');
                if (!container) return;

                container.innerHTML = '';
                this.waveformBars = [];

                for (let i = 0; i < 30; i++) {
                    const bar = document.createElement('div');
                    bar.style.cssText = `
                        width: 4px;
                        height: 10px;
                        background: linear-gradient(180deg, #7209b7, #00d4ff);
                        border-radius: 2px;
                        transition: height 0.1s ease;
                    `;
                    container.appendChild(bar);
                    this.waveformBars.push(bar);
                }
            },

            startWaveformAnimation() {
                const idleIcon = document.getElementById('voiceIdleIcon');
                if (idleIcon) idleIcon.style.display = 'none';

                const animate = () => {
                    this.waveformBars.forEach(bar => {
                        const height = Math.random() * 50 + 10;
                        bar.style.height = `${height}px`;
                    });
                    this.animationFrame = requestAnimationFrame(animate);
                };

                animate();
            },

            stopWaveformAnimation() {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }

                const idleIcon = document.getElementById('voiceIdleIcon');
                if (idleIcon) idleIcon.style.display = 'block';

                this.waveformBars.forEach(bar => {
                    bar.style.height = '10px';
                });
            }
        };

        // Initialize Voice AI when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            voiceAI.init();
        });

        // Also try to init if DOM already loaded
        if (document.readyState !== 'loading') {
            voiceAI.init();
        }

        // Save settings when changed
        document.addEventListener('change', (e) => {
            if (e.target.id === 'voiceAutoSpeak' || e.target.id === 'voiceSpeechRate') {
                voiceAI.saveSettings();
            }
        });
    </script>

    <!-- ============================================ -->
    <!-- PERMANENT CONICORE ATTRIBUTION FOOTER -->
    <!-- ============================================ -->
    <div id="conicorePoweredBy" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(5, 7, 20, 0.98));
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        padding: 10px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        border-top: 1px solid rgba(0, 212, 255, 0.3);
        z-index: 10000;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
    ">
        <span>Powered by</span>
        <a href="https://conicore.app" target="_blank" rel="noopener noreferrer" style="
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #00d4ff;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        " onmouseover="this.style.color='#06ffa5'; this.style.transform='scale(1.05)'" 
           onmouseout="this.style.color='#00d4ff'; this.style.transform='scale(1)'">
            <span style="font-size: 1.1rem;">ðŸ“Š</span>
            <span>ConiCore</span>
        </a>
        <span style="opacity: 0.4;">|</span>
        <span style="opacity: 0.6; font-size: 0.75rem;">Professional Business Management Â© 2026</span>
    </div>

    <style>
        /* Ensure main content doesn't get hidden behind footer */
        .tab-content, #dashboard, #invoices, #customers, #products, #settings, #admin {
            padding-bottom: 60px !important;
        }
        
        /* Hide ConiCore footer when printing */
        @media print {
            #conicorePoweredBy {
                display: none !important;
            }
        }
        
        /* Mobile adjustments for footer */
        @media (max-width: 480px) {
            #conicorePoweredBy {
                padding: 8px 15px;
                font-size: 0.7rem;
                flex-wrap: wrap;
                gap: 5px;
            }
            #conicorePoweredBy span:last-child {
                display: none;
            }
        }
    </style>

</body>
</html>